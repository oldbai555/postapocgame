/**
 * @Author: zjj
 * @Date: 2025/11/12
 * @Desc: C -> S
**/

syntax = "proto3";

package pb3;

option go_package = "server/internal/protocol";
import "base.proto";
import "player.proto";
import "attr_def.proto";
import "social_def.proto";

// G2D 和 D2G 相关消息定义已移除，统一使用 DungeonActorMsgId 进行内部消息交互
// 以下消息定义保留，用于 DungeonActorMsgId 消息的负载：
message G2DEnterDungeonReq {
    string session_id = 1;
    uint32 platform_id = 2;// 平台ID
    uint32 srv_id = 3;// 区服ID
    PlayerSimpleData simple_data = 4;
    SyncAttrData sync_attr_data = 5;// 属性数据
    map<uint32, uint32> skill_map = 6;// 技能列表（skillId -> level）
    uint32 dungeon_id = 7;// 副本ID（0表示默认副本，>0表示限时副本）
    uint32 difficulty = 8;// 难度（1=普通 2=精英 3=地狱）
}

message G2DSyncAttrsReq {
    string session_id = 1;
    uint64 role_id = 2;
    SyncAttrData sync_data = 3;// 属性同步数据
}

message G2DUpdateHpMpReq {
    string session_id = 1;// 会话ID
    uint64 role_id = 2;// 角色ID
    int64 hp_delta = 3;// HP变化量（正数表示增加，负数表示减少）
    int64 mp_delta = 4;// MP变化量（正数表示增加，负数表示减少）
}

message G2DUpdateSkillReq {
    string session_id = 1;// 会话ID
    uint64 role_id = 2;// 角色ID
    uint32 skill_id = 3;// 技能ID
    uint32 skill_level = 4;// 技能等级
}

// DungeonActor → PlayerActor 消息定义（用于 PlayerActorMsgId 消息的负载）
message D2GAddItemReq {
    string session_id = 1;// 会话ID
    uint64 role_id = 2;// 角色ID
    uint32 item_id = 3;// 物品ID
    uint32 count = 4;// 数量
    uint64 item_hdl = 5;// 掉落物句柄（用于响应时移除）
}

message D2GSettleDungeonReq {
    string session_id = 1;// 会话ID
    uint64 role_id = 2;// 角色ID
    uint32 dungeon_id = 3;// 副本ID
    uint32 difficulty = 4;// 难度
    bool success = 5;// 是否成功
    uint32 kill_count = 6;// 击杀数量
    uint32 time_used = 7;// 用时（秒）
    repeated RewardItem rewards = 8;// 奖励列表
}

message RewardItem {
    uint32 type = 1;// 1=经验 2=金币 3=物品
    uint32 item_id = 2;
    uint32 count = 3;
}

message D2GEnterDungeonSuccessReq {
    string session_id = 1;// 会话ID
    uint64 role_id = 2;// 角色ID
}

message D2GSyncPositionReq {
    string session_id = 1;// 会话ID
    uint64 role_id = 2;// 角色ID
    uint32 scene_id = 3;// 场景ID
    uint32 pos_x = 4;// 位置X
    uint32 pos_y = 5;// 位置Y
}

message D2GSyncAttrsReq {
    string session_id = 1;// 会话ID
    uint64 role_id = 2;// 角色ID
    SyncAttrData sync_data = 3;// 属性数据
}

// 透传 S2C 协议
message PlayerActorMsgIdSendToClientReq {
    uint32 msg_id = 1; // S2C 协议ID
    bytes data = 2;    // 编码后的 S2C 消息体
}

// 玩家Actor离线消息投递
message AddActorMessageMsg {
    uint64 role_id = 1;// 目标角色ID
    int32 msg_type = 2;// 消息类型
    bytes msg_data = 3;// 序列化后的消息体
}

// ========== DungeonActor <-> PlayerActor 内部消息 ==========

// DungeonActor 内部消息ID（用于 GameServer 内部路由，PlayerActor → DungeonActor）
// 说明：所有发送给 DungeonActor 的内部消息必须使用此枚举，禁止在 Go 代码中自行定义常量。
// 这些消息的负载通常直接复用客户端 C2S 协议的请求体（例如 C2SStartMoveReq/C2SUseSkillReq 等）。
enum DungeonActorMsgId {
    DungeonActorMsgIdNil = 0;

    // 移动相关
    DungeonActorMsgIdStartMove    = 1; // C2SStartMove
    DungeonActorMsgIdUpdateMove   = 2; // C2SUpdateMove
    DungeonActorMsgIdEndMove      = 3; // C2SEndMove
    DungeonActorMsgIdChangeScene  = 4; // C2SChangeScene

    // 战斗与交互
    DungeonActorMsgIdUseSkill     = 5; // C2SUseSkill
    DungeonActorMsgIdPickupItem   = 6; // C2SPickupItem
    DungeonActorMsgIdRevive       = 7; // C2SRevive

    // GameServer → DungeonActor 内部消息（原 G2D RPC）
    DungeonActorMsgIdEnterDungeon     = 8;  // G2DEnterDungeon
    DungeonActorMsgIdSyncAttrs        = 9;  // G2DSyncAttrs
    DungeonActorMsgIdUpdateHpMp       = 10; // G2DUpdateHpMp
    DungeonActorMsgIdUpdateSkill      = 11; // G2DUpdateSkill
    DungeonActorMsgIdGetNearestMonster = 12; // C2SGetNearestMonster
}

// ========== PlayerActor <-> DungeonActor 内部消息（DungeonActor → PlayerActor）==========

// PlayerActor 内部消息ID（用于 GameServer 内部路由）
// 说明：所有发送给 PlayerActor 的内部消息必须使用此枚举，禁止在 Go 代码中自行定义常量。
enum PlayerActorMsgId {
    PlayerActorMsgIdNil = 0;

    // 系统消息（GameServer → PlayerActor）
    PlayerActorMsgIdDoNetworkMsg = 1;    // 处理客户端网络消息
    PlayerActorMsgIdDoRunOneMsg = 2;     // 执行 RunOne 循环
    PlayerActorMsgIdPlayerMessageMsg = 3; // 玩家离线消息投递

    // DungeonActor → PlayerActor 消息
    PlayerActorMsgIdAddItem = 4;              // 添加物品（拾取掉落物）
    PlayerActorMsgIdSettleDungeon = 5;        // 副本结算
    PlayerActorMsgIdEnterDungeonSuccess = 6;  // 进入副本成功通知
    PlayerActorMsgIdSyncPosition = 7;         // 同步坐标
    PlayerActorMsgIdSyncAttrs = 8;            // 同步属性（Dungeon → GameServer）
    PlayerActorMsgIdSendToClient = 9;         // 透传 S2C 协议
}

// ========== PublicActor <-> PlayerActor 内部消息 ==========

// PublicActor 内部消息ID（用于 GameServer 内部路由）
// 说明：服务端所有针对 PublicActor 的消息ID必须使用此枚举，禁止在 Go 代码中自行定义常量。
enum PublicActorMsgId {
    PublicActorMsgIdNil = 0;

    // 在线状态管理
    PublicActorMsgIdRegisterOnline = 1;
    PublicActorMsgIdUnregisterOnline = 2;

    // 聊天系统
    PublicActorMsgIdChatWorld = 3;
    PublicActorMsgIdChatPrivate = 4;

    // 好友系统
    PublicActorMsgIdAddFriendReq = 5;
    PublicActorMsgIdAddFriendResp = 6;
    PublicActorMsgIdNotifyAddFriend = 7;
    PublicActorMsgIdFriendListQuery = 8;

    // 排行榜系统
    PublicActorMsgIdUpdateRankSnapshot = 9;
    PublicActorMsgIdUpdateRankValue = 10;
    PublicActorMsgIdQueryRank = 11;

    // 公会系统
    PublicActorMsgIdCreateGuild = 12;
    PublicActorMsgIdJoinGuildReq = 13;
    PublicActorMsgIdLeaveGuild = 14;
    PublicActorMsgIdGuildJoinApprove = 15;
    PublicActorMsgIdGuildJoinReject = 16;
    PublicActorMsgIdGuildKickMember = 17;
    PublicActorMsgIdGuildChangePosition = 18;
    PublicActorMsgIdGuildUpdateAnnouncement = 19;
    PublicActorMsgIdGuildUpdateName = 20;

    // 拍卖行系统
    PublicActorMsgIdAuctionPutOn = 21;
    PublicActorMsgIdAuctionBuy = 22;
    PublicActorMsgIdAuctionQuery = 23;

    PublicActorMsgRunOne = 24;
    PublicActorMsgIdUpdateOfflineData = 25; // 离线数据更新
}

// 在线状态管理
message RegisterOnlineMsg {
    uint64 role_id = 1;
    string session_id = 2;
}

message UnregisterOnlineMsg {
    uint64 role_id = 1;
}

// 聊天消息
message ChatWorldMsg {
    uint64 sender_id = 1;
    string sender_name = 2;
    string content = 3;
}

message ChatPrivateMsg {
    uint64 sender_id = 1;
    uint64 target_id = 2;
    string sender_name = 3;
    string content = 4;
}

message ChatBroadcastMsg {
    ChatMessage chat_msg = 1;
}

// 好友系统
message AddFriendReqMsg {
    uint64 requester_id = 1;
    uint64 target_id = 2;
    string requester_name = 3;
}

message AddFriendRespMsg {
    uint64 requester_id = 1;
    uint64 target_id = 2;
    bool accepted = 3; // true=同意, false=拒绝
}

message AddFriendNotifyMsg {
    uint64 requester_id = 1;
    uint64 target_id = 2;
    string requester_name = 3;
    string target_session_id = 4; // 目标玩家的SessionId，用于推送通知
}

message FriendListQueryMsg {
    uint64 requester_id = 1;
    string requester_session_id = 2;
    repeated uint64 friend_ids = 3;
}

message FriendListQueryRespMsg {
    repeated PlayerRankSnapshot snapshots = 1;
    map<uint64, bool> online_status = 2; // role_id -> is_online
}

// 排行榜系统
message UpdateRankSnapshotMsg {
    uint64 role_id = 1;
    PlayerRankSnapshot snapshot = 2;
}

message UpdateRankValueMsg {
    RankType rank_type = 1;
    int64 key = 2;   // 角色ID或公会ID
    int64 value = 3; // 排行榜数值
}

message QueryRankReqMsg {
    RankType rank_type = 1;
    int32 top_n = 2;
    string requester_session_id = 3;
    uint64 requester_role_id = 4;
}

message QueryRankRespMsg {
    RankData rank_data = 1;
    int64 requester_rank = 2; // 请求者的排名（-1表示未上榜）
    int64 requester_value = 3; // 请求者的数值
}

// 离线数据更新
message UpdateOfflineDataMsg {
    uint64 role_id = 1;
    OfflineDataType data_type = 2;
    bytes payload = 3;    // 序列化后的具体数据
    uint32 version = 4;   // 数据版本（预留，默认1）
    int64 updated_at = 5; // 数据更新时间
}

// 公会系统
message CreateGuildMsg {
    uint64 creator_id = 1;
    string guild_name = 2;
    string creator_name = 3;
}

message CreateGuildRespMsg {
    bool success = 1;
    string error_msg = 2;
    GuildData guild_data = 3;
}

message JoinGuildReqMsg {
    uint64 requester_id = 1;
    uint64 guild_id = 2;
    string requester_name = 3;
}

message JoinGuildRespMsg {
    bool success = 1;
    string error_msg = 2;
    GuildData guild_data = 3;
}

message LeaveGuildMsg {
    uint64 role_id = 1;
    uint64 guild_id = 2;
}

message GuildMemberUpdateMsg {
    uint64 guild_id = 1;
    GuildData guild_data = 2;
}

// 公会审批流程
message GuildJoinApproveMsg {
    uint64 guild_id = 1;
    uint64 approver_id = 2;  // 审批者ID
    uint64 applicant_id = 3; // 申请人ID
}

message GuildJoinRejectMsg {
    uint64 guild_id = 1;
    uint64 approver_id = 2;  // 审批者ID
    uint64 applicant_id = 3; // 申请人ID
}

message GuildKickMemberMsg {
    uint64 guild_id = 1;
    uint64 operator_id = 2;  // 操作者ID
    uint64 target_id = 3;    // 被踢出的成员ID
}

message GuildChangePositionMsg {
    uint64 guild_id = 1;
    uint64 operator_id = 2;  // 操作者ID
    uint64 target_id = 3;    // 目标成员ID
    uint32 new_position = 4; // 新职位
}

message GuildUpdateAnnouncementMsg {
    uint64 guild_id = 1;
    uint64 operator_id = 2;  // 操作者ID
    string announcement = 3; // 新宣言
}

message GuildUpdateNameMsg {
    uint64 guild_id = 1;
    uint64 operator_id = 2;  // 操作者ID
    string new_name = 3;     // 新名称
}

// 拍卖行系统
message AuctionPutOnMsg {
    uint64 seller_id = 1;
    uint32 item_id = 2;
    uint32 count = 3;
    int64 price = 4;
    int64 duration = 5; // 持续时间（秒）
}

message AuctionPutOnRespMsg {
    bool success = 1;
    string error_msg = 2;
    uint64 auction_id = 3;
}

message AuctionBuyMsg {
    uint64 buyer_id = 1;
    uint64 auction_id = 2;
}

message AuctionBuyRespMsg {
    bool success = 1;
    string error_msg = 2;
    AuctionItem item = 3;
}

message AuctionQueryMsg {
    uint32 item_id = 1;      // 0表示查询所有
    int32 page = 2;          // 页码（从1开始）
    int32 page_size = 3;     // 每页数量
    string requester_session_id = 4;
}

message AuctionQueryRespMsg {
    repeated AuctionItem items = 1;
    int32 total_count = 2;
    int32 total_page = 3;
}
