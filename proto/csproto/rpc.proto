/**
 * @Author: zjj
 * @Date: 2025/11/12
 * @Desc: C -> S
**/

syntax = "proto3";

package pb3;

option go_package = "server/internal/protocol";
import "base.proto";
import "player.proto";
import "attr_def.proto";
import "social_def.proto";

enum G2DRpcProtocol{
    G2DRPCProtocolNil = 0;

    G2DEnterDungeon = 1;// 进入副本
    G2DSyncAttrs = 2;// 同步属性
    G2DUpdateHpMp = 3;// 更新HP/MP
    G2DUpdateSkill = 4;// 更新技能（学习/升级）
}

message G2DEnterDungeonReq {
    string session_id = 1;
    uint32 platform_id = 2;// 平台ID
    uint32 srv_id = 3;// 区服ID
    PlayerSimpleData simple_data = 4;
    SyncAttrData sync_attr_data = 5;// 属性数据
    map<uint32, uint32> skill_map = 6;// 技能列表（skillId -> level）
    uint32 dungeon_id = 7;// 副本ID（0表示默认副本，>0表示限时副本）
    uint32 difficulty = 8;// 难度（1=普通 2=精英 3=地狱）
}

message G2DSyncAttrsReq {
    string session_id = 1;
    uint64 role_id = 2;
    SyncAttrData sync_data = 3;// 属性同步数据
}

message G2DSyncGameDataReq {
    uint32 platform_id = 1;// 平台ID
    uint32 srv_id = 2;// 区服ID
}

// DungeonServer -> GameServer RPC Protocol
enum D2GRpcProtocol{
    D2GRPCProtocolNil = 0;

    D2GRegisterProtocols = 1;// 注册协议
    D2GUnregisterProtocols = 2;// 注销协议
    D2GSettleDungeon = 3;// 副本结算
    D2GEnterDungeonSuccess = 4;// 进入副本成功通知
    D2GAddItem = 5;// 添加物品（拾取掉落物）
    D2GSyncPosition = 6;// 同步坐标到GameServer
    D2GSyncAttrs = 7;// Dungeon属性回传
}

// 协议注册信息
message ProtocolInfo {
    uint32 protoId = 1;// 协议ID
    bool isCommon = 2;// 是否为通用协议(多个DungeonServer共享)
}

// 注册协议请求
message D2GRegisterProtocolsReq {
    uint32 srvType = 1;// DungeonServer类型
    repeated ProtocolInfo protocols = 2;// 协议列表
}

// 注销协议请求
message D2GUnregisterProtocolsReq {
    uint32 srvType = 1;// DungeonServer类型
}

// 副本结算请求
message D2GSettleDungeonReq {
    string session_id = 1;// 会话ID
    uint64 role_id = 2;// 角色ID
    uint32 dungeon_id = 3;// 副本ID
    uint32 difficulty = 4;// 难度
    bool success = 5;// 是否成功
    uint32 kill_count = 6;// 击杀数量
    uint32 time_used = 7;// 用时（秒）
    repeated RewardItem rewards = 8;// 奖励列表
}

// 奖励物品
message RewardItem {
    uint32 type = 1;// 1=经验 2=金币 3=物品
    uint32 item_id = 2;
    uint32 count = 3;
}

// 副本结算响应
message D2GSettleDungeonResp {
    bool success = 1;// 是否成功
    string error_msg = 2;// 错误信息
}

// 进入副本成功通知
message D2GEnterDungeonSuccessReq {
    string session_id = 1;// 会话ID
    uint64 role_id = 2;// 角色ID
}

// 更新HP/MP请求
message G2DUpdateHpMpReq {
    string session_id = 1;// 会话ID
    uint64 role_id = 2;// 角色ID
    int64 hp_delta = 3;// HP变化量（正数表示增加，负数表示减少）
    int64 mp_delta = 4;// MP变化量（正数表示增加，负数表示减少）
}

// 添加物品请求（拾取掉落物）
message D2GAddItemReq {
    string session_id = 1;// 会话ID
    uint64 role_id = 2;// 角色ID
    uint32 item_id = 3;// 物品ID
    uint32 count = 4;// 数量
    uint64 item_hdl = 5;// 掉落物句柄（用于响应时移除）
}

// 添加物品响应
message D2GAddItemResp {
    bool success = 1;// 是否成功
    string error_msg = 2;// 错误信息
    uint64 item_hdl = 3;// 掉落物句柄（用于DungeonServer清理）
}

// 更新技能请求（学习/升级）
message G2DUpdateSkillReq {
    string session_id = 1;// 会话ID
    uint64 role_id = 2;// 角色ID
    uint32 skill_id = 3;// 技能ID
    uint32 skill_level = 4;// 技能等级
}

// 同步坐标请求（DungeonServer -> GameServer）
message D2GSyncPositionReq {
    string session_id = 1;// 会话ID
    uint64 role_id = 2;// 角色ID
    uint32 scene_id = 3;// 场景ID
    uint32 pos_x = 4;// 位置X
    uint32 pos_y = 5;// 位置Y
}

// 同步坐标响应
message D2GSyncPositionResp {
    bool success = 1;// 是否成功
    string error_msg = 2;// 错误信息
}

// Dungeon -> GameServer 属性同步
message D2GSyncAttrsReq {
    string session_id = 1;// 会话ID
    uint64 role_id = 2;// 角色ID
    SyncAttrData sync_data = 3;// 属性数据
}

// 玩家Actor离线消息投递
message AddActorMessageMsg {
    uint64 role_id = 1;// 目标角色ID
    int32 msg_type = 2;// 消息类型
    bytes msg_data = 3;// 序列化后的消息体
}

// ========== PublicActor <-> PlayerActor 内部消息 ==========

// PublicActor 内部消息ID（用于 GameServer 内部路由）
// 说明：服务端所有针对 PublicActor 的消息ID必须使用此枚举，禁止在 Go 代码中自行定义常量。
enum PublicActorMsgId {
    PublicActorMsgIdNil = 0;

    // 在线状态管理
    PublicActorMsgIdRegisterOnline = 1;
    PublicActorMsgIdUnregisterOnline = 2;

    // 聊天系统
    PublicActorMsgIdChatWorld = 3;
    PublicActorMsgIdChatPrivate = 4;

    // 好友系统
    PublicActorMsgIdAddFriendReq = 5;
    PublicActorMsgIdAddFriendResp = 6;
    PublicActorMsgIdNotifyAddFriend = 7;
    PublicActorMsgIdFriendListQuery = 8;

    // 排行榜系统
    PublicActorMsgIdUpdateRankSnapshot = 9;
    PublicActorMsgIdUpdateRankValue = 10;
    PublicActorMsgIdQueryRank = 11;

    // 公会系统
    PublicActorMsgIdCreateGuild = 12;
    PublicActorMsgIdJoinGuildReq = 13;
    PublicActorMsgIdLeaveGuild = 14;
    PublicActorMsgIdGuildJoinApprove = 15;
    PublicActorMsgIdGuildJoinReject = 16;
    PublicActorMsgIdGuildKickMember = 17;
    PublicActorMsgIdGuildChangePosition = 18;
    PublicActorMsgIdGuildUpdateAnnouncement = 19;
    PublicActorMsgIdGuildUpdateName = 20;

    // 拍卖行系统
    PublicActorMsgIdAuctionPutOn = 21;
    PublicActorMsgIdAuctionBuy = 22;
    PublicActorMsgIdAuctionQuery = 23;

    PublicActorMsgRunOne = 24;
    PublicActorMsgIdUpdateOfflineData = 25; // 离线数据更新
}

// 在线状态管理
message RegisterOnlineMsg {
    uint64 role_id = 1;
    string session_id = 2;
}

message UnregisterOnlineMsg {
    uint64 role_id = 1;
}

// 聊天消息
message ChatWorldMsg {
    uint64 sender_id = 1;
    string sender_name = 2;
    string content = 3;
}

message ChatPrivateMsg {
    uint64 sender_id = 1;
    uint64 target_id = 2;
    string sender_name = 3;
    string content = 4;
}

message ChatBroadcastMsg {
    ChatMessage chat_msg = 1;
}

// 好友系统
message AddFriendReqMsg {
    uint64 requester_id = 1;
    uint64 target_id = 2;
    string requester_name = 3;
}

message AddFriendRespMsg {
    uint64 requester_id = 1;
    uint64 target_id = 2;
    bool accepted = 3; // true=同意, false=拒绝
}

message AddFriendNotifyMsg {
    uint64 requester_id = 1;
    uint64 target_id = 2;
    string requester_name = 3;
    string target_session_id = 4; // 目标玩家的SessionId，用于推送通知
}

message FriendListQueryMsg {
    uint64 requester_id = 1;
    string requester_session_id = 2;
    repeated uint64 friend_ids = 3;
}

message FriendListQueryRespMsg {
    repeated PlayerRankSnapshot snapshots = 1;
    map<uint64, bool> online_status = 2; // role_id -> is_online
}

// 排行榜系统
message UpdateRankSnapshotMsg {
    uint64 role_id = 1;
    PlayerRankSnapshot snapshot = 2;
}

message UpdateRankValueMsg {
    RankType rank_type = 1;
    int64 key = 2;   // 角色ID或公会ID
    int64 value = 3; // 排行榜数值
}

message QueryRankReqMsg {
    RankType rank_type = 1;
    int32 top_n = 2;
    string requester_session_id = 3;
    uint64 requester_role_id = 4;
}

message QueryRankRespMsg {
    RankData rank_data = 1;
    int64 requester_rank = 2; // 请求者的排名（-1表示未上榜）
    int64 requester_value = 3; // 请求者的数值
}

// 离线数据更新
message UpdateOfflineDataMsg {
    uint64 role_id = 1;
    OfflineDataType data_type = 2;
    bytes payload = 3;    // 序列化后的具体数据
    uint32 version = 4;   // 数据版本（预留，默认1）
    int64 updated_at = 5; // 数据更新时间
}

// 公会系统
message CreateGuildMsg {
    uint64 creator_id = 1;
    string guild_name = 2;
    string creator_name = 3;
}

message CreateGuildRespMsg {
    bool success = 1;
    string error_msg = 2;
    GuildData guild_data = 3;
}

message JoinGuildReqMsg {
    uint64 requester_id = 1;
    uint64 guild_id = 2;
    string requester_name = 3;
}

message JoinGuildRespMsg {
    bool success = 1;
    string error_msg = 2;
    GuildData guild_data = 3;
}

message LeaveGuildMsg {
    uint64 role_id = 1;
    uint64 guild_id = 2;
}

message GuildMemberUpdateMsg {
    uint64 guild_id = 1;
    GuildData guild_data = 2;
}

// 公会审批流程
message GuildJoinApproveMsg {
    uint64 guild_id = 1;
    uint64 approver_id = 2;  // 审批者ID
    uint64 applicant_id = 3; // 申请人ID
}

message GuildJoinRejectMsg {
    uint64 guild_id = 1;
    uint64 approver_id = 2;  // 审批者ID
    uint64 applicant_id = 3; // 申请人ID
}

message GuildKickMemberMsg {
    uint64 guild_id = 1;
    uint64 operator_id = 2;  // 操作者ID
    uint64 target_id = 3;    // 被踢出的成员ID
}

message GuildChangePositionMsg {
    uint64 guild_id = 1;
    uint64 operator_id = 2;  // 操作者ID
    uint64 target_id = 3;    // 目标成员ID
    uint32 new_position = 4; // 新职位
}

message GuildUpdateAnnouncementMsg {
    uint64 guild_id = 1;
    uint64 operator_id = 2;  // 操作者ID
    string announcement = 3; // 新宣言
}

message GuildUpdateNameMsg {
    uint64 guild_id = 1;
    uint64 operator_id = 2;  // 操作者ID
    string new_name = 3;     // 新名称
}

// 拍卖行系统
message AuctionPutOnMsg {
    uint64 seller_id = 1;
    uint32 item_id = 2;
    uint32 count = 3;
    int64 price = 4;
    int64 duration = 5; // 持续时间（秒）
}

message AuctionPutOnRespMsg {
    bool success = 1;
    string error_msg = 2;
    uint64 auction_id = 3;
}

message AuctionBuyMsg {
    uint64 buyer_id = 1;
    uint64 auction_id = 2;
}

message AuctionBuyRespMsg {
    bool success = 1;
    string error_msg = 2;
    AuctionItem item = 3;
}

message AuctionQueryMsg {
    uint32 item_id = 1;      // 0表示查询所有
    int32 page = 2;          // 页码（从1开始）
    int32 page_size = 3;     // 每页数量
    string requester_session_id = 4;
}

message AuctionQueryRespMsg {
    repeated AuctionItem items = 1;
    int32 total_count = 2;
    int32 total_page = 3;
}
