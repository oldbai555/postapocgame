## 0. 开发必读（精简版）

- **唯一权威**：本文件是服务端整体规划和进度的权威视图；需要细节时再看对应子文档 docs/服务端开发进度文档_full.md。
- **什么时候改文档**：
  - 做完一块功能：补到「已完成功能」+ 在「关键代码位置」登记入口。
  - 需求分期实现：先写到「待实现 / 待完善功能」，用复选框拆子任务。
  - 发现全局约束 / 坑：写进「开发注意事项与架构决策」。
- **不写什么**：不要在这里堆实现细节、函数参数级说明，保持“我复盘或交接时会翻的东西”。
- **实现细节、函数参数级说明**：在“docs/已完成/服务端开发进度文档_full.md”补充。

---

## 1. 当前架构概览

- **服务划分**
  - `gateway`：接入层（TCP/WS、Session 生命周期、消息转发、限流）。
  - `gameserver`：玩家主逻辑（账号/角色、成长、经济、社交、公会、GM、反作弊），一玩家一 Actor。
  - `dungeonserver`：副本/战斗/AI/掉落，单 Actor 驱动整服战斗。
- **跨服通信**
  - Gateway → Game：`ForwardMessage` + Session 事件。
  - Game ↔ Dungeon：异步 RPC（`DungeonServerGateway` / `dungeonserverlink` 封装），禁止同步阻塞。
- **数据归属**
  - 玩家全部状态：`PlayerRoleBinaryData`（SQLite + GORM）。
  - 全局社交/经济：PublicActor + 专门表（公会、拍卖、排行榜快照等）。
- **架构风格**
  - GameServer/DungeonServer：按 Clean Architecture 分层，业务逻辑在 UseCase，协议/Actor 只做适配。
  - 玩家侧旧 `entitysystem` 只剩系统管理器 + 离线消息分发器，其余系统迁移到 `adapter/{system,controller,presenter}`。

---

## 2. 已完成功能（只列关键块）

### 2.1 Gateway
- 接入与转发：TCP + WebSocket、Session 管理、C2S → GameServer、限流/资源保护。

### 2.2 GameServer 核心
- **账号 / 角色 / 会话**
  - 账号注册/登录、Token、角色创建/进入游戏，Session 扩展账号/角色信息。
- **Actor 与系统框架**
  - 每玩家一个 Actor，系统通过 SystemAdapter 挂在 PlayerActor 上，统一生命周期（Init/Login/RunOne）。
  - 定期落盘、统一事件总线、无锁单线程。
- **统一时间与日志**
  - 全服务统一 `servertime`，禁止直接 `time.Now()`。
  - 日志统一走 `pkg/log`，支持 `IRequester` 注入 Session/Role，方便排查。
- **成长 / 经济 / 玩法（已迁 Clean Architecture 的）**
  - 背包（Bag）、货币（Money）、装备（Equip）、属性（AttrCalculator 工具类）、任务（Quest）、副本（Fuben）、技能（Skill）、物品使用（ItemUse）、商店（Shop）、回收（Recycle）。
  - 这些系统的业务逻辑都在 `usecase` 层，Controller 只做协议入口，SystemAdapter 只做生命周期调度。
- **防作弊 / GM / 系统通知**
  - AntiCheat：操作频率控制、可疑行为计数、临时/永久封禁。
  - GM：C2S GM 指令 → GM 系统 → 系统广播/系统邮件等。
  - 系统广播 + 系统邮件：可单人/全服，GM 工具和活动发奖统一复用。
- **Phase 3 社交与 PublicActor**
  - PublicActor：单 Actor 管全局在线状态、排行榜、公会、拍卖、离线快照。
  - 聊天 / 好友 / 排行 / 公会 / 拍卖：全部按 Clean Architecture 落地，Player 通过 UseCase + `PublicActorGateway` 交互，不再直接写 entitysystem。
  - 离线数据管理器：离线快照（Rank 等）的权威实现，PublicActor 负责定期 Flush 和启动加载。
- **玩家消息系统**
  - 已有玩家消息表、注册中心、离线消息加载与回放（MessageSys + `message_dispatcher`），支持“在线直接投递 / 离线入库稍后回放”链路。

### 2.3 DungeonServer
- **战斗服务器基础**
  - 单 Actor 场景 + 实体系统，技能、Buff、AI、战斗流程。
- **移动与坐标**
  - 移动：C2SStart/Update/EndMove 流程，服务端时间驱动位置更新，带速度和延迟容忍度。
  - 坐标：统一“服务端内部用格子坐标，客户端发像素坐标，统一转换”，寻路、范围、校验全部基于格子。
- **属性系统**
  - 接收 GameServer 下发的属性同步，并结合本地系统（怪物、Buff 等）通过注册的计算器重算；RunOne 周期性检查并推属性。

### 2.4 调试客户端（server/example）
- 文本冒险调试端：账号/角色/场景/移动/战斗/背包/副本/GM/脚本等高频动作全覆盖。
- 已有自动寻路（直线+A*）、脚本录制/回放、GM 命令桥接，足够模拟真实客户端链路。

---

## 3. 待实现 / 待完善功能（抓大不抓小）

> 具体分阶段的设计/细则在对应子文档，本节只保留“我下一步要干什么”的 todo 视角。

### 3.1 Clean Architecture 收尾
- [⏳] **SystemAdapter 进一步瘦身**
  - SystemAdapter 只保留“生命周期和事件接线”；业务逻辑下沉 UseCase 已做一轮，但仍需滚动排查是否有新逻辑写回了 SystemAdapter。
  - 关键检查：Money/Bag/Level/Quest/Fuben/Attr 等是否又长出 if/for 逻辑。
- [⏳] **UseCase 测试补齐**
  - Equip / Fuben / Quest / Shop / Recycle / Skill / ItemUse 等核心 UseCase 单测补齐。
- [⏳] **Controller 层系统启用检查的测试**
  - 已在 Controller 里统一加了“系统未开启”的错误返回，需补一轮测试，避免忘检查或误用错误码。

### 3.2 核心玩法 & 运营向
- [ ] 战斗录像：录制/回放/存储三件套（最低要求：单人副本可回放，观测数值问题）。
- [ ] 多人副本匹配/排队：匹配算法 + 队列管理 + 与 DungeonServer 的房间模型。
- [ ] Boss 特殊机制：阶段/环境技、特殊掉落/结算。
- [ ] 反作弊强化：接入所有高风险协议（移动/技能/货币/交易），统一走 AntiCheat。
- [ ] 数据统计与分析：关键行为埋点（登录/付费/副本结果）、简单报表/导出能力。

### 3.3 安全与运维
- [⏳] **GM 权限与审计（高优先级）**
  - 为 GM 账号/角色建立权限模型（等级/标签）、IP/环境白名单。
  - 对高危指令写入审计表或结构化日志（操作者/目标/指令/参数/IP/时间）。
- [⏳] **Gateway / DungeonServer 接入安全**
  - Gateway WebSocket：生产环境启用 IP 白名单、Origin 校验、握手阶段 Token/签名校验。
  - Game ↔ Dungeon：加上 TLS/认证方案，确保只接收可信 GameServer 请求。

### 3.4 辅助系统
- [⏳] **玩家消息系统 Phase 4**
  - 在已有存储/加载/回放基础上，补监控（积压量、失败率）和过期策略，避免消息表无限膨胀。
- [ ] **离线数据管理器二期**
  - 扩展更多离线快照类型（公会展示、拍卖、外观），接入监控，考虑按类型懒加载。

### 3.5 调试客户端
- [ ] 多 Session 管理（小规模机器人编队，验证社交/战斗负载）。
- [ ] 战斗/副本脚本的脚本化 DSL 或最简录制格式，用来快速复现复杂战斗。

---

## 4. 开发注意事项与架构决策（高频必看）

### 4.1 并发与 Actor 约束
- 一切玩家状态修改必须在 PlayerActor 主线程内完成；禁止在业务中起 goroutine 去改玩家数据。
- DungeonServer 视为单 Actor，AI/战斗/移动都按“每帧遍历实体”思路写。
- 公共全局数据（公会/拍卖/排行榜/离线数据）全部经 PublicActor；不要在其它地方偷偷加全局 map。

### 4.2 时间与数据库
- 时间：所有业务统一使用 `server/internal/servertime`；DB 时间字段统一 Unix 秒，禁止 `time.Time` 乱写。
- 玩家侧只落 `PlayerRoleBinaryData`；全局侧只落专门表（公会、拍卖、离线快照等），两者间用 ID 关联。

### 4.3 协议 / Controller / UseCase 一致性
- C2S/S2C：Controller 统一注册在 `adapter/controller/*_controller_init.go`，禁止在 SystemAdapter 和 entitysystem 里散落注册。
- Controller 只做“解析+权限/系统开关检查+调 UseCase”，所有回包用 Presenter。
- UseCase 不感知 Actor/网络，依赖接口（Repository/Gateway/PresenterAdapter），贯彻依赖倒置。

### 4.4 Game ↔ Dungeon / RPC 约束
- 只通过 `DungeonServerGateway` 调 DungeonServer，禁止直接用 `dungeonserverlink` 到处飞。
- 新 RPC 必须显式标明：调用方/被调用方、是否有超时、失败策略（重试/降级/忽略）。

### 4.5 日志与排障
- 所有关键路径（充值、拍卖、回收、GM、战斗结算）必须带 RoleID/SessionId，统一通过 `pkg/log` + IRequester。
- 不要在业务代码中 `fmt.Println`；出问题时第一步是“查对应模块的日志 + PlayerActor 日志”。

### 4.6 坐标 / 移动 / 寻路
- 服务端业务一律用**格子坐标**（地图/寻路/技能范围/AOI），客户端自行做像素坐标。
- 移动系统只处理移动相关逻辑；AI 系统通过组合调用移动协议来驱动单位移动。
- 地图与出生点必须经过 GameMap 校验；地图缺失仅允许在开发期临时跑。

### 4.7 社交 / PublicActor
- 好友、公会、拍卖、排行榜都基于 “PlayerActor 数据 + PublicActor 全局状态” 模型：
  - PlayerActor 负责“我自己”的社交数据（好友列表、公会 ID 等）。
  - PublicActor 负责“全局视图”（全服公会、全服拍卖、排行榜排名、离线快照）。
- 所有给 PublicActor 的消息通过 `PublicActorGateway` 或 `PlayerRole.sendPublicActorMessage`；禁止直接调底层 `gshare.SendPublicMessageAsync`。

### 4.8 调试客户端与服务对齐
- server/example 是“服务端官方调试端”，协议/时间/日志等约束与正式服务相同（同样用 servertime，同样走 Proto）。
- 新增测试链路优先用 example 客户端串起来，再考虑写脚本或单测。

---

## 5. 关键代码位置（只列入口级）

### 5.1 Gateway
- 接入与转发：`server/service/gateway/internel/clientnet`、`engine`。

### 5.2 GameServer
- PlayerActor & 系统注册：`internel/app/playeractor`、`internel/app/playeractor/entitysystem/sys_mgr.go`。
- 玩家网络入口：`internel/app/playeractor/entity/player_network.go`。
- 公共 Actor：`internel/app/publicactor/*`（消息入口、离线数据、排行榜、公会、拍卖等）。
- Clean Architecture 主干：
  - Controller：`internel/adapter/controller/*`（含 `protocol_router_controller.go`）。
  - SystemAdapter：`internel/adapter/system/*`（玩法/社交/辅助系统生命周期）。
  - UseCase：`internel/usecase/*`。
  - Gateway & Presenter：`internel/adapter/gateway/*`、`internel/adapter/presenter/*`。
- 玩家消息系统：`internel/engine/message_registry.go` + `internel/adapter/system/message_system_adapter.go` + `internel/app/playeractor/entitysystem/message_dispatcher.go`。
- 离线数据：`internel/app/publicactor/offlinedata/*` + `server/internal/database/offline_data.go`。

### 5.3 DungeonServer
- 实体与系统：`internel/entitysystem/*`（移动/战斗/AI/属性/寻路）。
- 场景与地图：`internel/scene`（GameMap/出生点/移动校验）。

### 5.4 通用基础
- Actor 框架：`server/internal/actor`。
- 时间：`server/internal/servertime`。
- 配置：`server/internal/jsonconf`。
- 坐标：`server/internal/argsdef/position.go`。
- 日志：`server/pkg/log`。

### 5.5 调试客户端
- 入口：`server/example/cmd/example`。
- 客户端核心：`server/example/internal/client`。
- 面板与系统：`server/example/internal/panel`、`server/example/internal/systems`。

---

## 6. 其它文档索引（需要细节再看）

- Clean Architecture 总览与实施：
  - `docs/gameserver_CleanArchitecture重构实施手册.md`
  - `docs/gameserver_CleanArchitecture重构文档.md`
  - `docs/dungeonserver_CleanArchitecture重构文档.md`
  - `docs/gameserver_目录与调用关系说明.md`
  - `docs/服务端开发进度文档_full.md`
- 属性系统：
  - `docs/属性系统重构文档.md`
  - `docs/属性系统阶段三联调记录.md`
- 社交与离线：
  - `docs/离线数据管理器开发文档.md`
- 调试客户端：
  - `docs/golang客户端待开发文档.md`
  - `docs/server_example重构方案.md`
- 兼容/清理规划：
  - `docs/gameserver_兼容代码清理规划.md`
  - `docs/SystemAdapter_CodeReview清单.md`
  - `docs/SystemAdapter系统开启检查优化方案.md`


