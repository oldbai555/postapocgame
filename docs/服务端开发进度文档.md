# æ¸¸æˆæœåŠ¡å™¨å¼€å‘è¿›åº¦æ–‡æ¡£ï¼ˆå•ä¸€æƒå¨ç‰ˆæœ¬ï¼‰

æ›´æ–°æ—¶é—´ï¼š2025-11-20  
è´£ä»»äººï¼šä¸ªäººç‹¬ç«‹å¼€å‘  

> âš ï¸ è‡ªæœ¬æ¬¡æ›´æ–°èµ·ï¼ŒåŸ `docs/Phase3ç¤¾äº¤ç»æµæ¶æ„è®¾è®¡æ–¹æ¡ˆ.md` å·²å®Œå…¨æ•´åˆåˆ°æœ¬æ–‡ï¼Œæœªæ¥æ‰€æœ‰å¼€å‘ã€è¯„å®¡ä¸äº¤æ¥å‡ä»¥æœ¬æ–‡ä»¶ä¸ºå”¯ä¸€æƒå¨ä¿¡æ¯æºã€‚è¯·åœ¨æ¯æ¬¡å¼€å‘å‰å®Œæ•´é˜…è¯»ç¬¬ 0 ç« ä¸ç¬¬ 7 ç« ï¼Œå®Œæˆæ–°åŠŸèƒ½ååŒæ­¥"å·²å®ŒæˆåŠŸèƒ½ / å¾…å®ç° / æ³¨æ„äº‹é¡¹ / å…³é”®ä»£ç ä½ç½®"å››ä¸ªç« èŠ‚ã€‚

---

## 0. å¼€å‘å¿…è¯»

- **å…ˆè¯»åå†™**ï¼šä»»ä½•æ–°ä»»åŠ¡å¼€å§‹å‰å¿…é¡»å…ˆé˜…è¯»"æœåŠ¡å™¨æ¶æ„""å¼€å‘æ³¨æ„äº‹é¡¹ä¸æ¶æ„å†³ç­–"ä»¥åŠ"Phase 3 ç¤¾äº¤ç»æµä¸€ä½“åŒ–æ–¹æ¡ˆ"ï¼Œç¡®ä¿éµå¾ª Actor/æ— é”çº¦æŸä¸æ—¢å®šæ•°æ®è§„èŒƒã€‚  
- **æ–‡æ¡£åŒæ­¥è§„åˆ™**ï¼šæ–°åŠŸèƒ½ä¸Šçº¿åï¼Œå°†æ¡ç›®ä¸Šç§»è‡³"å·²å®ŒæˆåŠŸèƒ½"ï¼Œè¡¥å……å®ç°ç»†èŠ‚ï¼Œå¹¶åœ¨"å…³é”®ä»£ç ä½ç½®"ç™»è®°å…¥å£ï¼›è‹¥åŠŸèƒ½ä»éœ€åˆ†é˜¶æ®µæ¨è¿›ï¼Œéœ€åœ¨"å¾…å®ç° / å¾…å®Œå–„åŠŸèƒ½"æ‹†åˆ†å­é¡¹ã€‚  
- **æ¶æ„å†³ç­–è®°å½•**ï¼šä»»ä½•é‡è¦ç»“æ„æˆ–è·¨æ¨¡å—çº¦æŸï¼Œå‡è®°å½•åœ¨ç¬¬ 7 ç« ï¼›è‹¥æ¶‰åŠæµç¨‹æˆ–æ•°æ®æµè½¬å˜æ›´ï¼Œè¯·åŒæ­¥ç»˜åˆ¶åœ¨ç¬¬ 5 ç« ç›¸å…³å­èŠ‚ã€‚  
- **å…³é”®ä»£ç ä½ç‚¹**ï¼šå‘ç°æ–°çš„æ ¸å¿ƒå…¥å£ã€æ˜“è¸©å‘é€»è¾‘ã€éšå«çº¦æŸæ—¶ç«‹å³æ›´æ–°ç¬¬ 8 ç« ï¼Œé¿å…çŸ¥è¯†æ•£è½ã€‚  
- **é˜¶æ®µæ€§éœ€æ±‚æ‹†åˆ†**ï¼šé‡åˆ°å¤§éœ€æ±‚éœ€åˆ†å¤šè¿­ä»£äº¤ä»˜æ—¶ï¼Œå°†å‰©ä½™å·¥ä½œå†™å…¥ç¬¬ 6 ç« å¯¹åº”å°èŠ‚ï¼Œå¹¶æ ‡æ³¨å‰ç½®ä¾èµ–/å®Œæˆæ ‡å‡†ã€‚
- **æ—¶é—´è®¿é—®è§„èŒƒ**ï¼šé™¤ proto/ç¬¬ä¸‰æ–¹åº“å¤–ï¼Œæ‰€æœ‰æœåŠ¡ç«¯ä¸šåŠ¡ä»£ç å¿…é¡»é€šè¿‡ `server/internal/servertime` è·å–æ—¶é—´ï¼›ç¦æ­¢ç›´æ¥è°ƒç”¨ `time.Now()`ã€`time.Since()` ç­‰æ ‡å‡†åº“æ¥å£ï¼Œä»¥ä¿è¯å¤šæœåŠ¡ç»Ÿä¸€æ—¶é—´ä¸å¯é…ç½®åç§»ã€‚

---

## 1. é¡¹ç›®æ¦‚è¿°

- **é¡¹ç›®åç§°**ï¼špostapocgameï¼ˆåå¯ç¤ºå½•æ¨ªç‰ˆåŠ¨ä½œï¼‰  
- **å®¢æˆ·ç«¯**ï¼šGodotï¼ˆè®¡åˆ’ä¸­ï¼‰ï¼Œè¿è¡Œäº Windows / Android / iOS  
- **æœåŠ¡å™¨è¯­è¨€**ï¼šGolang 1.24.10ï¼ˆ`go 1.24` toolchainï¼‰  
- **æœåŠ¡é›†åˆ**ï¼š`gateway`ã€`gameserver`ã€`dungeonserver` å•ä»“ç®¡ç†  
- **æ•°æ®å±‚**ï¼šSQLiteï¼ˆ`server/output/postapocgame.db`ï¼‰+ GORMï¼Œæ‰€æœ‰ç©å®¶æ•°æ®è½äº `PlayerRoleBinaryData`  
- **é…ç½®é©±åŠ¨**ï¼š`server/output/config/*.json` 26+ è¡¨ï¼›éœ€å­˜åœ¨äºè¾“å‡ºç›®å½•æ–¹å¯å¯åŠ¨  
- **ç›®æ ‡éƒ¨ç½²**ï¼šå¼€å‘ä½¿ç”¨ Windowsï¼›çº¿ä¸Šå…¼å®¹ Windows/Linux

---

## 2. æœåŠ¡å™¨æ¶æ„

### 2.1 æœåŠ¡åˆ’åˆ†

| æœåŠ¡            | èŒè´£                                                                 | å…³é”®ç›®å½• |
| --------------- | -------------------------------------------------------------------- | -------- |
| Gateway         | TCP/WS æ¥å…¥ã€Session ç”Ÿå‘½å‘¨æœŸã€æ¶ˆæ¯å‹ç¼©/åˆ†å‘ã€é™æµã€æ—¥å¿—             | `server/service/gateway` |
| GameServer      | ç©å®¶é•¿è¿æ¥é€»è¾‘ï¼ˆä»»åŠ¡ã€æˆé•¿ã€ç»æµã€ç¤¾äº¤ã€å…¬ä¼šã€GMï¼‰ï¼Œä¸€ç©å®¶ä¸€ Actor    | `server/service/gameserver` |
| DungeonServer   | å‰¯æœ¬/æˆ˜æ–—/æ‰è½/æŠ€èƒ½çŠ¶æ€æœºï¼Œå• Actor é©±åŠ¨                              | `server/service/dungeonserver` |
| Shared Packages | Actor æ¡†æ¶ã€äº‹ä»¶ã€ç½‘ç»œç¼–è§£ç ã€Protoã€é…ç½®ã€æ—¥å¿—ã€é”™è¯¯ç               | `server/internal`, `server/pkg`, `proto/` |

### 2.2 æ‹“æ‰‘ä¸é€šä¿¡

```
Client (TCP / WebSocket)
      |
Gateway (SessionManager + ClientHandler)
      | ForwardMessage / SessionEvent
GameServer (per-player Actor + PublicActor)
      | Async RPC (dungeonserverlink / gameserverlink)
DungeonServer (single Actor dungeon runtime)
```

- **ä¼šè¯åˆ†å‘**ï¼šGateway ç»´æŠ¤ Sessionï¼Œæ‰€æœ‰ C2S æ¶ˆæ¯å°è£…ä¸º `ForwardMessage` å¼‚æ­¥è½¬å‘åˆ° GameServerï¼›Session äº‹ä»¶é€šè¿‡ `gameserverlink` å¹¿æ’­ã€‚  
- **Actor è°ƒåº¦**ï¼šGameServer ä½¿ç”¨ `actor.ModePerKey`ï¼ˆkey=SessionIdï¼‰ï¼›`PlayerHandler.Loop()` é€šè¿‡ `actorCtx.ExecuteAsync` æ³¨å…¥ `gshare.DoRunOneMsg`ï¼Œç¡®ä¿æ‰€æœ‰ç³»ç»Ÿ RunOne åœ¨ Actor ä¸»çº¿ç¨‹æ‰§è¡Œã€‚  
- **è·¨æœ RPC**ï¼šGameServer â†” DungeonServer é—´ç»Ÿä¸€ä½¿ç”¨ `dungeonserverlink.AsyncCall` ä¸ `gameserverlink` æ³¨å†Œå›è°ƒï¼Œç¦æ­¢åŒæ­¥é˜»å¡ã€‚  
- **æ•°æ®æŒä¹…åŒ–**ï¼šç©å®¶ç³»ç»Ÿæ•°æ®åºåˆ—åŒ–ä¸º `protocol.PlayerRoleBinaryData`ï¼Œè½åº“å­—æ®µ `Player.BinaryData`ï¼›å…¨å±€æ•°æ®ï¼ˆå…¬ä¼š/æ‹å–è¡Œç­‰ï¼‰å°†ç”± PublicActor é©±åŠ¨æŒä¹…åŒ–ã€‚  
- **å…¬å…± Actor**ï¼šGameServer å†…åŒ…å« `PublicActor`ï¼ˆå• Actorï¼‰ç”¨äºç¤¾äº¤ç»æµå…¨å±€æ•°æ®ã€åœ¨çº¿æ˜ å°„ã€æ’è¡Œæ¦œç­‰é€»è¾‘ã€‚

---

## 3. æ„å»ºä¸è¿è¡Œç°çŠ¶

- **Go ç‰ˆæœ¬**ï¼š`go 1.24.0`ï¼Œtoolchain `1.24.10`ã€‚  
- **æœ€æ–°å¯æ‰§è¡Œæ–‡ä»¶**ï¼š  
  - `go build -o server/output/gameserver.exe ./server/service/gameserver`  
  - `go build -o server/output/dungeonserver.exe ./server/service/dungeonserver`  
  - `gateway.exe` å·²å­˜åœ¨å†å²æ„å»ºäº§ç‰©  
- **é…ç½®**ï¼š`server/output/{gateway,gamesrv,dungeonsrv}.json` + `server/output/config/*.json` å¿…é¡»é½å¤‡ã€‚  
- **æ•°æ®åº“**ï¼š`server/output/postapocgame.db` éš GameServer è‡ªåŠ¨è¿ç§»ï¼Œè¡¨å®šä¹‰ä½äº `server/internal/database/*.go`ã€‚  
- **æ—¥å¿—**ï¼šå„æœåŠ¡é»˜è®¤è¾“å‡ºåˆ° `server/output/log/<service>.log`ï¼ŒåŒæ—¶æ‰“å°è‡³æ§åˆ¶å°ã€‚  
- **å¯åŠ¨é¡ºåºå»ºè®®**ï¼šDungeonServer â†’ GameServer â†’ Gateway â†’ å®¢æˆ·ç«¯ã€‚

---

## 4. å·²å®ŒæˆåŠŸèƒ½

> è‹¥æ–°å¢å­ç³»ç»Ÿæˆ–å®Œæˆé˜¶æ®µæ€§èƒ½åŠ›ï¼Œè¯·åœ¨å¯¹åº”å­èŠ‚è¡¥å……å®ç°ç»†èŠ‚ï¼Œå¹¶æè¿°å…³é”®å…¥å£/æ³¨æ„äº‹é¡¹ã€‚

### 4.1 Gatewayï¼ˆæ¥å…¥å±‚ï¼‰

- åŒåè®®æ¥å…¥ï¼šTCP + WebSocket
- Session ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€æ¶ˆæ¯è½¬å‘ã€é™æµä¸èµ„æºä¿æŠ¤
- å…³é”®ä»£ç ï¼š`server/service/gateway/internel/clientnet`ã€`server/service/gateway/internel/engine`

### 4.2 GameServerï¼ˆç©å®¶ä¸»é€»è¾‘ï¼‰

**è´¦å· / è§’è‰² / Session**
- æ³¨å†Œã€ç™»å½•ã€Token è®¤è¯ï¼ˆbcryptï¼‰
- è§’è‰²åˆ›å»º/åˆ é™¤/æŸ¥è¯¢/è¿›å…¥æ¸¸æˆæµç¨‹ï¼Œè´¦å·æœ€å¤š 3 è§’è‰²
- Session æ‰©å±•ï¼ˆAccountID/Tokenï¼‰

**ç©å®¶ Actor ä¸ç³»ç»Ÿæ¡†æ¶**
- PlayerRoleActorï¼ˆModePerKeyï¼‰ã€EntitySystem åŠ¨æ€æ³¨å†Œ
- BinaryData åŠ è½½/ä¿å­˜ã€äº‹ä»¶æ€»çº¿ã€RunOne å®šæœŸå­˜ç›˜

**ç»Ÿä¸€æ—¶é—´ä¸æœåŠ¡å™¨å¹¿æ’­**
- `server/internal/servertime` ç»Ÿä¸€ UTC æ—¶é—´æº
- `timesync.Broadcaster` æ¯ç§’å¹¿æ’­æœåŠ¡å™¨æ—¶é—´

**æˆé•¿ / ç»æµ / ç©æ³•ç³»ç»Ÿ**
- èƒŒåŒ…ã€è´§å¸ã€è£…å¤‡ã€å±æ€§ã€ç­‰çº§ã€VIPã€ä»»åŠ¡ï¼ˆæ—¥/å‘¨ï¼‰ã€æ´»è·ƒåº¦ã€æˆå°±ã€å•†åŸã€ç‰©å“ä½¿ç”¨ã€å›æ”¶ã€ç¦»çº¿æ”¶ç›Šã€GMã€åä½œå¼Š

**å‰¯æœ¬ä¸é™æ—¶ç©æ³•æ”¯æ’‘**
- âœ… å‰¯æœ¬è¿›å…¥/ç»“ç®—é“¾è·¯ï¼š`FubenSys` è´Ÿè´£ `DungeonData` è¯»å†™ï¼Œæ”¯æŒå‰¯æœ¬è®°å½•æŒ‰å¤©é‡ç½®ã€æ¬¡æ•°é™åˆ¶ä¸è¿›å…¥å†·å´ï¼ˆ`GetDungeonRecord/GetOrCreateDungeonRecord/CheckDungeonCD/EnterDungeon`ï¼‰
- âœ… é™æ—¶å‰¯æœ¬æ ¡éªŒï¼š`handleEnterDungeon` æŒ‰ `DungeonConfig` æ ¡éªŒå‰¯æœ¬å­˜åœ¨æ€§ã€ç±»å‹ï¼ˆé™æ—¶ï¼‰ã€éš¾åº¦ã€æ¯æ—¥è¿›å…¥æ¬¡æ•°ä¸æ¶ˆè€—ç‰©å“ï¼Œå¤±è´¥åœºæ™¯å‡è¿”å›æ˜ç¡®é”™è¯¯ç ä¸æ–‡æ¡ˆ
- âœ… å‰¯æœ¬ç»“ç®—å›å†™ï¼š`handleSettleDungeon` åœ¨å‰¯æœ¬æˆåŠŸåæ›´æ–°è¿›å…¥è®°å½•ï¼Œå¹¶æ ¹æ®å¥–åŠ±ç±»å‹æ‹†åˆ†ä¸ºç»éªŒ/è´§å¸/ç‰©å“ï¼Œç”± `LevelSys/GrantRewards` åˆ†åˆ«è½åˆ°è§’è‰²æ•°æ®ä¸èƒŒåŒ…

**é˜²ä½œå¼Šä¸ GM èƒ½åŠ›**
- âœ… `AntiCheatSys`ï¼šåŸºäº `SiAntiCheatData` ç»´æŠ¤æ“ä½œè®¡æ•°ä¸æ¯æ—¥é‡ç½®ï¼Œæ”¯æŒ 10 ç§’çª—å£ 100 æ¬¡çš„é¢‘ç‡é™åˆ¶ã€å¯ç–‘è®¡æ•°ä¸ 1 å°æ—¶ä¸´æ—¶å°ç¦/æ°¸ä¹…å°ç¦ï¼ˆ`CheckOperationFrequency/RecordSuspiciousBehavior/BanPlayer`ï¼‰
- âœ… `GMSys`ï¼šç©å®¶çº§ GM ç³»ç»Ÿï¼Œæ”¯æŒé€šè¿‡ `C2SGMCommand` åè®®ä¸‹å‘ GM æŒ‡ä»¤ï¼Œç”± `GMManager` æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼›GM æ‰§è¡Œç»“æœé€šè¿‡ `S2CGMCommandResult` å›ä¼ å®¢æˆ·ç«¯
- âœ… ç³»ç»Ÿå¹¿æ’­ä¸ç³»ç»Ÿé‚®ä»¶ï¼š`SendSystemNotification* / SendSystemMail* / SendSystemMailByTemplate* / GrantRewardsByMail` æ”¯æŒå•äºº/å…¨æœå¹¿æ’­ä¸ç³»ç»Ÿé‚®ä»¶å‘æ”¾ï¼Œå¯å¤ç”¨ä¸ºè¿è¥æ´»åŠ¨å·¥å…·

**å‰¯æœ¬åä½œ**
- `FubenSys`ã€`SkillSys`ã€`dungeonserverlink` è´Ÿè´£å‰¯æœ¬è¿›å…¥ã€æŠ€èƒ½åŒæ­¥ã€æ‰è½æ‹¾å–
- âœ… GameServer è‡ªåŠ¨è¯†åˆ«æ— æ³•æœ¬åœ°å¤„ç†çš„ `C2S` åè®®ï¼Œå¹¶å°† `MsgTypeClient` æ¶ˆæ¯é€ä¼ è‡³å¯¹åº” `DungeonServer`ï¼Œç¡®ä¿å®¢æˆ·ç«¯æˆ˜æ–—/ç§»åŠ¨åè®®æ— éœ€é‡å¤æ³¨å†Œ

**Phase 3 ç¤¾äº¤ç»æµç³»ç»Ÿï¼ˆå…¨éƒ¨å®Œæˆï¼‰**
- âœ… **PublicActor æ¡†æ¶**ï¼šå• Actor æ¡†æ¶ã€åœ¨çº¿çŠ¶æ€ç®¡ç†ã€æ¶ˆæ¯è·¯ç”±
- âœ… **èŠå¤©ç³»ç»Ÿ**ï¼šä¸–ç•Œ/ç§èŠã€é¢‘ç‡é™åˆ¶ã€æ•æ„Ÿè¯è¿‡æ»¤ã€ç¦»çº¿æ¶ˆæ¯ï¼ˆæŒä¹…åŒ–ã€æ•°é‡é™åˆ¶ã€è¿‡æœŸæ¸…ç†ï¼‰
- âœ… **å¥½å‹ç³»ç»Ÿ**ï¼šç”³è¯·/åŒæ„/æ‹’ç»ã€åˆ—è¡¨æŸ¥è¯¢ã€åœ¨çº¿çŠ¶æ€è”åŠ¨
- âœ… **æ’è¡Œæ¦œç³»ç»Ÿ**ï¼šæŸ¥è¯¢ã€å¿«ç…§æ³¨å†Œã€æ•°å€¼æ›´æ–°ã€è‡ªåŠ¨åˆ·æ–°ï¼ˆä¸Šçº¿/ç­‰çº§å˜åŒ–ï¼‰
- âœ… **å…¬ä¼šç³»ç»Ÿ**ï¼šåˆ›å»º/è§£æ•£ã€ç”³è¯·åŠ å…¥ã€å®¡æ‰¹æµç¨‹ã€æƒé™ç®¡ç†ï¼ˆä¼šé•¿/å‰¯ä¼šé•¿/ç»„é•¿/æˆå‘˜ï¼‰ã€æ•°æ®æŒä¹…åŒ–
- âœ… **æ‹å–è¡Œç³»ç»Ÿ**ï¼šä¸Šæ¶/è´­ä¹°/æµè§ˆã€è¿‡æœŸå¤„ç†ã€è´§å¸ç»“ç®—ã€ç‰©å“äº¤ä»˜ã€æ•°æ®æŒä¹…åŒ–
- âœ… **ç¤¾äº¤å®‰å…¨ç³»ç»Ÿ**ï¼šé…ç½®åŒ–æ•æ„Ÿè¯åº“ã€äº¤æ˜“å®¡è®¡ã€é»‘åå•æœºåˆ¶
- âœ… **ç¦»çº¿æ•°æ®ç®¡ç†å™¨ï¼ˆRankSnapshot é¦–ç‰ˆï¼‰**ï¼šPublicActor å¼•å…¥ `OfflineDataManager`ï¼ˆ`publicactor/offlinedata`ï¼‰ï¼Œè½åœ° `OfflineData` æ•°æ®è¡¨ã€`UpdateOfflineDataMsg` åè®®ä¸ `PublicActorMsgIdUpdateOfflineData`ï¼Œå®Œæˆç©å®¶ä¸Šçº¿/å®šæ—¶/ä¸‹çº¿çš„ç¦»çº¿å¿«ç…§å†™åº“ã€DB å¯åŠ¨åŠ è½½ä¸ 60s å®šæ—¶ Flushï¼Œ`FriendSys`/æ’è¡Œæ¦œæŸ¥è¯¢å¯ç›´æ¥è¯»å–ç¦»çº¿å¿«ç…§ï¼›è¯¦è§ã€Š`docs/ç¦»çº¿æ•°æ®ç®¡ç†å™¨å¼€å‘æ–‡æ¡£.md`ã€‹
- ğŸ†• **ç©å®¶æ¶ˆæ¯ç³»ç»Ÿï¼ˆé˜¶æ®µä¸€ï¼šæ•°æ®åº“å±‚ï¼‰**ï¼šæ–°å¢ `PlayerActorMessage` è¡¨ï¼ˆæ¶ˆæ¯ç±»å‹+åºåˆ—åŒ–æ•°æ®+æ—¶é—´æˆ³ï¼‰ï¼Œæä¾› `Save/Load/Delete/Count` ç­‰ DAO å°è£…ï¼Œæ”¯æŒæŒ‰ `msgId` å¢é‡åŠ è½½ï¼›è¯¦è§ã€Š`docs/ç©å®¶æ¶ˆæ¯ç³»ç»Ÿå¼€å‘æ–‡æ¡£.md`ã€‹
- ğŸ†• **ç©å®¶æ¶ˆæ¯ç³»ç»Ÿï¼ˆé˜¶æ®µäºŒï¼šå›æ”¾æ¡†æ¶ï¼‰**ï¼šå®ç° `engine/message_registry.go` æ¶ˆæ¯æ³¨å†Œä¸­å¿ƒ + `entitysystem/message_sys.go` ç¦»çº¿æ¶ˆæ¯å›æ”¾ï¼ˆOnInit/ç™»å½•/é‡è¿è‡ªåŠ¨åŠ è½½ã€å›è°ƒæˆåŠŸååˆ åº“ï¼Œå¤±è´¥ä¿ç•™ï¼‰ï¼Œå¹¶åœ¨ `proto/csproto/system.proto` å¢åŠ  `SysMessage`
- ğŸ†• **ç©å®¶æ¶ˆæ¯ç³»ç»Ÿï¼ˆé˜¶æ®µä¸‰ï¼šå‘é€å…¥å£ï¼‰**ï¼šæ–°å¢ `gshare.SendPlayerActorMessage`ï¼ˆåœ¨çº¿ç›´æ¥å‘ Actor æŠ•é€’ï¼Œå¤±è´¥/ç¦»çº¿å›è½å…¥åº“ï¼‰ã€`player_network.handlePlayerMessageMsg`ï¼ˆActor å†…è°ƒåº¦æ¶ˆæ¯å›è°ƒï¼‰ä»¥åŠ `rpc.proto/AddActorMessageMsg`ï¼Œå®Œæˆåœ¨çº¿/ç¦»çº¿ç»Ÿä¸€é“¾è·¯

**å±æ€§ç³»ç»Ÿé˜¶æ®µä¸€ï¼ˆåŸºç¡€ç»“æ„ï¼‰**
- `entitysystem/attr_sys.go` æ”¯æŒ `sysAttr/sysAddRateAttr/sysPowerMap` ç¼“å­˜ã€å·®å¼‚åŒ–é‡ç®—ä¸ `ResetSysAttr` å¯¹å¤–æ¥å£ï¼›`SyncAttrData` è¿½åŠ  `AddRateAttr` å­—æ®µï¼Œä¸‹è¡Œä»…åŒæ­¥å˜æ›´ç³»ç»Ÿï¼Œé™ä½ DungeonServer å‹åŠ›ã€‚

**å±æ€§ç³»ç»Ÿé˜¶æ®µäºŒï¼ˆåŠ æˆä¸æ¨é€ï¼‰**
- `attrcalc/add_rate_bus.go` æä¾›åŠ æˆè®¡ç®—æ³¨å†Œï¼›ç¤ºä¾‹ `level_sys` åŸºäºè§’è‰²ç­‰çº§æ³¨å…¥ HP/MP å›å¤åŠ æˆï¼Œ`AttrSys.calcTotalSysAddRate` è‡ªåŠ¨æ±‡æ€»å¹¶å†™å…¥ `sysAddRateAttr`ã€‚
- `proto/sc.proto` çš„ `S2CAttrDataReq` æºå¸¦ `SyncAttrData+sys_power_map`ï¼›GameServer åœ¨å±æ€§å˜æ›´ã€é¦–æ¬¡ç™»å½•ã€é‡è¿æ—¶é€šè¿‡ `AttrSys.pushAttrDataToClient` æ¨é€å±æ€§å¿«ç…§ã€‚

**æœåŠ¡å™¨å¼€æœä¿¡æ¯**
- `server/internal/database/server_info.go` å­˜å‚¨å¼€æœæ—¶é—´ï¼Œ`gshare.GetOpenSrvDay()` è·å–å¼€æœå¤©æ•°

### 4.3 DungeonServerï¼ˆå‰¯æœ¬ä¸æˆ˜æ–—ï¼‰

- å• Actor ä¸»å¾ªç¯ã€å®ä½“å±‚ï¼ˆè§’è‰²/æ€ªç‰©/æ‰è½/AOIï¼‰
- çŠ¶æ€æœºã€Buffã€AIã€æŠ€èƒ½ã€æˆ˜æ–—ç³»ç»Ÿ
- âœ… **ç§»åŠ¨ç³»ç»Ÿé‡æ„**ï¼šé‡æ–°å®ç°ç§»åŠ¨ç³»ç»Ÿ
  - âœ… **æœåŠ¡ç«¯æ—¶é—´é©±åŠ¨ç§»åŠ¨**ï¼šå®ç° `MovingTime` æ–¹æ³•ï¼Œæ ¹æ®æ—¶é—´è®¡ç®—å½“å‰ä½ç½®ï¼Œæ”¯æŒæœåŠ¡ç«¯é©±åŠ¨ç§»åŠ¨
  - âœ… **å®¢æˆ·ç«¯ä½ç½®æ ¡éªŒ**ï¼šå®ç° `LocationUpdate` æ–¹æ³•ï¼Œæ ¡éªŒå®¢æˆ·ç«¯ä¸ŠæŠ¥çš„ä½ç½®æ˜¯å¦åˆç†ï¼Œé˜²æ­¢ç§»åŠ¨è¿‡å¿«æˆ–ç¬ç§»
  - âœ… **åæ ‡ç³»ç»Ÿç»Ÿä¸€**ï¼šå†…éƒ¨ä½¿ç”¨åƒç´ åæ ‡è¿›è¡Œç²¾ç¡®è®¡ç®—ï¼Œä¸åœºæ™¯ç³»ç»Ÿäº¤äº’æ—¶è½¬æ¢ä¸ºæ ¼å­åæ ‡
  - âœ… **ç§»åŠ¨çŠ¶æ€ç®¡ç†**ï¼šç»´æŠ¤ç§»åŠ¨å¼€å§‹æ—¶é—´ã€èµ·å§‹ä½ç½®ã€ç›®æ ‡ä½ç½®ã€ç§»åŠ¨è·ç¦»ç­‰çŠ¶æ€ä¿¡æ¯
  - âœ… **é€Ÿåº¦å®¹å·®å¤„ç†**ï¼šç»™ä¸å®¢æˆ·ç«¯é€Ÿåº¦1.5å€ä¸200pingçš„å®¹å¿åº¦ï¼Œå…¼å®¹ç½‘ç»œå»¶è¿Ÿå’ŒæœåŠ¡ç«¯å¡é¡¿
  - âœ… **ç§»åŠ¨åè®®æµç¨‹ä¼˜åŒ–**ï¼š
    - âœ… **C2SStartMove å¤„ç†**ï¼šæ”¶åˆ° C2SStartMove æ‰§è¡Œ handleStartï¼Œè®°å½• move_dataï¼ˆåŒ…å«ç›®çš„åœ°ï¼‰ï¼Œå¹¿æ’­ S2CStartMoveï¼ˆæºå¸¦å®ä½“hdlå’Œmove_dataï¼‰
    - âœ… **C2SUpdateMove å¤„ç†**ï¼šæ”¶åˆ° C2SUpdateMove æ‰§è¡Œ handleUpdateï¼Œåˆ¤å®šå®¢æˆ·ç«¯è¦æ›´æ–°çš„åæ ‡å’ŒæœåŠ¡ç«¯è®¡ç®—çš„åæ ‡è¯¯å·®æ˜¯å¦ä¼šå¾ˆå¤§ï¼Œæ”¯æŒæœ‰1sçš„è¯¯å·®ï¼Œå¦‚æœå·®è·å¾ˆå¤§å°±è¦ç»“æŸç§»åŠ¨æ‰§è¡Œ handleEndï¼Œå¹¿æ’­S2CEndMoveï¼Œé€šçŸ¥å®¢æˆ·ç«¯ç»“æŸç§»åŠ¨ï¼Œæœ€ç»ˆåæ ‡ä¸ºä¸Šä¸€ä¸ªç‚¹ï¼›å¦åˆ™å°±æ›´æ–°å®¢æˆ·ç«¯ç»™è¿‡æ¥æœ€æ–°çš„åæ ‡
    - âœ… **C2SEndMove å¤„ç†**ï¼šæ”¶åˆ° C2SEndMove æ‰§è¡Œ handleEndï¼Œå¹¿æ’­S2CEndMoveï¼Œé€šçŸ¥å®¢æˆ·ç«¯ç»“æŸç§»åŠ¨
- âœ… **ç§»åŠ¨ç³»ç»Ÿé‡æ„**ï¼š`MoveSys` ä¸“æ³¨äºç§»åŠ¨åŠŸèƒ½ï¼Œç§»é™¤æ‰€æœ‰AIç›¸å…³ä¸šåŠ¡é€»è¾‘ï¼›AIç³»ç»Ÿé€šè¿‡ç»„åˆè°ƒç”¨ `HandleStartMove` â†’ `HandleUpdateMove` â†’ `HandleEndMove` æ¨¡æ‹Ÿå®¢æˆ·ç«¯ç§»åŠ¨åè®®ï¼Œä¿æŒç§»åŠ¨ç³»ç»Ÿä»£ç ç®€æ´å¹²å‡€
- åœºæ™¯åœ°å›¾åŠ è½½ï¼š`scene_config.json` é€šè¿‡ `mapId` å…³è” `map_config.json`ï¼Œå¯åŠ¨æ—¶è½¬æ¢ä¸º `GameMap`ï¼ˆå®½é«˜ã€é˜»æŒ¡ã€éšæœºå‡ºç”Ÿç‚¹ã€ç§»åŠ¨æ ¡éªŒä¸€è‡´ï¼‰
- å‡ºç”Ÿç‚¹åˆ¤å®šï¼š`scene_config.BornArea` ä½œä¸ºç©å®¶/å®ä½“å‡ºç”ŸèŒƒå›´ï¼Œè¿›å…¥åœºæ™¯æ—¶éšæœºç‚¹ä½éœ€è½åœ¨ `GameMap` å¯è¡Œèµ°åŒºåŸŸï¼Œå¦åˆ™å›é€€åˆ°å…¨å±€éšæœºå¯è¡Œèµ°ç‚¹
- **å¯»è·¯ç³»ç»Ÿ**ï¼šæ”¯æŒ A* ç®—æ³•ï¼ˆç»•éšœç¢ã€è´´å¢™èµ°ï¼‰å’Œç›´çº¿å¯»è·¯ï¼ˆæœ€çŸ­ç›´çº¿ã€é‡éšœç¢è‡ªåŠ¨ç»•è¿‡ï¼‰ï¼Œ`MonsterAIConfig` å¯é…ç½®å·¡é€»/è¿½å‡»æ—¶ä½¿ç”¨çš„å¯»è·¯ç®—æ³•ï¼Œ`MoveSys.MoveToWithPathfinding` æä¾›å¯»è·¯ç§»åŠ¨æ¥å£
- æŠ€èƒ½é‡Šæ”¾æ ¡éªŒï¼ˆ`Effects` ä¸ºç©ºæ—¶è¿”å›é”™è¯¯ï¼‰
- æŠ€èƒ½å¹¿æ’­ï¼ˆé‡Šæ”¾æˆåŠŸ/ä¼¤å®³ç»“æœï¼Œå®¢æˆ·ç«¯é©±åŠ¨åŠ¨ç”»ï¼‰
- **åè®®æ³¨å†Œé‡æ„**ï¼šå‚è€ƒ GameServer çš„åè®®æ³¨å†Œæ–¹å¼ï¼Œå°† DungeonServer çš„åè®®æ³¨å†Œå½’åˆ°å…·ä½“ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼›æŠ€èƒ½åè®®ï¼ˆ`C2SUseSkill`ï¼‰çš„æ³¨å†Œå·²ä» `clientprotocol/skill_handler.go` ç§»è‡³ `entitysystem/fight_sys.go`ï¼Œä½¿ç”¨ `devent.Subscribe(OnSrvStart)` åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶æ³¨å†Œ
- **åæ ‡ç³»ç»Ÿä¼˜åŒ–**ï¼š
  - âœ… ç§»åŠ¨ç³»ç»Ÿï¼šå®¢æˆ·ç«¯å‘é€çš„åƒç´ åæ ‡è‡ªåŠ¨è½¬æ¢ä¸ºæ ¼å­åæ ‡è¿›è¡Œæ ¡éªŒï¼Œè·ç¦»è®¡ç®—å’Œé€Ÿåº¦æ ¡éªŒåŸºäºæ ¼å­å¤§å°
  - âœ… å¯»è·¯ç®—æ³•ï¼šæ˜ç¡®è¾“å…¥è¾“å‡ºä¸ºæ ¼å­åæ ‡ï¼Œè·ç¦»è®¡ç®—ä½¿ç”¨æ ¼å­è·ç¦»ï¼ˆæ›¼å“ˆé¡¿è·ç¦»æˆ–æ¬§å‡ é‡Œå¾—è·ç¦»ï¼‰
  - âœ… åœºæ™¯ç³»ç»Ÿï¼šç»Ÿä¸€ä½¿ç”¨æ ¼å­åæ ‡ï¼Œæ‰€æœ‰ä½ç½®ç›¸å…³å‡½æ•°æ˜ç¡®æ ‡æ³¨åæ ‡ç±»å‹
  - âœ… å®¢æˆ·ç«¯ï¼ˆserver/exampleï¼‰ï¼šç»Ÿä¸€è§„èŒƒä¸ºå‘é€åƒç´ åæ ‡ï¼ŒæœåŠ¡ç«¯è‡ªåŠ¨è½¬æ¢ä¸ºæ ¼å­åæ ‡
  - âœ… åè®®å®šä¹‰ï¼šåœ¨ç§»åŠ¨ã€å®ä½“ã€æŠ€èƒ½ç›¸å…³åè®®ä¸­æ·»åŠ åæ ‡ç±»å‹æ³¨é‡Š
  - âœ… è·ç¦»å’ŒèŒƒå›´è®¡ç®—ï¼šæŠ€èƒ½èŒƒå›´ã€æ”»å‡»èŒƒå›´ç»Ÿä¸€ä½¿ç”¨æ ¼å­è·ç¦»ï¼Œæ·»åŠ è¯¦ç»†æ³¨é‡Š

**å±æ€§ç³»ç»Ÿé˜¶æ®µä¸€ï¼ˆèšåˆåŒæ­¥ï¼‰**
- `entitysystem/attr_sys.go` æä¾› `ApplySyncData/ensureAggregated`ï¼Œå¯ç›´æ¥èšåˆ GameServer ä¸‹å‘çš„ç³»ç»Ÿå±æ€§ä¸ `AddRateAttr`ï¼›`entity/rolest.go` çš„ `UpdateAttrs/initAttrSys` ä»…é€ä¼  `SyncAttrData`ï¼Œç§»é™¤æ—§çš„é€å±æ€§å¢å‡é€»è¾‘ã€‚

**å±æ€§ç³»ç»Ÿé˜¶æ®µå››ï¼ˆDungeonServer æœ¬åœ°å±æ€§è®¡ç®—ä¸ RunOne æœºåˆ¶ï¼‰**
- âœ… **å±æ€§è®¡ç®—å™¨æ³¨å†Œç®¡ç†å™¨**ï¼š`entitysystem/attrcalc/bus.go` æä¾› `RegIncAttrCalcFn/RegDecAttrCalcFn` å’Œ `GetIncAttrCalcFn/GetDecAttrCalcFn`ï¼Œæ”¯æŒæ³¨å†Œæ€ªç‰©åŸºç¡€å±æ€§è®¡ç®—å™¨ï¼ˆ`MonsterBaseProperty`ï¼‰ã€Buff å±æ€§è®¡ç®—å™¨ï¼ˆ`SaBuff`ï¼‰ç­‰
- âœ… **ResetSysAttr æ–¹æ³•**ï¼š`AttrSys.ResetSysAttr` é€šè¿‡æ³¨å†Œç®¡ç†å™¨è§¦å‘å±æ€§é‡ç®—ï¼Œæ”¯æŒå¢é‡å’Œå‡é‡å±æ€§è®¡ç®—
- âœ… **RunOne æœºåˆ¶**ï¼š`AttrSys.RunOne` æ¯å¸§è°ƒç”¨ `ResetProperty` å’Œ `CheckAndSyncProp`ï¼Œåœ¨ `BaseEntity.RunOne` ä¸­ç»Ÿä¸€è°ƒç”¨
- âœ… **éæˆ˜æ–—å±æ€§å˜åŒ–è·Ÿè¸ª**ï¼šä½¿ç”¨ `extraUpdateMask`ï¼ˆmapï¼‰è·Ÿè¸ªéæˆ˜æ–—å±æ€§å˜åŒ–ï¼Œ`CheckAndSyncProp` æ£€æŸ¥å¹¶åŒæ­¥å˜åŒ–
- âœ… **åˆå§‹åŒ–å®Œæˆæ ‡å¿—**ï¼š`bInitFinish` æ ‡å¿—æ§åˆ¶æ˜¯å¦å¹¿æ’­å±æ€§ï¼ˆåˆå§‹åŒ–å®Œæˆå‰ä¸å¹¿æ’­ï¼‰ï¼Œ`SetInitFinish` æ–¹æ³•æ ‡è®°åˆå§‹åŒ–å®Œæˆ
- âœ… **å®ä½“å±æ€§é‡ç½®**ï¼š`MonsterEntity.ResetProperty` å…ˆè°ƒç”¨ `ResetSysAttr` è®¡ç®—åŸºç¡€å±æ€§ï¼Œå†è°ƒç”¨ `AttrSys.ResetProperty` è§¦å‘å®Œæ•´æµç¨‹

### 4.4 å…±äº«åŸºç¡€èƒ½åŠ›

- Actor æ¡†æ¶ï¼ˆModeSingle / ModePerKeyï¼‰
- ç½‘ç»œç¼–è§£ç ã€å‹ç¼©ã€è¿æ¥æ± 
- ç»Ÿä¸€æ—¶é—´æºï¼ˆservertimeï¼‰
- äº‹ä»¶æ€»çº¿ï¼ˆgeventï¼‰
- Proto ä½“ç³»
- æ—¥å¿—ã€é”™è¯¯ç ã€å·¥å…·å‡½æ•°
- **æ—¥å¿—ä¸Šä¸‹æ–‡è¯·æ±‚å™¨**ï¼š`server/pkg/log` æ–°å¢ `IRequester` æ¥å£åŠ `NewRequester/WithRequester` ç³»åˆ—å…¨å±€å‡½æ•°ï¼Œå¯åœ¨è°ƒç”¨ä¾§å£°æ˜å‰ç¼€ä¸æ ˆæ·±ï¼Œ`gshare`/`player_network` çš„ä¸Šä¸‹æ–‡æ—¥å¿—å·²å…¨éƒ¨æ”¹ä¸ºé€šè¿‡è¯·æ±‚å™¨æ³¨å…¥ `session/role` ä¿¡æ¯ï¼Œå †æ ˆå®šä½æŒ‡å‘çœŸå®ä¸šåŠ¡è°ƒç”¨è€…
- **åæ ‡ç³»ç»Ÿå®šä¹‰ä¸è½¬æ¢**ï¼šåœ¨ `server/internal/argsdef/position.go` ä¸­å®šä¹‰äº†æ ¼å­å¤§å°å¸¸é‡ï¼ˆTileSize=128ã€TileCenterOffset=64ï¼‰å’Œåæ ‡è½¬æ¢å‡½æ•°ï¼ˆæ ¼å­åæ ‡â†”åƒç´ åæ ‡ï¼‰ï¼Œç»Ÿä¸€äº†åæ ‡ç³»ç»Ÿçš„å®šä¹‰å’Œä½¿ç”¨è§„èŒƒ

### 4.5 è°ƒè¯•å®¢æˆ·ç«¯ï¼ˆGolang æ–‡å­—å†’é™©é¢æ¿ï¼‰

- æ–°å¢ `server/example` æ–‡æœ¬å†’é™©å¼è°ƒè¯•å®¢æˆ·ç«¯ï¼Œé»˜è®¤è‡ªåŠ¨è¿æ¥ Gatewayï¼Œæä¾› `register/login/roles/create-role/enter/status/look/move/attack` ç­‰å‘½ä»¤ï¼Œå®Œæ•´è¦†ç›–è´¦å·â†’è§’è‰²â†’è¿›åœºæ™¯â†’æˆ˜æ–—é“¾è·¯
- åŸºäº `AdventurePanel` + `GameClient` + Actor ç®¡ç†å™¨å®ç°ï¼Œæ‰€æœ‰å‘½ä»¤å‡ç›´æ¥æ˜ å°„åˆ°ç°æœ‰åè®®ï¼Œä¾¿äºå½•åˆ¶/å›æ”¾
- `docs/golangå®¢æˆ·ç«¯å¾…å¼€å‘æ–‡æ¡£.md` è®°å½•åç»­æ‰©å±•è®¡åˆ’ä¸å‘½ä»¤æ˜ å°„ï¼Œæ˜¯è°ƒè¯•å®¢æˆ·ç«¯çš„å”¯ä¸€è§„åˆ’æ–‡æ¡£
- äº¤äº’å±‚é‡‡ç”¨â€œæ ‡é¢˜åŒº + æ—¥å¿—åŒº + å‘½ä»¤åŒºâ€ä¸‰æ®µå¼å¸ƒå±€ï¼Œæ”¯æŒæ•°å­—/å¿«æ·é”®èœå•æ“ä½œï¼Œè´´åˆå¤æ—©æ–‡å­—å†’é™©ä½“éªŒ
- âœ… `move` å‘½ä»¤å‰ä¼šåŠ è½½ `map_config` â†’ `GameMap`ï¼Œè‡ªåŠ¨è£å‰ªå¹¶æ ¡éªŒåæ ‡ï¼Œé¿å…å‘æœåŠ¡å™¨å‘é€è¶Šç•Œ/ä¸å¯è¡Œèµ°çš„ç§»åŠ¨è¯·æ±‚
- âœ… `move` å‘½ä»¤å‘é€é“¾è·¯å·²å¯¹é½æ­£å¼å®¢æˆ·ç«¯ï¼šæŒ‰ `C2SStartMove â†’ C2SUpdateMoveï¼ˆé€æ ¼ï¼‰â†’ C2SEndMove` é¡ºåºé€æ­¥ä¸ŠæŠ¥åƒç´ åæ ‡ï¼ŒæœåŠ¡ç«¯ç§»åŠ¨ç³»ç»Ÿå¯ç¨³å®šå¤ç°å®¢æˆ·ç«¯è¡Œä¸º
- ğŸ†• æ–°å¢ã€Š`docs/server_exampleé‡æ„æ–¹æ¡ˆ.md`ã€‹ï¼Œå®šä¹‰ä¸ `server/service` åŒæ„çš„å®¢æˆ·ç«¯ç›®å½•ã€è„šæœ¬åŒ–å›è°ƒä¸ä¸šåŠ¡æ‰©å±•é˜¶æ®µç›®æ ‡
- ğŸ†• **Phase A æ¶æ„å¯¹é½å®Œæˆ**ï¼š`server/example` é‡‡ç”¨ `cmd/example + internal/{client,panel,systems}` ç»“æ„ï¼›`GameClient` æ‹†åˆ†ä¸º `client.Core` + `systems` å››å­ç³»ç»Ÿï¼ˆAccount/Scene/Move/Combatï¼‰ï¼›`AdventurePanel` èœå•ä¸å‘½ä»¤å®ç°è¿ç§»è‡³ `panel/actions.go`ï¼›åè®®ç­‰å¾…é€šé“ç»Ÿä¸€ç”± `internal/client/flow.go` ç®¡ç†
- ğŸ†• **Phase B MoveRunner**ï¼š`internal/client/move_runner.go` + `systems.Move` æ”¯æŒç›´çº¿ä¼˜å…ˆ+A* å¯»è·¯ã€é€Ÿåº¦å®¹é”™ã€è‡ªåŠ¨é‡è¯•ä¸å›è°ƒï¼›é¢æ¿æä¾› `move-to/move-resume`ã€è„šæœ¬å¯å¤ç”¨åŒä¸€é“¾è·¯
- ğŸ†• **Phase C èƒŒåŒ…/å‰¯æœ¬/GM/è„šæœ¬**ï¼š`systems.Inventory/Dungeon/GM/Script` å°è£…èƒŒåŒ…ã€GMã€å‰¯æœ¬ä¸ Demo è„šæœ¬ï¼›CLI æ–°å¢ `bag/use-item/pickup/gm/enter-dungeon/script-record/script-run` æŒ‡ä»¤ï¼Œæ”¯æŒå½•åˆ¶/å›æ”¾

---

## 5. Phase 3 ç¤¾äº¤ç»æµæ¶æ„è®¾è®¡

### 5.1 æ¶æ„åŸåˆ™

**PublicActor èŒè´£**
1. å…¨å±€æ•°æ®ç®¡ç†ï¼šå…¬ä¼šã€æ‹å–è¡Œã€æ’è¡Œæ¦œç­‰æƒå¨æ•°æ®
2. è·¨ç©å®¶æ¶ˆæ¯è·¯ç”±ï¼šèŠå¤©ã€å¥½å‹è¯·æ±‚ã€å…¬ä¼šå®¡æ‰¹ç­‰
3. åœ¨çº¿çŠ¶æ€ç®¡ç†ï¼š`roleId â†’ SessionId` æ˜ å°„
4. å¿«ç…§ç¼“å­˜ï¼šè§’è‰²å±•ç¤ºã€æ’è¡Œæ¦œå±•ç¤ºæ•°æ®
5. æ•°æ®æŒä¹…åŒ–ï¼šå…¬ä¼šä¸æ‹å–è¡Œå¿…é¡»è½åº“ï¼ˆç‹¬ç«‹è¡¨ï¼‰

**PlayerActor èŒè´£**
1. ç®¡ç†è‡ªèº«æ•°æ®ï¼šå¥½å‹ã€å…¬ä¼šå½’å±ã€æ‹å–ä¸Šæ¶è®°å½•å‡å­˜äº `PlayerRoleBinaryData`
2. EntitySystem æ‰¿è½½ä¸šåŠ¡ï¼š`FriendSys`ã€`GuildSys`ã€`AuctionSys` å‡åœ¨ `entitysystem` ç›®å½•å®ç°
3. æ•°æ®æ›´æ–° â†’ ä¸»åŠ¨é€šçŸ¥ PublicActorï¼ˆæ’è¡Œæ¦œæ•°å€¼ã€å¿«ç…§ã€åœ¨çº¿çŠ¶æ€ï¼‰
4. å®¢æˆ·ç«¯åè®®å…¥å£ï¼šæ¥å…¥è¯·æ±‚ã€åšåˆæ³•æ€§æ ¡éªŒã€è½¬å‘/å›è°ƒ PublicActor

**åä½œæ¨¡å¼**
```
å®¢æˆ·ç«¯
  â†“
PlayerActorï¼ˆæ ¡éªŒ + é˜²åˆ·ï¼‰
  â†“
PublicActorï¼ˆå…¨å±€é€»è¾‘ / æ•°æ®æŒä¹…åŒ–ï¼‰
  â†“
PlayerActorï¼ˆé€šçŸ¥/å›å†™ï¼‰
  â†“
å®¢æˆ·ç«¯
```

### 5.2 Proto ä¸æ•°æ®å®šä¹‰

> ä¿®æ”¹ Proto ååŠ¡å¿…è¿è¡Œ `proto/genproto.sh && gofmt`.

- `proto/csproto/social_def.proto`ï¼šChatTypeã€ChatMessageã€RankTypeã€RankDataã€PlayerRankSnapshotã€GuildPositionã€GuildMemberã€GuildDataã€AuctionItem
- `proto/csproto/system.proto`ï¼šSiFriendDataã€SiGuildDataã€SiAuctionData
- `proto/csproto/player.proto`ï¼šPlayerRoleBinaryData æ–°å¢ç¤¾äº¤å­—æ®µ
- `proto/csproto/rpc.proto`ï¼šPublicActor â†” PlayerActor å†…éƒ¨æ¶ˆæ¯å®šä¹‰

è¯¦ç»†å®šä¹‰è§ä»£ç ï¼Œæ­¤å¤„ä¸å†é‡å¤ã€‚

### 5.3 EntitySystem å®ç°æ¨¡å¼

æ‰€æœ‰ç¤¾äº¤ç³»ç»Ÿä¸ BinaryData ç›´æ¥å…±äº«å†…å­˜å¼•ç”¨ï¼Œç¦æ­¢å¤åˆ¶ï¼›ä¿®æ”¹å³æŒä¹…åŒ–ã€‚ç³»ç»Ÿéœ€åœ¨ `entitysystem.RegisterSystemFactory` æ³¨å†Œï¼ŒID æ”¾å…¥ `protocol.SystemId`ã€‚

### 5.4 PublicActor æŒä¹…åŒ–ç­–ç•¥

- **å…¬ä¼š**ï¼š`database.Guild` è¡¨ï¼Œå˜æ›´æ—¶ç«‹å³æŒä¹…åŒ–
- **æ‹å–è¡Œ**ï¼š`database.AuctionItem` è¡¨ï¼Œå®šæœŸè¿‡æœŸæ£€æµ‹
- **æ•°æ®æ¢å¤**ï¼šGameServer å¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰å…¬ä¼š/æ‹å–æ•°æ®åˆ° PublicActor
- **æ—¥å¿—å¯¹é½**ï¼šé‡è¦äº‹ä»¶éœ€å†™ `pkg/log` å¹¶å¯é€‰è½åœ°åˆ°å®¡è®¡è¡¨

---

## 6. å¾…å®ç° / å¾…å®Œå–„åŠŸèƒ½

> å®Œæˆåè¯·åŠæ—¶ä¸Šç§»è‡³ç¬¬ 4 ç« ï¼Œå¹¶æè¿°å®ç°ç»†èŠ‚ã€‚

### 6.1 Phase 2 æ ¸å¿ƒç©æ³•ï¼ˆè¿›è¡Œä¸­ï¼‰

1. **æˆ˜æ–—å½•åƒ**ï¼šå½•åˆ¶/å›æ”¾/å­˜å‚¨é“¾è·¯
2. **å¤šäººå‰¯æœ¬åŒ¹é…/æ’é˜Ÿ**ï¼šåŒ¹é…ç®—æ³• + æ’é˜Ÿç­–ç•¥
3. **Boss ç‰¹æ®Šæœºåˆ¶**ï¼šé˜¶æ®µæŠ€èƒ½ã€æ‰è½è¡¨
4. **é˜²ä½œå¼Šé“¾è·¯å®Œå–„**ï¼šåè®®çº§é¢‘ç‡æ£€æµ‹ã€ç§»åŠ¨æµ‹é€Ÿã€ä¼¤å®³/CD æ ¡éªŒ
5. **æ•°æ®ç»Ÿè®¡ä¸åˆ†æ**ï¼šå…³é”®äº‹ä»¶æ‰“ç‚¹ã€æ€§èƒ½ç›‘æ§ã€è¡Œä¸ºåˆ†æ
6. **æŠ€èƒ½é…ç½®å·¡æ£€**ï¼šå¯¹ `skillCfg.Effects` ä¸ºç©ºçš„æŠ€èƒ½è¡¥é½é…ç½®ï¼Œé¿å…è¿è¡ŒæœŸè¢«åˆ¤å®šä¸ºé‡Šæ”¾å¤±è´¥
7. **åœ°å›¾ç”Ÿäº§å·¥å…·**ï¼š`map_config` å¯è§†åŒ–ç¼–è¾‘ã€è¡Œåˆ—ä¸ `scene_config` æ ¡éªŒã€é˜»æŒ¡å¯è§†åŒ–å¯¼å‡º
8. **å±æ€§ç³»ç»Ÿé‡æ„**ï¼ˆè¿›è¡Œä¸­ï¼Œé«˜ä¼˜å…ˆçº§ï¼‰ï¼šå‚è€ƒ `server/server` å®ç°ï¼Œåˆ†é˜¶æ®µå®Œæˆ `server/service` ä¸­ GameServer ä¸ DungeonServer çš„å±æ€§ç³»ç»Ÿ
   - âœ… é˜¶æ®µä¸€ï¼ˆåŸºç¡€ç»“æ„ï¼‰ï¼šGameServer `entitysystem/attr_sys.go` æ”¯æŒç³»ç»Ÿçº§ç¼“å­˜ã€å·®å¼‚åŒ–åŒæ­¥ä¸ `AddRateAttr` æ‰©å±•ï¼›DungeonServer `entitysystem/attr_sys.go` / `entity/rolest.go` å¯ç›´æ¥èšåˆ `SyncAttrData`
   - âœ… é˜¶æ®µäºŒï¼ˆåŠ æˆä¸æ¨é€ï¼‰ï¼š`attrcalc/add_rate_bus.go` æä¾›åŠ æˆè®¡ç®—æ³¨å†Œï¼Œ`level_sys` å®ç°ç¤ºä¾‹åŠ æˆï¼›`S2CAttrDataReq` æºå¸¦ `SyncAttrData + sys_power_map`ï¼ŒGameServer åœ¨å˜æ›´/ç™»å½•/é‡è¿æ—¶æ¨é€å±æ€§
   - âœ… é˜¶æ®µä¸‰ï¼ˆæˆ˜åŠ›ä¸å¹¿æ’­ï¼‰ï¼šDungeonServer `AttrSys` ä½¿ç”¨å…±äº« `AttrSet` + `ResetProperty`ï¼Œåœ¨åº”ç”¨ `attr_config.json.formula`ï¼ˆè½¬æ¢/ç™¾åˆ†æ¯”ï¼‰åå‘å®¢æˆ·ç«¯ä¸ GameServer (`D2GSyncAttrs`) åŒå‘å¹¿æ’­ï¼›GameServer å¤ç”¨ `attrpower` æˆ˜åŠ›è®¡ç®—ã€`attrpush` æ¨é€é…ç½®ä¸ç»Ÿä¸€çš„å±æ€§/åŠ æˆè®¡ç®—å™¨æ¥å£
   - âœ… **é˜¶æ®µå››ï¼ˆDungeonServer æœ¬åœ°å±æ€§è®¡ç®—ï¼‰**ï¼šä¸º DungeonServer åˆ›å»ºå±æ€§è®¡ç®—å™¨æ³¨å†Œç®¡ç†å™¨ï¼ˆ`server/service/dungeonserver/internel/entitysystem/attrcalc/bus.go`ï¼‰ï¼Œå®ç° `ResetSysAttr` æ–¹æ³•ï¼Œæ”¯æŒæ€ªç‰©åŸºç¡€å±æ€§è®¡ç®—å™¨ï¼ˆ`MonsterBaseProperty`ï¼‰ã€Buff ç³»ç»Ÿå±æ€§è®¡ç®—å™¨ï¼ˆ`SaBuff`ï¼‰ï¼›å±æ€§æ±‡æ€»é€»è¾‘ï¼š`GameServerå±æ€§ + Buffå±æ€§ + å…¶ä»–æˆ˜æ–—æœç³»ç»Ÿå±æ€§`ï¼›åœ¨ `proto/csproto/attr_def.proto` ä¸­æ·»åŠ  `SaBuff` å’Œ `MonsterBaseProperty` ç³»ç»ŸIDï¼›è¯¦è§ã€Š`docs/å±æ€§ç³»ç»Ÿé‡æ„æ–‡æ¡£.md`ã€‹ç¬¬ 8 ç« 
8. **åæ ‡ç³»ç»Ÿä¼˜åŒ–**ï¼ˆåŸºæœ¬å®Œæˆï¼‰ï¼š
   - âœ… **åæ ‡ç³»ç»Ÿå®šä¹‰ä¸è½¬æ¢**ï¼šå·²å®Œæˆæ ¼å­å¤§å°å¸¸é‡å®šä¹‰å’Œåæ ‡è½¬æ¢å‡½æ•°ï¼ˆ`TileCoordToPixel`ã€`PixelCoordToTile`ã€`IsSameTile`ï¼‰ï¼Œè¯¦è§ `server/internal/argsdef/position.go`
   - âœ… **ç§»åŠ¨ç³»ç»Ÿä¼˜åŒ–**ï¼šå·²å®Œæˆå®¢æˆ·ç«¯åƒç´ åæ ‡åˆ°æ ¼å­åæ ‡çš„è½¬æ¢ï¼Œè·ç¦»è®¡ç®—å’Œé€Ÿåº¦æ ¡éªŒåŸºäºæ ¼å­å¤§å°ï¼Œå®¹å·®è°ƒæ•´ä¸ºæ ¼å­è·ç¦»ï¼ˆè¯¦è§ `server/service/dungeonserver/internel/entitysystem/move_sys.go`ï¼‰
   - âœ… **å¯»è·¯ç®—æ³•ä¼˜åŒ–**ï¼šå·²ç¡®ä¿å¯»è·¯ç®—æ³•è¾“å…¥è¾“å‡ºæ˜ç¡®ä¸ºæ ¼å­åæ ‡ï¼Œè·ç¦»è®¡ç®—ä½¿ç”¨æ ¼å­è·ç¦»ï¼Œæ·»åŠ äº†è¯¦ç»†æ³¨é‡Šï¼ˆè¯¦è§ `server/service/dungeonserver/internel/entitysystem/pathfinding.go`ï¼‰
   - âœ… **åœºæ™¯ç³»ç»Ÿä¼˜åŒ–**ï¼šå·²ç¡®è®¤åœºæ™¯ç³»ç»Ÿç»Ÿä¸€ä½¿ç”¨æ ¼å­åæ ‡ï¼Œæ‰€æœ‰ä½ç½®ç›¸å…³å‡½æ•°æ˜ç¡®æ ‡æ³¨åæ ‡ç±»å‹ï¼ˆè¯¦è§ `server/service/dungeonserver/internel/scene/scenest.go`ï¼‰
   - âœ… **å®¢æˆ·ç«¯ä¼˜åŒ–**ï¼šè°ƒè¯•å®¢æˆ·ç«¯å·²æ˜ç¡®åæ ‡ç±»å‹ï¼Œæ·»åŠ è¯¦ç»†æ³¨é‡Šè¯´æ˜åæ ‡ç³»ç»Ÿï¼ˆè¯¦è§ `server/example/game_client.go`ï¼‰
   - âœ… **åè®®å®šä¹‰æ£€æŸ¥**ï¼šå·²åœ¨ç§»åŠ¨ã€å®ä½“ã€æŠ€èƒ½ç›¸å…³åè®®ä¸­æ·»åŠ åæ ‡ç±»å‹æ³¨é‡Šï¼ˆè¯¦è§ `proto/csproto/cs.proto`ã€`proto/csproto/sc.proto`ã€`proto/csproto/base.proto`ï¼‰
   - âœ… **è·ç¦»å’ŒèŒƒå›´è®¡ç®—**ï¼šæŠ€èƒ½èŒƒå›´ã€æ”»å‡»èŒƒå›´å·²ç»Ÿä¸€ä½¿ç”¨æ ¼å­è·ç¦»ï¼Œæ·»åŠ äº†è¯¦ç»†æ³¨é‡Šï¼ˆè¯¦è§ `server/service/dungeonserver/internel/skill/skill.go`ï¼‰
   - â³ **é…ç½®å’Œå¸¸é‡ä¼˜åŒ–**ï¼šå½“å‰æ ¼å­å¤§å°ç¡¬ç¼–ç ä¸º128ï¼Œæœªæ¥å¯è€ƒè™‘é…ç½®åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼Œè¯¦è§ `docs/åæ ‡ç³»ç»Ÿä¼˜åŒ–å»ºè®®.md` ç¬¬8ç‚¹ï¼‰
9. **æ—¥å¿—ä¸Šä¸‹æ–‡è¯·æ±‚å™¨æ¨å¹¿**ï¼ˆæ–°ï¼‰ï¼š`server/pkg/log` ä¸ `gshare` å·²æ”¯æŒ `IRequester` æ³¨å…¥ Session/Role å‰ç¼€ï¼Œåç»­éœ€åœ¨ Gateway/DungeonServer/å·¥å…·è„šæœ¬ç­‰è·¯å¾„æ›¿æ¢æ—§çš„ `GetSkipCall+å­—ç¬¦ä¸²æ‹¼æ¥` åšæ³•ï¼Œç¡®ä¿è·¨æ¨¡å—æ—¥å¿—èƒ½å®šä½çœŸå®è°ƒç”¨è€…

10. **GM æƒé™ä¸å®¡è®¡ä½“ç³»**ï¼ˆæ–°ï¼Œé«˜ä¼˜å…ˆçº§ï¼‰  
   - ç›®å‰ `GMSys` é€šè¿‡ `C2SGMCommand` åè®®ç›´æ¥å¯¹æ¥ `GMManager`ï¼Œå°šæœªåœ¨åè®®å…¥å£ç»Ÿä¸€åš GM è´¦å·æƒé™æ ¡éªŒï¼ˆè´¦å·æ ‡è®°/IP ç™½åå•/ç­¾åä»¤ç‰Œï¼‰ä¸è°ƒç”¨é¢‘ç‡é™åˆ¶  
   - éœ€è¦ä¸º GM æŒ‡ä»¤æ¥å…¥ç»Ÿä¸€çš„æƒé™æ¨¡å‹ï¼ˆè´¦å·ç­‰çº§/è§’è‰²æ ‡ç­¾ï¼‰ã€å®¡è®¡æ—¥å¿—ï¼ˆåŒ…å«æ“ä½œè€…è´¦å·/è§’è‰²/IP/æŒ‡ä»¤/å‚æ•°/ç›®æ ‡ï¼‰ä¸å¯é…ç½®çš„ IP/ç¯å¢ƒç™½åå•ï¼Œé˜²æ­¢çº¿ä¸Šè¯¯æ“ä½œæˆ–è¢«æ¶æ„åˆ©ç”¨  
   - å»ºè®®å°† GM ç›¸å…³æ“ä½œçº³å…¥ç‹¬ç«‹å®¡è®¡é€šé“ï¼ˆåº“è¡¨æˆ–ç»“æ„åŒ–æ—¥å¿—ï¼‰ï¼Œä¾¿äºåç»­é—®é¢˜è¿½è¸ª

11. **ç½‘å…³ / å‰¯æœ¬æ¥å…¥å®‰å…¨åŠ å›º**ï¼ˆæ–°ï¼Œé«˜ä¼˜å…ˆçº§ï¼‰  
   - Gateway WebSocket å½“å‰é…ç½® `AllowedIPs=nil` ä¸” `CheckOrigin=func() bool { return true }`ï¼Œä»…é€‚åˆå¼€å‘ç¯å¢ƒï¼›ç”Ÿäº§éœ€å¯ç”¨ IP ç™½åå•ã€Origin æ ¡éªŒä¸æ¡æ‰‹é˜¶æ®µçš„ç­¾å/Token æ ¡éªŒ  
   - DungeonServer åªåš TCP åœ°å€åˆæ³•æ€§æ ¡éªŒï¼Œå°šæœªå¯¹ä¸Šæ¸¸ GameServer åœ°å€/è¯ä¹¦åšå¼ºæ ¡éªŒï¼›åç»­éœ€ç»“åˆ TLS ä¸åŒå‘è®¤è¯ç¡®ä¿åªæ¥å—å¯ä¿¡æ¥æº  
   - ä»¥ä¸Šæ¥å…¥é˜²æŠ¤åº”ä¸ 7.4 ä¸­çš„ TLS/é‰´æƒè¦æ±‚ä¸€å¹¶è½åœ°ï¼Œå¹¶åœ¨é…ç½®ä¸­æä¾›ç°åº¦/å¼€å…³èƒ½åŠ›

12. **ç©å®¶æ¶ˆæ¯ç³»ç»Ÿï¼ˆè¿›è¡Œä¸­ï¼‰**
   - âœ… é˜¶æ®µä¸€ï¼šæ•°æ®åº“è¡¨ `PlayerActorMessage` ä¸ DAO æ¥å£  
   - âœ… é˜¶æ®µäºŒï¼šæ¶ˆæ¯å›è°ƒæ³¨å†Œä¸­å¿ƒ + MessageSys ç³»ç»ŸåŠ è½½/å›æ”¾  
   - âœ… é˜¶æ®µä¸‰ï¼šæ¶ˆæ¯å‘é€æ¥å£ã€PlayerActor å…¥å£ä¸ Proto æ‰©å±•  
   - â³ é˜¶æ®µå››ï¼šæ§åˆ¶å°/ç›‘æ§ä¸è¿‡æœŸæ¸…ç†ç­–ç•¥

### 6.2 Phase 4 PvPï¼ˆå¾…è§„åˆ’ï¼‰

1. **ç«æŠ€åœºç³»ç»Ÿ**ï¼šåŒ¹é…ã€æˆ˜æ–—ã€ç§¯åˆ†ä¸å¥–åŠ±
2. **å®æ—¶é…å¯¹ç³»ç»Ÿ**ï¼šELO/MMR ç®—æ³•ã€æ–­çº¿å¤„ç†
3. **è¯„åˆ†ç³»ç»Ÿ**ï¼šç§¯åˆ†è®¡ç®—ã€æ’åè°ƒæ•´ã€èµ›å­£é‡ç½®

### 6.3 Golang æ–‡å­—å†’é™©é¢æ¿ï¼ˆå¾…å®Œå–„ï¼‰

1. âœ… **GCLI-1 èƒŒåŒ…/ç‰©å“æŒ‡ä»¤**ï¼š`bag/use-item/pickup` å‘½ä»¤å·²æ¥å…¥ `C2SOpenBag/C2SUseItem/C2SPickupItem`
2. **GCLI-2 å…»æˆ/ä»»åŠ¡é¢æ¿**ï¼šç­‰çº§/å±æ€§/ä»»åŠ¡/æ´»è·ƒåº¦ç­‰ä¿¡æ¯å±•ç¤ºä¸å¸¸ç”¨äº¤äº’
3. **GCLI-3 æˆ˜æ–—è„šæœ¬åŒ–**ï¼šå½•åˆ¶/å›æ”¾å·¡é€»ä¸æŠ€èƒ½å¾ªç¯ï¼Œè¾“å‡ºå‘½ä¸­/ä¼¤å®³ç»Ÿè®¡
4. âœ… **GCLI-4 å‰¯æœ¬/åŒ¹é…æµç¨‹**ï¼šæä¾› `enter-dungeon <id> [difficulty]` å‘½ä»¤å¿«é€Ÿè”è°ƒå‰¯æœ¬
5. âœ… **GCLI-5 GM/è°ƒè¯•å‘½ä»¤æ¡¥æ¥**ï¼š`gm <name> [args...]` å‘½ä»¤æ¥å…¥ GM åè®®ï¼Œå¯ç”¨äºæ‰¹é‡è„šæœ¬
6. âœ… **GCLI-6 åè®®å½•åˆ¶å›æ”¾**ï¼šæ–°å¢ `script-record/script-run`ï¼Œæ”¯æŒå‘½ä»¤å½•åˆ¶ä¸å›æ”¾
7. **GCLI-7 å¤š Session æ”¯æŒ**ï¼šå•é¢æ¿ç®¡ç†å¤šå®¢æˆ·ç«¯ï¼ˆæœºå™¨äººï¼‰ï¼ŒéªŒè¯ç¤¾äº¤/æˆ˜æ–—
8. âœ… **GCLI-9 ç§»åŠ¨é“¾è·¯å¢å¼º**ï¼š`MoveRunner` + `move-to/move-resume` æŒ‡ä»¤å·²ä¸Šçº¿ï¼Œæ”¯æŒç›´çº¿ä¼˜å…ˆ+BFS å¯»è·¯ã€è‡ªåŠ¨é‡è¯•ä¸å›è°ƒ
9. âœ… **GCLI-10 ä¸šåŠ¡æ‰©å±•è„šæœ¬**ï¼šæ–°å¢ `bag/use-item/pickup/gm/enter-dungeon/script-record/script-run` å‘½ä»¤ï¼Œå®ŒæˆèƒŒåŒ…/å‰¯æœ¬/GM/è„šæœ¬èƒ½åŠ›é¦–ä¸ªç‰ˆæœ¬

### 6.4 ç¦»çº¿æ•°æ®ç®¡ç†å™¨ï¼ˆäºŒæœŸè§„åˆ’ï¼‰

1. **æ•°æ®ç±»å‹æ‰©å±•**ï¼šä¸ºå…¬ä¼šå±•ç¤ºã€æ‹å–è¡Œé™ˆåˆ—ã€å½¢è±¡å¤–è§‚ç­‰æ–°å¢ `OfflineDataType`ï¼Œè¡¥å…… PlayerActor é‡‡é›†ä¸ PublicActor è§£ç é€»è¾‘ã€‚
2. **æ€§èƒ½ä¸æ‡’åŠ è½½**ï¼šæŒ‰ `data_type` åˆ†æ‰¹åŠ è½½ã€æä¾›å†·å¯åŠ¨é™æµä¸å•ç©å®¶æŒ‰éœ€æ‹‰å–èƒ½åŠ›ï¼Œé¿å…å…¨é‡åŠ è½½å¯¹å¤§åŒºé€ æˆå‹åŠ›ã€‚
3. **ç›‘æ§ä¸è§‚æµ‹**ï¼šæ¥å…¥ç¦»çº¿æ•°æ® Flush ç»Ÿè®¡ï¼ˆdirtyCountã€è€—æ—¶ã€å¤±è´¥æ¬¡æ•°ï¼‰ï¼Œå¹¶æä¾›å‘½ä»¤è¡Œ/GM æŸ¥è¯¢æ¥å£ä¸è¿‡æœŸæ¸…ç†ç­–ç•¥ã€‚
4. **å®¹é”™**ï¼šå®ç°ç£ç›˜/æ•°æ®åº“å¼‚å¸¸æ—¶çš„é™çº§ç­–ç•¥ï¼ˆç¼“å­˜ä¿ç•™ + é‡è¯•é˜Ÿåˆ—ï¼‰ï¼ŒåŒæ—¶åœ¨ `docs/ç¦»çº¿æ•°æ®ç®¡ç†å™¨å¼€å‘æ–‡æ¡£.md` è®°å½•æ‰©å±•æ–¹æ¡ˆã€‚

---

## 7. å¼€å‘æ³¨æ„äº‹é¡¹ä¸æ¶æ„å†³ç­–

### 7.1 Actor / å¹¶å‘çº¦æŸ

- æ¯ä½ç©å®¶ä»…ä¸€ä¸ª Actorï¼›DungeonServer å• Actorã€‚ç¦æ­¢åœ¨ä¸šåŠ¡é€»è¾‘ä¸­é¢å¤–åˆ›å»º goroutine è®¿é—®ç©å®¶çŠ¶æ€
- æ‰€æœ‰ç©å®¶ç³»ç»Ÿç¦æ­¢ä½¿ç”¨ `sync.Mutex`ï¼›æ•°æ®åªèƒ½æºè‡ª `PlayerRoleBinaryData`
- PublicActor è´Ÿè´£æ‰€æœ‰è·¨ç©å®¶æ•°æ®ï¼Œä¿æŒæ— é”ï¼›å¦‚éœ€å¹¶è¡Œè®¡ç®—ï¼Œå¿…é¡»åœ¨ Actor å¤–å°è£…å¼‚æ­¥ä»»åŠ¡å¹¶é€šè¿‡æ¶ˆæ¯è¿”å›
- `MoveSys` åªä¸“æ³¨äºç§»åŠ¨åŠŸèƒ½ï¼Œä¸åŒ…å«AIä¸šåŠ¡é€»è¾‘ï¼›AIç³»ç»Ÿé€šè¿‡ç»„åˆè°ƒç”¨ç§»åŠ¨åè®®æ–¹æ³•ï¼ˆ`HandleStartMove` â†’ `HandleUpdateMove` â†’ `HandleEndMove`ï¼‰å®ç°ç§»åŠ¨ï¼Œæ¨¡æ‹Ÿå®¢æˆ·ç«¯è¡Œä¸º

### 7.2 æ•°æ®ä¸å­˜å‚¨

- æ•°æ®åº“ä»…å­˜ `PlayerRoleBinaryData`ï¼ˆç©å®¶ä¾§ï¼‰+ å…¬ä¼š/æ‹å–ç­‰å…¨å±€æ•°æ®ï¼ˆPublicActor æŒä¹…åŒ–ï¼‰
- å±æ€§ç”± `AttrSys` å®æ—¶è®¡ç®—ï¼Œç¦æ­¢æŒä¹…åŒ–æœ€ç»ˆå±æ€§å€¼
- å®šæœŸå­˜ç›˜ï¼šé»˜è®¤æ¯ 5 åˆ†é’Ÿï¼Œå¯æŒ‰éœ€è°ƒæ•´ `_5minChecker`
- æ‰€æœ‰é”™è¯¯æ—¥å¿—å¿…é¡»åŒ…å«å…³é”®ä¸Šä¸‹æ–‡ï¼ˆRoleIDã€ItemIDã€QuestID ç­‰ï¼‰
- `server/internal/database` çš„å…ƒæ•°æ®æ—¶é—´åˆ—ç»Ÿä¸€ä½¿ç”¨ç§’çº§ Unix æ—¶é—´æˆ³ï¼ˆint64ï¼‰ï¼Œç¦æ­¢ç›´æ¥å†™å…¥ `time.Time`
- `scene_config` çš„ `width/height` ä¼šåœ¨åŠ è½½ `map_config` åè¢« `GameMap` è¦†ç›–ï¼Œ`map_config.tileData` çš„ `row/col` å¿…é¡»ä¸åœºæ™¯å°ºå¯¸ä¸€è‡´ï¼›ç¼ºå¤±åœ°å›¾æ—¶ä»…é€€åŒ–ä¸ºéšæœºåœ°å›¾ï¼ˆè°ƒè¯•ç”¨ï¼‰ï¼Œä¸Šçº¿å‰å¿…é¡»æä¾›æƒå¨åœ°å›¾
- æ¸¸æˆå®ä½“è¿›å…¥åœºæ™¯æ—¶å¿…é¡»è°ƒç”¨ `SceneSt.GetSpawnPos()`ï¼Œç¡®ä¿å‡ºç”Ÿç‚¹å‘½ä¸­ `BornArea` ä¸”å¯è¡Œèµ°ï¼›`BornArea` ä¸åˆæ³•æ—¶éœ€å›é€€éšæœºå¯è¡Œèµ°ç‚¹å¹¶è®°å½•å‘Šè­¦
- `GameMap` å¿…é¡»æ”¯æŒåæ ‡ â†” index åŒå‘è½¬æ¢ï¼ˆ`CoordToIndex`/`IndexToCoord`ï¼‰ï¼Œä¾›ç§»åŠ¨æ ¡éªŒã€å¯»è·¯å’Œå®¢æˆ·ç«¯éªŒè¯ç›´æ¥å¤ç”¨ï¼Œé¿å…è‡ªè¡Œè®¡ç®—é€ æˆè¶Šç•Œ
- **å¯»è·¯ç®—æ³•é…ç½®**ï¼š`MonsterAIConfig.PatrolPathfinding`ï¼ˆå·¡é€»ï¼‰å’Œ `ChasePathfinding`ï¼ˆè¿½å‡»ï¼‰åˆ†åˆ«æ§åˆ¶å¯¹åº”çŠ¶æ€ä¸‹çš„å¯»è·¯ç®—æ³•ï¼Œ1=ç›´çº¿å¯»è·¯ï¼ˆæœ€çŸ­ç›´çº¿ã€é‡éšœç¢è‡ªåŠ¨ç»•è¿‡ï¼‰ï¼Œ2=A*å¯»è·¯ï¼ˆç»•éšœç¢ã€è´´å¢™èµ°ï¼‰ï¼›é»˜è®¤å·¡é€»ç”¨ç›´çº¿ã€è¿½å‡»ç”¨A*ï¼›`AISys` åœ¨ `handleIdle`/`handleChase`/`handleReturn` ä¸­æ ¹æ®é…ç½®è°ƒç”¨ `moveTowardsWithPathfinding`ï¼Œè‡ªåŠ¨ç®¡ç†è·¯å¾„ç¼“å­˜å’Œåˆ†æ®µç§»åŠ¨ï¼›ç›´çº¿å¯»è·¯åœ¨é‡åˆ°éšœç¢æ—¶ä¼šä¼˜å…ˆä¿æŒç›´çº¿æ–¹å‘ï¼Œå°è¯•å·¦å³ä¸¤ä¾§å¯è¡Œèµ°ç‚¹ç»•è¿‡éšœç¢ï¼Œç¡®ä¿èƒ½å¤Ÿåˆ°è¾¾ç›®æ ‡ç‚¹
- **åæ ‡ç³»ç»Ÿè§„èŒƒ**ï¼š
  - **æœåŠ¡ç«¯ç»Ÿä¸€ä½¿ç”¨æ ¼å­åæ ‡**ï¼šæ‰€æœ‰æœåŠ¡ç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆç§»åŠ¨æ ¡éªŒã€å¯»è·¯ã€è·ç¦»è®¡ç®—ã€æŠ€èƒ½èŒƒå›´ã€AOIç­‰ï¼‰ç»Ÿä¸€ä½¿ç”¨æ ¼å­åæ ‡è¿›è¡Œå¤„ç†
  - **å®¢æˆ·ç«¯åæ ‡å¤„ç†**ï¼šå®¢æˆ·ç«¯æ ¹æ®æ ¼å­åæ ‡è‡ªè¡Œè½¬æ¢ä¸ºåƒç´ åæ ‡ç”¨äºæ˜¾ç¤ºå’Œç‰¹æ•ˆï¼›å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡ç«¯çš„åæ ‡ç»Ÿä¸€ä¸ºåƒç´ åæ ‡
  - **æœåŠ¡ç«¯åæ ‡è½¬æ¢**ï¼šå®¢æˆ·ç«¯å‘é€çš„åæ ‡ç»Ÿä¸€ä¸ºåƒç´ åæ ‡ï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°åè‡ªåŠ¨è½¬æ¢ä¸ºæ ¼å­åæ ‡è¿›è¡Œä¸šåŠ¡å¤„ç†
  - **åæ ‡å®šä¹‰**ï¼šå®¢æˆ·ç«¯æ ¼å­å¤§å°ä¸º 128Ã—128 åƒç´ ï¼ŒæœåŠ¡ç«¯åæ ‡ (x, y) ä»£è¡¨æ ¼å­åæ ‡ï¼Œç©å®¶åœ¨æ ¼å­ä¸­å¿ƒï¼ˆåƒç´ åæ ‡ x*128+64, y*128+64ï¼‰
  - **åæ ‡è½¬æ¢å‡½æ•°**ï¼šå·²å®šä¹‰åæ ‡è½¬æ¢å‡½æ•°ï¼ˆ`argsdef.TileCoordToPixel`ã€`argsdef.PixelCoordToTile`ã€`argsdef.IsSameTile`ï¼‰ï¼Œè¯¦è§ `server/internal/argsdef/position.go`
  - **å·²ä¼˜åŒ–æ¨¡å—**ï¼šç§»åŠ¨ç³»ç»Ÿã€å¯»è·¯ç®—æ³•ã€åœºæ™¯ç³»ç»Ÿã€æŠ€èƒ½ç³»ç»Ÿã€è·ç¦»è®¡ç®—å·²ç»Ÿä¸€ä½¿ç”¨æ ¼å­åæ ‡ï¼›åè®®å®šä¹‰å·²æ˜ç¡®å®¢æˆ·ç«¯å‘é€åƒç´ åæ ‡ï¼›æœåŠ¡ç«¯ç»Ÿä¸€å°†åƒç´ åæ ‡è½¬æ¢ä¸ºæ ¼å­åæ ‡
- **å±æ€§åŒæ­¥è§„èŒƒ**ï¼šGameServer ä»…ä¸‹å‘å·®å¼‚åŒ–çš„ `SyncAttrData.AttrData` + æ±‡æ€» `AddRateAttr`ï¼›DungeonServer å¿…é¡»é€šè¿‡ `entitysystem.AttrSys.ApplySyncData` èšåˆï¼Œç¦æ­¢åœ¨ `RoleEntity` ç­‰å¤„è‡ªè¡Œç´¯åŠ æˆ–ç›´æ¥å†™å…¥å±æ€§å€¼ã€‚
- **å±æ€§æ¨é€è§„èŒƒ**ï¼šGameServer åœ¨å±æ€§å˜æ›´ã€é¦–ç™»ä¸é‡è¿æ—¶é€šè¿‡ `S2CAttrData` æ¨é€æœ€æ–° `SyncAttrData + sys_power_map`ï¼Œå®¢æˆ·ç«¯ç¦æ­¢æœ¬åœ°æ¨å¯¼ã€‚
- **ç©å®¶æ¶ˆæ¯æŒä¹…åŒ–è§„èŒƒ**ï¼šç¦»çº¿æ¶ˆæ¯ï¼ˆéèŠå¤©ï¼‰ç»Ÿä¸€å†™å…¥ `PlayerActorMessage` è¡¨ï¼Œ`MsgData` å­˜å‚¨å®Œæ•´ Proto å­—èŠ‚ï¼Œæ—¶é—´å­—æ®µé‡‡ç”¨ `servertime.Now().Unix()`ï¼ˆç§’ï¼‰ï¼›æ‰€æœ‰ DAO è°ƒç”¨éœ€ä½äº `server/internal/database/player_actor_message.go`ï¼Œç¦æ­¢ç›´æ¥æ‹¼ SQLã€‚

### 7.3 åè®®ä¸ Proto è§„èŒƒ

- å…±äº«æšä¸¾/ç»“æ„ç»Ÿä¸€ä½äº `proto/csproto/*.proto`ï¼›ä¿®æ”¹åæ‰§è¡Œ `proto/genproto.sh` å¹¶ `gofmt`
- æšä¸¾æ”¾å…¥ `*_def.proto`ï¼›ç³»ç»Ÿæ•°æ®æ”¾å…¥ `system.proto`ï¼›ç©å®¶æ•°æ®æ”¾å…¥ `player.proto`ï¼›åè®®æ¶ˆæ¯åœ¨ `cs.proto/sc.proto`ï¼›å†…éƒ¨æ¶ˆæ¯åœ¨ `rpc.proto`
- è‹¥æ•°æ®æ— æ³•ä½¿ç”¨ Protoï¼Œæ”¾å…¥ `server/internal/argsdef/`
- **åè®®æ³¨å†Œè§„èŒƒ**ï¼š
  - **GameServer**ï¼šåè®®æ³¨å†Œç»Ÿä¸€åœ¨ `entitysystem` å„ä¸šåŠ¡ç³»ç»Ÿçš„ `init()` ä¸­ï¼Œé€šè¿‡ `gevent.Subscribe(gevent.OnSrvStart, ...)` è®¢é˜…æœåŠ¡å™¨å¯åŠ¨äº‹ä»¶ï¼Œåœ¨äº‹ä»¶å›è°ƒä¸­è°ƒç”¨ `clientprotocol.Register` æ³¨å†Œåè®®å¤„ç†å™¨
  - **DungeonServer**ï¼šåè®®æ³¨å†Œç»Ÿä¸€åœ¨ `entitysystem` å„ä¸šåŠ¡ç³»ç»Ÿçš„ `init()` ä¸­ï¼Œé€šè¿‡ `devent.Subscribe(devent.OnSrvStart, ...)` è®¢é˜…æœåŠ¡å™¨å¯åŠ¨äº‹ä»¶ï¼Œåœ¨äº‹ä»¶å›è°ƒä¸­è°ƒç”¨ `clientprotocol.Register` æ³¨å†Œåè®®å¤„ç†å™¨ï¼›ç¦æ­¢åœ¨ `clientprotocol` ç›®å½•ä¸‹ç›´æ¥æ³¨å†Œåè®®ï¼Œæ‰€æœ‰åè®®æ³¨å†Œåº”å½’åˆ°å¯¹åº”çš„ä¸šåŠ¡ç³»ç»Ÿä¸­

### 7.4 ç½‘ç»œä¸å®‰å…¨

- Gateway Session `Stop` å¿…é¡»å¹‚ç­‰ï¼›GameServer éœ€æ­£ç¡®å¤„ç† `SessionEventClose`
- `pkg/log` ä¸ºå”¯ä¸€æ—¥å¿—å…¥å£ï¼Œç¦æ­¢ `fmt.Println`
- `pkg/log` æ”¯æŒ `IRequester`ï¼Œå¸¦ä¸Šä¸‹æ–‡æ—¥å¿—å¿…é¡»ç»„åˆ `NewRequester/WithRequester` ä¼ å…¥ session/role ä¿¡æ¯ï¼ŒåŒæ—¶è®¾ç½® `GetLogCallStackSkip()` ä»¥ç¡®ä¿å †æ ˆå®šä½åˆ°çœŸå®ä¸šåŠ¡å‡½æ•°
- WebSocket/TCP å°šæœªåŠ  TLS/é‰´æƒï¼Œçº¿ä¸Šå‰éœ€è¡¥é½
- é˜²ä½œå¼Šï¼šé¢‘ç‡æ£€æµ‹ã€ç§»åŠ¨æµ‹é€Ÿã€ä¼¤å®³éªŒè¯ã€CD æ ¡éªŒéœ€é€æ­¥æ¥å…¥åè®®é“¾è·¯
- GameServer åœ¨ `handleDoNetWorkMsg` ä¸­å°†æ— æ³•æœ¬åœ°å¤„ç†çš„ `C2S` åè®®ä»¥ `msgId=0` è°ƒç”¨ `dungeonserverlink.AsyncCall`ï¼Œåº•å±‚ä¼šç¼–ç ä¸º `MsgTypeClient` å¹¶å¸¦ä¸Š `sessionId`ï¼›ç¦æ­¢ç›´æ¥æ„é€ è‡ªå®šä¹‰æ ¼å¼ï¼Œé¿å… DungeonServer æ— æ³•è¯†åˆ«ä¼šè¯

**æ¥å…¥ä¸æƒé™è¡¥å……çº¦æŸ**
- Gateway WebSocket åœ¨ç”Ÿäº§ç¯å¢ƒå¿…é¡»å¼€å¯ IP ç™½åå•ä¸ Origin æ ¡éªŒï¼š`WSServerConfig.AllowedIPs` éœ€é…ç½®ä¸ºå¯ä¿¡ç½‘æ®µï¼Œ`CheckOrigin` ç¦æ­¢è¿”å›å¸¸é‡ trueï¼Œåº”æ ¡éªŒåŸŸå/åè®®ä¸é¢„æœŸå‰ç«¯ä¸€è‡´  
- æ‰€æœ‰ GM åè®®ï¼ˆ`C2SGMCommand`ï¼‰å¿…é¡»åœ¨åè®®å…¥å£åšæƒé™æ ¡éªŒï¼šä»…å…è®¸å…·å¤‡ GM æ ‡è®°çš„è´¦å·/è§’è‰²è°ƒç”¨ï¼Œå¿…è¦æ—¶å åŠ æ¥æº IPã€ç¯å¢ƒå˜é‡æˆ–ä¸´æ—¶ä»¤ç‰Œæ ¡éªŒ  
- é’ˆå¯¹é«˜å± GM æŒ‡ä»¤ï¼ˆå‘æ”¾è´§å¸/é“å…·ã€è¸¢å°ç©å®¶ç­‰ï¼‰å¿…é¡»è¾“å‡ºç»“æ„åŒ–å®¡è®¡æ—¥å¿—æˆ–å†™å…¥å®¡è®¡è¡¨ï¼Œæ—¥å¿—å­—æ®µéœ€è‡³å°‘åŒ…å«ï¼šæ“ä½œè€…è´¦å·/è§’è‰²ã€ç›®æ ‡è´¦å·/è§’è‰²ã€æŒ‡ä»¤åã€å‚æ•°ã€æ—¶é—´ä¸æ¥æº IP

### 7.8 RPC ä¸ä¸Šä¸‹æ–‡ä½¿ç”¨

- åœ¨è·¨æœ RPC åœºæ™¯ï¼ˆ`dungeonserverlink.AsyncCall`ã€`gameserverlink.CallGameServer` ç­‰ï¼‰ä¸­ç¦æ­¢ç›´æ¥ä½¿ç”¨ `context.Background()` å‘èµ·é•¿é“¾è·¯è°ƒç”¨ï¼Œä¸Šçº¿å‰éœ€ç»Ÿä¸€æ”¹ä¸ºæºå¸¦è¶…æ—¶çš„ `context.WithTimeout` æˆ–æœåŠ¡çº§åˆ«çš„è¯·æ±‚ä¸Šä¸‹æ–‡  
- å¯¹äº fire-and-forget ç±»é€šçŸ¥å¯ä»¥ç»§ç»­ä½¿ç”¨å¸¦è¶…æ—¶çš„çŸ­æœŸä¸Šä¸‹æ–‡ï¼Œä½†å¿…é¡»ä¿è¯åº•å±‚ TCP å®¢æˆ·ç«¯åœ¨å¤±è´¥æ—¶ä¸ä¼šæ— é™é‡è¯•æˆ–é˜»å¡ Actor ä¸»çº¿ç¨‹  
- æ–°å¢ RPC æ—¶éœ€åœ¨æœ¬èŠ‚ç™»è®°è°ƒç”¨æ–¹/è¢«è°ƒæ–¹ã€ä¸Šä¸‹æ–‡ç­–ç•¥ï¼ˆå¸¦/ä¸å¸¦è¶…æ—¶ï¼‰ã€å¤±è´¥é‡è¯•ä¸é™çº§ç­–ç•¥

### 7.5 Phase 3 ç‰¹æ®Šå†³ç­–

- **PublicActor + PlayerActor åä½œ** æ˜¯æ‰€æœ‰ç¤¾äº¤ç»æµåŠŸèƒ½çš„å”¯ä¸€æ–¹æ¡ˆ
- æ’è¡Œæ¦œä»…å­˜ key/valueï¼›å±•ç¤ºæ•°æ®æ¥è‡ªå¿«ç…§ï¼Œç¼ºå¤±æ—¶å¼‚æ­¥è¡¥å…¨
- EntitySystem æ¨¡æ¿ç»Ÿä¸€ï¼›æ‰€æœ‰ç¤¾äº¤ç³»ç»Ÿå‡éœ€åœ¨ `entitysystem` ä¸‹æ³¨å†Œ
- å…¬ä¼š/æ‹å–è¡Œå¿…é¡»æŒä¹…åŒ–å¹¶åœ¨ GameServer å¯åŠ¨æ—¶åŠ è½½è‡³ PublicActor
- **PublicActor æ¶ˆæ¯å¤„ç†**ï¼šæ‰€æœ‰æ¶ˆæ¯å¤„ç†å™¨å‡½æ•°ç­¾åå¿…é¡»ç¬¦åˆ `actor.HandlerMessageFunc`
- **åœ¨çº¿çŠ¶æ€ç®¡ç†**ï¼šç©å®¶ä¸Šçº¿æ—¶é€šè¿‡ `RegisterOnlineMsg` æ³¨å†Œåˆ° PublicActorï¼Œä¸‹çº¿æ—¶é€šè¿‡ `UnregisterOnlineMsg` æ³¨é”€
- **PublicActor å†…éƒ¨æ¶ˆæ¯ ID è§„èŒƒ**ï¼šæ‰€æœ‰ PublicActor å†…éƒ¨æ¶ˆæ¯ ID å¿…é¡»ç»Ÿä¸€ä½¿ç”¨ Proto ä¸­çš„ `PublicActorMsgId` æšä¸¾å®šä¹‰

### 7.6 æ—¶é—´åŒæ­¥ä¸å®¢æˆ·ç«¯åŠ¨ç”»èŒè´£

- æ‰€æœ‰æœåŠ¡ä¸€å¾‹é€šè¿‡ `server/internal/servertime` è¯»å–æƒå¨ UTC æ—¶é—´ï¼Œç¦æ­¢ç›´æ¥è°ƒç”¨ `time.Now()`
- æœåŠ¡å™¨æ—¶é—´å¹¿æ’­ç”± GameServer çš„ `timesync.Broadcaster` ç»Ÿä¸€æ‰¿æ‹…
- æŠ€èƒ½/åŠ¨ä½œåŠ¨ç”»å®Œå…¨ç”±å®¢æˆ·ç«¯é©±åŠ¨ï¼šæœåŠ¡ç«¯åªè®¡ç®—æŠ€èƒ½é‡Šæ”¾æˆåŠŸä¸ä¼¤å®³æ‰¹æ¬¡å¹¶å¹¿æ’­ï¼Œå®¢æˆ·ç«¯æ ¹æ®åè®®ç»“æœè‡ªè¡Œæ’­æ”¾

### 7.7 æŠ€èƒ½é…ç½®æ ¡éªŒ

- æ‰€æœ‰æŠ€èƒ½å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ª `skillCfg.Effects` æ¡ç›®ï¼›è‹¥ä¸ºç©ºï¼Œ`skill.Skill.Use` ä¼šç›´æ¥è¿”å› `ErrSkillCannotCast`

### 7.8 è°ƒè¯•å®¢æˆ·ç«¯çº¦æŸ

- `server/example` è§†ä¸ºæœåŠ¡ç«¯ä»£ç ï¼Œå¿…é¡»ä½¿ç”¨ `servertime` è¯»å–æ—¶é—´ï¼Œç¦æ­¢ `time.Now()` ç›´æ¥è°ƒç”¨
- æ–‡å­—å†’é™©é¢æ¿å‘½ä»¤éœ€ä¸ç°æœ‰åè®®ä¸€ä¸€æ˜ å°„ï¼Œç¦æ­¢åœ¨ `GameClient` ä¸­ç¡¬ç¼–ç ä¸´æ—¶é€»è¾‘
- æ‰€æœ‰æ‰©å±•è®¾è®¡ã€å‘½ä»¤åˆ—è¡¨ã€å¾…åŠäº‹é¡¹ç»Ÿä¸€è®°å½•åœ¨ `docs/golangå®¢æˆ·ç«¯å¾…å¼€å‘æ–‡æ¡£.md`
- æ‰©å±•å‘½ä»¤å‰ä¼˜å…ˆå¤ç”¨ `AdventurePanel` è§£æä¸ `GameClient` èƒ½åŠ›ï¼Œç¦æ­¢åˆ›å»ºå¹³è¡Œè„šæœ¬
- server/example ä»»æ„é‡æ„ä¸æ–°å¢å‘½ä»¤å¿…é¡»éµå¾ªã€Š`docs/server_exampleé‡æ„æ–¹æ¡ˆ.md`ã€‹ï¼Œå¹¶ä¿æŒç§»åŠ¨æ¨¡æ‹Ÿ
- server/example ç°å·²ä½¿ç”¨ `cmd/example` å…¥å£ä¸ `internal/{client,panel,systems}` åˆ†å±‚ï¼Œæ–°å¢èƒ½åŠ›éœ€æŒ‰æ¨¡å—æ‹†åˆ†ï¼›åè®®ç­‰å¾…/å›è°ƒç»Ÿä¸€å¤ç”¨ `internal/client/flow.go`
- è‡ªåŠ¨å¯»è·¯ã€è„šæœ¬ä¸ AI å¿…é¡»é€šè¿‡ `systems.Move`/`MoveRunner` å®ç°ï¼Œç¦æ­¢ç»•è¿‡ç»Ÿä¸€å®¹é”™é€»è¾‘ï¼›èƒŒåŒ…/GM/å‰¯æœ¬ç­‰èƒ½åŠ›éœ€å¤ç”¨ `systems.Inventory/GM/Dungeon` è¯»å†™åè®®

### 7.9 ç¦»çº¿æ•°æ®ç®¡ç†å™¨çº¦æŸï¼ˆæ–°ï¼‰

- PublicActor æ˜¯å”¯ä¸€çš„ç¦»çº¿å¿«ç…§å†™å…¥å£ï¼Œ`OfflineDataManager` å†…éƒ¨çŠ¶æ€ç¦æ­¢åœ¨ PlayerActor ä¸­ç›´æ¥è®¿é—®ã€‚
- æ‰€æœ‰ç¦»çº¿æ•°æ®æ—¶é—´æˆ³ã€å®šæ—¶å™¨å‡éœ€ä½¿ç”¨ `servertime`ï¼›ç¦æ­¢ `time.Now()`ã€‚
- æ–°å¢ç¦»çº¿æ•°æ®ç±»å‹å¿…é¡»é€šè¿‡æ³¨å†Œè¡¨å£°æ˜ `data_type`ã€åºåˆ—åŒ–å‡½æ•°ä¸è½åº“ç­–ç•¥ï¼Œå¹¶åœ¨ `docs/ç¦»çº¿æ•°æ®ç®¡ç†å™¨å¼€å‘æ–‡æ¡£.md` è®°å½•ã€‚
- GameServer å¯åŠ¨æ—¶å¿…é¡»åŠ è½½ç¦»çº¿æ•°æ®ï¼ˆæˆ–æŒ‰éœ€æ‡’åŠ è½½ï¼‰ï¼Œå¹¶åœ¨ `rank` æŸ¥è¯¢ç­‰è·¯å¾„ä¸Šå…è®¸ç¦»çº¿ç©å®¶è¿”å›å¿«ç…§ã€‚
- æŒä¹…åŒ–å¤±è´¥éœ€è¦ä¿ç•™ `dirty` çŠ¶æ€å¹¶ç›‘æ§æ—¥å¿—ï¼Œé¿å…åæ‰è½åº“å¤±è´¥ã€‚
- PlayerActor å¿…é¡»é€šè¿‡ `PublicActorMsgIdUpdateOfflineData`ï¼ˆ`UpdateOfflineDataMsg`ï¼‰ä¸ŠæŠ¥æœ€æ–°å¿«ç…§ï¼›è‹¥æ¶ˆæ¯å‘é€å¤±è´¥éœ€åœ¨ Actor ç«¯é‡è¯•ã€‚

---

## 8. å…³é”®ä»£ç ä½ç½®

### 8.1 Gateway
- `server/service/gateway/internel/clientnet`ï¼šSession ä¸æ¶ˆæ¯é€‚é…
- `server/service/gateway/internel/engine`ï¼šGateway é…ç½®è§£æåŠ TCP/WS å¯åœ

### 8.2 GameServer - ç©å®¶ Actor
- `server/service/gameserver/internel/playeractor`ï¼šç©å®¶ Actor Handler / Adapter / `PlayerRole`
- `server/service/gameserver/internel/playeractor/entitysystem/*`ï¼šæ‰€æœ‰ç©å®¶å­ç³»ç»Ÿ
  - `entitysystem/friend_sys.go`ï¼šå¥½å‹ç³»ç»Ÿ
  - `entitysystem/guild_sys.go`ï¼šå…¬ä¼šç³»ç»Ÿ
  - `entitysystem/auction_sys.go`ï¼šæ‹å–è¡Œç³»ç»Ÿ
  - `entitysystem/chat_sys.go`ï¼šèŠå¤©ç³»ç»Ÿ
  - `entitysystem/anti_cheat_sys.go`ï¼šé˜²ä½œå¼Šç³»ç»Ÿï¼Œç»´æŠ¤ç©å®¶æ“ä½œé¢‘ç‡ä¸å°ç¦çŠ¶æ€ï¼ˆ`CheckOperationFrequency/RecordSuspiciousBehavior/BanPlayer`ï¼‰
  - `entitysystem/gm_sys.go`ï¼šç©å®¶çº§ GM ç³»ç»Ÿï¼Œ`handleGMCommand` åè®®å…¥å£ä¸ç³»ç»Ÿå¹¿æ’­/ç³»ç»Ÿé‚®ä»¶å·¥å…·æ–¹æ³•
  - `entitysystem/fuben_sys.go`ï¼šå‰¯æœ¬ç³»ç»Ÿï¼Œè´Ÿè´£é™æ—¶å‰¯æœ¬è¿›å…¥æ ¡éªŒã€è®°å½•æŒ‰å¤©é‡ç½®ä¸å‰¯æœ¬ç»“ç®—å¥–åŠ±å‘æ”¾
  - `entitysystem/attr_sys.go`ï¼šå±æ€§ç³»ç»Ÿï¼Œç¼“å­˜æ¯ä¸ªç³»ç»Ÿçš„å±æ€§ä¸ `AddRateAttr`ï¼Œæ”¯æŒå·®å¼‚åŒ–é‡ç®—ã€`RegisterAddRate`ã€`attr_config.json.power` æˆ˜åŠ›æƒé‡ä¸ `attr_config.json.push` æ§åˆ¶çš„å®¢æˆ·ç«¯æ¨é€
  - `entitysystem/message_sys.go`ï¼šç©å®¶æ¶ˆæ¯ç³»ç»Ÿï¼Œè´Ÿè´£ç¦»çº¿æ¶ˆæ¯åŠ è½½/é‡æ”¾ä¸æ¶ˆæ¯å›è°ƒè°ƒç”¨
- `server/service/gameserver/internel/playeractor/entity/player_network.go`ï¼šå®¢æˆ·ç«¯åè®®å¤„ç†å…¥å£
- `server/service/gameserver/internel/gshare/log_helper.go`ï¼šæ—¥å¿—ä¸Šä¸‹æ–‡è¾…åŠ©ï¼ˆè‡ªåŠ¨è¾“å‡º Session/Role ä¿¡æ¯ï¼‰

### 8.3 GameServer - PublicActor
- `server/service/gameserver/internel/publicactor/adapter.go`ï¼šPublicActor é€‚é…å™¨ï¼Œå• Actor æ¨¡å¼
- `server/service/gameserver/internel/publicactor/handler.go`ï¼šPublicActor æ¶ˆæ¯å¤„ç†å™¨
- `server/service/gameserver/internel/publicactor/public_role.go`ï¼šå…¬å…±è§’è‰²æ•°æ®ç®¡ç†ï¼ˆåœ¨çº¿çŠ¶æ€ã€æ’è¡Œæ¦œã€å…¬ä¼šã€æ‹å–è¡Œï¼‰
- `server/service/gameserver/internel/publicactor/message_handler.go`ï¼šPublicActor æ¶ˆæ¯å¤„ç†å‡½æ•°
- `server/service/gameserver/internel/publicactor/public_role_offline_data.go`ï¼šç¦»çº¿æ•°æ®åŠ è½½ã€æ¶ˆæ¯å…¥å£ä¸å‘¨æœŸ Flush
- `server/service/gameserver/internel/publicactor/offlinedata/*`ï¼šOfflineDataManagerï¼ˆå†…å­˜ç¼“å­˜ã€Load/Update/FlushDirtyï¼‰
- `docs/ç¦»çº¿æ•°æ®ç®¡ç†å™¨å¼€å‘æ–‡æ¡£.md`ï¼šç¦»çº¿å¿«ç…§/æ’è¡Œæ¦œæŒä¹…åŒ–é‡æ„æ–¹æ¡ˆä¸å®æ–½æ­¥éª¤

### 8.4 GameServer - å…¶ä»–
- `server/service/gameserver/internel/dungeonserverlink`ï¼šDungeonServer RPC å®¢æˆ·ç«¯
  - `dungeon_cli.go`ï¼š`AsyncCall` å¯¹ `msgId=0` çš„è°ƒç”¨å°è£… `MsgTypeClient` é€ä¼ ï¼Œä¿æŒ sessionId
- `server/service/gameserver/internel/gatewaylink`ï¼šä¸ Gateway çš„ Session æ˜ å°„ä¸æ¶ˆæ¯è½¬å‘
- `server/service/gameserver/internel/timesync`ï¼šæœåŠ¡å™¨æ—¶é—´å¹¿æ’­å™¨
- `server/service/gameserver/internel/gshare/srv.go`ï¼šå¹³å°/åŒºæœå¸¸é‡ã€å¼€æœæ—¶é—´ã€`GetOpenSrvDay`
- `server/service/gameserver/internel/manager/role_mgr.go`ï¼šç©å®¶è§’è‰²ç®¡ç†ã€å…³æœåˆ·ç›˜ `FlushAndSave`
- `server/service/gameserver/internel/engine/message_registry.go`ï¼šç©å®¶æ¶ˆæ¯å›è°ƒæ³¨å†Œä¸­å¿ƒ
- `server/service/gameserver/internel/gshare/message_sender.go`ï¼šç©å®¶æ¶ˆæ¯å‘é€å…¥å£ï¼ˆåœ¨çº¿ Actor æŠ•é€’ + ç¦»çº¿å›é€€ï¼‰
- `proto/csproto/rpc.proto`ï¼š`AddActorMessageMsg` å†…éƒ¨æ¶ˆæ¯å®šä¹‰

### 8.5 DungeonServer
- `server/service/dungeonserver/internel/clientprotocol`ï¼šDungeonServer åè®®å…¥å£ï¼ˆåè®®æ³¨å†Œè¡¨ï¼Œåè®®å¤„ç†å™¨åº”æ³¨å†Œåœ¨å¯¹åº”çš„ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼‰
- `server/service/dungeonserver/internel/entitysystem/*`ï¼šAIã€Buffã€Attrã€Moveã€Fightã€StateMachineã€AOI
  - `entitysystem/pathfinding.go`ï¼šå¯»è·¯ç®—æ³•å®ç°ï¼ˆA*ã€ç›´çº¿å¯»è·¯ï¼‰ï¼Œ`FindPath` æä¾›ç»Ÿä¸€å…¥å£ï¼›æ‰€æœ‰åæ ‡å‚æ•°å’Œè¿”å›å€¼éƒ½æ˜¯æ ¼å­åæ ‡ï¼›ç›´çº¿å¯»è·¯åœ¨é‡åˆ°éšœç¢æ—¶è‡ªåŠ¨ç»•è¿‡ï¼Œä¼˜å…ˆä¿æŒç›´çº¿æ–¹å‘å¹¶é€‰æ‹©æœ€æ¥è¿‘ç›®æ ‡çš„æ–¹å‘
  - `entitysystem/move_sys.go`ï¼šç§»åŠ¨ç³»ç»Ÿï¼Œä¸“æ³¨äºç§»åŠ¨åŠŸèƒ½ï¼Œä¸åŒ…å«AIä¸šåŠ¡é€»è¾‘
    - `HandleStartMove`ï¼šå¤„ç† C2SStartMoveï¼Œè®°å½• move_dataï¼ˆåŒ…å«ç›®çš„åœ°ï¼‰ï¼Œå¹¿æ’­ S2CStartMove
    - `HandleUpdateMove`ï¼šå¤„ç† C2SUpdateMoveï¼Œåˆ¤å®šåæ ‡è¯¯å·®ï¼ˆæ”¯æŒ1sè¯¯å·®ï¼‰ï¼Œå¦‚æœå·®è·å¤§å°±ç»“æŸç§»åŠ¨ï¼Œå¦åˆ™æ›´æ–°åæ ‡
    - `HandleEndMove`ï¼šå¤„ç† C2SEndMoveï¼Œå¹¿æ’­ S2CEndMoveï¼Œé€šçŸ¥å®¢æˆ·ç«¯ç»“æŸç§»åŠ¨
    - `HandMove`ï¼šå¤„ç†å®¢æˆ·ç«¯ç§»åŠ¨è¯·æ±‚çš„æ ¸å¿ƒé€»è¾‘
    - `LocationUpdate`ï¼šå®¢æˆ·ç«¯ä½ç½®æ›´æ–°æ ¡éªŒï¼Œé˜²æ­¢ç§»åŠ¨è¿‡å¿«æˆ–ç¬ç§»
    - `MovingTime`ï¼šæœåŠ¡ç«¯æ—¶é—´é©±åŠ¨ç§»åŠ¨ï¼Œæ ¹æ®æ—¶é—´è®¡ç®—å½“å‰ä½ç½®
  - `entitysystem/fight_sys.go`ï¼šæˆ˜æ–—ç³»ç»Ÿï¼Œç®¡ç†æŠ€èƒ½é‡Šæ”¾ã€ä¼¤å®³ç»“ç®—ã€Buff åº”ç”¨ï¼›åŒ…å« `handleUseSkill` åè®®å¤„ç†å™¨ï¼Œé€šè¿‡ `devent.Subscribe(OnSrvStart)` æ³¨å†Œ `C2SUseSkill` åè®®
  - `entitysystem/ai_sys.go`ï¼šAIç³»ç»Ÿï¼Œé€šè¿‡ç»„åˆè°ƒç”¨ç§»åŠ¨åè®®æ–¹æ³•ï¼ˆ`HandleStartMove` â†’ `HandleUpdateMove` â†’ `HandleEndMove`ï¼‰å®ç°ç§»åŠ¨ï¼Œæ¨¡æ‹Ÿå®¢æˆ·ç«¯è¡Œä¸ºï¼›`moveTowardsWithPathfinding` æ ¹æ®é…ç½®é€‰æ‹©å¯»è·¯ç®—æ³•å¹¶ç®¡ç†è·¯å¾„ç¼“å­˜ï¼›`distanceBetween` å‡½æ•°è®¡ç®—æ ¼å­è·ç¦»
  - `entitysystem/attr_sys.go`ï¼šå±æ€§ç³»ç»Ÿï¼Œä½¿ç”¨ `attrcalc.AttrSet`+`ResetProperty`ï¼Œå¹¿æ’­ `S2CAttrData`ï¼ˆDungeonå³æ—¶å±æ€§ï¼‰å¹¶å¤ç”¨ `attr_config.json.power` æˆ˜åŠ›å…¬å¼ï¼›æ”¯æŒ `ApplySyncData` æ¥æ”¶ GameServer å±æ€§ï¼Œ`ResetSysAttr` æ”¯æŒæœ¬åœ°ç³»ç»Ÿå±æ€§è®¡ç®—ï¼ˆæ€ªç‰©ã€Buff ç­‰ï¼‰ï¼›`RunOne` æ¯å¸§è°ƒç”¨ `ResetProperty` å’Œ `CheckAndSyncProp`ï¼›`extraUpdateMask` è·Ÿè¸ªéæˆ˜æ–—å±æ€§å˜åŒ–ï¼Œ`bInitFinish` æ§åˆ¶æ˜¯å¦å¹¿æ’­å±æ€§
  - `entitysystem/attrcalc/bus.go`ï¼šå±æ€§è®¡ç®—å™¨æ³¨å†Œç®¡ç†å™¨ï¼Œæä¾› `RegIncAttrCalcFn/RegDecAttrCalcFn` å’Œ `GetIncAttrCalcFn/GetDecAttrCalcFn`ï¼Œæ”¯æŒæ³¨å†Œæ€ªç‰©åŸºç¡€å±æ€§è®¡ç®—å™¨ï¼ˆ`MonsterBaseProperty`ï¼‰ã€Buff å±æ€§è®¡ç®—å™¨ï¼ˆ`SaBuff`ï¼‰ç­‰
  - `entity/monster.go`ï¼šæ€ªç‰©å®ä½“ï¼Œåœ¨ `NewMonsterEntity` ä¸­è°ƒç”¨ `ResetProperty()` è§¦å‘å®Œæ•´å±æ€§è®¡ç®—æµç¨‹ï¼›`MonsterEntity.ResetProperty()` æ–¹æ³•å…ˆè°ƒç”¨ `ResetSysAttr(MonsterBaseProperty)` è®¡ç®—åŸºç¡€å±æ€§ï¼Œå†è°ƒç”¨ `AttrSys.ResetProperty()` è§¦å‘å±æ€§æ±‡æ€»ã€è½¬æ¢ã€ç™¾åˆ†æ¯”åŠ æˆå’Œå¹¿æ’­ï¼›`monsterBaseProperty` å‡½æ•°ä»æ€ªç‰©é…ç½®è¡¨è¯»å–å±æ€§å¹¶å†™å…¥ `AttrSet`
  - `entitysystem/buff_sys.go`ï¼šBuff ç³»ç»Ÿï¼Œåœ¨ `AddBuff/RemoveBuff/ClearAllBuffs` æ—¶è§¦å‘ `ResetSysAttr(SaBuff)`ï¼›`buffAttrCalc` å‡½æ•°éå†æ‰€æœ‰ Buff æ±‡æ€»å±æ€§åŠ æˆ
- `server/service/dungeonserver/internel/fuben` & `fbmgr`ï¼šå‰¯æœ¬å®ä¾‹ä¸ç»“ç®—é€»è¾‘
- `server/service/dungeonserver/internel/scene/scenest.go`ï¼š`GameMap` ç»‘å®šã€å‡ºç”Ÿç‚¹éšæœºæ ¡éªŒï¼ˆ`BornArea`ï¼‰ã€ç§»åŠ¨æ ¡éªŒï¼›æ‰€æœ‰ä½ç½®ç›¸å…³å‡½æ•°ç»Ÿä¸€ä½¿ç”¨æ ¼å­åæ ‡
- `server/service/dungeonserver/internel/skill/skill.go`ï¼šæŠ€èƒ½ç›®æ ‡ç­›é€‰ã€é…ç½®æ ¡éªŒã€ç»“æœå¡«å……ï¼›è·ç¦»è®¡ç®—å’ŒèŒƒå›´åˆ¤æ–­ç»Ÿä¸€ä½¿ç”¨æ ¼å­è·ç¦»

### 8.6 æ•°æ®åº“
- `server/internal/database`ï¼šè´¦å·/è§’è‰²/Token è®¿é—®å±‚
- `server/internal/database/server_info.go`ï¼šå¹³å°/åŒºæœå¼€æœä¿¡æ¯è¡¨
- `server/internal/database/guild.go`ï¼šå…¬ä¼šæ•°æ®æŒä¹…åŒ–
- `server/internal/database/auction_item.go`ï¼šæ‹å–è¡Œæ•°æ®æŒä¹…åŒ–
- `server/internal/database/offline_message.go`ï¼šç¦»çº¿æ¶ˆæ¯æŒä¹…åŒ–
- `server/internal/database/offline_data.go`ï¼šç¦»çº¿æ•°æ®è¡¨ `OfflineData` å®šä¹‰åŠ Upsert/æŸ¥è¯¢
- `server/internal/database/player_actor_message.go`ï¼šç©å®¶æ¶ˆæ¯è¡¨ DAOï¼ˆå¢é‡åŠ è½½ã€å•æ¡/æ‰¹é‡åˆ é™¤ã€è®¡æ•°ï¼‰
- `server/internal/database/transaction_audit.go`ï¼šäº¤æ˜“å®¡è®¡
- `server/internal/database/blacklist.go`ï¼šé»‘åå•ç®¡ç†

### 8.7 å…±äº«åŸºç¡€
- `server/internal/actor`ï¼šActor æ¡†æ¶
- `server/internal/network`ï¼šæ¶ˆæ¯ç¼–è§£ç ã€å‹ç¼©
- `server/internal/network/codec.go` & `message.go`ï¼šå‰å‘æ¶ˆæ¯æ± åŒ–ã€ç¼“å†²å¤ç”¨
- `server/internal/servertime`ï¼šç»Ÿä¸€æ—¶é—´æº
- `server/internal/event`ï¼šäº‹ä»¶æ€»çº¿
- `server/internal/jsonconf`ï¼šé…ç½®åŠ è½½ä¸ç¼“å­˜
  - `monster_config.go`ï¼šæ€ªç‰©é…ç½®ï¼Œ`MonsterAIConfig` åŒ…å« `PatrolPathfinding`/`ChasePathfinding` å¯»è·¯ç®—æ³•é…ç½®
  - `map_config.go`ï¼š`map_config.json` â†’ `GameMap` è½¬æ¢ã€åœºæ™¯ç»‘å®š
    - `CoordToIndex` / `IndexToCoord`ï¼šåæ ‡ä¸ä¸€ç»´æ•°ç»„ç´¢å¼•äº’è½¬ï¼Œä¾›ç§»åŠ¨æ ¡éªŒ/å¯»è·¯è°ƒç”¨
- `server/internal/argsdef`ï¼šå‚æ•°å®šä¹‰ä¸å·¥å…·å‡½æ•°
  - `position.go`ï¼šåæ ‡ç³»ç»Ÿå®šä¹‰ä¸è½¬æ¢ï¼ˆ`TileSize`ã€`TileCenterOffset`ã€`TileCoordToPixel`ã€`PixelCoordToTile`ã€`IsSameTile`ï¼‰
  - `gridst.go`ï¼šAOIæ ¼å­ç³»ç»Ÿï¼ˆ`GrIdSt`ã€`GrIdSize`ã€`GetGrIdSt`ã€`GetNineGrIds`ï¼‰ï¼Œæ³¨æ„ï¼šAOIæ ¼å­å¤§å°ï¼ˆ100ï¼‰ä¸æ¸¸æˆåæ ‡æ ¼å­å¤§å°ï¼ˆ128ï¼‰ä¸åŒ
- `server/internal/attrcalc`ï¼šå±æ€§è®¡ç®—å·¥å…·åŒ…ï¼ˆå¾…å®Œå–„ï¼‰
  - `attrcalc.go`ï¼šæˆ˜æ–—å±æ€§è®¡ç®—å™¨ï¼ˆ`CombatAttrCalc`ï¼‰
  - `extraattrcalc.go`ï¼šéæˆ˜æ–—å±æ€§è®¡ç®—å™¨ï¼ˆ`ExtraAttrCalc`ï¼‰
  - å¾…å®ç°ï¼š`attr_set.go`ï¼ˆå±æ€§é›†åˆç®¡ç†ï¼Œå‚è€ƒ `server/server/base/attrcalc/attr_set.go`ï¼‰
- `server/internal/attrdef`ï¼šå±æ€§ç±»å‹å®šä¹‰ï¼ˆ`attrdef.go`ï¼‰
- `server/pkg/log`ï¼šç»Ÿä¸€æ—¥å¿—ç»„ä»¶ï¼ˆçº§åˆ«æ§åˆ¶ã€ç»“æ„åŒ–å­—æ®µã€æ–‡ä»¶è½®è½¬ï¼‰
  - `logger.go` / `requester.go`ï¼š`IRequester` æ¥å£ä¸ `*_WithRequester` å…¨å±€å‡½æ•°ï¼Œç”¨äºæ³¨å…¥ Session/Role å‰ç¼€ä¸è‡ªå®šä¹‰æ ˆæ·±ï¼›GameServer `gshare/log_helper.go` é€šè¿‡è¯¥èƒ½åŠ›è¡¥å……ä¸Šä¸‹æ–‡
- `proto/csproto/*.proto`ï¼šåè®®å®šä¹‰
- `server/internal/protocol/*.pb.go`ï¼šåè®®ç”Ÿæˆç»“æœ

### 8.8 è°ƒè¯•å®¢æˆ·ç«¯ï¼ˆserver/exampleï¼‰
- `server/example/cmd/example/main.go`ï¼šè°ƒè¯•å®¢æˆ·ç«¯å…¥å£ï¼Œåˆå§‹åŒ–æ—¥å¿—/é…ç½®å¹¶å¯åŠ¨é¢æ¿
- `server/example/internal/client`ï¼š`Core`ï¼ˆåè®®æ”¶å‘ã€çŠ¶æ€ã€Flow Waiterã€MoveRunnerï¼‰ã€`Manager`ã€`ClientHandler`
- `server/example/internal/panel`ï¼š`AdventurePanel` UIã€å‘½ä»¤è§£æä¸è„šæœ¬è§¦å‘
- `server/example/internal/systems`ï¼š`Account/Scene/Move/Combat/Inventory/Dungeon/GM/Script` ç³»ç»Ÿå°è£…
- `docs/golangå®¢æˆ·ç«¯å¾…å¼€å‘æ–‡æ¡£.md`ï¼šè°ƒè¯•å®¢æˆ·ç«¯è§„åˆ’ã€å‘½ä»¤æ˜ å°„ã€å¾…åŠ
- `docs/server_exampleé‡æ„æ–¹æ¡ˆ.md`ï¼šserver/example é‡æ„ä¸ç§»åŠ¨å¯¹é½æŒ‡å—ï¼Œåˆ†é˜¶æ®µä»»åŠ¡ä¸éªŒæ”¶æ ‡å‡†

### 8.9 å‚è€ƒé¡¹ç›®ï¼ˆserver/serverï¼‰
- `server/server/gameserver/logicworker/actorsystem/attr_sys.go`ï¼šGameServer å±æ€§ç³»ç»Ÿå‚è€ƒå®ç°ï¼ˆç³»ç»Ÿå±æ€§å­˜å‚¨ã€åŠ æˆå±æ€§è®¡ç®—ã€æˆ˜åŠ›è®¡ç®—ã€å±æ€§æ¨é€ï¼‰
- `server/server/fightsrv/entitysystem/attr_sys.go`ï¼šFightServer å±æ€§ç³»ç»Ÿå‚è€ƒå®ç°ï¼ˆAttrSet ç»“æ„ã€å±æ€§é‡ç½®è®¡ç®—ã€å±æ€§åŒæ­¥å¤„ç†ã€å±æ€§å¹¿æ’­ï¼‰
- `server/server/base/attrcalc/`ï¼šå±æ€§è®¡ç®—å™¨å‚è€ƒå®ç°ï¼ˆ`fight_attr.go`ã€`extra_attr.go`ã€`attr_set.go`ï¼‰
- `docs/å±æ€§ç³»ç»Ÿé‡æ„æ–‡æ¡£.md`ï¼šå±æ€§ç³»ç»Ÿé‡æ„æ–¹æ¡ˆæ–‡æ¡£ï¼ŒåŒ…å«è¯¦ç»†çš„é‡æ„æ­¥éª¤å’Œæ£€æŸ¥æ¸…å•
- `docs/å±æ€§ç³»ç»Ÿé˜¶æ®µä¸‰è”è°ƒè®°å½•.md`ï¼šé˜¶æ®µä¸‰ç«¯åˆ°ç«¯è‡ªæµ‹æµç¨‹è®°å½•

---

## 9. æ ¸å¿ƒè¿è¡Œæµç¨‹ï¼ˆæ‘˜è¦ï¼‰

1. **ç™»å½•**ï¼šClient â†’ Gateway â†’ GameServer (`C2SRegister/C2SLogin`) â†’ `database.Account` æ ¡éªŒ â†’ Token + Session æ‰©å±•
2. **è§’è‰²ç®¡ç†**ï¼š`C2SQueryRoles/C2SCreateRole/C2SEnterGame` â†’ åŠ è½½ `PlayerRoleBinaryData` â†’ åˆå§‹åŒ–ç³»ç»Ÿ â†’ `S2CLoginSuccess`
3. **è¿›å…¥å‰¯æœ¬**ï¼šGameServer é€šè¿‡ `dungeonserverlink` å‘ `G2DEnterDungeonReq`ï¼ˆå«å±æ€§/æŠ€èƒ½ï¼‰ï¼ŒDungeonServer åˆ›å»ºå®ä½“å¹¶å›æ‰§
4. **ç§»åŠ¨ä¸æˆ˜æ–—**ï¼šå®¢æˆ·ç«¯ç›´æ¥è¿æ¥ DungeonServerï¼Œç§»åŠ¨èµ° `C2SStart/Update/EndMove`ï¼ŒæŠ€èƒ½èµ° `C2SUseSkill`ï¼›DungeonServer æ ¡éªŒå¹¶å¹¿æ’­ï¼Œå¿…è¦ä¿¡æ¯å›ä¼  GameServer
5. **æ‰è½æ‹¾å–**ï¼šDungeonServer åˆ¤å®šå½’å±/è·ç¦» â†’ GameServer RPC æ£€æŸ¥èƒŒåŒ… â†’ æˆåŠŸåˆ™åˆ é™¤æ‰è½å¹¶è§¦å‘ä»»åŠ¡äº‹ä»¶
6. **å‰¯æœ¬ç»“ç®—**ï¼šDungeonServer å‘é€ `D2GSettleDungeon` â†’ GameServer `FubenSys` æ›´æ–°è®°å½•ã€å‘å¥–åŠ±
7. **æ–­çº¿é‡è¿**ï¼šGateway å…³é—­è¿æ¥ â†’ GameServer æ¥æ”¶ `SessionEventClose`ï¼Œæ ‡è®°ç¦»çº¿å¹¶å…è®¸åœ¨ `ReconnectKey` æœ‰æ•ˆæœŸå†…é‡è¿

---

## 10. ç‰ˆæœ¬è®°å½•

| æ—¥æœŸ | å†…å®¹ |
| ---- | ---- |
| 2025-11-26 | **server/example Phase B & C**ï¼šå¼•å…¥ `MoveRunner` + `move-to/move-resume`ã€`bag/use-item/pickup/gm/enter-dungeon` å‘½ä»¤ä¸ `script-record/script-run` å½•åˆ¶å›æ”¾ï¼›`systems` åŒ…è¡¥å…¨ Inventory/Dungeon/GM/Scriptï¼Œé¢æ¿å…¨é‡ç»ç”±ç³»ç»Ÿæ¥å£è°ƒç”¨ |
| 2025-12-XX | **ç§»åŠ¨ç³»ç»Ÿä»£ç ç®€åŒ–**ï¼šç§»é™¤ `MoveSys` ä¸­çš„AIç›¸å…³ä¸šåŠ¡é€»è¾‘ï¼ˆ`TickAutoMove`ã€`MoveTo`ã€`MoveToWithPathfinding`ç­‰ï¼‰ï¼Œä¿æŒç§»åŠ¨ç³»ç»Ÿä»£ç ç®€æ´å¹²å‡€ï¼›AIç³»ç»Ÿé€šè¿‡ç»„åˆè°ƒç”¨ç§»åŠ¨åè®®æ–¹æ³•ï¼ˆ`HandleStartMove` â†’ `HandleUpdateMove` â†’ `HandleEndMove`ï¼‰å®ç°ç§»åŠ¨ï¼Œæ¨¡æ‹Ÿå®¢æˆ·ç«¯è¡Œä¸º |
| 2025-11-25 | **DungeonServer ç§»åŠ¨ç³»ç»Ÿé‡æ„**ï¼šé‡æ–°å®ç°ç§»åŠ¨ç³»ç»Ÿï¼Œæ·»åŠ æœåŠ¡ç«¯æ—¶é—´é©±åŠ¨ç§»åŠ¨ï¼ˆ`MovingTime`ï¼‰å’Œå®¢æˆ·ç«¯ä½ç½®æ ¡éªŒï¼ˆ`LocationUpdate`ï¼‰ï¼Œç»Ÿä¸€åæ ‡ç³»ç»Ÿï¼ˆå†…éƒ¨ä½¿ç”¨åƒç´ åæ ‡ï¼Œä¸åœºæ™¯äº¤äº’æ—¶è½¬æ¢ä¸ºæ ¼å­åæ ‡ï¼‰ï¼Œæ”¯æŒé€Ÿåº¦å®¹å·®å’Œç½‘ç»œå»¶è¿Ÿå®¹å¿åº¦ |
| 2025-11-25 | **DungeonServer ç§»åŠ¨åè®®æµç¨‹ä¼˜åŒ–**ï¼šä¼˜åŒ–ç§»åŠ¨åè®®å¤„ç†æµç¨‹ï¼Œå®ç° `HandleStartMove`ï¼ˆè®°å½• move_data å¹¶å¹¿æ’­ S2CStartMoveï¼‰ã€`HandleUpdateMove`ï¼ˆåˆ¤å®šåæ ‡è¯¯å·®ï¼Œæ”¯æŒ1sè¯¯å·®ï¼Œå·®è·å¤§æ—¶ç»“æŸç§»åŠ¨ï¼‰ã€`HandleEndMove`ï¼ˆå¹¿æ’­ S2CEndMoveï¼‰ï¼›åœ¨ proto ä¸­å®šä¹‰ MoveData å’Œ S2CStartMoveã€S2CEndMove åè®® |
| 2025-11-25 | **DungeonServer ç§»åŠ¨é‡æ„**ï¼š`MoveSys` æ”¹ä¸ºä»…ç”± `AISys.TickAutoMove` é©±åŠ¨ï¼ˆç©å®¶ä¸å†è°ƒç”¨ RunOneï¼‰ï¼Œè‡ªåŠ¨ç§»åŠ¨å¤±è´¥æ—¥å¿—è¾“å‡ºæ ¼å­åæ ‡ï¼›`server/example` çš„ `move` å‘½ä»¤ä¸¥æ ¼æŒ‰ç…§ `C2SStart/C2SUpdate/C2SEnd` é¡ºåºé€æ ¼ä¸ŠæŠ¥åƒç´ åæ ‡ï¼Œä¾¿äºå¤ç°å®¢æˆ·ç«¯ç§»åŠ¨é“¾è·¯ |
| 2025-11-24 | **DungeonServer åè®®æ³¨å†Œé‡æ„**ï¼šå‚è€ƒ GameServer çš„åè®®æ³¨å†Œæ–¹å¼ï¼Œå°† DungeonServer çš„åè®®æ³¨å†Œå½’åˆ°å…·ä½“ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼›å°† `clientprotocol/skill_handler.go` çš„ `handleUseSkill` ç§»è‡³ `entitysystem/fight_sys.go`ï¼Œä½¿ç”¨ `devent.Subscribe(OnSrvStart)` åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶æ³¨å†Œåè®®ï¼›æ›´æ–°å¼€å‘æ³¨æ„äº‹é¡¹ï¼Œæ˜ç¡®åè®®æ³¨å†Œè§„èŒƒ |
| 2025-11-24 | **åæ ‡ç³»ç»Ÿè§„èŒƒç»Ÿä¸€**ï¼šç»Ÿä¸€è§„èŒƒä¸ºå®¢æˆ·ç«¯åªå‘é€åƒç´ åæ ‡ï¼ŒæœåŠ¡ç«¯ç»Ÿä¸€è½¬æ¢ä¸ºæ ¼å­åæ ‡è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼›æ›´æ–°åè®®å®šä¹‰ã€ä»£ç æ³¨é‡Šå’Œå¼€å‘æ³¨æ„äº‹é¡¹ï¼Œæ˜ç¡®åæ ‡ç³»ç»Ÿè§„èŒƒ |
| 2025-11-24 | **åæ ‡ç³»ç»Ÿä¼˜åŒ–ï¼ˆå®Œæ•´ï¼‰**ï¼šå®Œæˆåæ ‡ç³»ç»Ÿä¼˜åŒ–å»ºè®®ç¬¬2-7é¡¹ï¼Œç§»åŠ¨ç³»ç»Ÿã€å¯»è·¯ç®—æ³•ã€åœºæ™¯ç³»ç»Ÿã€å®¢æˆ·ç«¯ã€åè®®å®šä¹‰ã€è·ç¦»å’ŒèŒƒå›´è®¡ç®—å…¨éƒ¨ä¼˜åŒ–å®Œæˆï¼›æœåŠ¡ç«¯ç»Ÿä¸€ä½¿ç”¨æ ¼å­åæ ‡è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼›å·²åœ¨å¼€å‘æ³¨æ„äº‹é¡¹ä¸­æ˜ç¡®åæ ‡ç³»ç»Ÿè§„èŒƒ |
| 2025-11-24 | **åæ ‡ç³»ç»Ÿä¼˜åŒ–ï¼ˆç§»åŠ¨/å¯»è·¯/åœºæ™¯ï¼‰**ï¼šå®Œæˆåæ ‡ç³»ç»Ÿä¼˜åŒ–å»ºè®®ç¬¬2ã€3ã€4é¡¹ï¼Œç§»åŠ¨ç³»ç»Ÿå®ç°å®¢æˆ·ç«¯åƒç´ åæ ‡åˆ°æ ¼å­åæ ‡çš„è‡ªåŠ¨è½¬æ¢ï¼Œè·ç¦»è®¡ç®—å’Œé€Ÿåº¦æ ¡éªŒåŸºäºæ ¼å­å¤§å°ï¼›å¯»è·¯ç®—æ³•æ˜ç¡®è¾“å…¥è¾“å‡ºä¸ºæ ¼å­åæ ‡ï¼›åœºæ™¯ç³»ç»Ÿç»Ÿä¸€ä½¿ç”¨æ ¼å­åæ ‡å¹¶æ·»åŠ è¯¦ç»†æ³¨é‡Š |
| 2025-11-24 | **åæ ‡ç³»ç»Ÿå®šä¹‰ä¸è½¬æ¢**ï¼šå®Œæˆåæ ‡ç³»ç»Ÿä¼˜åŒ–å»ºè®®ç¬¬1é¡¹ï¼Œåœ¨ `server/internal/argsdef/position.go` ä¸­æ·»åŠ æ ¼å­å¤§å°å¸¸é‡ï¼ˆTileSize=128ã€TileCenterOffset=64ï¼‰å’Œåæ ‡è½¬æ¢å‡½æ•°ï¼ˆTileCoordToPixelã€PixelCoordToTileã€IsSameTileï¼‰ï¼Œç»Ÿä¸€äº†åæ ‡ç³»ç»Ÿçš„å®šä¹‰å’Œä½¿ç”¨è§„èŒƒ |
| 2025-11-24 | æ—¥å¿—ç®¡ç†ä¼˜åŒ–ï¼š`server/pkg/log` æ–°å¢ç»“æ„åŒ–å­—æ®µ & ç¯å¢ƒçº§åˆ«æ§åˆ¶ï¼Œå®Œæˆ 11.2.9 |
| 2025-11-24 | ä¼˜åŒ–èµ„æºæ¸…ç†ï¼šForwardMessage æ± åŒ–ã€Gateway è½¬å‘é“¾è·¯é‡Šæ”¾æ¶ˆæ¯ï¼Œå®Œæˆ 11.2.7 èµ„æºæ¸…ç†æ£€æŸ¥ |
| 2025-11-21 | **ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–ä¿®å¤**ï¼šä¿®å¤æ—¶é—´è®¿é—®è§„èŒƒè¿åï¼ˆchat_sys.goã€session_mgr.goï¼‰ã€æ·»åŠ æ•°æ®åº“è¿æ¥æ± é…ç½®ã€åœ¨ Actor æ¶ˆæ¯å¤„ç†ä¸­æ·»åŠ  Panic æ¢å¤æœºåˆ¶ |
| 2025-11-20 | é‡æ–°æ¢³ç†æ–‡æ¡£ç»“æ„ï¼Œç®€åŒ–å·²å®ŒæˆåŠŸèƒ½æè¿°ï¼Œæ¸…ç†å¾…å®ç°ç« èŠ‚ï¼Œä¼˜åŒ–æ–‡æ¡£å¯è¯»æ€§ |
| 2025-11-21 | æ–°å¢ `server` è¡¨å­˜å‚¨å¼€æœä¿¡æ¯ï¼Œæä¾› `gshare.GetOpenSrvDay()`ï¼›ç»Ÿä¸€æ•°æ®åº“æ—¶é—´å­—æ®µä¸ºç§’çº§ Unix æ—¶é—´æˆ³ |
| 2025-11-20 | å®Œæˆ Phase 3 ç¤¾äº¤ç»æµç³»ç»Ÿï¼šèŠå¤©ã€å¥½å‹ã€æ’è¡Œæ¦œã€å…¬ä¼šã€æ‹å–è¡Œã€ç¤¾äº¤å®‰å…¨ç³»ç»Ÿå…¨éƒ¨å®Œæˆ |
| 2025-11-20 | å®Œæˆ Phase 3 ç¤¾äº¤ç»æµåŸºç¡€æ¡†æ¶ï¼šPublicActor æ¡†æ¶ã€Proto å®šä¹‰ã€EntitySystem åŸºç¡€ |
| 2025-11-17 | ä¾æ®å½“å‰ä»£ç è¡¥å…¨æ¶æ„è¯´æ˜ã€å·²å®ŒæˆåŠŸèƒ½ã€å…³é”®ä»£ç ä½ç½®ä¸æ³¨æ„äº‹é¡¹ |

---

## 11. ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–å»ºè®®ï¼ˆä¼˜å…ˆå¤„ç†ï¼‰

> ä»¥ä¸‹ä¼˜åŒ–é¡¹åŸºäºå¯¹ `server/service` ç›®å½•çš„ä»£ç å®¡æŸ¥ï¼Œå»ºè®®æŒ‰ä¼˜å…ˆçº§é€æ­¥å®æ–½ã€‚

### 11.1 å…³é”®é—®é¢˜ä¿®å¤ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

#### 1. æ—¶é—´è®¿é—®è§„èŒƒè¿å âœ… **å·²ä¿®å¤**
- **é—®é¢˜**ï¼šéƒ¨åˆ†ä»£ç ç›´æ¥ä½¿ç”¨ `time.Now()` è€Œé `servertime.Now()`
- **ä½ç½®**ï¼š
  - `server/service/gameserver/internel/playeractor/entitysystem/chat_sys.go:64` - `time.Now()` åº”æ”¹ä¸º `servertime.Now()`
  - `server/service/gateway/internel/clientnet/session_mgr.go:58,136,163` - `time.Now()` åº”æ”¹ä¸º `servertime.Now()`
- **å½±å“**ï¼šå¯èƒ½å¯¼è‡´å¤šæœåŠ¡æ—¶é—´ä¸åŒæ­¥ï¼Œå½±å“æ—¶é—´ç›¸å…³ä¸šåŠ¡é€»è¾‘
- **ä¿®å¤**ï¼šç»Ÿä¸€æ›¿æ¢ä¸º `servertime.Now()`ï¼Œç¡®ä¿æ‰€æœ‰æœåŠ¡ä½¿ç”¨ç»Ÿä¸€æ—¶é—´æº
- **ä¿®å¤è¯¦æƒ…**ï¼š
  - `chat_sys.go`: å°† `time.Now()` æ”¹ä¸º `servertime.Now()`ï¼Œ`time.Since()` æ”¹ä¸º `servertime.Since()`
  - `session_mgr.go`: å°†ä¸‰å¤„ `time.Now()` æ”¹ä¸º `servertime.Now()`

#### 2. æ•°æ®åº“è¿æ¥æ± é…ç½®ç¼ºå¤± âœ… **å·²ä¿®å¤**
- **é—®é¢˜**ï¼š`server/internal/database/database.go` ä¸­æœªé…ç½®è¿æ¥æ± å‚æ•°
- **å½±å“**ï¼šå¯èƒ½å¯¼è‡´è¿æ¥æ³„æ¼ã€æ€§èƒ½ç“¶é¢ˆ
- **ä¿®å¤**ï¼šå·²æ·»åŠ è¿æ¥æ± é…ç½®
  - æœ€å¤§æ‰“å¼€è¿æ¥æ•°ï¼š25
  - æœ€å¤§ç©ºé—²è¿æ¥æ•°ï¼š10
  - è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´ï¼š5åˆ†é’Ÿ
  - è¿æ¥æœ€å¤§ç©ºé—²æ—¶é—´ï¼š10åˆ†é’Ÿ
- **å…³é”®ä»£ç ä½ç½®**ï¼š`server/internal/database/database.go:22-32`

#### 3. Panic æ¢å¤æœºåˆ¶ç¼ºå¤± âœ… **å·²ä¿®å¤**
- **é—®é¢˜**ï¼šActor æ¶ˆæ¯å¤„ç†ã€goroutine ä¸­ç¼ºå°‘ panic æ¢å¤
- **å½±å“**ï¼šå•ä¸ª panic å¯èƒ½å¯¼è‡´æ•´ä¸ªæœåŠ¡å´©æºƒ
- **ä¿®å¤**ï¼šåœ¨ Actor æ¶ˆæ¯å¤„ç†å…¥å£ä½¿ç”¨ `routine.Run()` æ·»åŠ  panic æ¢å¤
- **ä¿®å¤è¯¦æƒ…**ï¼š
  - `actor_context.go`: åœ¨ `doMsgLogic` å’Œ `Loop()` è°ƒç”¨å¤„ä½¿ç”¨ `routine.Run()` åŒ…è£…ï¼Œç¡®ä¿ panic è¢«æ•è·å¹¶è®°å½•æ—¥å¿—
- **å…³é”®ä»£ç ä½ç½®**ï¼š`server/internal/actor/actor_context.go:114-143`

### 11.2 æ€§èƒ½ä¸ç¨³å®šæ€§ä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

#### 4. é…ç½®éªŒè¯ä¸é»˜è®¤å€¼ âœ… **å·²å®Œæˆ**
- **æ”¹åŠ¨**ï¼šGateway/GameServer/DungeonServer ä¸‰ä¸ªæœåŠ¡åœ¨é…ç½®åŠ è½½é˜¶æ®µç»Ÿä¸€è¡¥é½é»˜è®¤å€¼å¹¶åšä¸¥æ ¼æ ¡éªŒ
- **ç»†èŠ‚**ï¼š
  - `server/service/gateway/internel/engine/config.go`ï¼šæ ¡éªŒ TCP/WS åœ°å€ã€ä¼šè¯ç¼“å†²åŒºã€å¸§å¤§å°å¹¶æä¾›é»˜è®¤å€¼
  - `server/service/gameserver/internel/config/config.go`ï¼šæ ¡éªŒ `app_id/platform_id/srv_id`ã€Actor é…ç½®åŠ `dungeon_server_addr_map`
  - `server/service/dungeonserver/internel/config/config.go`ï¼šæ ¡éªŒç›‘å¬åœ°å€ã€Actor é‚®ç®±ï¼Œé»˜è®¤ `srv_type=1`
- **æ”¶ç›Š**ï¼šé…ç½®é”™è¯¯åœ¨å¯åŠ¨å‰å³è¢«æ•è·ï¼Œé¿å…å› ç«¯å£/ç¼“å†²åŒºå¼‚å¸¸å¯¼è‡´çº¿ä¸Šå´©æºƒ

#### 5. é”™è¯¯å¤„ç†ä¸æ—¥å¿—æ”¹è¿› âœ… **å·²å®Œæˆ**
- **æ”¹åŠ¨**ï¼š
  - æ–°å¢ `gshare/log_helper.go`ï¼Œè‡ªåŠ¨åœ¨æ—¥å¿—å‰ç¼€é™„å¸¦ `sessionId/roleId`
  - ç™»å½•/æ³¨å†Œ/è¿›å…¥æ¸¸æˆ/åè®®è½¬å‘ç­‰è·¯å¾„ç»Ÿä¸€ä½¿ç”¨ä¸Šä¸‹æ–‡æ—¥å¿—ï¼ˆ`player_network.go`ï¼‰
- **æ”¶ç›Š**ï¼šæ—¥å¿—å¯ä»¥ç›´æ¥å®šä½ç©å®¶ä¸åè®®ï¼Œæ’éšœæ•ˆç‡æ˜¾è‘—æå‡

#### 6. ä¼˜é›…å…³é—­å®Œå–„ âœ… **å·²å®Œæˆ**
- **æ”¹åŠ¨**ï¼š
  - `manager/role_mgr.go` æ–°å¢ `FlushAndSave`ï¼Œé€ä¸ªç©å®¶è½åº“å¹¶æ”¯æŒè¶…æ—¶
  - `gameserver/main.go` åœ¨åœæ­¢ PlayerActor åè°ƒç”¨ Flushï¼Œç¡®ä¿æ‰€æœ‰ç©å®¶çŠ¶æ€ä¿å­˜å®Œæˆ
- **æ”¶ç›Š**ï¼šåœæœè¿‡ç¨‹ä¸ä¼šä¸¢å¤±ç©å®¶æ•°æ®ï¼Œå…³é—­æ—¥å¿—æ›´æ¸…æ™°å¯è¿½æº¯

#### 7. èµ„æºæ¸…ç†æ£€æŸ¥ âœ… **å·²å®Œæˆ**
- **æ”¹åŠ¨**ï¼š
  - `network/codec.go` ç»Ÿä¸€ä½¿ç”¨ `ForwardMessage` å¯¹è±¡æ± ï¼Œå¹¶åœ¨è§£ç é˜¶æ®µå¤åˆ¶ payloadï¼Œé¿å…ä¸åº•å±‚ socket buffer å…±äº«å†…å­˜
  - `network/message.go` è°ƒæ•´ `ForwardMessage.Reset()`ï¼Œä»…é‡ç½®é•¿åº¦ï¼Œä¿ç•™åº•å±‚ç¼“å†²ä»¥å¤ç”¨
  - `gateway/internel/gameserverlink/game_cli.go` å½“æ¥æ”¶é€šé“æ»¡æˆ–ä¸¢å¼ƒæ¶ˆæ¯æ—¶åŠæ—¶å½’è¿˜ `ForwardMessage`
  - `gateway/internel/engine/server.go` æ´¾å‘å®Œæˆåæ˜¾å¼ `PutForwardMessage`ï¼Œç¡®ä¿æ‰€æœ‰æ¶ˆæ¯å‡å›æ”¶åˆ°æ± ä¸­
- **æ”¶ç›Š**ï¼šè½¬å‘è·¯å¾„ä¸Šçš„ buffer ä¸ `ForwardMessage` å¯¹è±¡ä¸å†æ³„æ¼æˆ–å¤ç”¨å¼‚å¸¸ï¼Œé•¿æ—¶é—´è¿è¡Œå†…å­˜å ç”¨ç¨³å®š

### 11.3 ç›‘æ§ä¸å¯è§‚æµ‹æ€§ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

#### 8. æ€§èƒ½ç›‘æ§æŒ‡æ ‡
- **å»ºè®®**ï¼š
  - æ¶ˆæ¯å¤„ç†å»¶è¿Ÿç»Ÿè®¡ï¼ˆP50/P95/P99ï¼‰
  - æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ç»Ÿè®¡
  - Actor æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦ç›‘æ§
  - è¿æ¥æ•°ã€Session æ•°ç›‘æ§
  - å†…å­˜ä½¿ç”¨ç›‘æ§
  - å¯è€ƒè™‘é›†æˆ Prometheus + Grafana

#### 9. æ—¥å¿—ç®¡ç†ä¼˜åŒ– âœ… **å·²å®Œæˆ**
- **æ”¹åŠ¨**ï¼š
  - `server/pkg/log` æ–°å¢ `Fields` / `WithFields` / `InfofWithFields` ç­‰æ¥å£ï¼Œæ”¯æŒç»“æ„åŒ– `key=value` æ—¥å¿—
  - æ”¯æŒ `LOG_LEVEL` / `LOG_COLOR` ç¯å¢ƒå˜é‡ä¸ `WithColor()` Optionï¼Œå¯åœ¨ç”Ÿäº§ç¯å¢ƒå…³é—­ Debug æˆ–å½©è‰²è¾“å‡º
  - é»˜è®¤æ—¥å¿—çº§åˆ«ä¸º Infoï¼ˆå¯è¿è¡ŒæœŸ `SetLevel` è°ƒæ•´ï¼‰ï¼ŒFATAL/ERROR ç­‰å…³é”®æ—¥å¿—ä¹Ÿå¯æºå¸¦å­—æ®µ
- **æ”¶ç›Š**ï¼šæ—¥å¿—æ ¼å¼ä¸çº§åˆ«ç”±é…ç½®é©±åŠ¨ï¼Œå…³é”®è·¯å¾„å¯è¾“å‡ºä¸Šä¸‹æ–‡å­—æ®µï¼Œæ»¡è¶³æ’éšœä¸å®¡è®¡éœ€æ±‚

### 11.4 å®‰å…¨æ€§å¢å¼ºï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

#### 10. è¾“å…¥éªŒè¯åŠ å¼º
- **å»ºè®®**ï¼š
  - æ‰€æœ‰å®¢æˆ·ç«¯è¾“å…¥è¿›è¡Œä¸¥æ ¼éªŒè¯
  - æ•°å€¼èŒƒå›´æ£€æŸ¥ï¼ˆé˜²æ­¢æº¢å‡ºï¼‰
  - å­—ç¬¦ä¸²é•¿åº¦é™åˆ¶
  - æ•æ„Ÿæ“ä½œé¢‘ç‡é™åˆ¶

#### 11. æ•°æ®åº“æ“ä½œä¼˜åŒ–
- **å»ºè®®**ï¼š
  - ä¸ºæ‰€æœ‰æ•°æ®åº“æ“ä½œæ·»åŠ è¶…æ—¶è®¾ç½®
  - æ£€æŸ¥æ˜¯å¦æœ‰ N+1 æŸ¥è¯¢é—®é¢˜
  - å…³é”®æ“ä½œæ·»åŠ äº‹åŠ¡ä¿æŠ¤
  - å®šæœŸæ£€æŸ¥æ…¢æŸ¥è¯¢

#### 12. TLS/SSL æ”¯æŒ
- **é—®é¢˜**ï¼šæ–‡æ¡£ä¸­æåˆ° WebSocket/TCP å°šæœªåŠ  TLS/é‰´æƒ
- **å»ºè®®**ï¼š
  - ç”Ÿäº§ç¯å¢ƒå¿…é¡»å¯ç”¨ TLS
  - å®ç°å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯ï¼ˆå¯é€‰ï¼‰

### 11.5 åŠŸèƒ½å®Œå–„ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

#### 13. é…ç½®çƒ­é‡è½½
- **å»ºè®®**ï¼šå®ç°é…ç½®çƒ­é‡è½½æœºåˆ¶ï¼Œæ— éœ€é‡å¯æœåŠ¡å³å¯æ›´æ–°éƒ¨åˆ†é…ç½®

#### 14. å¥åº·æ£€æŸ¥æ¥å£
- **å»ºè®®**ï¼šæ·»åŠ  HTTP å¥åº·æ£€æŸ¥æ¥å£ï¼Œç”¨äºè´Ÿè½½å‡è¡¡å’Œç›‘æ§

#### 15. æ•°æ®å¤‡ä»½æœºåˆ¶
- **å»ºè®®**ï¼š
  - å®šæœŸè‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
  - å®ç°æ•°æ®æ¢å¤æµç¨‹
  - å…³é”®æ•°æ®æ“ä½œå‰å¤‡ä»½ï¼ˆå¯é€‰ï¼‰

### 11.6 ä»£ç è´¨é‡ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

#### 16. å•å…ƒæµ‹è¯•è¦†ç›–
- **å»ºè®®**ï¼šä¸ºæ ¸å¿ƒä¸šåŠ¡é€»è¾‘æ·»åŠ å•å…ƒæµ‹è¯•

#### 17. é›†æˆæµ‹è¯•
- **å»ºè®®**ï¼šæ·»åŠ ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•

#### 18. ä»£ç æ–‡æ¡£
- **å»ºè®®**ï¼šè¡¥å……å…³é”®å‡½æ•°å’Œå¤æ‚é€»è¾‘çš„æ³¨é‡Š

---

## 12. ä¸‹ä¸€æ­¥å»ºè®®

1. ~~**ç«‹å³ä¿®å¤**ï¼šæ—¶é—´è®¿é—®è§„èŒƒè¿åï¼ˆ11.1.1ï¼‰ã€æ•°æ®åº“è¿æ¥æ± é…ç½®ï¼ˆ11.1.2ï¼‰ã€Panic æ¢å¤æœºåˆ¶ï¼ˆ11.1.3ï¼‰~~ âœ… **å·²å®Œæˆ**
2. ~~**çŸ­æœŸä¼˜åŒ–**ï¼šé…ç½®éªŒè¯ï¼ˆ11.2.4ï¼‰ã€é”™è¯¯å¤„ç†æ”¹è¿›ï¼ˆ11.2.5ï¼‰ã€ä¼˜é›…å…³é—­å®Œå–„ï¼ˆ11.2.6ï¼‰~~ âœ… **å·²å®Œæˆ**
3. **ä¸­æœŸå»ºè®¾**ï¼šæ€§èƒ½ç›‘æ§ï¼ˆ11.3.8ï¼‰ã€å®‰å…¨æ€§å¢å¼ºï¼ˆ11.4ï¼‰
4. **é•¿æœŸå®Œå–„**ï¼šåŠŸèƒ½å®Œå–„ï¼ˆ11.5ï¼‰ã€ä»£ç è´¨é‡ï¼ˆ11.6ï¼‰
5. å®Œæˆ **é˜²ä½œå¼Šæ¥å…¥** ä¸ **æŠ€èƒ½ç»“æœç›‘æ§**ï¼Œä¿éšœ PvE ä½“éªŒ
6. æ–°å¢/ä¿®æ”¹ç³»ç»Ÿåï¼Œç«‹å³æ›´æ–°æœ¬æ–‡ä»¶çš„"å·²å®ŒæˆåŠŸèƒ½""å…³é”®ä»£ç ä½ç½®""å¾…å®ç°"ä¸"æ³¨æ„äº‹é¡¹"
