## 0. 开发必读（精简版）

- 本文件是服务端进度与决策的权威简表；需要细节看 `docs/服务端开发进度文档_full.md`。
- 开发完成：把条目放进「已完成功能」，并在「关键代码位置」补入口。
- 仍需分期：写进「待实现 / 待完善功能」并用复选框拆子项。
- 发现新的全局约束或坑：写进「开发注意事项与架构决策」。
- 不在此处堆函数级细节，保持便于复盘/交接。

---

## 1. 当前架构概览

- 服务划分
  - `gateway`：TCP/WS 接入、Session 生命周期、消息转发、限流。
  - `gameserver`：玩家主逻辑，一玩家一 Actor；内置单 Actor `DungeonActor` 负责战斗/副本。
- 通信
  - Gateway → GameServer：`ForwardMessage` + Session 事件。
  - PlayerActor ↔ DungeonActor：`gshare.IDungeonActorFacade` 内部消息（`DungeonActorMsgId` / `PlayerActorMsgId`），禁止阻塞调用。
- 数据
  - 玩家状态：`PlayerRoleBinaryData`（SQLite + GORM）。
  - 现阶段无 PublicActor，全局社交/经济待重建。
- 架构
  - 按 Clean Architecture 分层：Controller 解析与检查 → UseCase/Service 做业务 → Presenter 回包；SystemAdapter 只管生命周期与事件。

---

## 2. 已完成功能（关键块）

### 2.1 Gateway
- TCP + WebSocket 接入、Session 管理、ForwardMessage 转发、基础限流。

### 2.2 GameServer 核心基线（2025-12-23 后重置版）
- 账号 / 角色：注册、登录、角色创建/进入游戏，Session 带账号/角色信息。
- Actor 框架：每玩家单 Actor，SystemRegistry 仅挂载 `Level`、`Skill` 系统；定期落盘、无锁单线程。
- 协议入口：`player_account_controller`、`player_role_controller`、`move_controller`（转发至 DungeonActor）、`controller/skill_controller.go`。
- 依赖聚合：`playeractor/deps` 同时提供 Runtime + 工厂（gateway/repo），Context 取值统一在 `gshare/context_helper.go`。
- Dungeon 路由：`gshare.SendDungeonMessageAsync` 转发移动/技能等请求；PlayerActorMsg 路由在 `player_network_controller.go`。
- 瘦身：移除未用的 PublicActor 网关/事件发布器占位与多余玩家事件枚举，PlayerActor 运行时依赖保持最小；补齐 `DAMEnterGame` 处理并直接落默认场景/副本；删除未使用的 message registry/dispatcher，技能控制器归一到 `controller` 目录；额外删除与 proto 无关的怪物/AI/寻路/掉落接口，DungeonActor 仅承载玩家 AOI/移动/技能转发；配置层仅保留 `job/skill/scene/map`，删除 item/level/monster/monsterscene 配置与结构体。
- 技能定义：技能命中/施法结果结构迁移到 `proto/csproto/skill_def.proto` 生成，skill 包移除 Cast/HitResult 本地结构并精简 FightSys 未用字段。

### 2.3 DungeonActor（战斗/副本引擎）
- 单 Actor 主循环，包含场景、AOI、移动、战斗、技能、属性聚合等基础系统（已移除怪物、AI、寻路、掉落相关逻辑）。
- 坐标与移动：客户端上送像素坐标，服务端统一转格子坐标校验；Start/Update/EndMove 流程及容错。
- 副本骨架：房间管理、默认副本（限时副本 provider 已移除）；内部消息通过 `DungeonActorMsgId` / `PlayerActorMsgId` 交互。

### 2.4 共享基础
- Actor 框架、事件总线、servertime、日志、Proto、gatewaylink 透传。

### 2.5 调试客户端
- 示例客户端对齐当前 `cs/sc.proto`：仅保留注册/登录/角色/移动/技能命令，移除背包、GM、副本与脚本录制等旧命令。

---

## 3. 待实现 / 待完善功能（抓大不抓小）

- [ ] 按新骨架重建玩法/经济系统：Bag/Money/Equip/Fuben/Recycle/Quest/Shop/GM/AntiCheat 等，直接用现有分层，不做旧接口兼容。
- [ ] 重新引入 PublicActor 与社交（好友/公会/排行/拍卖/离线快照），全部经 Gateway → PlayerActor → PublicActor 消息链。
- [ ] Controller 层系统开启检查与 UseCase 单测补齐（现仅 Level/Skill）。
- [ ] 玩家消息系统 Phase4：监控与过期策略，防止消息表膨胀。
- [ ] Gateway 接入安全与 GM 权限/审计：生产环境 IP/Origin 校验、签名/Token、审计日志。
- [ ] 多人副本匹配与战斗录像（规划阶段，待骨架稳定后推进）。
- [ ] 调试客户端扩展：多 Session/脚本化战斗回放，与新协议保持同步。

---

## 4. 开发注意事项与架构决策（高频必看）

- Actor 约束：玩家状态只能在 PlayerActor 线程修改；DungeonActor 单线程；禁止业务 goroutine 直改玩家数据。
- 统一时间：所有业务使用 `server/internal/servertime`，DB 时间字段写 Unix 秒；禁止直接 `time.Now()`。
- 控制器职责：解析 + 权限/系统开关检查 + 调用 UseCase/Service；回包必经 Presenter。
- S2C 发送链路：任何下行都经 PlayerActor → `gatewaylink`，其它 Actor 禁止直发。
- 协议注册：集中在 `playeractor/router/protocol_registry.go` 与 `controller` 内的注册，DungeonActor 不处理 C2S。
- 接口归一：端口接口集中在 `server/service/gameserver/internel/iface`，新增接口一律放这里。
- 坐标规范：服务端一律用格子坐标做校验/寻路/范围，客户端上送像素坐标，转换在服务端完成。
- 历史兼容已移除：不再保留旧 entitysystem 玩法代码和过渡 wrapper，新增功能直接按现有分层重写。
- 配置约束：`server/internal/jsonconf` 仅加载 `job/skill/scene/map` 四类；`server/output/config` 必须至少包含同名四个 json，其他配置文件已移除。
- 技能结果：SkillCastResult/SkillHitResult 等统一由 `skill_def.proto` 定义，不在逻辑层重复声明。
- 停服流程：收到退出信号先发布 `OnSrvStop` 事件，再对所有在线玩家执行 OnDisconnect/Close 并移除 Actor，最后批量落盘。
- DungeonActor 仅支持 `ModeSingle`，配置错误直接拒绝启动。

---

## 5. 关键代码位置（入口级）

- Gateway：`server/service/gateway/internel/{clientnet,engine}`。
- GameServer 入口：`server/service/gameserver/main.go`、`internel/engine/*`、`internel/gatewaylink/*`。
- PlayerActor：`internel/playeractor/{adapter.go,handler.go}`、`controller/{player_account_controller.go,player_role_controller.go,move_controller.go,skill_controller.go}`、`router/protocol_registry.go`、`register/register.go`、`runtime/runtime.go`、`deps/deps.go`、系统注册 `entitysystem/{sys_mgr.go,system_registry.go}`、`level/*`、`skill/*`、`sysbase/base_system.go`。
- DungeonActor：`internel/dungeonactor/{adapter.go,handler.go,register.go}`、`entity/*`、`entitysystem/*`、`scene/*`、`scenemgr/*`、`fbmgr/*`、`fuben/*`、`skill/*`、`iface/*`。
- 基础库：`server/internal/{actor,servertime,jsonconf,argsdef}`、日志 `server/pkg/log`。
- 调试客户端：`server/example/cmd/example`、`server/example/internal/{client,panel,systems}`。

---

## 6. 其它文档索引

- 详细进展与实现摘要：`docs/服务端开发进度文档_full.md`
- Clean Architecture/目录说明（参考用）：`docs/gameserver_CleanArchitecture重构实施手册.md`、`docs/gameserver_目录与调用关系说明.md`


