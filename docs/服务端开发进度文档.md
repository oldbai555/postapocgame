# 游戏服务器开发进度文档（单一权威版本）

更新时间：2025-11-20  
责任人：个人独立开发  

> ⚠️ 自本次更新起，原 `docs/Phase3社交经济架构设计方案.md` 已完全整合到本文，未来所有开发、评审与交接均以本文件为唯一权威信息源。请在每次开发前完整阅读第 0 章与第 7 章，完成新功能后同步“已完成功能 / 待实现 / 注意事项 / 关键代码位置”四个章节。

---

## 0. 开发必读

- **先读后写**：任何新任务开始前必须先阅读“服务器架构”“开发注意事项与架构决策”以及“Phase 3 社交经济一体化方案”，确保遵循 Actor/无锁约束与既定数据规范。  
- **文档同步规则**：新功能上线后，将条目上移至“已完成功能”，补充实现细节，并在“关键代码位置”登记入口；若功能仍需分阶段推进，需在“待实现 / 待完善功能”拆分子项。  
- **架构决策记录**：任何重要结构或跨模块约束，均记录在第 7 章；若涉及流程或数据流转变更，请同步绘制在第 5 章相关子节。  
- **关键代码位点**：发现新的核心入口、易踩坑逻辑、隐含约束时立即更新第 6 章，避免知识散落。  
- **阶段性需求拆分**：遇到大需求需分多迭代交付时，将剩余工作写入第 5 章对应小节，并标注前置依赖/完成标准。
- **时间访问规范**：除 proto/第三方库外，所有服务端业务代码必须通过 `server/internal/servertime` 获取时间；禁止直接调用 `time.Now()`、`time.Since()` 等标准库接口，以保证多服务统一时间与可配置偏移。

---

## 1. 项目概述

- **项目名称**：postapocgame（后启示录横版动作）  
- **客户端**：Godot（计划中），运行于 Windows / Android / iOS  
- **服务器语言**：Golang 1.24.10（`go 1.24` toolchain）  
- **服务集合**：`gateway`、`gameserver`、`dungeonserver` 单仓管理  
- **数据层**：SQLite（`server/output/postapocgame.db`）+ GORM，所有玩家数据落于 `PlayerRoleBinaryData`  
- **配置驱动**：`server/output/config/*.json` 26+ 表；需存在于输出目录方可启动  
- **目标部署**：开发使用 Windows；线上兼容 Windows/Linux

---

## 2. 服务器架构

### 2.1 服务划分

| 服务            | 职责                                                                 | 关键目录 |
| --------------- | -------------------------------------------------------------------- | -------- |
| Gateway         | TCP/WS 接入、Session 生命周期、消息压缩/分发、限流、日志             | `server/service/gateway` |
| GameServer      | 玩家长连接逻辑（任务、成长、经济、社交、公会、GM），一玩家一 Actor    | `server/service/gameserver` |
| DungeonServer   | 副本/战斗/掉落/技能状态机，单 Actor 驱动                              | `server/service/dungeonserver` |
| Shared Packages | Actor 框架、事件、网络编解码、Proto、配置、日志、错误码              | `server/internal`, `server/pkg`, `proto/` |

### 2.2 拓扑与通信

```
Client (TCP / WebSocket)
      |
Gateway (SessionManager + ClientHandler)
      | ForwardMessage / SessionEvent
GameServer (per-player Actor + PublicActor)
      | Async RPC (dungeonserverlink / gameserverlink)
DungeonServer (single Actor dungeon runtime)
```

- **会话分发**：Gateway 维护 Session，所有 C2S 消息封装为 `ForwardMessage` 异步转发到 GameServer；Session 事件通过 `gameserverlink` 广播。  
- **Actor 调度**：GameServer 使用 `actor.ModePerKey`（key=SessionId）；`PlayerHandler.Loop()` 通过 `actorCtx.ExecuteAsync` 注入 `gshare.DoRunOneMsg`，确保所有系统 RunOne 在 Actor 主线程执行。  
- **跨服 RPC**：GameServer ↔ DungeonServer 间统一使用 `dungeonserverlink.AsyncCall` 与 `gameserverlink` 注册回调，禁止同步阻塞。  
- **数据持久化**：玩家系统数据序列化为 `protocol.PlayerRoleBinaryData`，落库字段 `Player.BinaryData`；全局数据（公会/拍卖行等）将由 PublicActor 驱动持久化（见第 5 章）。  
- **公共 Actor**：GameServer 内包含 `PublicActor`（单 Actor）用于社交经济全局数据、在线映射、排行榜等逻辑。

---

## 3. 构建与运行现状

- **Go 版本**：`go 1.24.0`，toolchain `1.24.10`。  
- **最新可执行文件**：  
  - `go build -o server/output/gameserver.exe ./server/service/gameserver`  
  - `go build -o server/output/dungeonserver.exe ./server/service/dungeonserver`  
  - `gateway.exe` 已存在历史构建产物  
- **配置**：`server/output/{gateway,gamesrv,dungeonsrv}.json` + `server/output/config/*.json` 必须齐备。  
- **数据库**：`server/output/postapocgame.db` 随 GameServer 自动迁移，表定义位于 `server/internal/database/*.go`。  
- **日志**：各服务默认输出到 `server/output/log/<service>.log`，同时打印至控制台。  
- **启动顺序建议**：DungeonServer → GameServer → Gateway → 客户端。

---

## 4. 已完成功能

> 若新增子系统或完成阶段性能力，请在对应子节补充实现细节，并描述关键入口/注意事项。

### 4.1 Gateway（接入层）

- 双协议接入：TCP（`engine/server.go`）+ WebSocket（`engine/config.go`）。  
- Session 生命周期：`clientnet.SessionManager` 负责创建、心跳、超时、幂等关闭，并通过 `gameserverlink.NotifySessionEvent` 同步 GameServer。  
- 消息转发：`clientnet.ClientHandler` 负责 `network.Message` ↔ `ForwardMessage` 转换，维护 per-session 发送协程、错误回退与重试。  
- 限流与资源保护：最大连接数、发送缓冲、`MaxFrameSize`、超时清理可配置。  
- 日志与监控：统一使用 `pkg/log`，后续可接 APM。

### 4.2 GameServer（玩家主逻辑）

**账号 / 角色 / Session**

- `entity/player_network.go` 完成注册、登录、Token（bcrypt + `database.Account`）。  
- 角色创建/删除/查询/进入游戏流程完整，账号最多 3 角色。  
- Session 扩展：`server/internal/argsdef/session.go` 增补 AccountID/Token，所有协议依赖 SessionId 路由。

**玩家 Actor 与系统框架**

- `playeractor.NewPlayerRoleActor(actor.ModePerKey)`；`PlayerRole` 负责生命周期、事件、BinaryData 加载/保存、跨服务 RPC。  
- `entitysystem.SysMgr` 动态注册所有子系统，`OnInit` 中直接持有 `PlayerRoleBinaryData` 引用，无锁运行。  
- `gshare.DoRunOneMsg` 在 Handler 循环内执行，RunOne 处理属性增量、定期存盘、时间维度事件（小时/天/周/月/年）。  
- `gevent` 事件总线已注册登录、登出、物品增减等事件，可扩展。

**统一时间与服务器广播**

- `server/internal/servertime` 为 GameServer/DungeonServer 提供统一 UTC 时间源，支持偏移校准，所有系统刷新与冷却均依赖此包，不再直接调用 `time.Now()`。  
- `internel/timesync.Broadcaster` 每秒扫描在线玩家，通过 `S2CTimeSync` 从 GameServer 向所有客户端广播权威服务器毫秒时间，跨天/跨小时逻辑以此为准。

**成长 / 经济 / 玩法系统**

- 背包、货币、装备、属性、等级、VIP、任务（日/周）、活跃度、成就、商城、物品使用、回收、离线收益、GM、反作弊（频率/封禁管理）全部上线。  
- 副本协作：`FubenSys`、`SkillSys`、`dungeonserverlink` 负责副本进入、技能同步、掉落拾取（DungeonServer RPC → BagSys 校验容量）。  
- JSON 配置热加载：`internal/jsonconf/ConfigManager` 支持变更后 `LoadAllConfigs`。

### 4.3 DungeonServer（副本与战斗）

- 单 Actor 主循环（`dungeonactor` + `entitymgr`），`fbmgr` 支持常驻/限时副本共存。  
- 实体层：`entity/role`、`entity/monster`、`entity/drop_item`、`scene/scenest.go`（AOI）。  
- 状态与战斗：`entitysystem/state_machine.go`、`buff_sys.go`、`ai_state.go`、`skill/skill_damage_calculator.go`、`fight_sys.go`。  
- 技能释放校验：`skill.Skill.Use` 在读取配置后若 `skillCfg.Effects` 为空立即返回 `ErrSkillCannotCast`，阻断无效技能释放。
- 移动同步：`clientprotocol/movement_handler.go` + `entitysystem/move_sys.go` + `aoi_sys.go`，具备速度校验、异常回滚、坐标同步。  
- 副本/掉落/复活/场景切换/属性同步（`entitysystem/attr_sys.go`）已成体系。  
- RPC 链路：`gameserverlink` 注册心跳、异步回调，DungeonServer 启动时 `SetDungeonSrvType`。
- 技能广播：`entitysystem.FightSys` 成功释放后立即计算唯一一段伤害/效果，`SendSkillCastAck` 广播释放成功（已移除 `castSeq`），`ApplySkillHits` 直接结算命中并推送 `S2CSkillDamageResult`（`BatchIndex=0`），`SkillHitResult.DamageFlags` 以 bit 标识物理/魔法/真实/治疗类型，客户端收到释放/伤害包后自行驱动动画帧。

### 4.4 共享基础能力

- `server/internal/actor`：ModeSingle / ModePerKey、MailBox、上下文。  
- `server/internal/network`：消息编解码、压缩、连接池、WS 适配。  
- `server/internal/servertime`：权威时间源、毫秒偏移/测试注入、`Now/UnixMilli/Since` 等封装。  
- `server/internal/event`：Bus + Event Type。  
- Proto 体系：`proto/csproto/*.proto` + `proto/genproto.sh`。  
- 工具：`pkg/log`、`pkg/customerr`、`pkg/tool`、`server/internal/json.go`。  
- Script：`scripts/git.sh` 提供仓库操作。

---

## 5. Phase 3 社交经济一体化方案（原 Phase3 文档）

### 5.1 范围与阶段

Phase 3 覆盖四大功能：聊天、好友/公会、拍卖行、排行榜。实施顺序建议：  
1. PublicActor 框架稳定 + 在线状态管理 + 数据持久化基建  
2. 聊天系统（世界/私聊）  
3. 好友系统（含在线状态、申请流程）  
4. 排行榜（快照 + Value）  
5. 公会系统（含权限、成员、持久化）  
6. 拍卖行（含物品交付、过期处理）

### 5.2 架构原则

**PublicActor 职责**

1. 全局数据管理：公会、拍卖行、排行榜等权威数据。  
2. 跨玩家消息路由：聊天、好友请求、公会审批等。  
3. 在线状态管理：`roleId → SessionId` 映射。  
4. 快照缓存：角色展示、排行榜展示数据。  
5. 数据持久化：公会与拍卖行必须落库（推荐独立表）。  

**PlayerActor 职责**

1. 管理自身数据：好友、公会归属、拍卖上架记录均存于 `PlayerRoleBinaryData`。  
2. EntitySystem 承载业务：`FriendSys`、`GuildSys`、`AuctionSys` 均在 `entitysystem` 目录实现。  
3. 数据更新 → 主动通知 PublicActor（排行榜数值、快照、在线状态）。  
4. 客户端协议入口：接入请求、做合法性校验、转发/回调 PublicActor。

**协作模式**

```
客户端
  ↓
PlayerActor（校验 + 防刷）
  ↓
PublicActor（全局逻辑 / 数据持久化）
  ↓
PlayerActor（通知/回写）
  ↓
客户端
```

### 5.3 Proto 与数据定义（需逐步落地）

> 修改 Proto 后务必运行 `proto/genproto.sh && gofmt`.

- `proto/csproto/social_def.proto`

```
enum ChatType { ChatTypeNil=0; ChatTypeWorld=1; ChatTypePrivate=2; ChatTypeGuild=3; ChatTypeTeam=4; }

message ChatMessage {
  ChatType chat_type = 1;
  uint64   sender_id = 2;
  string   sender_name = 3;
  uint64   target_id = 4;
  string   content = 5;
  int64    timestamp = 6;
}

enum RankType { RankTypeNil=0; RankTypeRoleCombatPower=1; RankTypeRoleLevel=2; RankTypeGuildCombatPower=3; }

message RankItem { int64 key = 1; int64 value = 2; }
message RankData { RankType rank_type = 1; repeated RankItem items = 2; int64 updated_at = 3; }
message PlayerRankSnapshot {
  uint64 role_id = 1; string role_name = 2; uint32 job = 3; uint32 sex = 4;
  uint32 level = 5; int64 combat_power = 6; string avatar = 7;
  map<uint32,uint32> fashion = 8; int64 updated_at = 9;
}

enum GuildPosition { GuildPositionNil=0; GuildPositionMember=1; GuildPositionViceLeader=2; GuildPositionLeader=3; }
message GuildMember { uint64 role_id=1; uint32 position=2; int64 join_time=3; }
message GuildData {
  uint64 guild_id=1; string guild_name=2; uint64 creator_id=3; uint32 level=4;
  int64 create_time=5; repeated GuildMember members=6; string announcement=7;
}

message AuctionItem {
  uint64 auction_id=1; uint32 item_id=2; uint32 count=3; int64 price=4;
  uint64 seller_id=5; int64 expire_time=6; int64 create_time=7;
}
```

- `proto/csproto/system.proto`

```
message SiFriendData { repeated uint64 friend_list = 1; repeated uint64 friend_request_list = 2; }
message SiGuildData { uint64 guild_id = 1; uint32 position = 2; int64 join_time = 3; }
message SiAuctionData { repeated uint64 auction_id_list = 1; }
```

- `proto/csproto/player.proto`

```
message PlayerRoleBinaryData {
  // ... existing fields ...
  SiFriendData friend_data = 17;
  SiGuildData  guild_data  = 18;
  SiAuctionData auction_data = 19;
}
```

- `proto/csproto/rpc.proto`（内部 Actor 消息）

```
message RegisterOnlineMsg { uint64 role_id = 1; string session_id = 2; }
message UnregisterOnlineMsg { uint64 role_id = 1; }
message ChatWorldMsg { uint64 sender_id = 1; string sender_name = 2; string content = 3; }
message ChatPrivateMsg { uint64 sender_id = 1; uint64 target_id = 2; string content = 3; }
message AddFriendReqMsg { uint64 requester_id = 1; uint64 target_id = 2; }
message CreateGuildMsg { uint64 creator_id = 1; string guild_name = 2; }
message AuctionPutOnMsg { uint64 seller_id=1; uint32 item_id=2; uint32 count=3; int64 price=4; int64 duration=5; }
message UpdateRankSnapshotMsg { uint64 role_id = 1; PlayerRankSnapshot snapshot = 2; }
message UpdateRankValueMsg { RankType rank_type = 1; int64 key = 2; int64 value = 3; }
message QueryRankReqMsg { RankType rank_type = 1; int32 top_n = 2; string requester_session_id = 3; }
```

### 5.4 公共功能设计

#### 聊天系统

- 数据：PublicActor 持有在线 map；`ChatMessage` 记录必要信息；可扩展队伍/公会频道。  
- 世界聊天流程：PlayerActor 校验频率/敏感词 → `ChatWorldMsg` → PublicActor 广播 `ChatBroadcastMsg` 给所有在线 PlayerActor → 客户端。  
- 私聊流程：PlayerActor 校验目标 → `ChatPrivateMsg` → PublicActor 查 Session → 转发给目标 PlayerActor；可选离线存储。  
- 重点：PlayerActor 内做频率与过滤；PublicActor 负责日志/风控钩子。

#### 好友 / 公会框架

- 好友：`FriendSys` 读写 `SiFriendData`；PublicActor 维护在线状态及好友展示所需快照。  
- 添加流程：PlayerActor 校验 → `AddFriendReqMsg` → PublicActor 查目标 → 将请求转发给目标 PlayerActor → 对方同意/拒绝 → 双方更新 BinaryData 并同步。  
- 列表查询：PlayerActor 发送好友 ID 列表 → PublicActor 汇总在线状态 + 快照 → 返回。  
- 公会：PublicActor 为权威数据源（`GuildData` + 成员列表 + 权限）；PlayerActor `GuildSys` 仅保存归属、职位、加入时间。  
- 创建/加入/审批流程：均通过 PublicActor 进行唯一性校验与成员更新，再异步通知相关 PlayerActor。  
- 公会数据持久化：建议 `server/internal/database/guild.go` 新增逻辑，启动时加载至 PublicActor。

#### 拍卖行

- PublicActor 存放 `AuctionItem` 列表 + 索引；数据需持久化（推荐独立表 `AuctionItem`）。  
- 上架：PlayerActor 扣物品 → `AuctionPutOnMsg` → PublicActor 分配 `auction_id`、记录过期时间 → 回写 PlayerActor 更新 `SiAuctionData`。  
- 购买：PlayerActor 先做货币检查 → PublicActor 二次校验（库存、价格、过期）→ 通过消息在买卖双方 PlayerActor 间完成扣币/发货 → 广播结果。  
- 浏览：PlayerActor 发送查询条件 → PublicActor 筛选/分页 → 返回列表（可附带卖家快照）。  
- 过期下架：PublicActor 定期 Tick（或依托 Actor Timer），自动下架并返还物品。

#### 排行榜

- 核心理念：PublicActor 仅维护 key/value 排序结构；展示数据从快照缓存读取。  
- 快照注册：角色上线时 `UpdateRankSnapshotMsg`；属性变化时（如战力）同时发送 `UpdateRankValueMsg` + `UpdateRankSnapshotMsg`。  
- 查询：PlayerActor → `QueryRankReqMsg`（携 SessionId）→ PublicActor 组装前 N 名 + 请求者排名 → 回调 PlayerActor。  
- 容错：快照缺失时、PublicActor 可向目标 PlayerActor 异步请求刷新；必要时读取数据库。

### 5.5 EntitySystem 实现模式（玩家侧）

```
type FriendSys struct {
  *BaseSystem
  data *protocol.SiFriendData
}

func (s *FriendSys) OnInit(ctx context.Context) {
  role := entitysystem.GetPlayerRole(ctx)
  bd := role.GetBinaryData()
  if bd.FriendData == nil {
    bd.FriendData = &protocol.SiFriendData{FriendList: make([]uint64, 0)}
  }
  s.data = bd.FriendData
}
```

- 所有社交系统与 BinaryData 直接共享内存引用，禁止复制；修改即持久化。  
- 系统需在 `entitysystem.RegisterSystemFactory` 注册，ID 放入 `protocol.SystemId`。  
- 公会、拍卖行系统均遵循同样模式。

### 5.6 PublicActor 持久化策略

- **公会**：推荐创建 `Guild` 表（GORM），结构体可直接映射 `GuildData` 序列化字段；变更时立即持久化或批量刷盘（需考虑崩溃恢复）。  
- **拍卖行**：推荐 `AuctionItem` 表；PublicActor Tick 负责过期检测与落库。  
- **数据恢复**：GameServer 启动时加载所有公会/拍卖数据到 PublicActor，并对无效玩家/离线状态做修正。  
- **日志对齐**：重要事件（建公会、交易、排行刷新）需写 `pkg/log` 并可选落地到审计表。

---

## 6. 待实现 / 待完善功能

> 完成后请及时上移至第 4 章，并描述实现细节。

### 6.1 Phase 2 核心玩法（进行中）

1. **战斗录像**：录制/回放/存储链路。  
2. **多人副本匹配/排队**：匹配算法 + 排队策略。  
3. **Boss 特殊机制**：阶段技能、掉落表。  
4. **防作弊链路完善**：协议级频率检测、移动测速、伤害/CD 校验。  
5. **数据统计与分析**：关键事件打点、性能监控、行为分析。
6. **技能配置巡检**：对 `skillCfg.Effects` 为空的技能补齐配置，避免运行期被判定为释放失败。

### 6.2 Phase 3 社交经济（本章详细设计）

1. **PublicActor 框架补全**：注册 Actor、在线状态增删、消息收敛、持久化骨架。  
2. **Proto 定义落地**：第 5.3 节所有结构与消息生成代码，并确保客户端同步。  
3. **聊天系统**：世界/私聊、频率限制、内容过滤、离线消息策略。  
4. **好友系统**：`FriendSys`、好友申请/同意/拒绝、列表查询、在线状态联动。  
5. **排行榜系统**：快照注册、Value 更新、查询回执、缺省刷新。  
6. **公会系统**：公会数据结构、创建/解散、加入/审批、权限管理、持久化。  
7. **拍卖行**：上架/购买/浏览/过期/货币结算/物品交付；`AuctionSys` + 公共持久化。  
8. **社交安全**：频率限制、内容审查、交易审计、黑名单机制。

### 6.3 Phase 4 PvP（待规划）

1. **竞技场系统**：匹配、战斗、积分与奖励。  
2. **实时配对系统**：ELO/MMR 算法、断线处理。  
3. **评分系统**：积分计算、排名调整、赛季重置。

---

## 7. 开发注意事项与架构决策

### 7.1 Actor / 并发约束

- 每位玩家仅一个 Actor；DungeonServer 单 Actor。禁止在业务逻辑中额外创建 goroutine 访问玩家状态。  
- 所有玩家系统禁止使用 `sync.Mutex`；数据只能源自 `PlayerRoleBinaryData`。  
- PublicActor 负责所有跨玩家数据，保持无锁；如需并行计算，必须在 Actor 外封装异步任务并通过消息返回。

### 7.2 数据与存储

- 数据库仅存 `PlayerRoleBinaryData`（玩家侧）+ 公会/拍卖等全局数据（PublicActor 持久化）。  
- 属性由 `AttrSys` 实时计算，禁止持久化最终属性值。  
- 定期存盘：默认每 5 分钟，可按需调整 `_5minChecker`。  
- 所有错误日志必须包含关键上下文（RoleID、ItemID、QuestID 等）。

### 7.3 协议与 Proto 规范

- 共享枚举/结构统一位于 `proto/csproto/*.proto`；修改后执行 `proto/genproto.sh` 并 `gofmt`。  
- 枚举放入 `*_def.proto`；系统数据放入 `system.proto`；玩家数据放入 `player.proto`；协议消息在 `cs.proto/sc.proto`；内部消息在 `rpc.proto`。  
- 若数据无法使用 Proto，放入 `server/internal/argsdef/`。  
- Proto 二进制迁移策略：  
  - **Phase A**：仅登录链路使用 Proto 序列化，验证链路可行。  
  - **Phase B**：按模块逐步替换 JSON，完成一模块记录于本章。  
- Phase 3 所有 Proto 需求详列于第 5.3 节，务必同步客户端。

### 7.4 网络与安全

- Gateway Session `Stop` 必须幂等；GameServer 需正确处理 `SessionEventClose`。  
- `pkg/log` 为唯一日志入口，禁止 `fmt.Println`。  
- WebSocket/TCP 尚未加 TLS/鉴权，线上前需补齐。  
- 防作弊：频率检测、移动测速、伤害验证、CD 校验需逐步接入协议链路。

### 7.5 Phase 3 特殊决策

- **PublicActor + PlayerActor 协作** 是所有社交经济功能的唯一方案。  
- 排行榜仅存 key/value；展示数据来自快照，缺失时异步补全。  
- EntitySystem 模板统一（见 5.5 节）；所有社交系统均需在 `entitysystem` 下注册。  
- 公会/拍卖行必须持久化并在 GameServer 启动时加载至 PublicActor。  
- 新发现的重要架构决策请继续追加到本章。

### 7.6 时间同步与客户端动画职责

- 所有服务一律通过 `server/internal/servertime` 读取权威 UTC 时间，可按需注入偏移；禁止直接调用 `time.Now()` 以避免跨模块时间漂移。  
- 服务器时间广播由 GameServer 的 `timesync.Broadcaster` 统一承担，`S2CTimeSync` 仅携带 `ServerTimeMs`，客户端据此做跨天/跨小时校准。  
- 技能/动作动画完全由客户端驱动：服务端只计算技能释放成功与伤害批次并广播 `S2CSkillCastResult`/`S2CSkillDamageResult`，其中 `LatencyToleranceMs` 与 `DamageFlags` 供客户端做兼容处理，任何帧段、前摇/后摇均由客户端根据协议结果自行播放。

### 7.7 技能配置校验

- 所有技能必须至少包含一个 `skillCfg.Effects` 条目；若为空，`skill.Skill.Use` 会直接返回 `ErrSkillCannotCast` 并记录日志，请在配置发布前完成巡检。

---

## 8. 关键代码位置

- `server/service/gateway/internel/clientnet`：Session 与消息适配（`ConnectionAdapter`）。  
- `server/service/gateway/internel/engine`：Gateway 配置解析及 TCP/WS 启停。  
- `server/service/gameserver/internel/playeractor`：玩家 Actor Handler / Adapter / `PlayerRole`。  
- `server/service/gameserver/internel/playeractor/entitysystem/*`：所有玩家子系统。  
- `server/service/gameserver/internel/playeractor/entitysystem/{quest_sys,daily_activity_sys}.go`：任务 & 日常刷新。  
- `server/service/gameserver/internel/publicactor/*`：PublicActor 及其子系统（聊天/好友/公会/拍卖/排行榜）。  
- `server/service/gameserver/internel/dungeonserverlink`：DungeonServer RPC 客户端、协议注册。  
- `server/service/gameserver/internel/gatewaylink`：与 Gateway 的 Session 映射与消息转发。  
- `server/service/gameserver/internel/timesync`：服务器时间广播器，定时遍历在线角色发送 `S2CTimeSync`。  
- `server/service/gameserver/internel/clientprotocol`：C2S 协议注册处。  
- `server/service/gameserver/internel/manager`：在线角色管理、重连 Key。  
- `server/service/dungeonserver/internel/clientprotocol`：DungeonServer 协议入口。  
- `server/service/dungeonserver/internel/entitysystem/*`：AI、Buff、Attr、Move、Fight、StateMachine、AOI。  
- `server/service/dungeonserver/internel/fuben` & `fbmgr`：副本实例与结算逻辑。  
- `server/service/dungeonserver/internel/skill/skill.go`：技能目标筛选、配置校验（含 `Effects` 为空时的失败逻辑）、结果填充。
- `server/internal/jsonconf`：配置加载与缓存。  
- `server/internal/database`：账号/角色/Token 访问层；未来扩展公会/拍卖表。  
- `server/internal/actor`, `server/internal/network`, `server/internal/event`：通用基础设施。  
- `proto/csproto/*.proto` + `server/internal/protocol/*.pb.go`：协议定义与生成结果。  
- `proto/csproto/social_def.proto`：社交经济相关枚举与数据结构（新增定义详见 5.3 节）。  
- `server/internal/argsdef/`：内部实现细节（如 `OnlinePlayerMap`）。
- `proto/csproto/base.proto` / `sc.proto`：`AnimationActionType`、`AnimationFrameSegment`、`S2CEntityActionState` 与 `S2CSkillCastResult.authoritative` 定义。  
- `server/service/dungeonserver/internel/entity/entity.go`：`BroadcastActionState`、`OnBattleStateChanged`、动作序列生成。  
- `server/service/dungeonserver/internel/entitysystem/{move_sys,state_machine,ai_sys}.go`：移动与状态机触发动画广播、AI 技能时间轴。  
- `server/service/dungeonserver/internel/clientprotocol/skill_handler.go`、`skill/animation_helper.go`：技能帧段映射、服务器权威命中广播链路。

---

## 9. 核心运行流程（摘要）

1. **登录**：Client → Gateway → GameServer (`C2SRegister/C2SLogin`) → `database.Account` 校验 → Token + Session 扩展。  
2. **角色管理**：`C2SQueryRoles/C2SCreateRole/C2SEnterGame` → 加载 `PlayerRoleBinaryData` → 初始化系统 → `S2CLoginSuccess`。  
3. **进入副本**：GameServer 通过 `dungeonserverlink` 发 `G2DEnterDungeonReq`（含属性/技能），DungeonServer 创建实体并回执。  
4. **移动与战斗**：客户端直接连接 DungeonServer，移动走 `C2SStart/Update/EndMove`，技能走 `C2SUseSkill`；DungeonServer 校验并广播，必要信息回传 GameServer。  
5. **掉落拾取**：DungeonServer 判定归属/距离 → GameServer RPC 检查背包 → 成功则删除掉落并触发任务事件。  
6. **副本结算**：DungeonServer 发送 `D2GSettleDungeon` → GameServer `FubenSys` 更新记录、发奖励。  
7. **断线重连**：Gateway 关闭连接 → GameServer 接收 `SessionEventClose`，标记离线并允许在 `ReconnectKey` 有效期内重连。

---

## 10. 版本记录

| 日期 | 内容 |
| ---- | ---- |
| 2025-11-20 | 重构文档结构、整合 Phase3 方案，新增开发必读、统一架构与 Proto 规范。 |
| 2025-11-17 | 依据当前代码补全架构说明、已完成功能、关键代码位置与注意事项；补充 Gateway 功能与构建状态。 |
| 2025-11-17 | 完成 Phase 3 社交经济架构设计，确定 PublicActor + PlayerActor 协作模式。 |
| 2025-11-17 | 整合排行榜设计方案至 Phase3；补充“优先使用 Proto 定义”规范。 |

---

## 11. 下一步建议

1. 完成 **防作弊接入** 与 **技能结果监控**，保障 PvE 体验。  
2. 落地 **PublicActor 框架 + 聊天系统**，打通社交链路。  
3. 启动 **数据打点 / 性能监控**，为平衡调整与质量评估提供依据。  
4. 新增/修改系统后，立即更新本文件的“已完成功能”“关键代码位置”“待实现”与“注意事项”。

