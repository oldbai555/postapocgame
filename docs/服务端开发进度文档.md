## 0. 开发必读（精简版）

- **唯一权威**：本文件是服务端整体规划和进度的权威视图；需要细节时再看对应子文档 docs/服务端开发进度文档_full.md。
- **什么时候改文档**：
  - 做完一块功能：补到「已完成功能」+ 在「关键代码位置」登记入口。
  - 需求分期实现：先写到「待实现 / 待完善功能」，用复选框拆子任务。
  - 发现全局约束 / 坑：写进「开发注意事项与架构决策」。
- **不写什么**：不要在这里堆实现细节、函数参数级说明，保持“我复盘或交接时会翻的东西”。
- **实现细节、函数参数级说明**：在“docs/已完成/服务端开发进度文档_full.md”补充。

---

## 1. 当前架构概览

- **服务划分**
  - `gateway`：接入层（TCP/WS、Session 生命周期、消息转发、限流）。
  - `gameserver`：玩家主逻辑（账号/角色、成长、经济、社交、公会、GM、反作弊），一玩家一 Actor，内部常驻 `DungeonActor` 单 Actor 作为战斗/副本引擎。
- **内部通信**
  - Gateway → Game：`ForwardMessage` + Session 事件。
  - PlayerActor ↔ DungeonActor：通过 `gshare.IDungeonActorFacade` 发送内部 Actor 消息（`DungeonActorMsgId` / `PlayerActorMsgId`），禁止同步阻塞。
- **数据归属**
  - 玩家全部状态：`PlayerRoleBinaryData`（SQLite + GORM）。
  - 全局社交/经济：PublicActor + 专门表（公会、拍卖、排行榜快照等）。
- **架构风格**
  - GameServer：按 Clean Architecture 分层，业务逻辑在 UseCase，协议/Actor 只做适配。
  - DungeonActor：GameServer 进程内的单 Actor 战斗/副本引擎，通过 `DungeonServerGateway` 接口暴露能力，内部使用 Actor 消息与 PlayerActor 协作。
  - 玩家侧旧 `entitysystem` 只剩系统管理器 + 离线消息分发器，其余系统迁移到 `adapter/{system,controller,presenter}`。

---

## 2. 已完成功能（只列关键块）

### 2.1 Gateway
- 接入与转发：TCP + WebSocket、Session 管理、C2S → GameServer、限流/资源保护。

### 2.2 GameServer 核心
- **账号 / 角色 / 会话**
  - 账号注册/登录、Token、角色创建/进入游戏，Session 扩展账号/角色信息。
- **Actor 与系统框架**
  - 每玩家一个 Actor，系统通过 SystemAdapter 挂在 PlayerActor 上，统一生命周期（Init/Login/RunOne）。
  - 定期落盘、统一事件总线、无锁单线程。
- **统一时间与日志**
  - 全服务统一 `servertime`，禁止直接 `time.Now()`。
  - 日志统一走 `pkg/log`，支持 `IRequester` 注入 Session/Role，方便排查。
- **成长 / 经济 / 玩法（已迁 Clean Architecture 的）**
  - 背包（Bag）、货币（Money）、装备（Equip）、属性（AttrCalculator 工具类）、任务（Quest）、副本（Fuben）、技能（Skill）、物品使用（ItemUse）、商店（Shop）、回收（Recycle）。
  - 这些系统的业务逻辑都在 `usecase` 层，Controller 只做协议入口，SystemAdapter 只做生命周期调度。
- **防作弊 / GM / 系统通知**
  - AntiCheat：操作频率控制、可疑行为计数、临时/永久封禁。
  - GM：C2S GM 指令 → GM 系统 → 系统广播/系统邮件等。
  - 系统广播 + 系统邮件：可单人/全服，GM 工具和活动发奖统一复用。
- **Phase 3 社交与 PublicActor**
  - PublicActor：单 Actor 管全局在线状态、排行榜、公会、拍卖、离线快照。
  - 聊天 / 好友 / 排行 / 公会 / 拍卖：全部按 Clean Architecture 落地，Player 通过 UseCase + `PublicActorGateway` 交互，不再直接写 entitysystem。
  - 离线数据管理器：离线快照（Rank 等）的权威实现，PublicActor 负责定期 Flush 和启动加载。
- **玩家消息系统**
  - 已有玩家消息表、注册中心、离线消息加载与回放（MessageSys + `message_dispatcher`），支持“在线直接投递 / 离线入库稍后回放”链路。
**DungeonActor 架构与实现（已完成）**
- 在 GameServer 内实现 `internel/app/dungeonactor` 单 Actor（ModeSingle），作为战斗/副本引擎常驻运行。
- 将原 `server/service/dungeonserver` 的核心代码（`entity`、`entitysystem`、`scene`、`fuben`、`skill` 等）完整迁移到 `internel/app/dungeonactor`，统一 import 前缀并保持 UTF-8 编码。
- 通过 `DungeonServerGateway` 接口暴露能力，内部通过 `gshare.IDungeonActorFacade` 与 PlayerActor 协作，使用 `DungeonActorMsgId` / `PlayerActorMsgId` 枚举统一管理内部消息。
- 物理删除 `server/service/dungeonserver` 代码目录，所有战斗相关改动统一在 `internel/app/dungeonactor` 维护。
- 在 `proto/csproto/rpc.proto` 中新增 `DungeonActorMsgId` 和 `PlayerActorMsgId` 枚举，统一管理内部消息ID。
- 所有客户端 C2S 协议统一在 PlayerActor Controller 层处理，通过 `gshare.SendDungeonMessageAsync` 将请求转发到 DungeonActor。
- DungeonActor → PlayerActor 的消息（添加物品、副本结算、坐标同步、属性同步等）通过 `gshare.SendMessageAsync` 发送，使用 `PlayerActorMsgId` 枚举。
### 2.3 DungeonActor（战斗/副本引擎）
- **战斗服务器基础**
  - 单 Actor 场景 + 实体系统，技能、Buff、AI、战斗流程。
- **移动与坐标**
  - 移动：C2SStart/Update/EndMove 流程，服务端时间驱动位置更新，带速度和延迟容忍度。
  - 坐标：统一“服务端内部用格子坐标，客户端发像素坐标，统一转换”，寻路、范围、校验全部基于格子。
- **属性系统**
  - 接收 GameServer 下发的属性同步，并结合本地系统（怪物、Buff 等）通过注册的计算器重算；RunOne 周期性检查并推属性。

### 2.4 调试客户端（server/example）
- 文本冒险调试端：账号/角色/场景/移动/战斗/背包/副本/GM/脚本等高频动作全覆盖。
- 已有自动寻路（直线+A*）、脚本录制/回放、GM 命令桥接，足够模拟真实客户端链路。

---

## 3. 待实现 / 待完善功能（抓大不抓小）

> 具体分阶段的设计/细则在对应子文档，本节只保留“我下一步要干什么”的 todo 视角。

### 3.1 Clean Architecture 收尾
- [⏳] **SystemAdapter 进一步瘦身**
  - SystemAdapter 只保留“生命周期和事件接线”；业务逻辑下沉 UseCase 已做一轮，但仍需滚动排查是否有新逻辑写回了 SystemAdapter。
  - 关键检查：Money/Bag/Level/Quest/Fuben/Attr 等是否又长出 if/for 逻辑。
- [⏳] **UseCase 测试补齐**
  - Equip / Fuben / Quest / Shop / Recycle / Skill / ItemUse 等核心 UseCase 单测补齐。
- [⏳] **Controller 层系统启用检查的测试**
  - 已在 Controller 里统一加了“系统未开启”的错误返回，需补一轮测试，避免忘检查或误用错误码。

### 3.2 核心玩法 & 运营向
- [ ] 战斗录像：录制/回放/存储三件套（最低要求：单人副本可回放，观测数值问题）。
- [ ] 多人副本匹配/排队：匹配算法 + 队列管理 + 与 DungeonActor 的房间模型。
- [ ] Boss 特殊机制：阶段/环境技、特殊掉落/结算。
- [ ] 反作弊强化：接入所有高风险协议（移动/技能/货币/交易），统一走 AntiCheat。
- [ ] 数据统计与分析：关键行为埋点（登录/付费/副本结果）、简单报表/导出能力。

### 3.3 安全与运维
- [⏳] **GM 权限与审计（高优先级）**
  - 为 GM 账号/角色建立权限模型（等级/标签）、IP/环境白名单。
  - 对高危指令写入审计表或结构化日志（操作者/目标/指令/参数/IP/时间）。
- [⏳] **Gateway 接入安全**
  - Gateway WebSocket：生产环境启用 IP 白名单、Origin 校验、握手阶段 Token/签名校验。

### 3.4 辅助系统
- [⏳] **玩家消息系统 Phase 4**
  - 在已有存储/加载/回放基础上，补监控（积压量、失败率）和过期策略，避免消息表无限膨胀。
- [ ] **离线数据管理器二期**
  - 扩展更多离线快照类型（公会展示、拍卖、外观），接入监控，考虑按类型懒加载。

### 3.5 调试客户端
- [ ] 多 Session 管理（小规模机器人编队，验证社交/战斗负载）。
- [ ] 战斗/副本脚本的脚本化 DSL 或最简录制格式，用来快速复现复杂战斗。

### 3.6 DungeonActor 架构优化（已完成基础，持续完善）
- [✅] 将原 `server/service/dungeonserver` 中战斗/场景核心逻辑迁移为 `server/service/gameserver/internel/app/dungeonactor`，在 GameServer 进程内以单 Actor 形式运行。
  - [✅] 基础骨架与入口：在 GameServer 内创建 `internel/app/dungeonactor`，以 `actor.ModeSingle` 启动单 Actor DungeonActor。
  - [✅] 代码迁移：完整复制 `entity/`、`entitysystem/`、`scene/`、`iface/`、`gameserverlink/`、`fuben/`、`fbmgr/` 等目录，统一 import 前缀。
  - [✅] 物理删除 `server/service/dungeonserver` 代码目录，所有战斗相关改动统一在 `internel/app/dungeonactor` 维护。
- [✅] `DungeonServerGateway` 仅实现 InProcess 模式：对 UseCase 暴露统一的异步接口，内部直接路由到 GameServer 内部的 DungeonActor。
- [✅] 交互与协议收敛：删除 `dungeonactor/{drpcprotocol,clientprotocol}` 包，移除所有 C2S/G2D 本地注册逻辑；在 `gshare.actor_facade.go` 中引入 `IDungeonActorFacade`，统一通过 Actor 消息协作。
- [✅] 消息ID统一：在 `proto/csproto/rpc.proto` 中新增 `DungeonActorMsgId` 和 `PlayerActorMsgId` 枚举，统一管理内部消息ID。
- [✅] C2S 协议接线：在 GameServer Controller 层补齐移动/技能/拾取/复活等链路，通过 `gshare.SendDungeonMessageAsync` 转发到 DungeonActor。
- [✅] D2P 消息发送：实现 DungeonActor → PlayerActor 的消息发送（添加物品、副本结算、坐标同步、属性同步等），使用 `PlayerActorMsgId` 枚举。
- [⏳] 性能评估与优化：完成副本进入/结算、移动/技能、掉落/拾取的完整联调与性能评估。

---

## 4. 开发注意事项与架构决策（高频必看）

### 4.1 并发与 Actor 约束
- 一切玩家状态修改必须在 PlayerActor 主线程内完成；禁止在业务中起 goroutine 去改玩家数据。
- DungeonActor 视为单 Actor 战斗/副本引擎，AI/战斗/移动都按“每帧遍历实体”思路写；原独立的 DungeonServer 已物理删除，所有战斗逻辑在 GameServer 进程内的 DungeonActor 中实现。
- 公共全局数据（公会/拍卖/排行榜/离线数据）全部经 PublicActor；不要在其它地方偷偷加全局 map。
  - DungeonActor 被视为 GameServer 内部的基础设施 Actor（单 Actor，ModeSingle），与 PublicActor 类似常驻运行；玩家是否可进入副本/战斗仍由 PlayerActor 一侧的 Controller/SystemAdapter 系统开关控制，DungeonActor 本身不感知玩法开关。
  - 开发与联调阶段统一采用 InProcess 模式：PlayerActor ↔ DungeonActor 的交互一律通过 `gshare.IDungeonActorFacade` 发送内部 Actor 消息完成；如需重新引入远程战斗服，需在 Gateway 中补充 Remote 模式并在文档中恢复对应服务拓扑描述。

### 4.2 时间与数据库
- 时间：所有业务统一使用 `server/internal/servertime`；DB 时间字段统一 Unix 秒，禁止 `time.Time` 乱写。
- 玩家侧只落 `PlayerRoleBinaryData`；全局侧只落专门表（公会、拍卖、离线快照等），两者间用 ID 关联。

### 4.3 协议 / Controller / UseCase 一致性
- C2S/S2C：Controller 统一注册在 `adapter/controller/*_controller_init.go`，禁止在 SystemAdapter 和 entitysystem 里散落注册；DungeonActor 也不再直接注册或处理任何 C2S 协议。
- Controller 只做“解析+权限/系统开关检查+调 UseCase”，所有回包用 Presenter。
- UseCase 不感知 Actor/网络，依赖接口（Repository/Gateway/PresenterAdapter），贯彻依赖倒置；PlayerActor ↔ DungeonActor 的交互统一通过 `gshare.IDungeonActorFacade` 发送内部 Actor 消息（`DungeonActorMsgId` / `PlayerActorMsgId`），不再通过 G2D/D2G RPC 枚举。

### 4.4 PlayerActor ↔ DungeonActor 通信约束
- PlayerActor → DungeonActor：通过 `gshare.SendDungeonMessageAsync` 发送内部 Actor 消息，使用 `DungeonActorMsgId` 枚举。
- DungeonActor → PlayerActor：通过 `gshare.SendMessageAsync` 发送内部 Actor 消息，使用 `PlayerActorMsgId` 枚举。
- UseCase 层统一通过 `DungeonServerGateway` 接口访问 DungeonActor 能力，禁止直接调用 `gshare.SendDungeonMessageAsync`。
- 所有消息必须显式标明：调用方/被调用方、是否有超时、失败策略（重试/降级/忽略）。

### 4.5 日志与排障
- 所有关键路径（充值、拍卖、回收、GM、战斗结算）必须带 RoleID/SessionId，统一通过 `pkg/log` + IRequester。
- 不要在业务代码中 `fmt.Println`；出问题时第一步是“查对应模块的日志 + PlayerActor 日志”。

### 4.6 S2C 发送链路统一
- DungeonActor / PublicActor / 其它系统不得直接调用 `gatewaylink`；所有发往客户端的消息必须由 PlayerActor 统一透传。
- 如需下发客户端协议，构造 `PlayerActorMsgIdSendToClient` 消息，由 PlayerActor 的 `handleSendToClient` 再调用 `gatewaylink`。这样可保持 Actor 单线程语义、统一 Session 校验与流控。

### 4.7 坐标 / 移动 / 寻路
- 服务端业务一律用**格子坐标**（地图/寻路/技能范围/AOI），客户端自行做像素坐标。
- 移动系统只处理移动相关逻辑；AI 系统通过组合调用移动协议来驱动单位移动。
- 地图与出生点必须经过 GameMap 校验；地图缺失仅允许在开发期临时跑。

### 4.8 社交 / PublicActor
- 好友、公会、拍卖、排行榜都基于 “PlayerActor 数据 + PublicActor 全局状态” 模型：
  - PlayerActor 负责“我自己”的社交数据（好友列表、公会 ID 等）。
  - PublicActor 负责“全局视图”（全服公会、全服拍卖、排行榜排名、离线快照）。
- 所有给 PublicActor 的消息通过 `PublicActorGateway` 或 `PlayerRole.sendPublicActorMessage`；禁止直接调底层 `gshare.SendPublicMessageAsync`。

### 4.9 调试客户端与服务对齐
- server/example 是“服务端官方调试端”，协议/时间/日志等约束与正式服务相同（同样用 servertime，同样走 Proto）。
- 新增测试链路优先用 example 客户端串起来，再考虑写脚本或单测。

---

## 5. 关键代码位置（只列入口级）

### 5.1 Gateway
- 接入与转发：`server/service/gateway/internel/clientnet`、`engine`。

### 5.2 GameServer
- PlayerActor & 系统注册：`internel/app/playeractor`、`internel/app/playeractor/entitysystem/sys_mgr.go`。
- 玩家网络入口：`internel/app/playeractor/entity/player_network.go`。
- 公共 Actor：`internel/app/publicactor/*`（消息入口、离线数据、排行榜、公会、拍卖等）。
- Clean Architecture 主干：
  - Controller：`internel/adapter/controller/*`（含 `protocol_router_controller.go`）。
  - SystemAdapter：`internel/adapter/system/*`（玩法/社交/辅助系统生命周期）。
  - UseCase：`internel/usecase/*`。
  - Gateway & Presenter：`internel/adapter/gateway/*`、`internel/adapter/presenter/*`。
- 玩家消息系统：`internel/engine/message_registry.go` + `internel/adapter/system/message_system_adapter.go` + `internel/app/playeractor/entitysystem/message_dispatcher.go`。
- 离线数据：`internel/app/publicactor/offlinedata/*` + `server/internal/database/offline_data.go`。
  - DungeonActor 基础骨架：`internel/app/dungeonactor/{adapter.go,handler.go,register.go,message.go}`（GameServer 进程内的单 Actor 副本/战斗引擎）。
  - DungeonActor 业务实现：`internel/app/dungeonactor/{entity,entitymgr,entitysystem,fbmgr,fuben,gameserverlink,iface,scene,scenemgr,skill}`（原 DungeonServer 核心逻辑已迁移至该目录）。

### 5.3 DungeonActor
- 实体与系统：`internel/app/dungeonactor/entitysystem/*`（移动/战斗/AI/属性/寻路）。
- 场景与地图：`internel/app/dungeonactor/scene`（GameMap/出生点/移动校验）。
- 副本管理：`internel/app/dungeonactor/fuben`、`internel/app/dungeonactor/fbmgr`。
- 消息注册：`internel/app/dungeonactor/register.go`（通过 `gshare.IDungeonActorFacade.RegisterHandler` 注册消息处理器）。

### 5.4 通用基础
- Actor 框架：`server/internal/actor`。
- 时间：`server/internal/servertime`。
- 配置：`server/internal/jsonconf`。
- 坐标：`server/internal/argsdef/position.go`。
- 日志：`server/pkg/log`。

### 5.5 调试客户端
- 入口：`server/example/cmd/example`。
- 客户端核心：`server/example/internal/client`。
- 面板与系统：`server/example/internal/panel`、`server/example/internal/systems`。

---

## 6. 其它文档索引（需要细节再看）

- Clean Architecture 总览与实施：
  - `docs/gameserver_CleanArchitecture重构实施手册.md`
  - `docs/gameserver_CleanArchitecture重构文档.md`
  - `docs/gameserver_目录与调用关系说明.md`
  - `docs/服务端开发进度文档_full.md`
- 属性系统：
  - `docs/属性系统重构文档.md`
  - `docs/属性系统阶段三联调记录.md`
- 社交与离线：
  - `docs/离线数据管理器开发文档.md`
- 调试客户端：
  - `docs/golang客户端待开发文档.md`
  - `docs/server_example重构方案.md`
- 兼容/清理规划：
  - `docs/gameserver_兼容代码清理规划.md`
  - `docs/SystemAdapter_CodeReview清单.md`
  - `docs/SystemAdapter系统开启检查优化方案.md`


