# 游戏服务器开发进度文档

更新时间：2025-11-17  
责任人：个人独立开发

本文根据 `server/` 目录下现有 Go 代码重新整理，覆盖最新架构、交付能力、关键代码位置以及待办事项。所有开发在开始前，请先阅读“服务器架构”和“开发注意事项”章节，保证与现有 Actor/无锁设计保持一致。

---

## 1. 项目概述

- **项目名称**：postapocgame（后启示录游戏）  
- **整体定位**：仿 2D 横版格斗（DNF 风格），客户端计划使用 Godot  
- **服务端语言**：Golang 1.24.10，单仓管理 `gateway / gameserver / dungeonserver`  
- **数据库**：SQLite（`server/output/postapocgame.db`） + GORM  
- **配置驱动**：`server/output/config/*.json` 共 26+ 份表  
- **目标平台**：Windows / Android / iOS（客户端），服务器主要部署在 Windows / Linux

---

## 2. 服务器架构

### 2.1 服务划分

| 服务 | 职责 | 关键目录 |
| ---- | ---- | -------- |
| Gateway | 统一接入层，管理 TCP/WebSocket 连接、Session 生命周期、消息压缩及转发 | `server/service/gateway` |
| GameServer | 玩家长连接逻辑（任务、背包、成长、经济、GM 等），一个玩家一个 Actor，无锁串行 | `server/service/gameserver` |
| DungeonServer | 副本/战斗逻辑，单 Actor 驱动场景、实体、战斗状态机、掉落与结算 | `server/service/dungeonserver` |
| Shared Packages | Actor 框架、事件总线、网络编解码、Proto、配置管理、日志、错误码 | `server/internal`, `server/pkg`, `proto/` |

### 2.2 拓扑与通信

```
Client (TCP / WebSocket)
      |
      v
Gateway (session_mgr + client_handler)
      | ForwardMessage / SessionEvent
      v
GameServer (per-player actor)
      | Async RPC (network.CallGameServer / dungeonserverlink.AsyncCall)
      v
DungeonServer (single actor dungeon runtime)
```

- **会话分发**：Gateway 建立 Session（`clientnet.SessionManager`），将 `ForwardMessage` 透传给 GameServer；Session 事件同样异步通知 GameServer（`gameserver/internel/gatewaylink`）。  
- **Actor 调度**：GameServer 使用 `actor.ModePerKey`，key=SessionId。`PlayerHandler.Loop()` 会通过 `actorCtx.ExecuteAsync` 注入 `gshare.DoRunOneMsg` 使 PlayerRole.RunOne 在 Handler 主循环内执行。  
- **跨服 RPC**：GameServer 与 DungeonServer 的 RPC 通过 `dungeonserverlink` / `gameserverlink` 模块，全部异步调用，避免阻塞 Actor。  
- **数据持久化**：所有玩家系统数据封装在 `protocol.PlayerRoleBinaryData`，以 protobuf 序列化写入 `Player.BinaryData` 字段。

---

## 3. 构建与运行现状

- **Go 版本**：`go 1.24.0`（toolchain 1.24.10），定义在 `server/go.mod`。  
- **最近构建**（已完成并产出在 `server/output/`）：
  - `go build -o server/output/gameserver.exe ./server/service/gameserver`
  - `go build -o server/output/dungeonserver.exe ./server/service/dungeonserver`
  - 仓库中也包含 `gateway.exe`（此前构建）  
- **配置文件**：
  - `server/output/gateway.json`、`gamesrv.json`、`dungeonsrv.json`  
  - JSON 配置表位于 `server/output/config/`，启动时必须保证该目录存在  
- **数据库**：`server/output/postapocgame.db` 随 GameServer 自动迁移，表定义见 `server/internal/database/*.go`。  
- **日志输出**：各服务默认写入 `server/output/log/` 子目录，并同步打印到控制台。  
- **运行顺序建议**：先启动 DungeonServer → GameServer → Gateway，最后启动客户端。

---

## 4. 已完成功能

> 以下功能均已在 `server/` 目录内实现，可直接在当前代码基础上继续扩展。若新增系统，请在本章节补充记录。

### 4.1 Gateway（接入层）

- **双协议接入**：支持 TCP (`engine/server.go`) 与 WebSocket (`engine/config.go`)，可同时监听。  
- **Session 生命周期**：`clientnet.SessionManager` 负责创建、超时清理、幂等关闭，自动通知 GameServer（`gameserverlink.NotifySessionEvent`）。  
- **消息转发与回写**：`clientnet.ClientHandler` 通过 `IGameServerConnector` 将 `network.Message` 转换为 `ForwardMessage` 发送至 GameServer，并维护 per-session 发送协程，包含连接错误判定与发送重试。  
- **限流与资源保护**：支持最大会话数、发送缓冲区、帧大小 (`MaxFrameSize`) 配置；超时会话定期清理。  
- **日志与监控**：关键路径全部使用 `pkg/log`，方便统一收集。

### 4.2 GameServer（玩家主逻辑）

**账号 / 角色 / Session**

- 注册、登录、Token（`entity/player_network.go`），基于 `database.Account` + bcrypt。  
- 角色创建/删除/查询、进入游戏流（同文件），支持账号最多 3 角色。  
- Session 扩展：`server/internal/argsdef/session.go` 增加 AccountID / Token，所有协议通过 SessionId 路由。

**玩家 Actor 运行时**

- `playeractor.NewPlayerRoleActor(actor.ModePerKey)`：单玩家单 Actor。  
- `PlayerRole`（`entity/player_role.go`）负责生命周期、事件发布、BinaryData 加载/保存、RunOne 调度、跨服务 RPC。  
- `PlayerHandler.Loop()` 中通过 `actorCtx.ExecuteAsync` 调 `gshare.DoRunOneMsg`，RunOne 内处理属性增量和周期存盘。  
- `entitysystem.SysMgr` 统一加载/注册子系统，每个系统在 `OnInit` 内从 BinaryData 初始化，所有系统严格无锁。

**成长与经济系统**

- 背包 `BagSys`（堆叠、容量、事件）  
- 钱包 `MoneySys`（多货币、事务、经验货币转发）  
- 装备 `EquipSys`（穿脱、强化、精炼、附魔、套装、属性计算）  
- 属性聚合 `AttrSys`（注册表 + RunOne 增量同步 DungeonServer）  
- 等级 `LevelSys`（经验、连跳升级、升级奖励、属性计算）  
- VIP `VipSys`、特权查询  
- GM 系统 `GMSys`（玩家级命令系统注册到 `SysMgr`，独享命令表，避免全局数据竞争）  
- 任务 `QuestSys`（统一掌控主线/支线/日常/周常，按类型分桶存储并支持自动刷新），日常活跃 `DailyActivitySys`（活跃点货币、日活奖励），成就 `AchievementSys`、新手保护 `NewbieSys`  
- 商城 `ShopSys`、物品使用 `ItemUseSys`、物品回收 `RecycleSys`  
- 离线收益 `OfflineRewardSys`  
- 反作弊 `AntiCheatSys`（频率限制、封禁状态管理，待进一步接入协议级检索）  
- GM 系统 + GM 命令管理器（`gm_sys.go` / `gm_manager.go`），支持等级校验和常用命令。

**副本 / 剧情协作**

- 副本系统 `FubenSys`：难度、进入条件、限时副本（通天塔）、结算记录。  
- 技能系统 `SkillSys`：学习、升级、同步 DungeonServer。  
- 物品掉落拾取流程：DungeonServer RPC → `BagSys` 检查容量。  
- 与 DungeonServer 的 RPC 注册、会话映射、属性/技能同步由 `dungeonserverlink` 负责。  
- 所有系统数据统一映射至 `PlayerRoleBinaryData` 子结构（bag_data、equip_data 等）。

**其它基建**

- `gevent`：玩家级事件总线，已注册登录、登出、物品增减等事件；可以拓展。  
- `manager.RoleMgr` 维护在线角色仓库，支持断线重连（`reconnect_key.go`）。  
- JSON 配置热加载（`internal/jsonconf/config_manager.go`），涵盖物品/等级/VIP/任务/怪物/技能/邮件/副本等 26+ 表。  
- 数据访问封装：`internal/database` 的 `Account`、`Player`、Token 体系，统一使用事务。

### 4.3 DungeonServer（副本与战斗）

- **主循环**：`dungeonactor` + `entitymgr` 单线程驱动，`fbmgr` 保持常驻副本也能持续 Tick。  
- **实体层**：`entity/role`, `entity/monster`, `entity/drop_item`，`scene/scenest.go` 管理 AOI。  
- **状态系统**：`entitysystem/state_machine.go`（待命/施法/硬直/倒地/死亡/无敌），`buff_sys.go`（Buff/Bleeding/DOT）、`ai_state.go` + `ai_sys.go`（巡逻→侦测→追击→脱战）。  
- **战斗计算**：`skill/skill_damage_calculator.go` 实现攻击、防御、属性相克、暴击/闪避、伤害浮动（全部万分比）；`fight_sys.go` 处理技能释放、CD/MP 校验。  
- **移动同步**：`clientprotocol/movement_handler.go` + `entitysystem/move_sys.go` + `aoi_sys.go`，服务器强校验速度/坐标，异常回滚，并在 `C2SEndMove` 时向 GameServer RPC 同步坐标。  
- **技能协议**：`C2SUseSkill` → `S2CSkillCastResult`，普通攻击映射默认技能 ID 1001。  
- **副本管理**：`fuben/`（限时副本、结算、进出场景、奖励结算 `D2GSettleDungeon`），`fbmgr` 支持常驻/限时副本同时运行。  
- **掉落与拾取**：`entity/drop_item.go` + `clientprotocol/pickup_handler.go`，包含归属校验、超时清理、RPC 询问背包空间。  
- **复活、最近怪物、场景切换**：`revive_handler.go`、`scene_handler.go` 等全面实现。  
- **属性同步**：`entitysystem/attr_sys.go` 接收 GameServer 的 `SyncAttrData`，支持差异更新（增减属性向量）。  
- **RPC 链路**：`gameserverlink` 包含注册、心跳、异步回调，DungeonServer 启动时会 `SetDungeonSrvType` 并向 GameServer 注册协议。

### 4.4 共享基础能力

- **Actor 框架**：`internal/actor`（context、handler、mailbox、消息），支持 `ModeSingle` / `ModePerKey`。  
- **网络栈**：`internal/network`（Message、Codec、压缩、连接池、WS 适配）。  
- **事件系统**：`internal/event`（Bus / Event / Type），游戏内事件以 publish-subscribe 方式分发。  
- **Proto**：`proto/csproto` 定义 cs/sc/system/rpc/attr/buff 等 proto，`proto/genproto.sh` 统一生成并 gofmt。  
- **日志与工具**：`pkg/log`、`pkg/customerr`、`pkg/tool`（时间、位运算、UUID）提供统一能力。  
- **配置与脚本**：`server/internal/json.go` 提供 JSON 工具，`scripts/git.sh` 维护 repo 快捷命令。

---

## 5. 待实现 / 待完善功能

> 优先级从高到低，完成后请将对应条目上移到“已完成功能”并补充实现细节。

### 5.1 Phase 2 核心玩法补充

1. **动画同步协议**：技能释放/受击/移动/状态切换动画。  
   - **概念：时间同步**：所有客户端统一使用服务器时间，消除本地时钟差异（基于服务器时间戳驱动动画事件）。  
   - **概念：帧定义**：为技能划分前摇 → 判定 → 后摇帧段，伤害仅在“判定帧”产生（例如：攻击帧 = 前摇 4 帧(200ms) + 判定 2 帧(100ms) + 后摇 6 帧(300ms)，伤害只在中间 100ms 产生）。  
   - **概念：状态广播**：服务器实时广播所有实体的动画/动作状态（进入施法、受击、倒地等），客户端只做表现同步。  
   - **概念：权威性验证**：伤害计算与命中判定完全由服务器决定，客户端只能上报意图，不能自判命中。  
   - **三大核心机制**：  
     1. **时间同步**：使用 Ping/Pong 校准客户端与服务器时间，所有动画事件基于服务器时间戳，网络延迟由时间对齐机制吸收。  
     2. **帧定义系统**：在服务器定义技能帧表，明确前摇/判定/后摇结构，并在特定帧（如判定帧）触发伤害与状态变更。  
     3. **服务器权威**：客户端不能直接声明“我命中了”，必须由服务器在帧驱动和碰撞检测后给出“你命中了”的结果，保证公平与防作弊。  
2. **战斗录像**：录制、回放、存储。  
3. **多人副本匹配/排队系统**：匹配算法、排队处理。  
4. **Boss 战特殊机制**：阶段、特殊技能、掉落。  
5. **防作弊机制完善**：在协议处理链路中挂载频率检测、移动测速、伤害验证、技能 CD 校验、数据一致性校验。  
6. **数据统计与分析**：关键事件打点、统计接口、玩家行为分析、性能监控、数据上报。

### 5.2 Phase 3 社交经济

1. **聊天系统**（世界/私聊，建议 GameServer 实现）。  
2. **好友/公会框架**（添加、删除、列表、基础公会操作）。  
3. **拍卖行**（上架、购买、下架）。  
4. **排行榜**（等级榜、战力榜等，定期刷新）。

### 5.3 Phase 4 PvP

1. **竞技场系统**：匹配、战斗、积分。  
2. **实时配对系统**：ELO/MMR 等匹配算法。  
3. **评分系统**：积分计算、排名调整。

---

## 6. 关键代码位置

- `server/service/gateway/internel/clientnet`：接入层 Session、连接适配 (`ConnectionAdapter`)、消息收发。  
- `server/service/gateway/internel/engine`：Gateway 配置解析与 TCP/WS Server 启停。  
- `server/service/gameserver/internel/playeractor`：玩家 Actor Handler、Adapter、`PlayerRole` 与 EntitySystem。  
- `server/service/gameserver/internel/playeractor/entitysystem/`：所有玩家子系统（背包、装备、货币、任务、GM、反作弊等）。  
- `server/service/gameserver/internel/playeractor/entitysystem/quest_sys.go` & `daily_activity_sys.go`：统一任务（主线/支线/日常/周常）逻辑、日常刷新、活跃点货币与奖励领取。  
- `server/service/gameserver/internel/dungeonserverlink`：DungeonServer RPC 客户端、协议注册、消息分发。  
- `server/service/gameserver/internel/gatewaylink`：与 Gateway 的 Session 映射、消息回发。  
- `server/service/gameserver/internel/clientprotocol`：C2S 协议注册表。  
- `server/service/gameserver/internel/manager`：在线角色管理、重连 Key。  
- `server/service/dungeonserver/internel/clientprotocol`：玩家协议入口（移动/战斗/拾取/复活/场景）。  
- `server/service/dungeonserver/internel/entitysystem`：AI、Buff、Attr、Move、Fight、StateMachine、AOI。  
- `server/service/dungeonserver/internel/fuben` & `fbmgr`：副本实例、限时副本、结算逻辑。  
- `server/internal/jsonconf`：配置加载与缓存。  
- `server/internal/database`：Account/Player/Token 操作（含 BinaryData 存取）。  
- `server/internal/actor`, `server/internal/network`, `server/internal/event`：通用基础设施。  
- `proto/csproto/*.proto` + `server/internal/protocol/*.pb.go`：协议与数据结构定义。

---

## 7. 开发注意事项与架构决策

1. **Actor 单线程模型**：GameServer 一个玩家一个 Actor，DungeonServer 单 Actor。严禁在业务逻辑中再开 goroutine（除非明确切出 Actor 上下文，如 Gateway 的网络 IO）。  
2. **无锁系统**：所有玩家子系统禁止使用 `sync.Mutex`，数据来源必须是 `PlayerRoleBinaryData`，如需索引使用临时结构并确保每次变更后重建。  
3. **BinaryData 单点存储**：数据库只存 `PlayerRoleBinaryData`，其他表一律移除；保存使用 `database.SavePlayerBinaryData`。  
4. **属性实时计算**：所有属性走 `AttrSys` 注册表，RunOne 负责增量同步。禁止将最终属性持久化。  
5. **异步 RPC**：GameServer ↔ DungeonServer 必须使用 `dungeonserverlink.AsyncCall` / `gameserverlink` 的异步接口，避免阻塞 Actor。  
6. **百分比统一使用万分比**：战斗/成长的百分比统一放大 10000，避免 float。  
7. **协议与枚举**：所有共享枚举统一放入 `proto/csproto/*.proto`（尤其是 `*_def.proto`）中定义，修改后执行 `proto/genproto.sh` 并 `gofmt`；Quest 系统的公共枚举（如任务目标类型、任务大类）已集中到 `quest_def.proto`。  
8. **公共枚举统一入口**：任何服务间共享的枚举（任务类型、实体类型、错误码等）一律在 `proto/csproto/` 下维护，禁止散落在 Go 代码或其它目录中，方便客户端与服务端保持同步。  
9. **错误处理**：统一使用 `pkg/customerr` 提供的错误码包装，客户端可依赖 `protocol.ErrorCode`.  
10. **配置热更**：`ConfigManager` 支持重新加载，开发阶段可在修改 JSON 后调用 `LoadAllConfigs`。生产建议加文件监听。  
11. **PlayerRole.RunOne Hook**：为保持 `actor` 包纯净，使用 `actorCtx.SetData/GetData` + 反射在 `PlayerHandler` 中注入 RunOne。若后续 refactor，需要同时维护 Handler 与 ActorContext 设置逻辑。  
12. **Session 管理**：Gateway 的 Session 在 `Stop` 时会幂等关闭；GameServer 需正确处理 `SessionEventClose`，避免悬挂 Actor。  
13. **定期存盘**：当前实现每 5 分钟自动落盘，可视需要调整 `_5minChecker`。  
14. **日志规范**：使用 `pkg/log`，自带 appName 与路径，禁止使用 `fmt.Println`。  
15. **安全提示**：外部依赖（WebSocket、TCP）尚未做 TLS/鉴权，部署生产前需补齐。  
16. **时间维度事件**：`PlayerRole` 在 `RunOne` 内监测跨小时/天/周/月/年并依次调用 `OnNewHour/OnNewDay/...`，系统若有周期刷新（如 `QuestSys`、`DailyActivitySys`）需重写对应钩子实现。  
17. **错误信息上下文**：返回或日志中的错误需要包含关键上下文（例如 RoleID、ItemID/QuestID 等），以便快速定位问题。  
18. **Proto 二进制迁移策略（2025-11-17）**：  
    - **Phase A**：仅改造登录链路（注册/登录/选角/进入游戏）及示例客户端，统一使用 `proto.Marshal/Unmarshal` + `SendToSessionProto`，验证最小可运行的二进制链路。  
    - **Phase B**：在 Phase A 稳定后，按模块（Dungeon 协议、物品、GM、商店等）逐步替换剩余 JSON，完成一个模块就记录在本文并同步客户端文档。  

---

## 8. 核心运行流程（摘要）

1. **登录**：Client → Gateway → GameServer (`C2SRegister/C2SLogin`) → `database.Account` 校验 → 返回 Token + Session 扩展。  
2. **角色管理**：`C2SQueryRoles/C2SCreateRole/C2SEnterGame`，GameServer 加载 `PlayerRoleBinaryData`，初始化系统、计算属性、推送 `S2CLoginSuccess`。  
3. **进入副本**：GameServer 通过 `dungeonserverlink` 发起 `G2DEnterDungeonReq`，携带 `SyncAttrData + SkillMap`；DungeonServer 创建实体并回执。  
4. **移动与战斗**：Client 直接连 DungeonServer，移动走 `C2SStartMove/C2SUpdateMove/C2SEndMove`，战斗走 `C2SUseSkill`；DungeonServer 校验后广播结果并同步关键信息到 GameServer。  
5. **掉落拾取**：怪物死亡生成 `DropItem`，玩家 `C2SPickupItem` → DungeonServer 校验归属/距离 → GameServer RPC 检查背包 → 成功后删除掉落，并向 GameServer 推送任务事件。  
6. **副本结算**：限时副本/剧情副本完结后，DungeonServer 通过 `D2GSettleDungeon` 给 GameServer，`FubenSys` 更新记录、发奖励。  
7. **断线重连**：Gateway 关闭连接 → GameServer 收到 Session 关闭事件，标记 `PlayerRole` 离线并允许在 `ReconnectKey` 有效期内重连。

---

## 9. 版本记录

| 日期 | 内容 |
| ---- | ---- |
| 2025-11-17 | 重新整理文档结构，依据当前代码补全架构说明、已完成功能、关键代码位置与注意事项；补充 Gateway 功能与构建状态。 |

---

## 10. 下一步建议

1. 先完成 **防作弊接入** 与 **动画同步**，保证 PvE 基础体验。  
2. 启动 **数据打点**，为之后的平衡性分析做准备。  
3. 规划 **社交/聊天**，利于封闭 Alpha。  
4. 继续保持文档同步：新增/修改系统后，更新“已完成功能”和“关键代码位置”。


