# 游戏服务器开发进度文档（单一权威版本）

更新时间：2025-11-20  
责任人：个人独立开发  

> ⚠️ 自本次更新起，原 `docs/Phase3社交经济架构设计方案.md` 已完全整合到本文，未来所有开发、评审与交接均以本文件为唯一权威信息源。请在每次开发前完整阅读第 0 章与第 7 章，完成新功能后同步"已完成功能 / 待实现 / 注意事项 / 关键代码位置"四个章节。

---

## 0. 开发必读

- **先读后写**：任何新任务开始前必须先阅读"服务器架构""开发注意事项与架构决策"以及"Phase 3 社交经济一体化方案"，确保遵循 Actor/无锁约束与既定数据规范。  
- **文档同步规则**：新功能上线后，将条目上移至"已完成功能"，补充实现细节，并在"关键代码位置"登记入口；若功能仍需分阶段推进，需在"待实现 / 待完善功能"拆分子项。  
- **架构决策记录**：任何重要结构或跨模块约束，均记录在第 7 章；若涉及流程或数据流转变更，请同步绘制在第 5 章相关子节。  
- **关键代码位点**：发现新的核心入口、易踩坑逻辑、隐含约束时立即更新第 8 章，避免知识散落。  
- **阶段性需求拆分**：遇到大需求需分多迭代交付时，将剩余工作写入第 6 章对应小节，并标注前置依赖/完成标准。
- **时间访问规范**：除 proto/第三方库外，所有服务端业务代码必须通过 `server/internal/servertime` 获取时间；禁止直接调用 `time.Now()`、`time.Since()` 等标准库接口，以保证多服务统一时间与可配置偏移。

---

## 1. 项目概述

- **项目名称**：postapocgame（后启示录横版动作）  
- **客户端**：Godot（计划中），运行于 Windows / Android / iOS  
- **服务器语言**：Golang 1.24.10（`go 1.24` toolchain）  
- **服务集合**：`gateway`、`gameserver`、`dungeonserver` 单仓管理  
- **数据层**：SQLite（`server/output/postapocgame.db`）+ GORM，所有玩家数据落于 `PlayerRoleBinaryData`  
- **配置驱动**：`server/output/config/*.json` 26+ 表；需存在于输出目录方可启动  
- **目标部署**：开发使用 Windows；线上兼容 Windows/Linux

---

## 2. 服务器架构

### 2.1 服务划分

| 服务            | 职责                                                                 | 关键目录 |
| --------------- | -------------------------------------------------------------------- | -------- |
| Gateway         | TCP/WS 接入、Session 生命周期、消息压缩/分发、限流、日志             | `server/service/gateway` |
| GameServer      | 玩家长连接逻辑（任务、成长、经济、社交、公会、GM），一玩家一 Actor    | `server/service/gameserver` |
| DungeonServer   | 副本/战斗/掉落/技能状态机，单 Actor 驱动                              | `server/service/dungeonserver` |
| Shared Packages | Actor 框架、事件、网络编解码、Proto、配置、日志、错误码              | `server/internal`, `server/pkg`, `proto/` |

### 2.2 拓扑与通信

```
Client (TCP / WebSocket)
      |
Gateway (SessionManager + ClientHandler)
      | ForwardMessage / SessionEvent
GameServer (per-player Actor + PublicActor)
      | Async RPC (dungeonserverlink / gameserverlink)
DungeonServer (single Actor dungeon runtime)
```

- **会话分发**：Gateway 维护 Session，所有 C2S 消息封装为 `ForwardMessage` 异步转发到 GameServer；Session 事件通过 `gameserverlink` 广播。  
- **Actor 调度**：GameServer 使用 `actor.ModePerKey`（key=SessionId）；`PlayerHandler.Loop()` 通过 `actorCtx.ExecuteAsync` 注入 `gshare.DoRunOneMsg`，确保所有系统 RunOne 在 Actor 主线程执行。  
- **跨服 RPC**：GameServer ↔ DungeonServer 间统一使用 `dungeonserverlink.AsyncCall` 与 `gameserverlink` 注册回调，禁止同步阻塞。  
- **数据持久化**：玩家系统数据序列化为 `protocol.PlayerRoleBinaryData`，落库字段 `Player.BinaryData`；全局数据（公会/拍卖行等）将由 PublicActor 驱动持久化。  
- **公共 Actor**：GameServer 内包含 `PublicActor`（单 Actor）用于社交经济全局数据、在线映射、排行榜等逻辑。

---

## 3. 构建与运行现状

- **Go 版本**：`go 1.24.0`，toolchain `1.24.10`。  
- **最新可执行文件**：  
  - `go build -o server/output/gameserver.exe ./server/service/gameserver`  
  - `go build -o server/output/dungeonserver.exe ./server/service/dungeonserver`  
  - `gateway.exe` 已存在历史构建产物  
- **配置**：`server/output/{gateway,gamesrv,dungeonsrv}.json` + `server/output/config/*.json` 必须齐备。  
- **数据库**：`server/output/postapocgame.db` 随 GameServer 自动迁移，表定义位于 `server/internal/database/*.go`。  
- **日志**：各服务默认输出到 `server/output/log/<service>.log`，同时打印至控制台。  
- **启动顺序建议**：DungeonServer → GameServer → Gateway → 客户端。

---

## 4. 已完成功能

> 若新增子系统或完成阶段性能力，请在对应子节补充实现细节，并描述关键入口/注意事项。

### 4.1 Gateway（接入层）

- 双协议接入：TCP + WebSocket
- Session 生命周期管理、消息转发、限流与资源保护
- 关键代码：`server/service/gateway/internel/clientnet`、`server/service/gateway/internel/engine`

### 4.2 GameServer（玩家主逻辑）

**账号 / 角色 / Session**
- 注册、登录、Token 认证（bcrypt）
- 角色创建/删除/查询/进入游戏流程，账号最多 3 角色
- Session 扩展（AccountID/Token）

**玩家 Actor 与系统框架**
- PlayerRoleActor（ModePerKey）、EntitySystem 动态注册
- BinaryData 加载/保存、事件总线、RunOne 定期存盘

**统一时间与服务器广播**
- `server/internal/servertime` 统一 UTC 时间源
- `timesync.Broadcaster` 每秒广播服务器时间

**成长 / 经济 / 玩法系统**
- 背包、货币、装备、属性、等级、VIP、任务（日/周）、活跃度、成就、商城、物品使用、回收、离线收益、GM、反作弊

**副本协作**
- `FubenSys`、`SkillSys`、`dungeonserverlink` 负责副本进入、技能同步、掉落拾取
- ✅ GameServer 自动识别无法本地处理的 `C2S` 协议，并将 `MsgTypeClient` 消息透传至对应 `DungeonServer`，确保客户端战斗/移动协议无需重复注册

**Phase 3 社交经济系统（全部完成）**
- ✅ **PublicActor 框架**：单 Actor 框架、在线状态管理、消息路由
- ✅ **聊天系统**：世界/私聊、频率限制、敏感词过滤、离线消息（持久化、数量限制、过期清理）
- ✅ **好友系统**：申请/同意/拒绝、列表查询、在线状态联动
- ✅ **排行榜系统**：查询、快照注册、数值更新、自动刷新（上线/等级变化）
- ✅ **公会系统**：创建/解散、申请加入、审批流程、权限管理（会长/副会长/组长/成员）、数据持久化
- ✅ **拍卖行系统**：上架/购买/浏览、过期处理、货币结算、物品交付、数据持久化
- ✅ **社交安全系统**：配置化敏感词库、交易审计、黑名单机制

**服务器开服信息**
- `server/internal/database/server_info.go` 存储开服时间，`gshare.GetOpenSrvDay()` 获取开服天数

### 4.3 DungeonServer（副本与战斗）

- 单 Actor 主循环、实体层（角色/怪物/掉落/AOI）
- 状态机、Buff、AI、技能、战斗系统
- 移动同步（速度校验、异常回滚）
- 技能释放校验（`Effects` 为空时返回错误）
- 技能广播（释放成功/伤害结果，客户端驱动动画）

### 4.4 共享基础能力

- Actor 框架（ModeSingle / ModePerKey）
- 网络编解码、压缩、连接池
- 统一时间源（servertime）
- 事件总线（gevent）
- Proto 体系
- 日志、错误码、工具函数

### 4.5 调试客户端（Golang 文字冒险面板）

- 新增 `server/example` 文本冒险式调试客户端，默认自动连接 Gateway，提供 `register/login/roles/create-role/enter/status/look/move/attack` 等命令，完整覆盖账号→角色→进场景→战斗链路
- 基于 `AdventurePanel` + `GameClient` + Actor 管理器实现，所有命令均直接映射到现有协议，便于录制/回放
- `docs/golang客户端待开发文档.md` 记录后续扩展计划与命令映射，是调试客户端的唯一规划文档
- 交互层采用“标题区 + 日志区 + 命令区”三段式布局，支持数字/快捷键菜单操作，贴合古早文字冒险体验

---

## 5. Phase 3 社交经济架构设计

### 5.1 架构原则

**PublicActor 职责**
1. 全局数据管理：公会、拍卖行、排行榜等权威数据
2. 跨玩家消息路由：聊天、好友请求、公会审批等
3. 在线状态管理：`roleId → SessionId` 映射
4. 快照缓存：角色展示、排行榜展示数据
5. 数据持久化：公会与拍卖行必须落库（独立表）

**PlayerActor 职责**
1. 管理自身数据：好友、公会归属、拍卖上架记录均存于 `PlayerRoleBinaryData`
2. EntitySystem 承载业务：`FriendSys`、`GuildSys`、`AuctionSys` 均在 `entitysystem` 目录实现
3. 数据更新 → 主动通知 PublicActor（排行榜数值、快照、在线状态）
4. 客户端协议入口：接入请求、做合法性校验、转发/回调 PublicActor

**协作模式**
```
客户端
  ↓
PlayerActor（校验 + 防刷）
  ↓
PublicActor（全局逻辑 / 数据持久化）
  ↓
PlayerActor（通知/回写）
  ↓
客户端
```

### 5.2 Proto 与数据定义

> 修改 Proto 后务必运行 `proto/genproto.sh && gofmt`.

- `proto/csproto/social_def.proto`：ChatType、ChatMessage、RankType、RankData、PlayerRankSnapshot、GuildPosition、GuildMember、GuildData、AuctionItem
- `proto/csproto/system.proto`：SiFriendData、SiGuildData、SiAuctionData
- `proto/csproto/player.proto`：PlayerRoleBinaryData 新增社交字段
- `proto/csproto/rpc.proto`：PublicActor ↔ PlayerActor 内部消息定义

详细定义见代码，此处不再重复。

### 5.3 EntitySystem 实现模式

所有社交系统与 BinaryData 直接共享内存引用，禁止复制；修改即持久化。系统需在 `entitysystem.RegisterSystemFactory` 注册，ID 放入 `protocol.SystemId`。

### 5.4 PublicActor 持久化策略

- **公会**：`database.Guild` 表，变更时立即持久化
- **拍卖行**：`database.AuctionItem` 表，定期过期检测
- **数据恢复**：GameServer 启动时加载所有公会/拍卖数据到 PublicActor
- **日志对齐**：重要事件需写 `pkg/log` 并可选落地到审计表

---

## 6. 待实现 / 待完善功能

> 完成后请及时上移至第 4 章，并描述实现细节。

### 6.1 Phase 2 核心玩法（进行中）

1. **战斗录像**：录制/回放/存储链路
2. **多人副本匹配/排队**：匹配算法 + 排队策略
3. **Boss 特殊机制**：阶段技能、掉落表
4. **防作弊链路完善**：协议级频率检测、移动测速、伤害/CD 校验
5. **数据统计与分析**：关键事件打点、性能监控、行为分析
6. **技能配置巡检**：对 `skillCfg.Effects` 为空的技能补齐配置，避免运行期被判定为释放失败

### 6.2 Phase 4 PvP（待规划）

1. **竞技场系统**：匹配、战斗、积分与奖励
2. **实时配对系统**：ELO/MMR 算法、断线处理
3. **评分系统**：积分计算、排名调整、赛季重置

### 6.3 Golang 文字冒险面板（待完善）

1. **GCLI-1 背包/物品指令**：面板命令映射 `BagSys/ItemSys`，支持查看、使用、掉落拾取
2. **GCLI-2 养成/任务面板**：等级/属性/任务/活跃度等信息展示与常用交互
3. **GCLI-3 战斗脚本化**：录制/回放巡逻与技能循环，输出命中/伤害统计
4. **GCLI-4 副本/匹配流程**：接入 `FubenSys`、多人副本匹配、战斗录像触发
5. **GCLI-5 GM/调试命令桥接**：面板命令映射 GM 协议，支持批量脚本
6. **GCLI-6 协议录制回放**：保存命令序列与服务端回包，支撑回归测试
7. **GCLI-7 多 Session 支持**：单面板管理多客户端（机器人），验证社交/战斗

---

## 7. 开发注意事项与架构决策

### 7.1 Actor / 并发约束

- 每位玩家仅一个 Actor；DungeonServer 单 Actor。禁止在业务逻辑中额外创建 goroutine 访问玩家状态
- 所有玩家系统禁止使用 `sync.Mutex`；数据只能源自 `PlayerRoleBinaryData`
- PublicActor 负责所有跨玩家数据，保持无锁；如需并行计算，必须在 Actor 外封装异步任务并通过消息返回

### 7.2 数据与存储

- 数据库仅存 `PlayerRoleBinaryData`（玩家侧）+ 公会/拍卖等全局数据（PublicActor 持久化）
- 属性由 `AttrSys` 实时计算，禁止持久化最终属性值
- 定期存盘：默认每 5 分钟，可按需调整 `_5minChecker`
- 所有错误日志必须包含关键上下文（RoleID、ItemID、QuestID 等）
- `server/internal/database` 的元数据时间列统一使用秒级 Unix 时间戳（int64），禁止直接写入 `time.Time`

### 7.3 协议与 Proto 规范

- 共享枚举/结构统一位于 `proto/csproto/*.proto`；修改后执行 `proto/genproto.sh` 并 `gofmt`
- 枚举放入 `*_def.proto`；系统数据放入 `system.proto`；玩家数据放入 `player.proto`；协议消息在 `cs.proto/sc.proto`；内部消息在 `rpc.proto`
- 若数据无法使用 Proto，放入 `server/internal/argsdef/`

### 7.4 网络与安全

- Gateway Session `Stop` 必须幂等；GameServer 需正确处理 `SessionEventClose`
- `pkg/log` 为唯一日志入口，禁止 `fmt.Println`
- WebSocket/TCP 尚未加 TLS/鉴权，线上前需补齐
- 防作弊：频率检测、移动测速、伤害验证、CD 校验需逐步接入协议链路
- GameServer 在 `handleDoNetWorkMsg` 中将无法本地处理的 `C2S` 协议以 `msgId=0` 调用 `dungeonserverlink.AsyncCall`，底层会编码为 `MsgTypeClient` 并带上 `sessionId`；禁止直接构造自定义格式，避免 DungeonServer 无法识别会话

### 7.5 Phase 3 特殊决策

- **PublicActor + PlayerActor 协作** 是所有社交经济功能的唯一方案
- 排行榜仅存 key/value；展示数据来自快照，缺失时异步补全
- EntitySystem 模板统一；所有社交系统均需在 `entitysystem` 下注册
- 公会/拍卖行必须持久化并在 GameServer 启动时加载至 PublicActor
- **PublicActor 消息处理**：所有消息处理器函数签名必须符合 `actor.HandlerMessageFunc`
- **在线状态管理**：玩家上线时通过 `RegisterOnlineMsg` 注册到 PublicActor，下线时通过 `UnregisterOnlineMsg` 注销
- **PublicActor 内部消息 ID 规范**：所有 PublicActor 内部消息 ID 必须统一使用 Proto 中的 `PublicActorMsgId` 枚举定义

### 7.6 时间同步与客户端动画职责

- 所有服务一律通过 `server/internal/servertime` 读取权威 UTC 时间，禁止直接调用 `time.Now()`
- 服务器时间广播由 GameServer 的 `timesync.Broadcaster` 统一承担
- 技能/动作动画完全由客户端驱动：服务端只计算技能释放成功与伤害批次并广播，客户端根据协议结果自行播放

### 7.7 技能配置校验

- 所有技能必须至少包含一个 `skillCfg.Effects` 条目；若为空，`skill.Skill.Use` 会直接返回 `ErrSkillCannotCast`

### 7.8 调试客户端约束

- `server/example` 视为服务端代码，必须使用 `servertime` 读取时间，禁止 `time.Now()` 直接调用
- 文字冒险面板命令需与现有协议一一映射，禁止在 `GameClient` 中硬编码临时逻辑
- 所有扩展设计、命令列表、待办事项统一记录在 `docs/golang客户端待开发文档.md`
- 扩展命令前优先复用 `AdventurePanel` 解析与 `GameClient` 能力，禁止创建平行脚本

---

## 8. 关键代码位置

### 8.1 Gateway
- `server/service/gateway/internel/clientnet`：Session 与消息适配
- `server/service/gateway/internel/engine`：Gateway 配置解析及 TCP/WS 启停

### 8.2 GameServer - 玩家 Actor
- `server/service/gameserver/internel/playeractor`：玩家 Actor Handler / Adapter / `PlayerRole`
- `server/service/gameserver/internel/playeractor/entitysystem/*`：所有玩家子系统
  - `entitysystem/friend_sys.go`：好友系统
  - `entitysystem/guild_sys.go`：公会系统
  - `entitysystem/auction_sys.go`：拍卖行系统
  - `entitysystem/chat_sys.go`：聊天系统
- `server/service/gameserver/internel/playeractor/entity/player_network.go`：客户端协议处理入口
- `server/service/gameserver/internel/gshare/log_helper.go`：日志上下文辅助（自动输出 Session/Role 信息）

### 8.3 GameServer - PublicActor
- `server/service/gameserver/internel/publicactor/adapter.go`：PublicActor 适配器，单 Actor 模式
- `server/service/gameserver/internel/publicactor/handler.go`：PublicActor 消息处理器
- `server/service/gameserver/internel/publicactor/public_role.go`：公共角色数据管理（在线状态、排行榜、公会、拍卖行）
- `server/service/gameserver/internel/publicactor/message_handler.go`：PublicActor 消息处理函数

### 8.4 GameServer - 其他
- `server/service/gameserver/internel/dungeonserverlink`：DungeonServer RPC 客户端
  - `dungeon_cli.go`：`AsyncCall` 对 `msgId=0` 的调用封装 `MsgTypeClient` 透传，保持 sessionId
- `server/service/gameserver/internel/gatewaylink`：与 Gateway 的 Session 映射与消息转发
- `server/service/gameserver/internel/timesync`：服务器时间广播器
- `server/service/gameserver/internel/gshare/srv.go`：平台/区服常量、开服时间、`GetOpenSrvDay`
- `server/service/gameserver/internel/manager/role_mgr.go`：玩家角色管理、关服刷盘 `FlushAndSave`

### 8.5 DungeonServer
- `server/service/dungeonserver/internel/clientprotocol`：DungeonServer 协议入口
- `server/service/dungeonserver/internel/entitysystem/*`：AI、Buff、Attr、Move、Fight、StateMachine、AOI
- `server/service/dungeonserver/internel/fuben` & `fbmgr`：副本实例与结算逻辑
- `server/service/dungeonserver/internel/skill/skill.go`：技能目标筛选、配置校验、结果填充

### 8.6 数据库
- `server/internal/database`：账号/角色/Token 访问层
- `server/internal/database/server_info.go`：平台/区服开服信息表
- `server/internal/database/guild.go`：公会数据持久化
- `server/internal/database/auction_item.go`：拍卖行数据持久化
- `server/internal/database/offline_message.go`：离线消息持久化
- `server/internal/database/transaction_audit.go`：交易审计
- `server/internal/database/blacklist.go`：黑名单管理

### 8.7 共享基础
- `server/internal/actor`：Actor 框架
- `server/internal/network`：消息编解码、压缩
- `server/internal/network/codec.go` & `message.go`：前向消息池化、缓冲复用
- `server/internal/servertime`：统一时间源
- `server/internal/event`：事件总线
- `server/internal/jsonconf`：配置加载与缓存
- `server/pkg/log`：统一日志组件（级别控制、结构化字段、文件轮转）
- `proto/csproto/*.proto`：协议定义
- `server/internal/protocol/*.pb.go`：协议生成结果

### 8.8 调试客户端（server/example）
- `server/example/adventure_panel.go`：文字冒险面板、命令解析、状态管理
- `server/example/game_client.go`：客户端协议封装、AOI/技能监听、状态同步
- `server/example/client_handler.go`：Actor Handler，负责解包 `S2C` 消息并分发
- `docs/golang客户端待开发文档.md`：调试客户端规划、命令映射、待办

---

## 9. 核心运行流程（摘要）

1. **登录**：Client → Gateway → GameServer (`C2SRegister/C2SLogin`) → `database.Account` 校验 → Token + Session 扩展
2. **角色管理**：`C2SQueryRoles/C2SCreateRole/C2SEnterGame` → 加载 `PlayerRoleBinaryData` → 初始化系统 → `S2CLoginSuccess`
3. **进入副本**：GameServer 通过 `dungeonserverlink` 发 `G2DEnterDungeonReq`（含属性/技能），DungeonServer 创建实体并回执
4. **移动与战斗**：客户端直接连接 DungeonServer，移动走 `C2SStart/Update/EndMove`，技能走 `C2SUseSkill`；DungeonServer 校验并广播，必要信息回传 GameServer
5. **掉落拾取**：DungeonServer 判定归属/距离 → GameServer RPC 检查背包 → 成功则删除掉落并触发任务事件
6. **副本结算**：DungeonServer 发送 `D2GSettleDungeon` → GameServer `FubenSys` 更新记录、发奖励
7. **断线重连**：Gateway 关闭连接 → GameServer 接收 `SessionEventClose`，标记离线并允许在 `ReconnectKey` 有效期内重连

---

## 10. 版本记录

| 日期 | 内容 |
| ---- | ---- |
| 2025-11-24 | 日志管理优化：`server/pkg/log` 新增结构化字段 & 环境级别控制，完成 11.2.9 |
| 2025-11-24 | 优化资源清理：ForwardMessage 池化、Gateway 转发链路释放消息，完成 11.2.7 资源清理检查 |
| 2025-11-21 | **生产环境优化修复**：修复时间访问规范违反（chat_sys.go、session_mgr.go）、添加数据库连接池配置、在 Actor 消息处理中添加 Panic 恢复机制 |
| 2025-11-20 | 重新梳理文档结构，简化已完成功能描述，清理待实现章节，优化文档可读性 |
| 2025-11-21 | 新增 `server` 表存储开服信息，提供 `gshare.GetOpenSrvDay()`；统一数据库时间字段为秒级 Unix 时间戳 |
| 2025-11-20 | 完成 Phase 3 社交经济系统：聊天、好友、排行榜、公会、拍卖行、社交安全系统全部完成 |
| 2025-11-20 | 完成 Phase 3 社交经济基础框架：PublicActor 框架、Proto 定义、EntitySystem 基础 |
| 2025-11-17 | 依据当前代码补全架构说明、已完成功能、关键代码位置与注意事项 |

---

## 11. 生产环境优化建议（优先处理）

> 以下优化项基于对 `server/service` 目录的代码审查，建议按优先级逐步实施。

### 11.1 关键问题修复（高优先级）

#### 1. 时间访问规范违反 ✅ **已修复**
- **问题**：部分代码直接使用 `time.Now()` 而非 `servertime.Now()`
- **位置**：
  - `server/service/gameserver/internel/playeractor/entitysystem/chat_sys.go:64` - `time.Now()` 应改为 `servertime.Now()`
  - `server/service/gateway/internel/clientnet/session_mgr.go:58,136,163` - `time.Now()` 应改为 `servertime.Now()`
- **影响**：可能导致多服务时间不同步，影响时间相关业务逻辑
- **修复**：统一替换为 `servertime.Now()`，确保所有服务使用统一时间源
- **修复详情**：
  - `chat_sys.go`: 将 `time.Now()` 改为 `servertime.Now()`，`time.Since()` 改为 `servertime.Since()`
  - `session_mgr.go`: 将三处 `time.Now()` 改为 `servertime.Now()`

#### 2. 数据库连接池配置缺失 ✅ **已修复**
- **问题**：`server/internal/database/database.go` 中未配置连接池参数
- **影响**：可能导致连接泄漏、性能瓶颈
- **修复**：已添加连接池配置
  - 最大打开连接数：25
  - 最大空闲连接数：10
  - 连接最大生存时间：5分钟
  - 连接最大空闲时间：10分钟
- **关键代码位置**：`server/internal/database/database.go:22-32`

#### 3. Panic 恢复机制缺失 ✅ **已修复**
- **问题**：Actor 消息处理、goroutine 中缺少 panic 恢复
- **影响**：单个 panic 可能导致整个服务崩溃
- **修复**：在 Actor 消息处理入口使用 `routine.Run()` 添加 panic 恢复
- **修复详情**：
  - `actor_context.go`: 在 `doMsgLogic` 和 `Loop()` 调用处使用 `routine.Run()` 包装，确保 panic 被捕获并记录日志
- **关键代码位置**：`server/internal/actor/actor_context.go:114-143`

### 11.2 性能与稳定性优化（中优先级）

#### 4. 配置验证与默认值 ✅ **已完成**
- **改动**：Gateway/GameServer/DungeonServer 三个服务在配置加载阶段统一补齐默认值并做严格校验
- **细节**：
  - `server/service/gateway/internel/engine/config.go`：校验 TCP/WS 地址、会话缓冲区、帧大小并提供默认值
  - `server/service/gameserver/internel/config/config.go`：校验 `app_id/platform_id/srv_id`、Actor 配置及 `dungeon_server_addr_map`
  - `server/service/dungeonserver/internel/config/config.go`：校验监听地址、Actor 邮箱，默认 `srv_type=1`
- **收益**：配置错误在启动前即被捕获，避免因端口/缓冲区异常导致线上崩溃

#### 5. 错误处理与日志改进 ✅ **已完成**
- **改动**：
  - 新增 `gshare/log_helper.go`，自动在日志前缀附带 `sessionId/roleId`
  - 登录/注册/进入游戏/协议转发等路径统一使用上下文日志（`player_network.go`）
- **收益**：日志可以直接定位玩家与协议，排障效率显著提升

#### 6. 优雅关闭完善 ✅ **已完成**
- **改动**：
  - `manager/role_mgr.go` 新增 `FlushAndSave`，逐个玩家落库并支持超时
  - `gameserver/main.go` 在停止 PlayerActor 后调用 Flush，确保所有玩家状态保存完成
- **收益**：停服过程不会丢失玩家数据，关闭日志更清晰可追溯

#### 7. 资源清理检查 ✅ **已完成**
- **改动**：
  - `network/codec.go` 统一使用 `ForwardMessage` 对象池，并在解码阶段复制 payload，避免与底层 socket buffer 共享内存
  - `network/message.go` 调整 `ForwardMessage.Reset()`，仅重置长度，保留底层缓冲以复用
  - `gateway/internel/gameserverlink/game_cli.go` 当接收通道满或丢弃消息时及时归还 `ForwardMessage`
  - `gateway/internel/engine/server.go` 派发完成后显式 `PutForwardMessage`，确保所有消息均回收到池中
- **收益**：转发路径上的 buffer 与 `ForwardMessage` 对象不再泄漏或复用异常，长时间运行内存占用稳定

### 11.3 监控与可观测性（中优先级）

#### 8. 性能监控指标
- **建议**：
  - 消息处理延迟统计（P50/P95/P99）
  - 数据库查询时间统计
  - Actor 消息队列长度监控
  - 连接数、Session 数监控
  - 内存使用监控
  - 可考虑集成 Prometheus + Grafana

#### 9. 日志管理优化 ✅ **已完成**
- **改动**：
  - `server/pkg/log` 新增 `Fields` / `WithFields` / `InfofWithFields` 等接口，支持结构化 `key=value` 日志
  - 支持 `LOG_LEVEL` / `LOG_COLOR` 环境变量与 `WithColor()` Option，可在生产环境关闭 Debug 或彩色输出
  - 默认日志级别为 Info（可运行期 `SetLevel` 调整），FATAL/ERROR 等关键日志也可携带字段
- **收益**：日志格式与级别由配置驱动，关键路径可输出上下文字段，满足排障与审计需求

### 11.4 安全性增强（中优先级）

#### 10. 输入验证加强
- **建议**：
  - 所有客户端输入进行严格验证
  - 数值范围检查（防止溢出）
  - 字符串长度限制
  - 敏感操作频率限制

#### 11. 数据库操作优化
- **建议**：
  - 为所有数据库操作添加超时设置
  - 检查是否有 N+1 查询问题
  - 关键操作添加事务保护
  - 定期检查慢查询

#### 12. TLS/SSL 支持
- **问题**：文档中提到 WebSocket/TCP 尚未加 TLS/鉴权
- **建议**：
  - 生产环境必须启用 TLS
  - 实现客户端证书验证（可选）

### 11.5 功能完善（低优先级）

#### 13. 配置热重载
- **建议**：实现配置热重载机制，无需重启服务即可更新部分配置

#### 14. 健康检查接口
- **建议**：添加 HTTP 健康检查接口，用于负载均衡和监控

#### 15. 数据备份机制
- **建议**：
  - 定期自动备份数据库
  - 实现数据恢复流程
  - 关键数据操作前备份（可选）

### 11.6 代码质量（低优先级）

#### 16. 单元测试覆盖
- **建议**：为核心业务逻辑添加单元测试

#### 17. 集成测试
- **建议**：添加端到端集成测试

#### 18. 代码文档
- **建议**：补充关键函数和复杂逻辑的注释

---

## 12. 下一步建议

1. ~~**立即修复**：时间访问规范违反（11.1.1）、数据库连接池配置（11.1.2）、Panic 恢复机制（11.1.3）~~ ✅ **已完成**
2. ~~**短期优化**：配置验证（11.2.4）、错误处理改进（11.2.5）、优雅关闭完善（11.2.6）~~ ✅ **已完成**
3. **中期建设**：性能监控（11.3.8）、安全性增强（11.4）
4. **长期完善**：功能完善（11.5）、代码质量（11.6）
5. 完成 **防作弊接入** 与 **技能结果监控**，保障 PvE 体验
6. 新增/修改系统后，立即更新本文件的"已完成功能""关键代码位置""待实现"与"注意事项"
