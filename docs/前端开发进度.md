## 0. 开发必读
- 权威设计文档：`docs/vue3实现方案.md`、`docs/fullstack_prompt.md`。遵循 Page → Component → Store → API → Backend 分层，generated 代码禁止手改。
- goctl 前后端协同：使用 `pnpm api:gen` 或直接执行 goctl 生成 TS（输出到 `src/api/generated/`），业务封装写在 `src/api/*.ts`。
- **开发流程规范（强制遵守）**：
  1. **确定要开发的功能**：明确功能需求，确定模块名称和功能描述
  2. **生成前端页面骨架**：使用 `scripts/generate-sql.sh -group <group> -name <name>` 生成前端页面 xxx.vue 骨架文件
  3. **等待后端完成**：等待后端完成 API 定义和实现，确保后端接口可独立测试通过
  4. **生成 TS 代码**：使用 `scripts/generate-ts.sh <api_file>` 从后端 .api 文件生成 TS 代码
  5. **完善前端页面**：基于生成的页面骨架和 TS 代码，完善前端页面和组件功能
  6. **前后端联调**：前后端联调接口，测试完整流程，确保功能正常
  7. **测试通过后再开发下一个功能**：每个功能必须完整实现并测试通过后，才能开始下一个功能的开发
- **通用组件使用规范**：
  - **D2Table 组件**（`src/components/common/D2Table.vue`）：适用于所有涉及表格展示、分页、详情/编辑、新增的业务页面
    - 功能：统一的表格展示、分页、内置详情/编辑抽屉、内置新增抽屉、支持多种列类型
    - 使用场景：列表管理页面（如角色管理、权限管理、用户管理等）
    - 参考示例：`src/views/system/RoleList.vue`、`src/views/system/PermissionList.vue`、`src/views/system/UserList.vue`
    - 组件文档：`src/components/common/README.md`
    - 类型定义：`src/types/table.ts`
  - **el-tree 组件**：适用于树形数据展示（如部门管理、菜单管理）
    - 参考示例：`src/views/system/DepartmentList.vue`、`src/views/system/MenuList.vue`
- **数据字典使用规范（必须遵守）**：
  - **字典的使用场景**：
    - **状态枚举**：用户状态、订单状态、审核状态等需要在多个地方使用的状态值
    - **类型分类**：文件类型、存储类型、支付方式、物流方式等业务类型
    - **选项列表**：性别、是否、地区、行业等需要在表单中下拉选择的选项
    - **业务常量**：需要在多个模块中复用的常量值，如用户等级、会员类型等
    - **配置选项**：需要动态调整且可能频繁变更的配置项，如通知类型、消息模板类型等
  - **优先考虑使用字典的情况**：
    - 前端需要在下拉选择框（`el-select`）、单选框（`el-radio-group`）、多选框（`el-checkbox-group`）等组件中展示的选项
    - 需要在多个页面或模块中复用的枚举值
    - 需要由业务人员或管理员动态维护的选项（不需要改代码）
    - 需要支持多语言或国际化显示的选项
    - 需要在表格列中显示标签（`el-tag`）的状态或类型字段
    - 需要在搜索条件中使用的筛选选项
  - **字典使用流程**：
    1. 在开发新功能时，先评估字段是否需要使用字典
    2. 如果需要，**后端开发人员编写增量字典插入 SQL 语句**（见后端文档「字典 SQL 插入规范」）
    3. 后端执行字典 SQL 语句，创建字典类型和字典项
    4. 前端通过 `dictGet({code: 'dict_code'})` API 获取字典项列表
    5. 在表单组件中使用字典项作为选项数据源
    6. 在表格列中使用字典项进行值转换显示（如状态标签）
  - **字典 SQL 插入规范（后端负责）**：
    - **字典数据通过 SQL 语句新增**：所有字典类型和字典项的数据都通过 SQL 语句插入，不在管理界面中手动创建
    - **增量 SQL 格式**：在 `admin-server/db/data.sql` 文件中，字典相关的 SQL 应放在统一位置
    - **字典类型 SQL 模板**：
      ```sql
      -- {功能模块}相关字典类型
      INSERT INTO `admin_dict_type` (`id`, `name`, `code`, `description`, `status`, `created_at`, `updated_at`, `deleted_at`)
      VALUES 
        ({id}, '{字典类型名称}', '{字典类型编码}', '{字典类型描述}', 1, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), 0)
      ON DUPLICATE KEY UPDATE 
        `name`=VALUES(`name`), 
        `description`=VALUES(`description`), 
        `updated_at`=UNIX_TIMESTAMP(), 
        `deleted_at`=0;
      ```
    - **字典项 SQL 模板**：
      ```sql
      -- {字典类型名称}字典项
      INSERT INTO `admin_dict_item` (`id`, `type_id`, `label`, `value`, `sort`, `status`, `remark`, `created_at`, `updated_at`, `deleted_at`)
      VALUES 
        ({id1}, {type_id}, '{字典项标签1}', '{字典项值1}', 1, 1, '{备注1}', UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), 0),
        ({id2}, {type_id}, '{字典项标签2}', '{字典项值2}', 2, 1, '{备注2}', UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), 0)
      ON DUPLICATE KEY UPDATE 
        `label`=VALUES(`label`), 
        `value`=VALUES(`value`), 
        `sort`=VALUES(`sort`), 
        `status`=VALUES(`status`), 
        `remark`=VALUES(`remark`), 
        `updated_at`=UNIX_TIMESTAMP(), 
        `deleted_at`=0;
      ```
    - **前端使用字典的注意事项**：
      - 前端不需要关心字典数据的创建，只需通过 API 获取字典项列表
      - 如果字典数据不存在，API 会返回空列表，前端应做容错处理
      - 字典项的 `value` 字段通常存储为字符串，前端使用时可能需要类型转换
  - **字典 API 使用示例**：
    ```typescript
    import { dictGet } from '@/api/generated/admin';
    
    // 获取字典项列表
    const resp = await dictGet({ code: 'user_status' });
    const options = resp.items.map(item => ({
      label: item.label,
      value: item.value
    }));
    ```

---

## 1. 已完成功能
- 初始化 admin-frontend（Vite + Vue3 + TS + Pinia + Vue Router + Element Plus），内置登录页、基础布局、菜单导航。
- 封装 Axios 请求与 Token 拦截（`src/utils/request.ts`），Pinia 用户状态与登录/登出（`src/stores/user.ts`）。
- 角色管理页面：列表查询、分页、新增、编辑、删除，对接 `/api/v1/roles`。
- 权限管理页面：列表查询、分页、新增、编辑、删除，对接 `/api/v1/permissions`。
- 部门管理页面：部门树展示、新增/编辑/删除，对接 `/api/v1/departments/tree` 等接口。
- 菜单管理页面：菜单树展示、新增/编辑/删除，对接 `/api/v1/menus/tree` 等接口。
- 用户管理页面：列表查询、分页、新增、编辑、删除，对接 `/api/v1/users`。
- goctl TS 生成脚本：`pnpm api:gen`（调用 `scripts/api-gen.mjs` 批量生成后端 .api 的 TS 代码）。
- 按钮级权限指令 `v-permission`，路由级权限校验（meta.permission），菜单/按钮按权限过滤渲染。
- 菜单树拉取 `/api/v1/menus/tree` 并在侧栏展示。
- 主题样式基础变量、403/404 错误页，内置 i18n（zh/en 文案覆盖），主题切换（明亮/暗色）。
- 权限/菜单本地缓存（TTL 5min），登录后自动加载缓存并按需刷新。
- 动态路由注入与 KeepAlive 缓存（菜单路径映射至页面组件，meta.keepAlive 为 true）。
- 阶段四 系统支撑页面：
  - 系统配置管理页面（ConfigList.vue）：列表查询、分页、新增、编辑、删除，支持刷新缓存功能。
  - 数据字典类型管理页面（DictTypeList.vue）：列表查询、分页、新增、编辑、删除，支持刷新缓存功能。
  - 数据字典项管理页面（DictItemList.vue）：列表查询、分页、新增、编辑、删除。
  - 文件管理页面（FileList.vue）：列表查询、分页、新增、编辑、删除，支持文件上传和下载功能。
- 通用组件集成：所有列表管理页面已集成 `D2Table` 组件，统一表格展示、分页、详情/编辑、新增功能。

---

## 2. 待实现 / 待完善功能
- [✅] 阶段三：RBAC 权限/组织/菜单管理（用户/角色/权限/部门/菜单/按钮）
  - [✅] 角色管理页面（列表、新增、编辑、删除）
  - [✅] 权限管理页面（列表、新增、编辑、删除）
  - [✅] 部门管理页面（树形展示、新增、编辑、删除）
  - [✅] 菜单管理页面（树形展示、新增、编辑、删除）
  - [✅] 用户管理页面（列表、新增、编辑、删除）
- [✅] 阶段四：系统支撑（系统配置、数据字典、文件存储）
  - [✅] 系统配置管理页面（列表、新增、编辑、删除、刷新缓存）
  - [✅] 数据字典类型管理页面（列表、新增、编辑、删除、刷新缓存）
  - [✅] 数据字典项管理页面（列表、新增、编辑、删除）
  - [✅] 文件管理页面（列表、新增、编辑、删除、上传、下载）
- [ ] 菜单组件路径与后端约定的自动映射策略（当前手工 map）。
- [ ] 主题更多维度（色板、字体），国际化文案进一步细化。
- [ ] 单元测试与 E2E 验证。

---

## 3. 技术决策记录
- 2025-12-24：前端使用 goctl TS 生成 + Axios 二次封装；对生成代码中的 path param 问题在自定义 API 层修正（不修改 generated）。
- 2025-12-24：权限指令 v-permission 基于 Pinia 权限列表与 `permissions.includes('*')`；路由 meta.permission 校验不通过跳转 403。
- 2025-12-24：权限/菜单本地缓存 TTL 5 分钟；动态路由由菜单树驱动并开启 KeepAlive；主题切换通过 `data-theme`。

---

## 4. 关键代码位置
- 入口：`src/main.ts`，路由：`src/router/index.ts`，布局：`src/layouts/DefaultLayout.vue`，登录：`src/views/Login.vue`。
- 状态：`src/stores/user.ts`；请求封装：`src/utils/request.ts`。
- 角色页：`src/views/system/RoleList.vue`；API 封装：`src/api/role.ts`。
- 权限页：`src/views/system/PermissionList.vue`；API 封装：`src/api/permission.ts`。
- 部门页：`src/views/system/DepartmentList.vue`；API 封装：`src/api/department.ts`。
- 菜单页：`src/views/system/MenuList.vue`；API 封装：`src/api/menu.ts`。
- 用户页：`src/views/system/UserList.vue`；API 封装：`src/api/user.ts`。
- 系统配置页：`src/views/system/ConfigList.vue`；API 封装：`src/api/generated/admin.ts`。
- 字典类型页：`src/views/system/DictTypeList.vue`；API 封装：`src/api/generated/admin.ts`。
- 字典项页：`src/views/system/DictItemList.vue`；API 封装：`src/api/generated/admin.ts`。
- 文件管理页：`src/views/system/FileList.vue`；API 封装：`src/api/generated/admin.ts`。
- goctl 生成目录：`src/api/generated/`；生成脚本：`scripts/generate-ts.sh`。
- 权限指令与钩子：`src/directives/permission.ts`，`src/hooks/usePermission.ts`。
- 菜单 API 与渲染：`src/api/menu.ts`，`src/layouts/DefaultLayout.vue`。
- 错误页：`src/views/error/NoAccess.vue`，`src/views/error/NotFound.vue`。
- 主题与 i18n：`src/styles/theme.scss`，`src/i18n/index.ts`。
- 路由/缓存：`src/router/index.ts`（动态注入 + meta.keepAlive）、`src/App.vue`（KeepAlive 包裹）。

---

## 5. 接口对接进度
- 角色管理：GET/POST/PUT/DELETE `/api/v1/roles` ✅
- 权限管理：GET/POST/PUT/DELETE `/api/v1/permissions` ✅
- 部门管理：GET `/api/v1/departments/tree`，POST/PUT/DELETE `/api/v1/departments/:id` ✅
- 菜单管理：GET `/api/v1/menus/tree`，POST/PUT/DELETE `/api/v1/menus/:id` ✅
- 用户管理：GET/POST/PUT/DELETE `/api/v1/users` ✅
- 认证：POST `/api/v1/auth/login`、POST `/api/v1/auth/logout`、GET `/api/v1/auth/profile` ✅（登录页接入）
- 系统配置管理：GET `/api/v1/configs`、GET `/api/v1/configs/:key`、POST/PUT/DELETE `/api/v1/configs` ✅
- 数据字典类型管理：GET/POST/PUT/DELETE `/api/v1/dict-types` ✅
- 数据字典项管理：GET/POST/PUT/DELETE `/api/v1/dict-items` ✅
- 公共字典查询：GET `/api/v1/dict` ✅
- 文件管理：GET/POST/PUT/DELETE `/api/v1/files`、POST `/api/v1/files/upload`、GET `/api/v1/files/:id/download` ✅
- 缓存管理：POST `/api/v1/cache/refresh` ✅

