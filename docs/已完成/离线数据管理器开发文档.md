# 离线数据管理器开发文档（离线快照统一方案）

更新时间：2025-11-27  
责任人：公共Actor / 玩家Actor 协同开发  

> ⚠️ 开发本功能前务必先通读《`docs/服务端开发进度文档.md`》中的“开发必读”“开发注意事项与架构决策”两章，并严格遵守 Actor 单线程、统一时间源与 Proto 规范。

---

## 0. 文档目的与阅读须知

- 本文提供 `server/service/gameserver` 内“离线数据管理器”功能的背景、参考实现拆解、目标架构与实施步骤，是重构 `PublicRole.rankSnapshotMap` 的唯一权威说明。
- 阅读顺序建议：先看第 1-3 章了解背景与问题，再看第 4-5 章制定开发计划，最后执行第 6-7 章中的测试与注意事项。
- 如果后续扩展离线数据类型（如时装、形象、阵容等），必须在本文补充数据结构、序列化要求与落库字段，并在 `docs/服务端开发进度文档.md` 同步待办。

---

## 1. 背景

现状：`PublicRole` 通过 `rankSnapshotMap` 以内存形式缓存玩家排行榜展示数据。一旦 GameServer 重启，PublicActor 的内存态被清空，直到玩家重新上线并再次调用 `UpdateRankSnapshot` 后，PublicActor 才能重新获得展示数据，导致：

1. 服务器重启后的排行榜为空或缺失快照，影响客户端展示。
2. 排行榜之外的其他公共系统同样缺少“离线快照”概念，无法提供可扩展的离线数据集合。
3. 无落库记录，排障或历史回放困难。

目标：仿照 `server` 中 `OfflineDataManager` 的做法，引入“离线数据管理器”，统一负责玩家离线快照的落库、加载、更新与查询，并将排行榜快照作为第一阶段落地的数据类型。

---

## 2. 参考项目（server）实现梳理

> 关键文件：`server/server/gameserver/logicworker/manager/offline_data.go`、`server/server/gameserver/dbworker/offline_data.go`

| 能力 | 说明 |
| --- | --- |
| 数据结构 | `offlineData map[playerId]map[dataId]*offlineSysData`，每个 `offlineSysData` 带 `dirty` 标记、`dataId`、`pb3.Message`。另有 `allBaseData` 专门缓存基础数据。 |
| 数据注册 | 通过 `Register(dataId, initFn, dataFn)` 绑定数据类型到初始化与采集函数；`setOfflineData` 遍历 `mDataFn`，在玩家登出事件中生成离线快照。 |
| 加载流程 | `LoadOfflineData` 启动时遍历 `model.OfflineData` 表，逐条解压 + 反序列化，填充 `offlineData`，并触发 `SeOfflineDataLoadSucc` 系统事件。 |
| 更新与持久化 | 玩家登出或在逻辑中调用 `setOfflineData` 时写入内存并置 `dirty`；`CheckSaveOfflineData` 定时扫描 `offlineData`，对 `dirty` 数据压缩并下发 DB 协程。 |
| DB Worker | `dbworker/offline_data.go` 监听 `GMsgSaveOfflineData`，判断记录是否存在并执行 `Insert` / `Update`。失败时通过 `GMsgSaveOfflineDataFailed` 回发，逻辑端重置 `dirty`。 |
| 事件触发 | 依赖 `custom_id.AeLogout`（玩家登出事件）触发数据采集；`SeServerInit` 注册 DB 消息处理器；`SeCrossSrvConnSucc` 触发跨服同步基础数据。 |

借鉴点：

1. **数据注册/采集解耦**：通过注册表让各系统自定义序列化逻辑，新增数据类型零侵入。
2. **dirty 标记 + 批量落库**：避免频繁写 DB，失败时可重试。
3. **启动加载 + 事件广播**：保证逻辑在 GameServer 启动后即可访问离线数据。

---

## 3. PostApoc 现状与缺口

| 组件 | 现状 | 缺口 |
| --- | --- | --- |
| `PublicRole.rankSnapshotMap` | 仅存内存 map，重启丢失；无统一接口 | 需要落库、加载、过期管理 |
| `PlayerRole.UpdateRankSnapshot` | 仅推送 `UpdateRankSnapshotMsg` + `UpdateRankValueMsg` | 可沿用消息，但 PublicActor 侧需改写存储逻辑 |
| 数据库 | 只有 `PlayerRoleBinaryData`, `Guild`, `AuctionItem`, `OfflineMessage` 等表 | 缺少 `offline_data` 表及访问方法 |
| Actor 协作 | PublicActor 单线程，具备离线消息等落库能力 | 需引入新模块 + Tick 机制刷新离线快照 |
| 任务管理 | 无“离线数据”待办 | 需要在 `docs/服务端开发进度文档.md` 注册实施步骤 |

---

## 4. 离线数据管理器设计

### 4.1 数据模型

1. **Proto 扩展**
   - `proto/csproto/social_def.proto`（或新增 `offline_def.proto`）增加：
     - `enum OfflineDataType`（例如 `OfflineDataTypeRankSnapshot = 1`）。
     - `message OfflineDataBlob { OfflineDataType data_type; bytes payload; int64 updated_at; }`
   - `proto/csproto/rpc.proto` 新增 `UpdateOfflineDataMsg`（包含 `role_id`、`data_type`、`data_bytes`、`version`）。

2. **数据库表**

```go
type OfflineData struct {
	ID        uint64 `gorm:"primaryKey;autoIncrement"`
	RoleID    uint64 `gorm:"not null;index:idx_role_type,priority:1"`
	DataType  uint32 `gorm:"not null;index:idx_role_type,priority:2"`
	Data      []byte `gorm:"type:blob;not null"` // 压缩后的 proto bytes
	Version   uint32 `gorm:"not null;default:1"`
	UpdatedAt int64  `gorm:"not null;index"`
	CreatedAt int64
}
```

- `database.AutoMigrate` 需追加 `&OfflineData{}`。
- 提供 `GetOfflineData(roleID, dataType)`, `UpsertOfflineData(...)`, `GetAllOfflineData(dataType)` 等方法。

3. **序列化规范**
   - 所有离线数据统一使用 `proto.Marshal` →（可选）`compress/zstd` → 存库。
   - `UpdatedAt` 必须来源于 `servertime.UnixMilli()`。

### 4.2 模块结构

新增目录：`server/service/gameserver/internel/publicactor/offlinedata`

| 文件 | 作用 |
| --- | --- |
| `manager.go` | `type OfflineDataManager struct { data map[roleId]map[dataType]*offlineEntry }`；负责加载、查询、更新、定时持久化。 |
| `entry.go` | 定义 `offlineEntry`（含 `dirty`, `payload []byte`, `meta`）。 |
| `registry.go` | 提供 `RegisterOfflineData(dataType protocol.OfflineDataType, initFn InitFn, gatherFn GatherFn)`，供各系统注册。 |
| `facade.go` | 封装 PublicActor 对外 API：`Update(roleId, dataType, proto.Message)`, `Get(roleId, dataType, out proto.Message)`, `Tick()`。 |
| `loader.go` | GameServer 启动时加载 DB 数据 → manager。 |

### 4.3 生命周期

1. **启动阶段**
   - `PublicHandler.OnInit` 调用 `offlineDataMgr.LoadAll()`，加载指定数据类型（初期仅 RankSnapshot），打印完成日志。
   - 若数据量大，可按 `data_type` 批量加载或懒加载。

2. **玩家上线**
   - `PlayerRole.OnLogin` 在发送 `RegisterOnlineMsg` 后，发送 `RequestOfflineDataMsg`（新消息）以获取最新快照（若需要）；同时调用本地 `UpdateRankSnapshot`，向 `PublicActor` 发 `UpdateOfflineDataMsg`（data_type=RankSnapshot）。
   - `PublicActor` 侧收到 `UpdateRankSnapshotMsg` 时，调用 `offlineDataMgr.UpdatePb(roleId, OfflineDataTypeRankSnapshot, snapshot)`，并在内存中标记 `dirty`。

3. **在线期间**
   - `PlayerRole` 运行时钟（每 5 分钟）触发 `UpdateRankSnapshot` 或其他离线数据采集 → 通过 `PublicActor` 消息更新。
   - 若还有其他系统（如装备战力）需要落库，可通过事件或系统级定时器调用同样的消息。

4. **玩家下线**
   - `PlayerRole.OnLogout` 最后一次调用 `UpdateRankSnapshot`，确保最新快照已经推送。
   - 未来扩展：可以订阅 `gevent.OnPlayerLogout`，让公共系统集中触发各数据类型采集函数。

5. **持久化**
   - `OfflineDataManager` 内部维护 `tool.TimeChecker`（例如 60 秒）；在 `PublicRole` 的 `RunOne` 或新建 `TickOfflineData()` 中调用 `FlushDirtyEntries()`：
     - 将所有 `dirty` 的 entry 转换为压缩字节并调用 `database.UpsertOfflineData`。
     - 成功后清除 `dirty`，失败则保持为 `true` 并记录日志。

6. **查询**
   - `PublicRole.GetRankSnapshot` 改为：`offlineDataMgr.Get(roleId, OfflineDataTypeRankSnapshot, snapshotOut)`，若内存不存在则尝试 DB 拉取并缓存。
   - 排行榜查询只依赖 `offlineDataMgr`，不再直接读取 `sync.Map`。

### 4.4 消息与接口

| 场景 | 消息 / 接口 | 说明 |
| --- | --- | --- |
| 玩家更新离线数据 | `PublicActorMsgIdUpdateOfflineData`（新） | PlayerActor 发送，payload= `UpdateOfflineDataMsg`。 |
| PublicActor 内部处理 | `handleUpdateOfflineData` | 反序列化后调用 `offlineDataMgr.UpdateRaw(...)`；如 `data_type == RankSnapshot`，同步更新 `rankDataMap` 以保证实时排行榜。 |
| 玩家获取离线数据 | 可复用 `QueryRank`；也可新增 `RequestOfflineDataMsg`。 | 当玩家上线需要自身快照，可由 PublicActor 主动推送。 |
| 定时持久化 | `PublicRole.Tick()` | 在 PublicActor 主循环周期内调用 `offlineDataMgr.FlushDirtyEntries()`。 |

### 4.5 数据注册与扩展

仿照参考项目，引入可插拔注册函数：

```go
type GatherFn func(ctx context.Context, role iface.IPlayerRole) proto.Message

func RegisterOfflineData(dataType protocol.OfflineDataType, gatherFn GatherFn, newFn func() proto.Message)
```

- `rank_snapshot` 模块在 `init()` 中注册 `OfflineDataTypeRankSnapshot`。
- Future：好友展示、主城形象、最近登陆信息等均可注册。

---

## 5. 实施步骤（建议顺序）

1. **Proto & 数据库**
   - 扩展 `proto`、生成代码。
   - 在 `server/internal/database` 创建 `offline_data.go`，实现 CRUD。
   - 更新 `AutoMigrate` 与 `docs/服务端开发进度文档.md`。

2. **PublicActor 模块**
   - 新建 `offlinedata` 子目录，实现 `OfflineDataManager`。
   - 在 `PublicRole` 中持有 `offlineDataMgr`，`NewPublicRole()` 初始化并加载数据。
   - 注册新的 PublicActor handler（`RegisterOfflineDataHandlers`）。

3. **替换 Rank 快照存储**
   - `public_role_rank.go`：删除 `rankSnapshotMap`，改为调用 manager。
   - 排行榜查询时，如缓存缺失，从 offline data manager 获取。

4. **PlayerActor 触发逻辑**
   - `PlayerRole.UpdateRankSnapshot` 增加 `UpdateOfflineDataMsg` 推送（或在 `handleUpdateRankSnapshot` 内部同步转存）。
   - 确保上线、升级、定时、下线场景都会触发。

5. **定时持久化与恢复**
   - 在 `PublicHandler.RunOne` 或新增 `offline_data_tick.go`，每 60 秒执行 `FlushDirtyEntries`。
   - 启动时日志输出加载数据量、耗时。

6. **迁移/清理**
   - 删除 `rankSnapshotMap` 字段与相关引用。
   - 文档与配置同步更新。

### 5.1 当前实现进度（2025-11-27）

- ✅ 已完成 Step 1~6：`OfflineDataType/UpdateOfflineDataMsg`、`OfflineData` 表与 DAO、`offlinedata.Manager`、`public_role_offline_data.go`、`PlayerRole.UpdateRankSnapshot` 双通道上报、PublicActor 定时 Flush。
- ✅ RankSnapshot 已迁移至离线数据管理器，`rankSnapshotMap` 移除，`FriendSys`、排行榜查询均从 `OfflineDataManager` 获取。
- ⚠️ 下一阶段按 6.4 待办扩展更多数据类型、性能与监控能力。

---

## 6. 测试计划

1. **单人流程**
   - 创建角色 → 登录 → 触发等级提升 → 检查 `OfflineData` 表出现 `RankSnapshot` 记录，`UpdatedAt` 随操作变化。
   - 重启 GameServer，直接调用 `QueryRank`，应能返回快照且日志显示命中离线数据。

2. **多人竞赛**
   - 同时登录 10 名玩家，交替升级，验证 `OfflineDataManager` 的 `dirty` 批处理不会阻塞 PublicActor。
   - 强制模拟 DB 写失败（例如断库），确认 `dirty` 标记保持，恢复后可继续写入。

3. **性能 / 内存**
   - 使用基准数据（例如 5w 玩家）导入离线表，启动时统计加载耗时与内存占用，必要时改为按需加载。

4. **回归**
   - 排行榜查询、好友、公会等依赖 `PublicActor` 的功能需回归，确保引入新 manager 不影响现有 handler。

---

## 7. 注意事项

1. **统一时间源**：所有 `UpdatedAt`、过期检查使用 `servertime`，禁止 `time.Now()`。
2. **Actor 边界**：`OfflineDataManager` 只在 PublicActor 线程内访问，不可在 PlayerActor 直接操作全局 map。
3. **数据兼容**：上线前需编写迁移脚本，将旧的排行榜快照（若存在）导入新表；如无历史数据，可允许为空。
4. **压缩策略**：首版可不压缩（直接存 proto bytes），待数据量增大再接入 `compress` 包。
5. **日志**：新增 `pkg/log` requester，关键操作需包含 `roleId`、`dataType`、`dirtyCount`。
6. **扩展协议**：修改 proto 后必须运行 `proto/genproto.sh && gofmt ./...`，并更新客户端（若暴露给 C/S）。

---

## 8. 关联代码 & 文档

- `server/service/gameserver/internel/publicactor/public_role.go`
- `server/service/gameserver/internel/publicactor/public_role_rank.go`
- `server/service/gameserver/internel/playeractor/entity/player_role.go`
- `server/server/gameserver/logicworker/manager/offline_data.go`
- `server/server/gameserver/dbworker/offline_data.go`
- `docs/服务端开发进度文档.md`（待办更新点）

如实现过程中发现新需求（例如战力榜以外的数据入口），需在本文 4.5 节登记并扩展数据类型定义。

