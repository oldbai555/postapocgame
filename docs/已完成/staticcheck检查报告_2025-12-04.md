# staticcheck æ£€æŸ¥æŠ¥å‘Š

**æ£€æŸ¥æ—¶é—´**ï¼š2025-12-04  
**æ£€æŸ¥èŒƒå›´**ï¼š`server/service/gameserver` ç›®å½•  
**æ£€æŸ¥å·¥å…·**ï¼š`staticcheck`, `go vet`

---

## âœ… æ£€æŸ¥ç»“æœ

### æ€»ä½“çŠ¶æ€

- âœ… **staticcheck**ï¼š0 ä¸ªé—®é¢˜
- âœ… **go vet**ï¼š0 ä¸ªè­¦å‘Š
- âœ… **ç¼–è¯‘çŠ¶æ€**ï¼šé€šè¿‡

**ç»“è®º**ï¼šæ‰€æœ‰ä»£ç è´¨é‡é—®é¢˜å·²ä¿®å¤å®Œæˆï¼

---

## ğŸ“Š ä¿®å¤å†å²

### ç¬¬ä¸€è½®ä¿®å¤ï¼ˆ2025-12-04ï¼‰

1. **é”™è¯¯å¤„ç†ä¸€è‡´æ€§**
   - ä¿®å¤äº† 4 ä¸ªæ–‡ä»¶ä¸­çš„ `fmt.Errorf` ä½¿ç”¨
   - ç»Ÿä¸€ä½¿ç”¨ `customerr.NewError` å’Œ `customerr.NewErrorByCode`

2. **SA1012 - nil Context é—®é¢˜**
   - ä¿®å¤äº† 3 ä¸ªæ–‡ä»¶ä¸­çš„ 17 å¤„ `nil Context` ä½¿ç”¨
   - ç»Ÿä¸€ä½¿ç”¨ `context.TODO()` æ›¿ä»£ `nil`

3. **SA4023 - æ°¸è¿œä¸ä¼šä¸ºçœŸçš„æ¯”è¾ƒ**
   - ä¿®å¤äº† 4 ä¸ªæ–‡ä»¶ä¸­çš„ 4 å¤„æ— æ•ˆæ¯”è¾ƒ
   - ç§»é™¤äº†å¯¹æ€»æ˜¯é nil è¿”å›å€¼çš„ nil æ£€æŸ¥

4. **S1040 - å†—ä½™çš„ç±»å‹æ–­è¨€**
   - ä¿®å¤äº† 4 ä¸ªæ–‡ä»¶ä¸­çš„ 9 å¤„å†—ä½™ç±»å‹æ–­è¨€
   - ç§»é™¤äº†å¯¹ `GetBySession` è¿”å›å€¼çš„å†—ä½™æ–­è¨€

5. **S1023 - å†—ä½™çš„ return è¯­å¥**
   - ä¿®å¤äº† 2 ä¸ªæ–‡ä»¶ä¸­çš„ 2 å¤„å†—ä½™ return

6. **SA4003 - æ— æ•ˆçš„æ•°å€¼æ¯”è¾ƒ**
   - ä¿®å¤äº† 1 ä¸ªæ–‡ä»¶ä¸­çš„é€»è¾‘é”™è¯¯
   - å°† `>= math.MaxUint32` æ”¹ä¸º `== math.MaxUint32`

### ç¬¬äºŒè½®ä¿®å¤ï¼ˆ2025-12-04ï¼‰

7. **SA1029 - Context Key ç±»å‹é—®é¢˜**
   - å®šä¹‰äº† `ContextKey` ç±»å‹
   - ä¿®å¤äº†çº¦ 20 å¤„ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²ä½œä¸º context key çš„é—®é¢˜
   - åˆ›å»ºäº† `docs/Context_Keyè§„èŒƒ.md` è§„èŒƒæ–‡æ¡£

8. **U1000 - æœªä½¿ç”¨çš„å‡½æ•°/å˜é‡**
   - åˆ é™¤äº† `player_role_economy.go` ä¸­æœªä½¿ç”¨çš„ `rollbackInfo` å­—æ®µ
   - åˆ é™¤äº† `public_role.go` ä¸­æœªä½¿ç”¨çš„ `lastCleanOfflineMessagesTime` å­—æ®µ
   - éªŒè¯äº† `offlineDataFlushIntervalMs` å¸¸é‡å·²æ­£ç¡®ä½¿ç”¨

### ç¬¬ä¸‰è½®ä¿®å¤ï¼ˆ2025-12-04ï¼‰

9. **æœªä½¿ç”¨å‡½æ•°ä¿®å¤**ï¼ˆè¯¦è§ `docs/æœªä½¿ç”¨å‡½æ•°åˆ†ææŠ¥å‘Š.md`ï¼‰
   - ä¿®å¤äº† AOI ç³»ç»Ÿç›¸å…³å‡½æ•°çš„ä½¿ç”¨
   - ä¿®å¤äº†ç¦»çº¿æ•°æ®åˆ·æ–°åŠŸèƒ½
   - æ›¿æ¢äº† `sendClientProtoViaPlayerActor` çš„ä½¿ç”¨
   - å¤„ç†äº† `spawnScene2Monsters` ä½œä¸º fallback
   - åˆ é™¤äº†æœªä½¿ç”¨çš„ `logWarn` å‡½æ•°

---

## ğŸ“ˆ ä¿®å¤ç»Ÿè®¡

| é—®é¢˜ç±»å‹ | ä¿®å¤æ•°é‡ | çŠ¶æ€ |
|---------|---------|------|
| é”™è¯¯å¤„ç†ä¸€è‡´æ€§ | 10 å¤„ | âœ… å®Œæˆ |
| SA1012 - nil Context | 17 å¤„ | âœ… å®Œæˆ |
| SA4023 - æ— æ•ˆæ¯”è¾ƒ | 4 å¤„ | âœ… å®Œæˆ |
| S1040 - å†—ä½™ç±»å‹æ–­è¨€ | 9 å¤„ | âœ… å®Œæˆ |
| S1023 - å†—ä½™ return | 2 å¤„ | âœ… å®Œæˆ |
| SA4003 - æ— æ•ˆæ•°å€¼æ¯”è¾ƒ | 1 å¤„ | âœ… å®Œæˆ |
| SA1029 - Context Key | 20 å¤„ | âœ… å®Œæˆ |
| U1000 - æœªä½¿ç”¨ä»£ç  | 7 å¤„ | âœ… å®Œæˆ |
| **æ€»è®¡** | **70+ å¤„** | **âœ… å…¨éƒ¨å®Œæˆ** |

---

## ğŸ” æ£€æŸ¥å‘½ä»¤

### è¿è¡Œ staticcheck

```bash
# Windows
cd server
staticcheck ./service/gameserver/...

# Linux/Mac
cd server
staticcheck ./service/gameserver/...
```

### è¿è¡Œ go vet

```bash
# Windows
cd server
go vet ./service/gameserver/...

# Linux/Mac
cd server
go vet ./service/gameserver/...
```

### è¿è¡Œå®Œæ•´ CI æ£€æŸ¥

```bash
# Windows
powershell -ExecutionPolicy Bypass -File scripts\ci_check.ps1

# Linux/Mac
bash scripts/ci_check.sh
```

---

## ğŸ“ è§„èŒƒæ–‡æ¡£

ä¿®å¤è¿‡ç¨‹ä¸­åˆ›å»º/æ›´æ–°çš„è§„èŒƒæ–‡æ¡£ï¼š

1. **`docs/Context_Keyè§„èŒƒ.md`**
   - Context Key ä½¿ç”¨è§„èŒƒ
   - æ–°å¢ Context Key çš„æµç¨‹
   - æ£€æŸ¥ä¸éªŒè¯æ–¹æ³•

2. **`docs/æœªä½¿ç”¨å‡½æ•°åˆ†ææŠ¥å‘Š.md`**
   - æœªä½¿ç”¨å‡½æ•°çš„è¯¦ç»†åˆ†æ
   - ä¿®å¤å»ºè®®å’Œä¼˜å…ˆçº§
   - ä¿®å¤çŠ¶æ€è·Ÿè¸ª

3. **`docs/CIæ£€æŸ¥å¾…ä¿®æ”¹æ¸…å•.md`**
   - CI æ£€æŸ¥é—®é¢˜æ¸…å•
   - ä¿®å¤çŠ¶æ€å’ŒéªŒè¯ç»“æœ
   - ä¿®å¤ç»Ÿè®¡å’Œæ³¨æ„äº‹é¡¹

---

## âœ… éªŒè¯ç»“æœ

### ç¼–è¯‘éªŒè¯

```bash
cd server
go build ./service/gameserver/...
```

**ç»“æœ**ï¼šâœ… é€šè¿‡

### é™æ€æ£€æŸ¥éªŒè¯

```bash
cd server
staticcheck ./service/gameserver/...
go vet ./service/gameserver/...
```

**ç»“æœ**ï¼š
- âœ… `staticcheck`ï¼š0 ä¸ªé—®é¢˜
- âœ… `go vet`ï¼š0 ä¸ªè­¦å‘Š

### CI æ£€æŸ¥éªŒè¯

```bash
# Windows
powershell -ExecutionPolicy Bypass -File scripts\ci_check.ps1
```

**ç»“æœ**ï¼š
- âœ… `go vet`ï¼šé€šè¿‡
- âœ… `staticcheck`ï¼šé€šè¿‡
- âœ… `gatewaylink` å¯¼å…¥æ£€æŸ¥ï¼šé€šè¿‡

---

## ğŸ¯ ä»£ç è´¨é‡æå‡

### ä¿®å¤å‰

- âŒ å¤šå¤„ä½¿ç”¨å­—ç¬¦ä¸²ä½œä¸º context keyï¼ˆç±»å‹ä¸å®‰å…¨ï¼‰
- âŒ é”™è¯¯å¤„ç†ä¸ä¸€è‡´ï¼ˆæ··ç”¨ `fmt.Errorf` å’Œ `customerr`ï¼‰
- âŒ å¤šå¤„ä¼ é€’ `nil Context`ï¼ˆä¸ç¬¦åˆæœ€ä½³å®è·µï¼‰
- âŒ å†—ä½™çš„ç±»å‹æ–­è¨€å’Œ return è¯­å¥
- âŒ æœªä½¿ç”¨çš„å‡½æ•°å’Œå˜é‡
- âŒ æ— æ•ˆçš„æ•°å€¼æ¯”è¾ƒé€»è¾‘é”™è¯¯

### ä¿®å¤å

- âœ… ç»Ÿä¸€çš„ Context Key ç±»å‹è§„èŒƒ
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ–¹å¼
- âœ… è§„èŒƒçš„ Context ä½¿ç”¨
- âœ… ç®€æ´çš„ä»£ç ç»“æ„
- âœ… æ— æœªä½¿ç”¨ä»£ç 
- âœ… æ­£ç¡®çš„é€»è¾‘å®ç°

---

## ğŸ“Œ åç»­å»ºè®®

1. **æŒç»­ç›‘æ§**ï¼šåœ¨ CI/CD ä¸­é›†æˆ staticcheck å’Œ go vet æ£€æŸ¥
2. **ä»£ç å®¡æŸ¥**ï¼šåœ¨ä»£ç å®¡æŸ¥æ—¶å…³æ³¨è¿™äº›è§„èŒƒ
3. **æ–‡æ¡£ç»´æŠ¤**ï¼šä¿æŒè§„èŒƒæ–‡æ¡£ä¸ä»£ç åŒæ­¥
4. **å®šæœŸæ£€æŸ¥**ï¼šå®šæœŸè¿è¡Œ staticcheck æ£€æŸ¥ï¼ŒåŠæ—¶å‘ç°æ–°é—®é¢˜

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- `docs/CIæ£€æŸ¥å¾…ä¿®æ”¹æ¸…å•.md` - CI æ£€æŸ¥é—®é¢˜æ¸…å•
- `docs/Context_Keyè§„èŒƒ.md` - Context Key ä½¿ç”¨è§„èŒƒ
- `docs/æœªä½¿ç”¨å‡½æ•°åˆ†ææŠ¥å‘Š.md` - æœªä½¿ç”¨å‡½æ•°åˆ†æ
- `scripts/ci_check.sh` / `scripts/ci_check.ps1` - CI æ£€æŸ¥è„šæœ¬

