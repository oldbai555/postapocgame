# 属性系统阶段三联调记录

## 目标

验证“登录 → 属性变更 → 重连”链路中，客户端能够持续收到 `S2CAttrData` 推送，并确认 DungeonServer 的即时属性重算与推送机制生效。

## 测试环境

- `gameserver.exe` / `dungeonserver.exe` 本地启动，`config` 目录包含 `attr_config.json`（push/power/add_rate/formula 四个分区）
- 角色：`测试账号A`，预置装备若干，可通过 GM 指令发放升级奖励。

## 测试步骤

1. **登录并抓取基线属性**
   - 启动 GameServer、DungeonServer。
   - 使用 `server/example` 登录账号，执行 `enter` 指令进入场景。
   - 观察客户端日志，确认在进入副本后收到第一条 `S2CAttrData`（内含 `AttrData` 与 `sys_power_map`）。

2. **触发属性变更**
   - 执行 `gm equip-upgrade 1` 或者 `gm levelup 5` 等指令，保证至少一个系统发生属性变化。
   - 期望：GameServer 立即推送新的 `S2CAttrData`，日志中可见战力发生变化；DungeonServer 也会广播一次用于实时战斗校验。

3. **重连校验**
   - 断开客户端（`disconnect`），等待 GameServer 打印 `OnDisconnect`。
   - 在 5 秒内重新执行 `enter`，观测 `OnReconnect` 日志与客户端回包。
   - 期望：重连后立刻收到 `S2CAttrData`（GameServer `PushFullAttrData`），属性值与上一步一致，战力非 0。

4. **DungeonServer 即时推送**
   - 在副本内执行 `gm buff add`（或任何会修改 Dungeon 属性的调试命令，如果尚未实现可手动修改 `AttrSys` 并调用 `MarkDirty`）。
   - 期望：DungeonServer 侧日志输出 `broadcastAttrData`，客户端收到 `S2CAttrData`（来源为 Dungeon）。

## 结果记录

| 步骤 | 结果 | 备注 |
| ---- | ---- | ---- |
| 登录触发 `S2CAttrData` | ✅ | `sys_power_map` 含默认权重 |
| 属性变更推送 | ✅ | 装备强化后立即推送 |
| 重连自动补齐 | ✅ | 断线 2 秒后重连，收到最新属性 |
| Dungeon 实时推送 | ✅ | 通过临时代码触发 `MarkDirty` 验证 |

## 后续建议

1. 将上述流程纳入自动化脚本（可复用 `server/example`），用于 CI 冒烟。
2. 在客户端 UI 中提供属性推送日志，方便运营验证。
3. 扩展更多实际业务（Buff、时效性道具）接入 `attrcalc.RegisterAddRate`，确保配置与实现一致。

