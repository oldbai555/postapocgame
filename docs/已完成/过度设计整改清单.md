# server/service/gameserver 过度设计整改清单

> 本清单聚焦 `server/service/gameserver` 目录中仍然存在的“层次过多 / 生成物手工改写 / 全局单例侵入”等问题。每条都附带影响与整改建议，后续改造可按编号分批落地。

## 1. Proto 生成文件被手工修改
- **现状**：`server/internal/protocol/rpc.pb.go` 等生成文件存在中文注释和新增枚举，历史上多次手动编辑。
- **影响**：一旦重新执行 `protoc` 会被覆盖，协作期极易引发 merge 冲突，CI 也无法验证 proto 是否最新。
- **整改建议**：
  1. 只允许修改 `.proto`，禁止直接改 `*.pb.go`。脚本中增加检查步骤，若 diff 中包含生成文件则直接失败。
  2. 为 `proto/genproto.sh` 提供统一入口（Makefile / go generate / npm script），CI 固化“运行脚本 + gofmt + git diff 必须为空”。
  3. 在文档与 Code Review 清单中注明：“发现直接改 pb.go 视为阻断项”。

## 2. C2S 协议多层注册（ProtocolRouter + clientprotocol）
- **现状**：客户端消息需先到 `ProtocolRouterController.HandleDoNetworkMsg`，再通过 `clientprotocol` 查 handler，最后才调 Controller。
- **影响**：一条协议要在两个表中注册；`ProtocolRouterController` 还注入了未使用的 `DungeonServerGateway`，增加了噪音与依赖。
- **整改建议**：
  1. 废弃 `clientprotocol`，让 Controller 自身承担解析逻辑；`ProtocolRouterController` 只负责 codec + Session/Role 注入。
  2. 若必须保留 Router 层，可改为 `map[uint16]ControllerFunc`，但注册入口唯一，不再暴露多套 API。
  3. 移除 struct 中未使用的字段，结合 `staticcheck` 阻止死字段进入主干。
- **整改进展（2025-12-04）**：已提供 `router.RegisterProtocolHandler` 统一注册入口，删除 `clientprotocol` 包，并精简 `ProtocolRouterController`。

## 3. `player_network.go` 巨石化且越层访问数据库
- **现状**：`player_network.go` 既做 gshare handler，又直接处理注册/登录/角色查询等业务，内联大量数据库调用与回包逻辑。
- **影响**：Clean Architecture 约束被突破，账号相关逻辑与 PlayerActor 强耦合；文件过大难以维护，也无法复用 Presenter。
- **整改建议**：
  1. 拆分为 Controller + UseCase + Presenter，handler 只负责组装上下文与调用 Controller。
  2. 对注册/登录等流程补 Presenter，统一封装 S2C 消息，避免在 handler 里直接 `SendToSessionProto`。
  3. 将账号态管理前移到 Gateway 或专门 Adapter，降低 PlayerActor 内部对数据库的直接依赖。
- **整改进展（2025-12-04）**：新增 `PlayerAccountController` / `PlayerRoleController`、账号/角色用例与 Presenter，`player_network.go` 删除注册/登录/角色查询/创角的数据库访问逻辑，仅保留 EnterGame 等遗留流程，后续再拆。

## 4. S2C 透传链路缺少自动审计
- **现状**：虽然已强制 "DungeonActor/PublicActor → PlayerActor → Gateway" 的发送准则，但当前仅靠约定，没有工具校验；也没有批量接口，广播类业务需要 N 次 actor 投递。
- **影响**：开发者容易误用 `gatewaylink`；PublicActor 广播会产生大量 PlayerActor 消息，浪费上下文切换。
- **整改建议**：
  1. 在 CI 中增加 `grep`/AST 检查，禁止 gameserver 目录直接引用 `gatewaylink`（白名单 PlayerActor 除外）。
  2. 规划批量透传协议（同一消息指定多个 sessionId）或共享缓存，减少 PublicActor→PlayerActor 的重复工作。
  3. 提供逃生机制：若某些系统确实只需要网络发送，可在文档中登记并加白名单，避免后续重复讨论。
- **整改进展（2025-12-04）**：
  1. ✅ 已创建 `scripts/check_gatewaylink_usage.sh` 和 `scripts/check_gatewaylink_usage.ps1` 检查脚本，自动检测违规的 `gatewaylink` 直接引用。
  2. ✅ 修复 `gm_system_adapter_init.go`：将 `gatewaylink.SendToSessionProto` 改为使用 `NetworkGateway`（通过 DI 容器注入）。
  3. ✅ 修复 `protocol_router_controller.go`：将 `gatewaylink.GetSession` 改为使用 `SessionGateway`（通过 DI 容器注入）。
  4. ⏳ 批量透传协议和共享缓存优化待后续实现。

## 5. `SysMgr` 依赖"按枚举遍历"初始化
- **现状**：`entitysystem.SysMgr` 在 `OnInit` 中循环 `protocol.SystemId_SysLevel` 到 `SysIdMax`，依赖每个系统事先向全局 map 注册 factory。
- **影响**：新增/删除系统都要改枚举，且全局工厂是共享 map，不符合 Clean Architecture 的依赖方向。日志中频繁出现 "system factory not found" 的噪音。
- **整改建议**：
  1. 改为显式配置：PlayerActor 构造期传入需要挂载的系统列表，不再依赖枚举密集循环。
  2. 全局 `RegisterSystemFactory` 迁回 DI 容器或模块级注册，移除 `globalFactories`。
  3. 在 `sys_mgr` 上提供调试函数（打印已挂系统），让 UseCase/Controller 可以按系统名定位问题。
- **整改进展（2025-12-04）**：
  1. ✅ 新增 `system_registry.go`：将全局 `globalFactories` 迁移到 `SystemRegistry`，使用读写锁保护，提供模块级注册接口。
  2. ✅ 重构 `SysMgr`：新增 `NewSysMgrWithSystems(systemIds []uint32)` 支持显式配置系统列表；`NewSysMgr()` 默认使用 `GetDefaultSystemIds()` 返回的系统列表。
  3. ✅ 修改 `OnInit`：不再遍历枚举范围，只初始化显式配置的系统；未找到工厂时记录警告而非错误，避免日志噪音。
  4. ✅ 新增调试函数：`ListMountedSystems()` 返回已挂载系统的信息列表（SysId、Opened、HasImpl），便于 UseCase/Controller 定位问题。
  5. ⏳ 后续可考虑将系统列表配置化（配置文件/环境变量），支持不同环境挂载不同系统。

## 6. 全局 `PlayerRoleManager` 使用线性扫描
- **现状**：`GetBySession` 为了查 SessionId 需要遍历所有在线角色，时间复杂度 O(N)。
- **影响**：在线人数多时，Reconnect / 路由等链路会出现线性延迟；同时 `roleMgr` 仍暴露在全局单例里，不利于测试。
- **整改建议**：
  1. 增加 `sessionIndex map[string]uint64]` 或 `map[string]iface.IPlayerRole`，Add/Remove 同步维护。
  2. 将 `PlayerRoleManager` 注册到 DI 容器，通过接口注入，方便用 fake manager 做单元测试。
  3. 对 `FlushAndSave` 这些遍历函数增加超时/分批能力，避免长时间持有锁。
- **整改进展（2025-12-04）**：
  1. ✅ 新增 `sessionIndex map[string]uint64`：在 `PlayerRoleManager` 结构体中添加 `sessionIndex` 字段，用于 O(1) 查找。
  2. ✅ 更新 `Add` 方法：添加角色时同步维护 `sessionIndex`，如果角色已存在则先清理旧的 sessionId 索引。
  3. ✅ 更新 `Remove` 方法：移除角色时同步删除 `sessionIndex` 中的条目。
  4. ✅ 重构 `GetBySession`：从 O(N) 线性扫描改为 O(1) 索引查找，通过 `sessionIndex` 直接定位 roleId，再通过 `roleMgr` 获取角色实例。
  5. ✅ 新增 `UpdateSession` 方法：用于重连等场景下更新 sessionId 索引。
  6. ✅ 更新 `OnReconnect`：在 `PlayerRole.OnReconnect` 中调用 `UpdateSession` 同步更新索引。
  7. ✅ 将 `PlayerRoleManager` 注册到 DI 容器：创建 `IPlayerRoleManager` 接口，在 DI 容器中注册 `PlayerRoleManager`，更新所有使用处改为从 DI 容器获取（2025-12-04）。
  8. ✅ 为 `FlushAndSave` 增加超时/分批能力：修改 `FlushAndSave` 方法签名，支持 `batchSize` 参数，实现分批处理逻辑，避免长时间持有锁（2025-12-04）。

---

### 配套 CI / 流程动作
1. **Proto 防护**：CI 执行 `protoc` 后若检测到生成文件差异，立即失败。新增 pre-commit hook 阻止手工 edit。
   - ⏳ 待实现：创建 `scripts/check_proto_clean.sh` 脚本，在 CI 中执行。
2. **静态分析**：引入 `staticcheck`；对 `server/service/gameserver` 目录执行 `go vet`, `staticcheck ./...`。
   - ✅ 已实现（2025-12-04）：
     - 创建 `scripts/ci_check.sh` 和 `scripts/ci_check.ps1` 脚本
     - 集成 `go vet` 和 `staticcheck` 检查
     - 支持 Windows (PowerShell) 和 Linux/Mac (Bash)
3. **Forbidden Imports**：使用自定义脚本禁止除 PlayerActor 外的包引用 `gatewaylink`。
   - ✅ 已实现（2025-12-04）：
     - 创建 `scripts/check_gatewaylink_imports.sh` 和 `scripts/check_gatewaylink_imports.ps1` 脚本
     - 白名单包括：PlayerActor 相关文件、Gateway 适配器、gatewaylink 自身、engine/server.go、dungeonserverlink
     - 已集成到 CI 检查脚本中
4. **文档同步**：本清单与 `docs/服务端开发进度文档_full.md` 同步，后续新增条目或完成整改时务必更新两份文档。
   - ✅ 已建立同步机制，每次整改完成后更新两份文档。


