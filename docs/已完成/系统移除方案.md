# 系统移除方案

## 概述

本文档详细说明了移除以下系统的步骤和影响范围：
- **SysVip (8)** - VIP系统
- **SysDailyActivity (14)** - 日常活跃系统
- **SysFriend (15)** - 好友系统
- **SysGuild (16)** - 公会系统
- **SysAuction (17)** - 拍卖行系统
- **SysAttr (6)** - 属性系统（改为工具类嵌入PlayerRole）

---

## 移除步骤（按顺序执行）

### 阶段一：移除 SysVip (VIP系统)

#### 1.1 Proto 文件修改
**文件：** `proto/csproto/system.proto`
- [✅] 删除 `SysVip = 8;` 枚举项
- [✅] 删除 `message SiVipData { ... }` 定义

**文件：** `proto/csproto/sc.proto`
- [✅] 删除 `SiVipData vip_data = 1;` 字段（如果存在）

**文件：** `proto/csproto/player.proto`
- [✅] 删除 `SiVipData vip_data = 4;` 字段（如果存在）

#### 1.2 代码文件删除
**目录：** `server/service/gameserver/internel/adapter/system/`
- [✅] 删除 `vip_system_adapter.go`
- [✅] 删除 `vip_system_adapter_init.go`
- [✅] 删除 `vip_system_adapter_helper.go`

**目录：** `server/service/gameserver/internel/usecase/vip/`
- [✅] 删除整个 `vip/` 目录及其所有文件：
  - `init_vip_data.go`
  - `vip_money_use_case.go`

**目录：** `server/service/gameserver/internel/domain/vip/`
- [✅] 删除整个 `vip/` 目录及其所有文件：
  - `vip.go`

**目录：** `server/service/gameserver/internel/adapter/controller/`
- [✅] 检查并删除 VIP 相关的 Controller（已清理 `money_controller.go` 中的 VIP 引用）

**目录：** `server/service/gameserver/internel/adapter/presenter/`
- [✅] 检查并删除 VIP 相关的 Presenter（无 VIP Presenter）

#### 1.3 系统注册移除
**文件：** `server/service/gameserver/internel/app/playeractor/entitysystem/sys_mgr.go`
- [✅] 删除 `SysVip` 的系统注册代码
- [✅] 删除 `SysVip` 的依赖关系声明

#### 1.4 依赖清理
**搜索关键词：** `SysVip`、`VipSystemAdapter`、`GetVipSys`、`SiVipData`
- [✅] 全局搜索并删除所有引用
- [✅] 检查 `PlayerRoleBinaryData` 中是否还有 `VipData` 字段的引用（已从 proto 中删除）
- [✅] 清理 `money/add_money.go` 中的 VIP 经验处理逻辑
- [✅] 清理 `controller/money_controller.go` 中的 VIP 用例注入

---

### 阶段二：移除 SysDailyActivity (日常活跃系统)

#### 2.1 Proto 文件修改
**文件：** `proto/csproto/system.proto`
- [✅] 删除 `SysDailyActivity = 14;` 枚举项
- [✅] 删除 `message SiDailyActivityData { ... }` 定义
- [✅] 删除 `message DailyActivityRewardState { ... }` 定义

**文件：** `proto/csproto/player.proto`
- [✅] 删除 `SiDailyActivityData daily_activity_data = 14;` 字段

#### 2.2 代码文件删除
**目录：** `server/service/gameserver/internel/adapter/system/`
- [✅] 删除 `daily_activity_system_adapter.go`
- [✅] 删除 `daily_activity_system_adapter_init.go`
- [✅] 删除 `daily_activity_system_adapter_helper.go`
- [✅] 删除 `daily_activity_use_case_adapter.go`

**目录：** `server/service/gameserver/internel/usecase/dailyactivity/`
- [✅] 删除整个 `dailyactivity/` 目录及其所有文件：
  - `init_daily_activity_data.go`
  - `claim_reward_use_case.go`
  - `points_use_case.go`

**目录：** `server/service/gameserver/internel/domain/dailyactivity/`
- [✅] 删除整个 `dailyactivity/` 目录及其所有文件：
  - `daily_activity.go`

**目录：** `server/service/gameserver/internel/usecase/interfaces/`
- [✅] 删除 `daily_activity.go`

**目录：** `server/service/gameserver/internel/adapter/controller/`
- [✅] 检查并删除 DailyActivity 相关的 Controller（已清理 `money_controller.go`、`quest_controller.go` 中的引用）

**目录：** `server/service/gameserver/internel/adapter/presenter/`
- [✅] 检查并删除 DailyActivity 相关的 Presenter（无 DailyActivity Presenter）

#### 2.3 系统注册移除
**文件：** `server/service/gameserver/internel/app/playeractor/entitysystem/sys_mgr.go`
- [✅] 删除 `SysDailyActivity` 的系统注册代码
- [✅] 删除 `SysDailyActivity` 的依赖关系声明

#### 2.4 依赖清理
**搜索关键词：** `SysDailyActivity`、`DailyActivitySystemAdapter`、`GetDailyActivitySys`、`SiDailyActivityData`
- [✅] 全局搜索并删除所有引用
- [✅] **重要**：检查 `SysQuest` 对 `SysDailyActivity` 的依赖（在 `sys_mgr.go` 中声明）
- [✅] 修改 `sys_mgr.go`，从 `SysQuest` 的依赖列表中移除 `SysDailyActivity`
- [✅] 清理 `money/add_money.go`、`money/consume_money.go` 中的活跃点处理逻辑
- [✅] 清理 `quest/submit_quest.go` 中的活跃点添加逻辑
- [✅] 清理 `money_controller.go`、`quest_controller.go`、`money_system_adapter.go`、`quest_system_adapter.go` 中的 DailyActivity 用例注入

---

### 阶段三：移除 SysFriend (好友系统)

#### 3.1 Proto 文件修改
**文件：** `proto/csproto/system.proto`
- [✅] 删除 `SysFriend = 15;` 枚举项
- [✅] 删除 `message SiFriendData { ... }` 定义

**文件：** `proto/csproto/player.proto`
- [✅] 删除 `SiFriendData friend_data = 17;` 字段

#### 3.2 代码文件删除
**目录：** `server/service/gameserver/internel/adapter/system/`
- [✅] 删除 `friend_system_adapter.go`
- [✅] 删除 `friend_system_adapter_init.go`
- [✅] 删除 `friend_system_adapter_helper.go`

**目录：** `server/service/gameserver/internel/usecase/friend/`
- [✅] 删除整个 `friend/` 目录及其所有文件：
  - `init_friend_data.go`
  - `send_friend_request.go`
  - `respond_friend_request.go`
  - `remove_friend.go`
  - `query_friend_list.go`
  - `blacklist.go`

**目录：** `server/service/gameserver/internel/domain/friend/`
- [✅] 删除整个 `friend/` 目录及其所有文件：
  - `friend.go`

**目录：** `server/service/gameserver/internel/adapter/controller/`
- [✅] 删除 `friend_controller.go`
- [✅] 删除 `friend_controller_init.go`

**目录：** `server/service/gameserver/internel/adapter/presenter/`
- [✅] 删除 `friend_presenter.go`

**目录：** `server/service/gameserver/internel/app/publicactor/`
- [✅] 删除 `public_role_friend.go`

#### 3.3 系统注册移除
**文件：** `server/service/gameserver/internel/app/playeractor/entitysystem/sys_mgr.go`
- [✅] 删除 `SysFriend` 的系统注册代码
- [✅] 删除 `SysFriend` 的依赖关系声明（包括 Guild、Chat 对 Friend 的依赖）

#### 3.4 依赖清理
**搜索关键词：** `SysFriend`、`FriendSystemAdapter`、`GetFriendSys`、`SiFriendData`
- [✅] 全局搜索并删除所有引用
- [✅] **重要**：检查以下系统对 Friend 的依赖，需要移除相关依赖：
  - `SysGuild`：依赖 Friend（在 `sys_mgr.go` 中声明）- 已移除
  - `SysChat`：依赖 Friend（在 `sys_mgr.go` 中声明）- 已移除
- [✅] 修改 `sys_mgr.go`，从 `SysGuild` 和 `SysChat` 的依赖列表中移除 `SysFriend`
- [✅] 从 `publicactor/register.go` 中移除 `RegisterFriendHandlers` 调用

---

### 阶段四：移除 SysGuild (公会系统)

#### 4.1 Proto 文件修改
**文件：** `proto/csproto/system.proto`
- [✅] 删除 `SysGuild = 16;` 枚举项
- [✅] 删除 `message SiGuildData { ... }` 定义

**文件：** `proto/csproto/player.proto`
- [✅] 删除 `SiGuildData guild_data = 18;` 字段

#### 4.2 代码文件删除
**目录：** `server/service/gameserver/internel/adapter/system/`
- [✅] 删除 `guild_system_adapter.go`
- [✅] 删除 `guild_system_adapter_init.go`
- [✅] 删除 `guild_system_adapter_helper.go`

**目录：** `server/service/gameserver/internel/usecase/guild/`
- [✅] 删除整个 `guild/` 目录及其所有文件：
  - `init_guild_data.go`
  - `create_guild.go`
  - `join_guild.go`
  - `leave_guild.go`
  - `query_guild_info.go`

**目录：** `server/service/gameserver/internel/domain/guild/`
- [✅] 删除整个 `guild/` 目录及其所有文件：
  - `guild.go`

**目录：** `server/service/gameserver/internel/adapter/controller/`
- [✅] 删除 `guild_controller.go`
- [✅] 删除 `guild_controller_init.go`

**目录：** `server/service/gameserver/internel/adapter/presenter/`
- [✅] 删除 `guild_presenter.go`

**目录：** `server/service/gameserver/internel/app/publicactor/`
- [✅] 删除 `public_role_guild.go`
- [✅] 删除 `public_role_guild_application.go`
- [✅] 删除 `public_role_guild_persist.go`
- [✅] 删除 `guild_permission.go`

#### 4.3 系统注册移除
**文件：** `server/service/gameserver/internel/app/playeractor/entitysystem/sys_mgr.go`
- [✅] 删除 `SysGuild` 的系统注册代码
- [✅] 删除 `SysGuild` 的依赖关系声明（包括从 Chat、Rank 的依赖列表中移除）

#### 4.4 依赖清理
**搜索关键词：** `SysGuild`、`GuildSystemAdapter`、`GetGuildSys`、`SiGuildData`
- [✅] 全局搜索并删除所有引用
- [✅] **重要**：检查以下系统对 Guild 的依赖，需要移除相关依赖：
  - `SysChat`：依赖 Guild（在 `sys_mgr.go` 中声明）- 已移除
  - `SysRank`：依赖 Guild（在 `sys_mgr.go` 中声明）- 已移除
- [✅] 修改 `sys_mgr.go`，从 `SysChat` 和 `SysRank` 的依赖列表中移除 `SysGuild`
- [✅] 从 `publicactor/register.go` 中移除 `RegisterGuildHandlers` 调用
- [✅] 从 `publicactor/public_role.go` 中移除 Guild 相关字段（guildMap、guildApplicationMap、nextGuildId、guildIdMu）
- [✅] 从 `publicactor/handler.go` 中移除加载公会数据的逻辑

---

### 阶段五：移除 SysAuction (拍卖行系统)

#### 5.1 Proto 文件修改
**文件：** `proto/csproto/system.proto`
- [✅] 删除 `SysAuction = 17;` 枚举项
- [✅] 删除 `message SiAuctionData { ... }` 定义

**文件：** `proto/csproto/player.proto`
- [✅] 删除 `SiAuctionData auction_data = 19;` 字段

#### 5.2 代码文件删除
**目录：** `server/service/gameserver/internel/adapter/system/`
- [✅] 删除 `auction_system_adapter.go`
- [✅] 删除 `auction_system_adapter_init.go`
- [✅] 删除 `auction_system_adapter_helper.go`

**目录：** `server/service/gameserver/internel/usecase/auction/`
- [✅] 删除整个 `auction/` 目录及其所有文件：
  - `init_auction_data.go`
  - `put_on.go`
  - `buy.go`
  - `query.go`

**目录：** `server/service/gameserver/internel/domain/auction/`
- [✅] 删除整个 `auction/` 目录及其所有文件：
  - `auction.go`

**目录：** `server/service/gameserver/internel/adapter/controller/`
- [✅] 删除 `auction_controller.go`
- [✅] 删除 `auction_controller_init.go`

**目录：** `server/service/gameserver/internel/adapter/presenter/`
- [✅] 删除 `auction_presenter.go`

**目录：** `server/service/gameserver/internel/app/publicactor/`
- [✅] 删除 `public_role_auction.go`

#### 5.3 系统注册移除
**文件：** `server/service/gameserver/internel/app/playeractor/entitysystem/sys_mgr.go`
- [✅] 删除 `SysAuction` 的系统注册代码
- [✅] 删除 `SysAuction` 的依赖关系声明

#### 5.4 依赖清理
**搜索关键词：** `SysAuction`、`AuctionSystemAdapter`、`GetAuctionSys`、`SiAuctionData`
- [✅] 全局搜索并删除所有引用
- [✅] 从 `publicactor/register.go` 中移除 `RegisterAuctionHandlers` 调用
- [✅] 从 `publicactor/public_role.go` 中移除 Auction 相关字段（auctionMap、nextAuctionId、auctionIdMu）
- [✅] 从 `publicactor/handler.go` 中移除加载拍卖行数据的逻辑

---

### 阶段六：SysAttr 改为工具类（属性系统）

#### 6.1 Proto 文件修改
**文件：** `proto/csproto/system.proto`
- [✅] 删除 `SysAttr = 6;` 枚举项（不再作为系统）
- [✅] **保留** `AttrVec`、`AttrSt` 等属性相关的 message 定义（这些是数据结构，不是系统）

#### 6.2 创建属性计算工具类
**新文件：** `server/service/gameserver/internel/app/playeractor/entity/attr_calculator.go`
- [✅] 创建 `AttrCalculator` 结构体，包含原 `AttrSystemAdapter` 的核心计算逻辑
- [✅] 将属性计算、战力计算等功能封装为工具方法
- [✅] 不依赖 Actor 框架，只依赖接口（Repository、ConfigManager 等）

#### 6.3 修改 PlayerRole
**文件：** `server/service/gameserver/internel/app/playeractor/entity/player_role.go`
- [✅] 添加 `attrCalculator *AttrCalculator` 字段
- [✅] 在 `NewPlayerRole` 中初始化 `attrCalculator`
- [✅] 在 `NewPlayerRole` 中调用 `attrCalculator.Init(ctx)` 初始化计算器
- [✅] 添加 `GetAttrCalculator()` 方法供其他包访问
- [✅] 将 `UpdateRankSnapshot` 中的 `attrsystem.GetAttrSys(ctx)` 调用改为使用 `pr.attrCalculator`
- [✅] 将 `RunOne` 中的 `attrSys.RunOne(ctx)` 调用改为使用 `pr.attrCalculator.RunOne(ctx)`
- [✅] 将 `OnReconnect` 中的 `attrSys.PushFullAttrData(ctx)` 调用改为使用 `pr.attrCalculator.PushFullAttrData(ctx)`

#### 6.4 代码文件删除/重构
**目录：** `server/service/gameserver/internel/adapter/system/`
- [✅] 删除 `attr_system_adapter.go`
- [✅] 删除 `attr_system_adapter_init.go`
- [✅] 删除 `attr_system_adapter_helper.go`
- [✅] 创建 `attr_calculator_helper.go` 提供 `GetAttrCalculator(ctx)` 辅助函数
- [✅] **保留** `level_system_adapter_attr.go`、`equip_system_adapter_attr.go`（这些是其他系统对属性的贡献，已通过 `GetAttrCalculator` 调用工具类）
- [✅] 修改 `equip_system_adapter_init.go`，使用 `GetAttrCalculator` 替代 `GetAttrSys`
- [✅] 修改 `attr_use_case_adapter.go`，使用 `GetAttrCalculator` 替代 `GetAttrSys`

**目录：** `server/service/gameserver/internel/usecase/attr/`
- [✅] **保留** UseCase（`calculate_sys_power.go`、`compare_attr_vec.go`），这些是纯业务逻辑
- [✅] UseCase 已被 `AttrCalculator` 调用

**目录：** `server/service/gameserver/internel/usecase/interfaces/`
- [✅] **保留** `attr.go`（如果存在），接口定义保持不变

#### 6.5 系统注册移除
**文件：** `server/service/gameserver/internel/app/playeractor/entitysystem/sys_mgr.go`
- [✅] 删除 `SysAttr` 的系统注册代码
- [✅] 删除其他系统对 `SysAttr` 的依赖关系声明（Quest、FuBen、ItemUse、Rank）

#### 6.6 依赖清理
**搜索关键词：** `SysAttr`、`AttrSystemAdapter`、`GetAttrSys`、`attrsystem.GetAttrSys`
- [✅] 全局搜索并替换为 `PlayerRole.attrCalculator` 或 `GetAttrCalculator(ctx)` 的调用
- [✅] 修改 `player_network.go`，使用类型断言访问 `attrCalculator`
- [✅] 修改 `fuben_controller.go`，使用 `GetAttrCalculator` 替代 `GetAttrSys`
- [✅] 修改 `level_up.go`，清理对 `SysAttr` 的引用
- [✅] **重要**：检查以下系统对 `SysAttr` 的依赖，已移除相关依赖：
  - `SysQuest`：依赖 Attr（在 `sys_mgr.go` 中声明）- 已移除
  - `SysFuBen`：依赖 Attr（在 `sys_mgr.go` 中声明）- 已移除
  - `SysItemUse`：依赖 Attr（在 `sys_mgr.go` 中声明）- 已移除
  - `SysRank`：依赖 Attr（在 `sys_mgr.go` 中声明）- 已移除
- [✅] 修改 `sys_mgr.go`，从上述系统的依赖列表中移除 `SysAttr`
- [✅] 这些系统如果需要属性计算，改为通过 `GetAttrCalculator(ctx)` 获取 `AttrCalculator` 来使用

#### 6.7 其他系统适配
**文件：** `server/service/gameserver/internel/usecase/level/level_up.go`
- [✅] 修改对 `SysAttr` 的调用，清理遗留代码

---

## 通用清理步骤

### 7.1 编译检查
- [✅] 运行 `go build` 确保无编译错误
- [ ] 运行 `go test ./...` 确保测试通过（如有测试）

### 7.2 Lint 检查
- [✅] 运行 lint 工具，修复所有警告（已完成：`go vet` 仅发现测试文件中的 mock 接口问题，不影响生产代码）

### 7.3 文档更新
- [✅] 更新 `docs/服务端开发进度文档.md`，移除已删除系统的相关章节（已完成）
- [✅] 更新 `docs/gameserver_adapter_system演进规划.md`，移除已删除系统的相关条目（已完成）
- [✅] 更新 `docs/gameserver_目录与调用关系说明.md`，移除已删除系统的说明（已完成）

### 7.4 数据库迁移（可选）
- [✅] 如果数据库中有这些系统的数据表，考虑是否需要迁移脚本（已完成：已从 `migrate.go` 中移除相关表的自动迁移）
- [✅] 注意：`PlayerRoleBinaryData` 中的字段会自动被忽略（proto 兼容性）（已验证：无需特殊处理）
- [✅] 创建数据库迁移说明文档（已完成：`docs/数据库迁移说明.md`）

### 7.5 Example 目录检查
- [✅] 检查 `server/example/` 目录，确认没有引用被删除的系统（已完成：grep 未找到相关引用）
- [✅] 如有引用，一并删除（当前检查结果：无引用，无需删除）

---

## 注意事项

1. **依赖关系**：移除系统时要注意依赖关系，例如 Guild 和 Auction 可能依赖 Friend，需要一并处理。

2. **PublicActor**：Friend、Guild、Auction 系统可能在 PublicActor 中有全局数据管理，需要一并清理。

3. **事件订阅**：检查是否有其他系统订阅了被删除系统的事件，需要一并移除。

4. **测试文件**：删除系统代码时，也要删除对应的测试文件（`*_test.go`）。

5. **Attr 系统重构**：将 Attr 从系统改为工具类时，要确保所有调用点都更新为新的调用方式。

6. **向后兼容**：如果已有玩家数据，proto 字段删除后，旧数据中的字段会被忽略，不会影响运行。

---

## 执行顺序建议

建议按以下顺序执行，避免依赖问题：

1. **阶段一**：移除 SysVip（独立系统，无依赖）
2. **阶段二**：移除 SysDailyActivity（独立系统，无依赖）
3. **阶段三**：移除 SysFriend（被 Guild、Auction 依赖，先移除）
4. **阶段四**：移除 SysGuild（依赖 Friend，Friend 已移除）
5. **阶段五**：移除 SysAuction（依赖 Friend、Guild，两者已移除）
6. **阶段六**：重构 SysAttr 为工具类（最后处理，因为其他系统可能依赖它）

---

## 验证清单

完成所有移除后，验证以下内容：

- [✅] 所有系统已从 `sys_mgr.go` 中移除（已验证：grep 未找到已删除系统的引用）
- [✅] 所有 Controller、Presenter 已删除（已验证：glob 搜索未找到相关文件）
- [✅] 所有 UseCase、Domain 已删除（已验证：glob 搜索未找到相关文件）
- [✅] 所有 SystemAdapter 已删除（已验证：glob 搜索未找到相关文件）
- [✅] Proto 文件已更新，枚举和 message 已删除（已验证：grep 未找到相关定义）
- [✅] 编译无错误（已验证：`go build` 成功）
- [✅] Lint 无警告（已验证：`go vet` 仅发现测试文件中的 mock 接口问题，不影响生产代码）
- [✅] 文档已更新（已完成：三个主要文档均已更新）
- [✅] Attr 系统已成功改为工具类，PlayerRole 可以正常使用（已验证：`AttrCalculator` 已注入到 `PlayerRole`，`GetAttrCalculator()` 方法已实现）

