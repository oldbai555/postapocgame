# 数据库迁移说明

## 概述

本文档说明在移除以下系统后的数据库迁移策略：
- SysVip (VIP系统)
- SysDailyActivity (日常活跃系统)
- SysFriend (好友系统)
- SysGuild (公会系统)
- SysAuction (拍卖行系统)
- SysAttr (属性系统，已重构为工具类)

## 迁移策略

### 1. PlayerRoleBinaryData（玩家二进制数据）

**位置**：`Player.BinaryData` 字段

**处理方式**：
- ✅ **无需特殊处理**：由于 Protocol Buffers 的向后兼容性，已删除的字段（`SiVipData`、`SiDailyActivityData`、`SiFriendData`、`SiGuildData`、`SiAuctionData`）在反序列化时会被自动忽略
- ✅ **数据安全**：旧数据中的这些字段会被保留但不会被读取，不会影响游戏运行
- ✅ **新数据**：新创建的玩家数据不会包含这些字段

**验证**：
- 已从 `proto/csproto/player.proto` 中删除相关字段定义
- 代码中已移除对这些字段的访问

### 2. Guild 表（公会表）

**位置**：`server/internal/database/guild.go`

**处理方式**：
- ✅ **已从自动迁移中移除**：`migrate.go` 中已注释掉 `&Guild{}`
- ⚠️ **表保留策略**：
  - 如果数据库中已有 `guilds` 表，表结构会保留但不会被自动迁移更新
  - 如果需要完全删除表，可以手动执行 SQL：`DROP TABLE IF EXISTS guilds;`
  - 建议：如果确定不需要历史数据，可以在生产环境维护窗口期间删除表

**相关文件**：
- `server/internal/database/guild.go` - 表定义和操作函数（已不再被调用）

### 3. AuctionItem 表（拍卖物品表）

**位置**：`server/internal/database/auction_item.go`

**处理方式**：
- ✅ **已从自动迁移中移除**：`migrate.go` 中已注释掉 `&AuctionItem{}`
- ⚠️ **表保留策略**：
  - 如果数据库中已有 `auction_items` 表，表结构会保留但不会被自动迁移更新
  - 如果需要完全删除表，可以手动执行 SQL：`DROP TABLE IF EXISTS auction_items;`
  - 建议：如果确定不需要历史数据，可以在生产环境维护窗口期间删除表

**相关文件**：
- `server/internal/database/auction_item.go` - 表定义和操作函数（已不再被调用）

### 4. Blacklist 表（黑名单表）

**位置**：`server/internal/database/blacklist.go`

**处理方式**：
- ✅ **保留自动迁移**：`migrate.go` 中保留 `&Blacklist{}`
- ✅ **仍在使用**：聊天系统（`public_role_chat.go`）仍在使用黑名单功能来过滤聊天消息
- ⚠️ **说明**：
  - 虽然好友系统已删除，但黑名单功能被聊天系统复用
  - 表会继续被自动迁移和维护

**相关文件**：
- `server/internal/database/blacklist.go` - 表定义和操作函数
- `server/service/gameserver/internel/app/publicactor/public_role_chat.go` - 使用黑名单功能
- `server/service/gameserver/internel/adapter/gateway/blacklist_repository.go` - 黑名单仓储实现

### 5. TransactionAudit 表（交易审计表）

**位置**：`server/internal/database/transaction_audit.go`

**处理方式**：
- ✅ **已从自动迁移中移除**：`migrate.go` 中已注释掉 `&TransactionAudit{}`
- ⚠️ **表保留策略**：
  - 交易审计功能主要用于拍卖行系统的交易记录
  - 如果数据库中已有 `transaction_audits` 表，表结构会保留但不会被自动迁移更新
  - 如果需要完全删除表，可以手动执行 SQL：`DROP TABLE IF EXISTS transaction_audits;`

**相关文件**：
- `server/internal/database/transaction_audit.go` - 表定义和操作函数（已不再被调用）

## 执行步骤

### 开发环境

1. ✅ **代码更新**：已完成
   - `migrate.go` 中已注释掉相关表的自动迁移

2. **数据库清理（可选）**：
   ```sql
   -- 如果需要删除表（仅在确定不需要历史数据时执行）
   DROP TABLE IF EXISTS guilds;
   DROP TABLE IF EXISTS auction_items;
   -- 注意：blacklists 表保留，因为聊天系统仍在使用
   DROP TABLE IF EXISTS transaction_audits;
   ```

### 生产环境

1. **备份数据库**（重要！）：
   ```bash
   # 备份 SQLite 数据库
   cp postapocgame.db postapocgame.db.backup.$(date +%Y%m%d_%H%M%S)
   ```

2. **执行迁移**：
   - 代码部署后，相关表不会被自动迁移
   - 旧表会保留但不会被使用

3. **清理表（可选，需谨慎）**：
   - 如果确定不需要历史数据，可以在维护窗口期间删除表
   - 建议先备份数据，再执行删除操作

## 注意事项

1. **数据安全**：
   - `PlayerRoleBinaryData` 中的已删除字段会被自动忽略，不会影响游戏运行
   - 独立的表（Guild、AuctionItem 等）如果保留，不会影响新功能

2. **向后兼容**：
   - Protocol Buffers 的向后兼容性保证了旧数据可以正常读取
   - 新代码不会访问已删除的字段，旧数据中的这些字段会被忽略

3. **性能影响**：
   - 保留表不会影响性能（因为不会被访问）
   - 删除表可以节省存储空间

4. **回滚策略**：
   - 如果需要回滚，可以恢复备份的数据库
   - 代码回滚后，相关表可以重新启用自动迁移

## 验证清单

- [✅] `migrate.go` 中已移除相关表的自动迁移
- [✅] 代码中已确认没有对相关表的调用
- [ ] 数据库表清理（可选，根据实际需求决定）
- [ ] 生产环境备份（如需要删除表）

## 相关文件

- `server/internal/database/migrate.go` - 数据库迁移配置
- `server/internal/database/guild.go` - 公会表定义（已不再使用）
- `server/internal/database/auction_item.go` - 拍卖物品表定义（已不再使用）
- `server/internal/database/blacklist.go` - 黑名单表定义（**仍在使用**：聊天系统使用）
- `server/internal/database/transaction_audit.go` - 交易审计表定义（已不再使用）
- `proto/csproto/player.proto` - 玩家数据协议定义（已删除相关字段）

