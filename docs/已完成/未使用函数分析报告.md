# æœªä½¿ç”¨å‡½æ•°åˆ†ææŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**ï¼š2025-12-04  
**åˆ†æèŒƒå›´**ï¼š`server/service/gameserver` ä¸­æ‰€æœ‰æœªä½¿ç”¨çš„å‡½æ•°

---

## ğŸ“‹ æœªä½¿ç”¨å‡½æ•°åˆ—è¡¨

æ ¹æ® `staticcheck` æ£€æµ‹ï¼Œä»¥ä¸‹å‡½æ•°æœªè¢«ä½¿ç”¨ï¼š

1. `(*MoveSys).flushAOIChanges` - `move_sys.go:631`
2. `(*MoveSys).notifyAppear` - `move_sys.go:654`
3. `(*MoveSys).notifyDisappear` - `move_sys.go:670`
4. `(*MoveSys).notifyDisappearByHandle` - `move_sys.go:682`
5. `(*SceneSt).spawnScene2Monsters` - `scenest.go:348`
6. `logWarn` - `player_network.go:35`
7. `sendClientProtoViaPlayerActor` - `send_client.go:37`
8. `(*PublicRole).flushOfflineDataIfNeeded` - `public_role_offline_data.go:32`

---

## ğŸ” è¯¦ç»†åˆ†æ

### 1. MoveSys AOI ç›¸å…³å‡½æ•° âš ï¸ **åº”è¯¥åœ¨ä¸šåŠ¡ä¸­ä½¿ç”¨**

#### å‡½æ•°åˆ—è¡¨
- `flushAOIChanges()` - åˆ·æ–° AOI å˜åŒ–
- `notifyAppear(receiver, subject)` - é€šçŸ¥å®ä½“å‡ºç°
- `notifyDisappear(receiver, targetHdl)` - é€šçŸ¥å®ä½“æ¶ˆå¤±
- `notifyDisappearByHandle(receiverHdl, subjectHdl)` - é€šè¿‡å¥æŸ„é€šçŸ¥å®ä½“æ¶ˆå¤±

#### åŠŸèƒ½è¯´æ˜
è¿™äº›å‡½æ•°å®ç°äº†å®Œæ•´çš„ **AOIï¼ˆArea of Interestï¼‰è§†é‡ç³»ç»Ÿ**ï¼Œç”¨äºï¼š
- è·Ÿè¸ªå®ä½“è¿›å…¥/ç¦»å¼€è§†é‡
- å‘å®¢æˆ·ç«¯å‘é€ `S2CEntityAppear` å’Œ `S2CEntityDisappear` æ¶ˆæ¯
- ç¡®ä¿å®¢æˆ·ç«¯èƒ½çœ‹åˆ°è§†é‡å†…çš„å…¶ä»–å®ä½“

#### å½“å‰é—®é¢˜
- âŒ **æœªè°ƒç”¨**ï¼š`flushAOIChanges` ä»æœªè¢«è°ƒç”¨
- âŒ **å½±å“**ï¼šå®¢æˆ·ç«¯å¯èƒ½çœ‹ä¸åˆ°è§†é‡å†…çš„å…¶ä»–å®ä½“ï¼ˆç©å®¶ã€æ€ªç‰©ç­‰ï¼‰
- âŒ **AOISys çŠ¶æ€**ï¼š`AOISys.ConsumeVisibilityChanges()` è¿”å›çš„è§†é‡å˜åŒ–æœªè¢«å¤„ç†

#### å»ºè®®ä¿®å¤
**åº”è¯¥åœ¨ `LocationUpdate` æˆ–ç§»åŠ¨å®Œæˆåè°ƒç”¨ `flushAOIChanges()`**ï¼š

```go
// åœ¨ move_sys.go çš„ LocationUpdate æ–¹æ³•ä¸­
func (ms *MoveSys) LocationUpdate(cPx, cPy int32) bool {
    // ... ç°æœ‰é€»è¾‘ ...
    
    // ä½ç½®æ›´æ–°åï¼Œåˆ·æ–° AOI å˜åŒ–
    ms.flushAOIChanges()
    
    return true
}
```

æˆ–è€…ï¼š

```go
// åœ¨ HandleUpdateMove æˆ– HandleEndMove ä¸­è°ƒç”¨
func (ms *MoveSys) HandleUpdateMove(scene iface.IScene, req *protocol.C2SUpdateMoveReq) error {
    // ... ç°æœ‰é€»è¾‘ ...
    
    // ç§»åŠ¨æ›´æ–°åï¼Œåˆ·æ–° AOI å˜åŒ–
    ms.flushAOIChanges()
    
    return nil
}
```

**ä¼˜å…ˆçº§**ï¼šğŸ”´ **é«˜** - å½±å“æ¸¸æˆæ ¸å¿ƒåŠŸèƒ½ï¼ˆå®ä½“å¯è§æ€§ï¼‰

---

### 2. spawnScene2Monsters âš ï¸ **å¯èƒ½å·²åºŸå¼ƒï¼Œéœ€è¦ç¡®è®¤**

#### åŠŸèƒ½è¯´æ˜
ç¡¬ç¼–ç çš„åœºæ™¯2æ€ªç‰©ç”Ÿæˆé€»è¾‘ï¼š
- å²è±å§† x10
- å“¥å¸ƒæ— x8
- æ£®æ—ç‹¼ x5
- å“¥å¸ƒæ—é¦–é¢† x2
- æ£®æ—å®ˆæŠ¤è€… x1 (BOSS)

#### å½“å‰çŠ¶æ€
- âœ… å·²æœ‰ `InitMonsters()` æ–¹æ³•ï¼Œä»é…ç½®è¯»å–æ€ªç‰©ä¿¡æ¯
- âŒ `spawnScene2Monsters` æœªè¢«è°ƒç”¨

#### åˆ†æ
1. **å¦‚æœåœºæ™¯2æœ‰é…ç½®**ï¼šåº”è¯¥ä½¿ç”¨ `InitMonsters()`ï¼Œ`spawnScene2Monsters` å¯ä»¥åˆ é™¤
2. **å¦‚æœåœºæ™¯2æ²¡æœ‰é…ç½®**ï¼šå¯èƒ½éœ€è¦ `spawnScene2Monsters` ä½œä¸º fallback

#### å»ºè®®
1. **æ£€æŸ¥åœºæ™¯2é…ç½®**ï¼šç¡®è®¤ `MonsterSceneConfig` ä¸­æ˜¯å¦æœ‰åœºæ™¯2çš„é…ç½®
2. **å¦‚æœæœ‰é…ç½®**ï¼šåˆ é™¤ `spawnScene2Monsters`ï¼Œä½¿ç”¨ `InitMonsters()`
3. **å¦‚æœæ²¡æœ‰é…ç½®**ï¼š
   - æ–¹æ¡ˆAï¼šåœ¨ `InitMonsters()` ä¸­ï¼Œå¦‚æœåœºæ™¯IDä¸º2ä¸”æ²¡æœ‰é…ç½®ï¼Œè°ƒç”¨ `spawnScene2Monsters()`
   - æ–¹æ¡ˆBï¼šè¡¥å……åœºæ™¯2çš„é…ç½®ï¼Œåˆ é™¤ç¡¬ç¼–ç å‡½æ•°

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ **ä¸­** - éœ€è¦ç¡®è®¤ä¸šåŠ¡éœ€æ±‚

---

### 3. logWarn âš ï¸ **å¯ä»¥åˆ é™¤æˆ–ä¿ç•™**

#### åŠŸèƒ½è¯´æ˜
æ—¥å¿—åŒ…è£…å‡½æ•°ï¼Œè°ƒç”¨ `gshare.WarnfCtx`ã€‚

#### å½“å‰çŠ¶æ€
- âœ… å·²æœ‰ `logError` å‡½æ•°ï¼Œè¢«å¤šå¤„ä½¿ç”¨
- âŒ `logWarn` æœªè¢«ä½¿ç”¨

#### åˆ†æ
- ä»£ç ä¸­åªä½¿ç”¨äº† `logError`ï¼Œæ²¡æœ‰ä½¿ç”¨ `logWarn`
- å¯èƒ½æ˜¯é¢„ç•™çš„åŠŸèƒ½ï¼Œä½†å½“å‰ä¸éœ€è¦

#### å»ºè®®
- **æ–¹æ¡ˆA**ï¼šåˆ é™¤ `logWarn`ï¼Œéœ€è¦æ—¶ç›´æ¥ä½¿ç”¨ `gshare.WarnfCtx`
- **æ–¹æ¡ˆB**ï¼šä¿ç•™ `logWarn`ï¼Œåœ¨éœ€è¦è­¦å‘Šæ—¥å¿—çš„åœ°æ–¹ä½¿ç”¨ï¼ˆä¸ `logError` ä¿æŒä¸€è‡´ï¼‰

**ä¼˜å…ˆçº§**ï¼šğŸŸ¢ **ä½** - ä¸å½±å“åŠŸèƒ½

---

### 4. sendClientProtoViaPlayerActor âš ï¸ **åº”è¯¥æ›¿æ¢ç°æœ‰è°ƒç”¨**

#### åŠŸèƒ½è¯´æ˜
`sendClientMessageViaPlayerActor` çš„åŒ…è£…å‡½æ•°ï¼Œæä¾›æ›´æ–¹ä¾¿çš„æ¥å£ï¼š
- æ¥å— `proto.Message` è€Œä¸æ˜¯ `[]byte`
- è‡ªåŠ¨è¿›è¡Œ `proto.Marshal`

#### å½“å‰çŠ¶æ€
- âœ… å‡½æ•°å·²å®ç°
- âŒ ä»£ç ä¸­å¤šå¤„ç›´æ¥ä½¿ç”¨ `sendClientMessageViaPlayerActor`ï¼Œæ‰‹åŠ¨è¿›è¡Œ `proto.Marshal`

#### ä½¿ç”¨ç¤ºä¾‹å¯¹æ¯”

**å½“å‰ä»£ç **ï¼ˆ`public_role_chat.go`ï¼‰ï¼š
```go
broadcastData, err := proto.Marshal(broadcastMsg)
if err != nil {
    log.Errorf("marshal chat message failed: %v", err)
    return
}
if err := sendClientMessageViaPlayerActor(sessionId, uint16(protocol.S2CProtocol_S2CChatMessage), broadcastData); err != nil {
    logSendFailure(sessionId, uint16(protocol.S2CProtocol_S2CChatMessage), err)
}
```

**åº”è¯¥æ”¹ä¸º**ï¼š
```go
if err := sendClientProtoViaPlayerActor(sessionId, uint16(protocol.S2CProtocol_S2CChatMessage), broadcastMsg); err != nil {
    logSendFailure(sessionId, uint16(protocol.S2CProtocol_S2CChatMessage), err)
}
```

#### å»ºè®®
**æ›¿æ¢æ‰€æœ‰ `sendClientMessageViaPlayerActor` + `proto.Marshal` çš„ç»„åˆä¸º `sendClientProtoViaPlayerActor`**ï¼š

æ¶‰åŠæ–‡ä»¶ï¼š
- `public_role_chat.go` - çº¦ 5 å¤„
- `public_role_online.go` - çº¦ 1 å¤„
- `public_role_rank.go` - çº¦ 1 å¤„

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ **ä¸­** - æé«˜ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§

---

### 5. flushOfflineDataIfNeeded âš ï¸ **åº”è¯¥åœ¨ RunOne ä¸­è°ƒç”¨**

#### åŠŸèƒ½è¯´æ˜
å®šæœŸåˆ·æ–°ç¦»çº¿æ•°æ®åˆ°æ•°æ®åº“ï¼š
- æ¯ 60 ç§’åˆ·æ–°ä¸€æ¬¡ï¼ˆ`offlineDataFlushIntervalMs = 60 * 1000`ï¼‰
- è°ƒç”¨ `offlineDataMgr.FlushDirty(ctx)` å°†è„æ•°æ®è½åº“

#### å½“å‰çŠ¶æ€
- âœ… å‡½æ•°å·²å®ç°
- âœ… `PublicRole` æœ‰ `lastOfflineDataFlushTime` å­—æ®µ
- âŒ `handleRunOneMsg` æ˜¯ç©ºçš„ï¼Œæœªè°ƒç”¨ `flushOfflineDataIfNeeded`

#### åˆ†æ
- `PublicRole` æœ‰ `RunOne` æœºåˆ¶ï¼ˆé€šè¿‡ `PublicActorMsgRunOne` æ¶ˆæ¯è§¦å‘ï¼‰
- ä½† `handleRunOneMsg` ç›®å‰æ˜¯ç©ºçš„ï¼Œæ³¨é‡Šè¯´"ä¿ç•™ç”¨äºæœªæ¥æ‰©å±•"
- ç¦»çº¿æ•°æ®éœ€è¦å®šæœŸåˆ·æ–°ï¼Œå¦åˆ™å¯èƒ½ä¸¢å¤±æ•°æ®

#### å»ºè®®
**åœ¨ `handleRunOneMsg` ä¸­è°ƒç”¨ `flushOfflineDataIfNeeded`**ï¼š

```go
// message_handler.go
func handleRunOneMsg(ctx context.Context, msg actor.IActorMessage, publicRole *PublicRole) {
    // å®šæœŸåˆ·æ–°ç¦»çº¿æ•°æ®
    now := servertime.Now().UnixMilli()
    publicRole.flushOfflineDataIfNeeded(ctx, now)
    
    // å…¶ä»– RunOne é€»è¾‘ï¼ˆå¦‚æ¸…ç†ç¦»çº¿æ¶ˆæ¯ç­‰ï¼‰
    // ...
}
```

**ä¼˜å…ˆçº§**ï¼šğŸ”´ **é«˜** - å½±å“æ•°æ®æŒä¹…åŒ–

---

## ğŸ“Š ä¼˜å…ˆçº§æ€»ç»“

| å‡½æ•° | ä¼˜å…ˆçº§ | å½±å“ | å»ºè®® |
|------|--------|------|------|
| `flushAOIChanges` åŠç›¸å…³ | ğŸ”´ **é«˜** | å®¢æˆ·ç«¯çœ‹ä¸åˆ°å…¶ä»–å®ä½“ | åœ¨ `LocationUpdate` ä¸­è°ƒç”¨ |
| `flushOfflineDataIfNeeded` | ğŸ”´ **é«˜** | ç¦»çº¿æ•°æ®å¯èƒ½ä¸¢å¤± | åœ¨ `handleRunOneMsg` ä¸­è°ƒç”¨ |
| `sendClientProtoViaPlayerActor` | ğŸŸ¡ **ä¸­** | ä»£ç å¯è¯»æ€§ | æ›¿æ¢ç°æœ‰è°ƒç”¨ |
| `spawnScene2Monsters` | ğŸŸ¡ **ä¸­** | éœ€è¦ç¡®è®¤ä¸šåŠ¡éœ€æ±‚ | ç¡®è®¤åå†³å®šåˆ é™¤æˆ–ä½¿ç”¨ |
| `logWarn` | ğŸŸ¢ **ä½** | æ— å½±å“ | åˆ é™¤æˆ–ä¿ç•™ |

---

## âœ… ä¿®å¤çŠ¶æ€

### âœ… å·²å®Œæˆä¿®å¤ï¼ˆ2025-12-04ï¼‰

1. **âœ… ä¿®å¤ AOI ç³»ç»Ÿ**ï¼š
   - âœ… åœ¨ `MoveSys.LocationUpdate` ä¸­è°ƒç”¨ `flushAOIChanges()`ï¼ˆä½ç½®æ›´æ–°æˆåŠŸåï¼‰
   - âœ… åœ¨ `MoveSys.HandleUpdateMove` ä¸­è°ƒç”¨ `flushAOIChanges()`ï¼ˆç§»åŠ¨æ›´æ–°åï¼‰
   - âœ… åœ¨ `MoveSys.HandleEndMove` ä¸­è°ƒç”¨ `flushAOIChanges()`ï¼ˆåœæ­¢ç§»åŠ¨åï¼‰
   - âœ… ç¡®ä¿å®¢æˆ·ç«¯èƒ½çœ‹åˆ°è§†é‡å†…çš„å®ä½“

2. **âœ… ä¿®å¤ç¦»çº¿æ•°æ®åˆ·æ–°**ï¼š
   - âœ… åœ¨ `handleRunOneMsg` ä¸­è°ƒç”¨ `flushOfflineDataIfNeeded`
   - âœ… ç¡®ä¿ç¦»çº¿æ•°æ®æ¯ 60 ç§’å®šæœŸè½åº“

3. **âœ… æ›¿æ¢ sendClientProtoViaPlayerActor**ï¼š
   - âœ… æ›¿æ¢ `public_role_chat.go` ä¸­æ‰€æœ‰ `sendClientMessageViaPlayerActor` + `proto.Marshal`ï¼ˆ5 å¤„ï¼‰
   - âœ… æ›¿æ¢ `public_role_online.go` ä¸­çš„è°ƒç”¨ï¼ˆ1 å¤„ï¼‰
   - âœ… æ›¿æ¢ `public_role_rank.go` ä¸­çš„è°ƒç”¨ï¼ˆ1 å¤„ï¼‰
   - âœ… æé«˜ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§

4. **âœ… å¤„ç† spawnScene2Monsters**ï¼š
   - âœ… åœ¨ `InitMonsters()` ä¸­æ·»åŠ  fallback é€»è¾‘
   - âœ… å¦‚æœåœºæ™¯IDä¸º2ä¸”æ²¡æœ‰é…ç½®ï¼Œè°ƒç”¨ `spawnScene2Monsters()`
   - âœ… ä¿ç•™ç¡¬ç¼–ç å‡½æ•°ä½œä¸º fallbackï¼ŒåŒæ—¶æ”¯æŒé…ç½®åŒ–

5. **âœ… å¤„ç† logWarn**ï¼š
   - âœ… åˆ é™¤æœªä½¿ç”¨çš„ `logWarn` å‡½æ•°
   - âœ… éœ€è¦æ—¶ç›´æ¥ä½¿ç”¨ `gshare.WarnfCtx`

### ğŸ“Š ä¿®å¤ç»Ÿè®¡

- **é«˜ä¼˜å…ˆçº§ä¿®å¤**ï¼š2 é¡¹ âœ…
- **ä¸­ä¼˜å…ˆçº§ä¿®å¤**ï¼š2 é¡¹ âœ…
- **ä½ä¼˜å…ˆçº§ä¿®å¤**ï¼š1 é¡¹ âœ…
- **æ€»è®¡**ï¼š5 é¡¹å…¨éƒ¨å®Œæˆ âœ…

### ğŸ” éªŒè¯ç»“æœ

è¿è¡Œ `staticcheck` éªŒè¯ï¼Œæ‰€æœ‰æŠ¥å‘Šä¸­çš„æœªä½¿ç”¨å‡½æ•°é—®é¢˜å·²è§£å†³ï¼š
- âœ… `flushAOIChanges` - å·²ä½¿ç”¨
- âœ… `notifyAppear` - å·²ä½¿ç”¨ï¼ˆé€šè¿‡ `flushAOIChanges` è°ƒç”¨ï¼‰
- âœ… `notifyDisappear` - å·²ä½¿ç”¨ï¼ˆé€šè¿‡ `flushAOIChanges` è°ƒç”¨ï¼‰
- âœ… `notifyDisappearByHandle` - å·²ä½¿ç”¨ï¼ˆé€šè¿‡ `flushAOIChanges` è°ƒç”¨ï¼‰
- âœ… `spawnScene2Monsters` - å·²ä½¿ç”¨ï¼ˆä½œä¸º fallbackï¼‰
- âœ… `logWarn` - å·²åˆ é™¤
- âœ… `sendClientProtoViaPlayerActor` - å·²ä½¿ç”¨
- âœ… `flushOfflineDataIfNeeded` - å·²ä½¿ç”¨

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **AOI ç³»ç»Ÿ**ï¼šä¿®å¤åéœ€è¦æµ‹è¯•å®¢æˆ·ç«¯æ˜¯å¦èƒ½æ­£ç¡®çœ‹åˆ°å…¶ä»–å®ä½“
2. **ç¦»çº¿æ•°æ®**ï¼šä¿®å¤åéœ€è¦æµ‹è¯•æ•°æ®æ˜¯å¦èƒ½æ­£ç¡®æŒä¹…åŒ–
3. **åœºæ™¯2æ€ªç‰©**ï¼šéœ€è¦ä¸ç­–åˆ’ç¡®è®¤åœºæ™¯2çš„æ€ªç‰©ç”Ÿæˆé€»è¾‘
4. **ä»£ç å®¡æŸ¥**ï¼šæ‰€æœ‰ä¿®å¤å»ºè®®éƒ½éœ€è¦ç»è¿‡ä»£ç å®¡æŸ¥

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `server/service/gameserver/internel/app/dungeonactor/entitysystem/move_sys.go`
- `server/service/gameserver/internel/app/dungeonactor/scene/scenest.go`
- `server/service/gameserver/internel/app/playeractor/entity/player_network.go`
- `server/service/gameserver/internel/app/publicactor/send_client.go`
- `server/service/gameserver/internel/app/publicactor/public_role_offline_data.go`
- `server/service/gameserver/internel/app/publicactor/message_handler.go`

