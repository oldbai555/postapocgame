# 前端菜单迁移指南

## 概述

当需要将前端菜单从一个目录迁移到另一个目录时，需要同时更新：
1. **SQL 初始化文件**：更新菜单路径和组件路径
2. **前端 Vue 组件**：移动文件到新目录

## 迁移步骤

### 方法一：使用自动化脚本（推荐）

使用 `scripts/migrate-menu.sh` 脚本自动完成迁移：

```bash
./scripts/migrate-menu.sh \
  -old-path /temp/chat \
  -new-path /chatroom/chat \
  -old-component temp/ChatList \
  -new-component chatroom/ChatList \
  -sql-file admin-server/db/migrations/init_chat.sql
```

**参数说明：**
- `-old-path`: 旧菜单路径（数据库中的 `path` 字段）
- `-new-path`: 新菜单路径（数据库中的 `path` 字段）
- `-old-component`: 旧组件路径（数据库中的 `component` 字段，不含 `.vue` 扩展名）
- `-new-component`: 新组件路径（数据库中的 `component` 字段，不含 `.vue` 扩展名）
- `-sql-file`: 可选，SQL 初始化文件路径

**脚本功能：**
1. 更新 SQL 文件中的菜单路径和组件路径
2. 移动前端 Vue 组件文件到新目录
3. 删除空的旧目录

### 方法二：手动迁移

#### 1. 更新 SQL 文件

在 SQL 初始化文件中（如 `admin-server/db/migrations/init_*.sql`），更新以下内容：

```sql
-- 旧代码
INSERT INTO `admin_menu` (..., `path`, `component`, ...)
VALUES (..., '/temp/chat', 'temp/ChatList', ...);

-- 新代码
INSERT INTO `admin_menu` (..., `path`, `component`, ...)
VALUES (..., '/chatroom/chat', 'chatroom/ChatList', ...);
```

**需要更新的字段：**
- `path`: 菜单路径（前端路由路径）
- `component`: 组件路径（Vue 组件文件路径，不含 `.vue` 扩展名）

#### 2. 移动前端组件文件

```bash
# 创建新目录
mkdir -p admin-frontend/src/views/chatroom

# 移动文件
mv admin-frontend/src/views/temp/ChatList.vue admin-frontend/src/views/chatroom/ChatList.vue

# 删除空目录（如果旧目录为空）
rmdir admin-frontend/src/views/temp
```

#### 3. 更新组件中的导入路径（如果有）

如果组件中硬编码了相对路径，需要手动更新：

```vue
<!-- 旧代码 -->
<script setup lang="ts">
import SomeComponent from '@/views/temp/SomeComponent.vue';
</script>

<!-- 新代码 -->
<script setup lang="ts">
import SomeComponent from '@/views/chatroom/SomeComponent.vue';
</script>
```

#### 4. 执行 SQL 更新数据库

```bash
# 执行 SQL 文件更新数据库
mysql -u root -p postapoc_admin < admin-server/db/migrations/init_chat.sql
```

## 迁移示例：在线聊天菜单迁移到聊天室目录

### 场景

将"在线聊天"菜单从 `/temp/chat` 迁移到 `/chatroom/chat`。

### 步骤

1. **执行迁移脚本**：

```bash
./scripts/migrate-menu.sh \
  -old-path /temp/chat \
  -new-path /chatroom/chat \
  -old-component temp/ChatList \
  -new-component chatroom/ChatList \
  -sql-file admin-server/db/migrations/init_chat.sql
```

2. **执行 SQL 更新数据库**：

```bash
mysql -u root -p postapoc_admin < admin-server/db/migrations/init_chat.sql
```

3. **验证迁移结果**：

- 前端：访问 `/chatroom/chat` 路径，确认页面正常显示
- 数据库：查询 `admin_menu` 表，确认 `path` 和 `component` 字段已更新

## 注意事项

1. **SQL 文件幂等性**：确保 SQL 文件使用 `ON DUPLICATE KEY UPDATE`，支持重复执行
2. **前端路由**：前端路由是动态生成的，基于菜单数据，无需手动更新路由配置
3. **组件依赖**：如果组件之间有依赖关系，需要同时更新所有相关组件
4. **权限关联**：菜单迁移不会影响权限关联，权限码保持不变
5. **备份**：迁移前建议备份 SQL 文件和前端组件文件

## 常见问题

### Q: 迁移后前端页面无法访问？

A: 检查以下几点：
1. SQL 文件是否已执行
2. 菜单路径和组件路径是否正确
3. 前端组件文件是否已移动到正确位置
4. 浏览器缓存是否已清除

### Q: 迁移后菜单显示在错误的位置？

A: 检查 SQL 文件中的 `parent_id` 是否正确指向新目录的菜单 ID。

### Q: 如何回滚迁移？

A: 执行反向迁移：
1. 使用脚本将菜单迁移回原目录
2. 执行 SQL 文件恢复数据库

