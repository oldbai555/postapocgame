# 坐标系统优化建议

## 背景
- 客户端单个格子：128×128 像素
- 服务端坐标 (x, y) 代表一个格子
- 服务端认为玩家始终在格子正中央：像素坐标 (x*128 + 64, y*128 + 64)

## 需要优化的点

### 1. 坐标系统定义与转换（高优先级）

**位置**：`server/internal/argsdef/position.go` 或新建 `server/internal/argsdef/coordinate.go`

**需要添加**：
- 格子大小常量：`const TileSize = 128`
- 格子中心偏移：`const TileCenterOffset = 64`
- 坐标转换函数：
  - `TileCoordToPixelX/Y(tileX, tileY uint32) (pixelX, pixelY uint32)` - 格子坐标转像素坐标（中心点）
  - `PixelCoordToTileX/Y(pixelX, pixelY uint32) (tileX, tileY uint32)` - 像素坐标转格子坐标
  - `IsSameTile(pos1, pos2 *Position) bool` - 判断两个位置是否在同一格子

**影响范围**：
- 所有位置相关的计算
- 移动校验
- 距离计算
- 寻路算法

### 2. 移动系统优化（高优先级）

**位置**：`server/service/dungeonserver/internel/entitysystem/move_sys.go`

**需要改进**：
- **位置校验**：客户端发送的像素坐标需要转换为格子坐标进行校验
- **移动目标**：移动目标应该是格子坐标，而不是像素坐标
- **距离计算**：`distanceBetween` 需要考虑格子大小，或者改为格子距离
- **速度单位**：明确速度单位是"格子/秒"还是"像素/秒"，统一处理
- **容差调整**：`positionTolerance`、`distanceTolerance` 等需要基于格子大小调整

**具体改动**：
```go
// 在移动校验时，将像素坐标转换为格子坐标
tileX, tileY := PixelCoordToTile(req.PosX, req.PosY)
// 校验格子是否可行走
if !scene.IsWalkable(int(tileX), int(tileY)) {
    return error
}
```

### 3. 寻路算法优化（中优先级）

**位置**：`server/service/dungeonserver/internel/entitysystem/pathfinding.go`

**需要改进**：
- 寻路算法已经基于格子坐标，但需要确保：
  - 输入输出都是格子坐标
  - 距离计算使用格子距离（曼哈顿距离或欧几里得距离）
  - 路径点都是格子中心

**验证点**：
- `FindPath` 函数的输入输出是否明确为格子坐标
- 路径点是否需要转换为像素坐标发送给客户端

### 4. 场景系统优化（中优先级）

**位置**：`server/service/dungeonserver/internel/scene/scenest.go`

**需要改进**：
- `IsWalkable` 已经基于格子，需要确认
- `GetSpawnPos` 返回的应该是格子坐标
- `EntityMove` 接收的坐标应该是格子坐标
- 位置存储：实体位置应该存储为格子坐标

### 5. 客户端（server/example）优化（高优先级）

**位置**：`server/example/game_client.go`

**需要改进**：
- **坐标转换**：客户端发送移动请求时，需要将像素坐标转换为格子坐标
- **位置显示**：显示位置时，需要明确是格子坐标还是像素坐标
- **移动命令**：`move` 命令应该接受格子坐标，或者自动转换
- **位置同步**：接收服务端位置时，需要转换为像素坐标用于显示

**具体改动**：
```go
// 发送移动请求前转换坐标
tileX, tileY := PixelCoordToTile(clientPixelX, clientPixelY)
req := &protocol.C2SStartMoveReq{
    FromX: tileX,
    FromY: tileY,
    ToX:   targetTileX,
    ToY:   targetTileY,
    // ...
}
```

### 6. 协议定义检查（中优先级）

**位置**：`proto/csproto/*.proto`

**需要检查**：
- `PosX`、`PosY` 字段的语义是否明确为格子坐标
- 是否需要添加注释说明坐标系统
- 速度字段的单位是否明确

### 7. 距离和范围计算（中优先级）

**位置**：所有涉及距离计算的地方

**需要改进**：
- 技能范围、攻击范围等应该基于格子距离
- AOI 范围计算需要考虑格子大小
- 移动速度校验需要考虑格子大小

### 8. 配置和常量（低优先级）

**位置**：`server/internal/jsonconf` 或新建配置

**建议**：
- 将格子大小作为配置项，而不是硬编码
- 不同场景可能有不同的格子大小（虽然当前是统一的）

## 实施优先级

### 第一阶段（必须）
1. 定义坐标转换函数和常量
2. 移动系统坐标转换
3. 客户端坐标转换

### 第二阶段（重要）
4. 距离计算统一
5. 速度单位明确
6. 协议注释完善

### 第三阶段（优化）
7. 配置化格子大小
8. 性能优化（避免重复转换）

## 注意事项

1. **向后兼容**：如果现有代码已经使用格子坐标，需要确认并统一
2. **测试覆盖**：坐标转换需要充分测试，特别是边界情况
3. **性能考虑**：坐标转换应该高效，避免在热点路径上重复计算
4. **文档更新**：更新开发文档，明确坐标系统的定义和使用规范

