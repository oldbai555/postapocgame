# 游戏服务器规划文档

## 📋 项目概述

**项目名称**: postapocgame（后启示录游戏）  
**服务端**: Golang  
**客户端**: Godot（计划）  
**游戏类型**: 仿2D横版格斗DNF游戏  
**目标平台**: Windows、安卓、iOS  
**数据库**: SQLite + GORM  
**开发模式**: 个人开发

### 名词定义

- **Client（游戏客户端）**: 玩家使用的游戏客户端
- **Gateway（网关）**: 网关服务器，处理客户端连接和消息转发
- **GameServer（游戏服务器）**: 游戏服务器，处理非副本业务（任务、商店、背包、装备等）
- **DungeonServer（副本服务器）**: 副本服务器，处理副本业务（战斗、移动、技能释放等）

### 服务器架构

本项目采用微服务架构，包含三个核心服务：

```
┌─────────────┐
│   Client    │ (游戏客户端)
└──────┬──────┘
       │ TCP/WebSocket
       │
┌──────▼─────────────────────────────────────────┐
│            Gateway (网关服务)                    │
│  - 管理客户端连接 (TCP/WebSocket)                │
│  - 会话管理 (SessionManager)                    │
│  - 消息转发 (Client ↔ GameServer)              │
└──────┬─────────────────────────────────────────┘
       │ TCP (ForwardMessage)
       │
┌──────▼─────────────────────────────────────────┐
│          GameServer (游戏服务器)                 │
│  - 玩家业务逻辑处理                              │
│  - Actor模式处理玩家消息（每个玩家一个Actor）   │
│  - 统一数据存储（PlayerRoleBinaryData）         │
│  - 连接DungeonServer进行副本操作                │
└──────┬─────────────────────────────────────────┘
       │ TCP (RPC)
       │
┌──────▼─────────────────────────────────────────┐
│        DungeonServer (副本服务器)                │
│  - 副本/战斗逻辑处理                             │
│  - Actor模式处理副本消息（单Actor模型）          │
│  - 实体系统 (Entity, Buff, Fight等)            │
└────────────────────────────────────────────────┘
```

**架构特点**:
- **GameServer**: 使用一个玩家一个Actor模型，处理非副本业务（背包、装备、任务、商店等），所有操作在玩家自己的Actor中执行，无锁化
- **DungeonServer**: 使用单Actor模型，处理副本业务（战斗、移动、技能释放等），所有操作在单Actor中顺序执行，无锁化
- **数据存储**: 所有玩家系统数据统一存储在`PlayerRoleBinaryData`中，通过protobuf序列化存储在`Player.BinaryData`字段

---

## 📐 游戏配置定义

### 1. 职业配置

**配置说明**: 定义游戏中的职业和性别

**示例配置**:
```json
{
  "jobs": [
    {"jobId": 1, "jobName": "战士", "sex": 1},
    {"jobId": 2, "jobName": "法师", "sex": 2}
  ]
}
```

**字段说明**:
- `jobId`: 职业ID
- `jobName`: 职业名称
- `sex`: 性别（1=男，2=女）

### 2. 副本配置

**配置说明**: 定义副本及其关联的场景

**示例配置**:
```json
{
  "dungeons": [
    {
      "fbId": 0,
      "fbName": "常驻副本-主城",
      "fbType": "permanent",
      "sceneIds": [1, 2]
    },
    {
      "fbId": 1,
      "fbName": "限时副本-通天塔",
      "fbType": "timed",
      "timeLimit": 60,
      "sceneIds": [101]
    }
  ]
}
```

**字段说明**:
- `fbId`: 副本ID（0=默认副本-主城）
- `fbName`: 副本名称
- `fbType`: 副本类型（permanent=常驻副本，timed=限时副本）
- `timeLimit`: 限时副本的时间限制（秒）
- `sceneIds`: 关联的场景ID数组

### 3. 场景配置

**配置说明**: 定义场景及其出生点范围

**示例配置**:
```json
{
  "scenes": [
    {
      "sceneId": 1,
      "sceneName": "新手村",
      "bornArea": {"x1": 0, "y1": 0, "x2": 100, "y2": 100}
    },
    {
      "sceneId": 2,
      "sceneName": "野外森林",
      "bornArea": {"x1": 0, "y1": 0, "x2": 200, "y2": 200}
    }
  ]
}
```

**字段说明**:
- `sceneId`: 场景ID
- `sceneName`: 场景名称
- `bornArea`: 出生点范围（矩形区域，x1,y1为左上角，x2,y2为右下角）

### 4. 怪物场景配置

**配置说明**: 定义场景中的怪物配置（副本创建时初始化）

**示例配置**:
```json
{
  "monsterScenes": [
    {
      "monsterId": 101,
      "sceneId": 2,
      "monsterName": "野外小怪",
      "bornArea": {"x1": 10, "y1": 10, "x2": 50, "y2": 50},
      "count": 10
    }
  ]
}
```

**字段说明**:
- `monsterId`: 怪物ID
- `sceneId`: 场景ID
- `monsterName`: 怪物名称
- `bornArea`: 出生点范围（矩形区域）
- `count`: 数量（在出生点内随机出生count只）

### 5. NPC场景配置

**配置说明**: 定义场景中的NPC配置

**示例配置**:
```json
{
  "npcScenes": [
    {
      "npcId": 101,
      "sceneId": 1,
      "npcName": "导师"
    }
  ]
}
```

**字段说明**:
- `npcId`: NPC ID
- `sceneId`: 场景ID
- `npcName`: NPC名称

### 6. 技能配置

**配置说明**: 定义技能及其消耗

**示例配置**:
```json
{
  "skills": [
    {"skillId": 101, "skillLv": 1, "name": "战士普通攻击", "consume": 0},
    {"skillId": 102, "skillLv": 1, "name": "战士火焰斩", "consume": 1}
  ]
}
```

**字段说明**:
- `skillId`: 技能ID
- `skillLv`: 技能等级
- `name`: 技能名称
- `consume`: 消耗（技能点数量，0表示不消耗）

### 7. 任务配置

**配置说明**: 定义任务及其目标

**示例配置**:
```json
{
  "quests": [
    {
      "questId": 101,
      "questName": "新手对话任务",
      "targets": [
        {"type": 1, "ids": [101], "count": 1}
      ]
    },
    {
      "questId": 102,
      "questName": "学习技能任务",
      "targets": [
        {"type": 2, "ids": [], "count": 1}
      ]
    },
    {
      "questId": 103,
      "questName": "击杀怪物任务",
      "targets": [
        {"type": 3, "ids": [], "count": 1}
      ]
    }
  ]
}
```

**字段说明**:
- `questId`: 任务ID
- `questName`: 任务名称
- `targets`: 任务目标数组
  - `type`: 任务类型（1=和NPC对话，2=学习任意技能，3=击杀任意怪物）
  - `ids`: 条件数组（整形数组，type=1时配置npcId，其他类型不需要配置）
  - `count`: 达标数量

### 8. 传送点配置

**配置说明**: 定义场景中的传送点

**示例配置**:
```json
{
  "teleports": [
    {
      "teleportId": 1,
      "sceneId": 1,
      "x": 50,
      "y": 50,
      "targetSceneId": 2
    }
  ]
}
```

**字段说明**:
- `teleportId`: 传送点ID
- `sceneId`: 场景ID
- `x`, `y`: 传送点坐标
- `targetSceneId`: 目标场景ID（可选）

---

## 🎮 游戏流程

### 1. 账号注册/登录流程

**流程**:
1. Client → Gateway → GameServer: 发送账号注册/登录请求
2. GameServer: 验证账号信息，生成Token
3. GameServer → Gateway → Client: 返回登录结果

**协议**: `C2SRegister` / `C2SLogin` → `S2CRegisterResult` / `S2CLoginResult`

### 2. 创建角色/选择角色流程

**流程**:
1. Client → GameServer: 查询角色列表 / 创建角色
2. GameServer: 从数据库加载角色数据
3. Client → GameServer: 选择角色进入游戏
4. GameServer: 初始化角色数据（加载`PlayerRoleBinaryData`）
5. GameServer: 触发`OnLogin`事件，调用`attr_sys.CalculateAllAttrs()`汇总所有属性系统的属性，得到总的`attrData`
6. GameServer: 获取角色已学习的技能列表`SkillMap`
7. GameServer → DungeonServer: 通知角色进入副本，请求携带：
   - `SkillMap`（技能列表）
   - `SyncAttrData`（总属性数据，格式为`map[saAttrSysId][]*AttrSt`）
8. DungeonServer: 初始化角色实体，使用传入的`attrData`和`SkillMap`初始化技能和属性
9. DungeonServer: 角色出生在默认副本主城（fbId 0）的场景1（新手村）
10. DungeonServer: 角色默认学习本职业的普通攻击技能
11. DungeonServer: 初始化角色实体进入副本场景成功后，发送RPC请求通知GameServer该角色进入副本服务器成功（仅在首次初始化角色实体成功后调用）
12. DungeonServer → Client: 发送角色进入场景通知

**协议**: `C2SQueryRoles` / `C2SCreateRole` / `C2SEnterGame`

**属性系统设计**:
- GameServer的`attr_sys`汇总所有有属性的系统（如`equip_sys`、`level_sys`等）
- 定义属性系统枚举`SaAttrSys`到`attr_def.proto`中
- 每个属性系统需要实现`CalculateAttrs()`方法，返回该系统的属性数组（`[]*AttrSt`）
- `attr_sys`通过注册机制管理所有属性系统的计算方法
- `attr_sys`遍历所有属性系统枚举，调用各系统的`CalculateAttrs()`方法进行汇总
- 汇总后得到总的`attrData`（`map[saAttrSysId][]*AttrSt`格式）
- **重要**: 属性都是动态计算的，不能固定存储。如果固定存储而不是每次都动态计算，调整了属性数值无法及时更新最新的属性值
- 首次登录后动态计算所有属性系统的属性，后续有养成变动时（如`level_sys`升级时），需要触发重算对应系统的属性
- `attr_sys`记录了一个`saAttrSysId → attrData`的数据，首次初始化实体同步到DungeonServer会将所有的`saAttrSysId`的`attrData`汇总得到一个总的`SyncAttrData`结构为`map[saAttrSysId][]*AttrSt`
- 后续部分系统重算属性后只需要同步部分`map[saAttrSysId][]*AttrSt`到DungeonServer的角色实体进行更新属性
- 在`IPlayerRole.RunOne()`里调用`attr_sys.RunOne()`先去计算变动的系统的最新属性，然后汇总得到一个变动的map，同步到DungeonServer去进行角色实体的属性更新
- DungeonServer的角色实体属性更新是对比收到协议前后总的`attrData`的差异，得到一份加属性数组，一份减属性数组，然后进行增加和减少属性
- DungeonServer的角色实体还需要保存`saAttrSysId → attrData`的数据，方便后续替换属性

### 3. 移动流程

**流程**:
1. Client → DungeonServer: 发送移动请求（`C2SStartMove` / `C2SUpdateMove` / `C2SEndMove`）
2. DungeonServer: 校验移动（速度、坐标连贯性、可行走区域）
3. DungeonServer: 更新移动坐标
4. DungeonServer → GameServer: 通过RPC同步最新坐标到GameServer的角色数据（结束移动时更新坐标）
5. DungeonServer → Client: 广播移动同步（`S2CEntityMove` / `S2CEntityStopMove`）

**协议**: `C2SStartMove` / `C2SUpdateMove` / `C2SEndMove` → `S2CEntityMove` / `S2CEntityStopMove`

**注意**: DungeonServer校验通过后会同步最新坐标到GameServer的角色上，确保GameServer和DungeonServer的坐标数据一致

### 4. NPC对话和任务流程

**流程**:
1. Client → GameServer: 请求移动到NPC导师位置
2. Client → GameServer: 接取新手对话引导任务（`C2SAcceptQuest`）
3. GameServer: 校验角色在NPC导师附近2格范围内即可接取任务
4. Client → GameServer: 发送对话请求（`C2STalkToNPC`），仅用于通知GameServer触发一次和NPC对话任务事件进行计数
5. GameServer: 更新任务进度，通知Client最新的任务进度（`S2CQuestProgressUpdate`）
6. Client → GameServer: 完成任务（`C2SSubmitQuest`）
7. GameServer: 校验角色在NPC导师附近2格范围内即可完成任务
8. GameServer: 完成新手对话任务后赠送一套普通装备（通过`GrantRewards`发放）

**协议**: `C2SAcceptQuest` / `C2STalkToNPC` / `C2SSubmitQuest` → `S2CQuestProgressUpdate` / `S2CQuestCompleted`

### 5. 技能学习流程

**流程**:
1. Client → GameServer: 向NPC导师接取学习技能前置对话任务
2. Client → GameServer: 发送对话请求，触发对话任务事件计数
3. GameServer: 完成后给予技能点奖励（技能点归属货币类型）
4. Client → GameServer: 向NPC导师接取学习技能任务
5. Client → GameServer: 学习任意一个技能（`C2SLearnSkill`）
6. GameServer: 确认能学习后，发送角色的RPC请求到DungeonServer的角色实体上更新学习技能
7. DungeonServer: 更新角色技能列表
8. GameServer: 完成后给予技能点奖励

**协议**: `C2SLearnSkill` → `S2CLearnSkillResult`

### 6. 场景切换流程

**流程**:
1. Client → DungeonServer: 发送移动协议移动到新手村场景的传送点（后端不做传送点校验，传送点是一个纯客户端展示）
2. Client → DungeonServer: 发送切换场景协议（`C2SChangeScene`）到达野外森林出生点
3. DungeonServer: 校验同副本内可以进行场景切换，不同副本不能进行跨副本场景切换
4. DungeonServer: 将角色从场景1切换到场景2
5. DungeonServer → Client: 发送场景切换结果（`S2CChangeSceneResult`）

**协议**: `C2SChangeScene` → `S2CChangeSceneResult`

### 7. 战斗流程

**流程**:
1. Client → DungeonServer: 发送请求获取最近的怪物（`C2SGetNearestMonster`）
2. DungeonServer → Client: 返回最近的怪物信息
3. Client → DungeonServer: 发送移动协议移动到怪物附近
4. DungeonServer: 怪物进入角色视野，角色进入怪物视野
5. DungeonServer: 怪物的AI系统会检测到角色进入视野，进行攻击角色
6. Client → DungeonServer: 发送技能释放协议（`C2SUseSkill`）角色释放技能攻击怪物
7. DungeonServer: 处理战斗逻辑，计算伤害（使用万分比计算）
8. DungeonServer → Client: 广播战斗结果（`S2CSkillCastResult`）
9. 如果角色死亡：DungeonServer让角色满血安全复活到新手村
10. 如果怪物死亡：DungeonServer处理怪物掉落奖励到场景中，进入角色视野

**协议**: `C2SGetNearestMonster` / `C2SUseSkill` → `S2CSkillCastResult`

### 8. 掉落物拾取流程

**流程**:
1. Client → DungeonServer: 发送拾取掉落物协议（`C2SPickupItem`）
2. DungeonServer: 校验掉落物归属者是否为该角色
3. DungeonServer → GameServer: 发送异步RPC请求判断背包还有足够空间拾取
4. GameServer: 检查背包空间，返回结果
5. DungeonServer: 成功拾取掉落物后，掉落物消失在场景中也消失在玩家视野
6. DungeonServer → GameServer: 通知该角色击杀了怪物，触发一次击杀任意怪物任务事件进行计数
7. GameServer: 更新任务进度
8. GameServer → Client: 通知最新的任务进度（`S2CQuestProgressUpdate`）

**协议**: `C2SPickupItem` → `S2CPickupItemResult`

### 9. 限时副本进入流程（通天塔）

**流程**:
1. Client → GameServer: 请求移动到新手村NPC通天塔引导人
2. Client → GameServer: 发送进入副本协议（`C2SEnterDungeon`），fuben_sys处理进入副本协议进入副本通天塔，默认难度（后续再做动态难度）
3. GameServer: 进入通天塔需要消耗通天令，通天令可以在商店购买
4. GameServer: 消耗通过后，通知DungeonServer角色要切换副本到限时副本-通天塔-试炼之地
5. DungeonServer: 创建限时副本通天塔，创建对应场景以及怪物
6. DungeonServer: 将角色从默认副本主城副本切换到限时副本通天塔-试炼之地中
7. DungeonServer: 限时1分钟，角色死亡或者达到了上限时间踢出限时副本-通天塔回到默认副本主城-新手村中
8. 如果通关了通天塔-试炼之地：DungeonServer发送结算数据以及结算奖励，fuben_sys记录通关数据

**协议**: `C2SEnterDungeon` → `S2CEnterDungeonResult`

**副本特点**:
- 试炼之地的怪物更加强大，奖励更加丰厚
- 可以掉落更高级的装备以及合成材料
- 可以给装备升阶

### 10. 游戏循环流程

**后续游戏流程**:
- 击杀怪物拾取掉落物
- 掉落物回收给商店兑换货币、材料
- 玩家通过货币材料购买恢复HP的药水、恢复MP的药水、高级装备等
- 有产出有消耗，能闭环

---

## ✅ 已完成功能

### Phase 1: 基础数据（已完成）✅

#### 1. 数据库设计与ORM集成 ✅
- **数据库**: SQLite + GORM
- **数据表**:
  - `Account`: 账号表（ID、用户名、密码hash、创建时间）
  - `Player`: 角色表（ID、账号ID、角色名、职业、性别、等级、BinaryData二进制数据）
  - **重要**: `PlayerBag`、`PlayerEquip`、`PlayerMoney`、`PlayerDungeon`等表已移除，所有系统数据统一存储在`Player.BinaryData`字段中（protobuf序列化的`PlayerRoleBinaryData`）
- **位置**: `server/internal/database/`
- **初始化**: `server/service/gameserver/main.go` 中自动初始化数据库和表迁移

#### 2. 账号注册/登录系统 ✅
- **功能**:
  - 账号注册（用户名3-32字符，密码至少6字符）
  - 账号登录（bcrypt密码验证）
  - Token生成和Session管理
- **协议**: 
  - `C2SRegister` / `S2CRegisterResult`
  - `C2SLogin` / `S2CLoginResult`
- **位置**: `server/service/gameserver/internel/playeractor/entity/player_network.go`

#### 3. 角色增删改查持久化 ✅
- **功能**:
  - 角色创建（角色名查重、每个账号最多3个角色）
  - 角色列表查询（从数据库读取）
  - 进入游戏（从数据库加载角色数据）
- **协议**: 
  - `C2SQueryRoles` / `S2CRoleList`
  - `C2SCreateRole` / `S2CCreateRoleResult`
  - `C2SEnterGame` / `S2CLoginSuccess`

#### 4. 配置表加载系统 ✅
- **功能**: JSON配置热加载
- **支持配置**: 物品、等级、VIP、货币、任务、邮件、怪物、技能、Buff、消耗、奖励、职业、场景、NPC、传送点、每日任务、成就、装备精炼/附魔/套装等（共26个配置文件）
- **位置**: `server/internal/jsonconf/config_manager.go`
- **配置路径**: `server/output/config/`

---

### Phase 2: 核心玩法（已完成）✅

#### 1. 玩家系统（GameServer）✅

##### 1.1 背包系统 ✅
- 物品添加/删除（支持堆叠）
- 背包容量管理（默认100格）
- 数据存储在`PlayerRoleBinaryData.bag_data`中
- 物品绑定状态管理
- 事务支持（消耗/奖励）

##### 1.2 装备系统 ✅
- 装备穿脱（自动处理背包交互）
- 装备强化（按等级配置消耗，使用万分比计算）
- 装备精炼（消耗材料提升精炼等级，每级+5%属性）
- 装备附魔（添加特殊属性）
- 装备套装效果（多件装备组合触发效果）
- 装备属性计算（根据强化等级、精炼等级、品质、星级、阶级，使用万分比）

##### 1.3 货币系统 ✅
- 支持多种货币（金币、钻石等）
- 经验值作为货币类型之一，统一由货币系统管理
- 货币增减操作
- 数据存储在`PlayerRoleBinaryData.money_data`中
- 事务支持（消耗/奖励）

##### 1.4 等级系统 ✅
- 经验值添加（`AddExp()`方法）
- 自动升级检查（`CheckLevelUp()`方法，支持连续升级）
- 升级奖励发放
- 升级事件发布
- 属性计算（`CalculateAttrs()`方法）

##### 1.5 商城系统 ✅
- 个人商城购买
- 支持配置化的消耗/奖励
- 自动处理货币和物品

##### 1.6 任务系统 ✅
- 任务接受（检查等级要求、前置任务）
- 任务进度追踪（按目标索引更新、按类型自动更新）
- 任务提交（检查完成条件并发放奖励）
- 任务链支持（自动接取后续任务）
- 日常/周常任务类型支持

##### 1.7 每日任务系统 ✅
- 每日任务刷新机制（跨天自动刷新）
- 每日任务奖励发放
- 任务进度追踪
- 每日任务提交（可重复完成）

##### 1.8 邮件系统 ✅
- 邮件发送（模板邮件、自定义邮件）
- 邮件读取（标记已读）
- 邮件附件领取
- 邮件删除
- 邮件批量操作（批量删除、批量领取）
- 邮件分类（系统邮件、玩家邮件）
- 邮件搜索（按标题和内容搜索）
- 过期邮件自动清理

##### 1.9 VIP系统 ✅
- VIP经验获取（`AddVipExp`）
- VIP等级提升（`CheckVipLevelUp`，支持连续升级）
- VIP特权功能（`GetPrivilegeValue`、`HasPrivilege`）

##### 1.10 技能系统 ✅
- 技能学习（检查等级要求、消耗）
- 技能升级（检查等级上限、消耗，同步到DungeonServer）
- 技能数据管理
- 根据职业配置初始化初始技能

##### 1.11 物品使用系统 ✅
- 物品使用协议处理
- 物品使用效果处理（恢复HP/MP、增加经验等）
- 冷却时间管理（持久化）
- 使用后物品数量减少
- GameServer到DungeonServer的RPC更新角色HP/MP

##### 1.12 物品回收系统 ✅
- 物品回收协议处理
- 回收奖励发放
- 批量回收功能
- 物品可回收性检查

##### 1.13 副本系统 ✅
- 副本难度区分（普通、精英、地狱）
- 副本结算系统（奖励计算、经验发放）
- 副本CD限制（冷却时间管理）
- 副本记录持久化
- 限时副本支持（进入消耗检查、时间限制、过期检查）

##### 1.14 离线收益系统 ✅
- 离线时间计算
- 离线收益计算（经验、金币等）
- 离线收益上限（默认24小时）
- 离线收益领取协议处理

##### 1.15 成就系统 ✅
- 成就配置表加载
- 成就进度追踪（支持按类型自动更新）
- 成就奖励发放
- 成就完成通知

##### 1.16 新手保护系统 ✅
- 新手保护标记（等级、时间限制，默认7天保护期）
- 新手保护状态检查（自动检查是否过期）
- 新手引导进度保存
- 新手保护状态校验

##### 1.17 防作弊系统（基础框架）✅
- 操作频率限制（每10秒最多100次操作）
- 异常行为检测（可疑行为计数）
- 封禁机制（临时封禁和永久封禁）
- 每日重置机制
- 封禁状态检查

##### 1.18 GM系统 ✅
- 系统通知发送（给指定玩家、给所有在线玩家）
- 系统邮件发送（给指定玩家、给所有在线玩家、使用模板）
- 奖励补发（通过邮件发放奖励）

##### 1.19 GM命令系统 ✅
- GM命令管理器（支持注册和执行GM命令）
- GM等级校验
- 默认GM命令集（addexp、addmoney、additem、setlevel、sendmail、sendnotice等）

##### 1.20 属性系统汇总架构 ✅
- 属性系统注册机制
- 属性汇总（首次登录时汇总所有属性）
- 属性增量更新（标记需要重算的系统，计算变动的系统属性并同步到DungeonServer）
- 各系统属性计算（`LevelSys.CalculateAttrs()`、`EquipSys.CalculateAttrs()`）

##### 1.21 角色进入游戏流程完善 ✅
- 在`enterGame`函数中，先调用`OnLogin`初始化系统
- 调用`attr_sys.CalculateAllAttrs()`汇总所有属性
- 扩展`G2DEnterDungeonReq`协议，添加`SyncAttrData`和`SkillMap`字段
- 在`PlayerRole`中添加`RunOne()`方法，调用`attr_sys.RunOne()`处理属性增量更新

#### 2. 副本系统（DungeonServer）✅

##### 2.1 战斗计算系统 ✅
- 完整伤害公式（攻击力、防御减免、技能倍率、属性相克，使用万分比）
- 暴击系统（暴击率、暴击伤害加成，使用万分比）
- 闪避系统（闪避率、命中率、速度影响，使用万分比）
- 属性相克（火、冰、雷属性抗性）
- 伤害加成/减免计算（使用万分比）
- 治疗量计算

##### 2.2 战斗状态机 ✅
- 状态类型：待命、施法、硬直、倒地、死亡、无敌
- 状态自动过期（根据持续时间）
- 状态切换限制（硬直/倒地不能立即切换到待命）
- 状态影响实体行为（攻击、移动限制）

##### 2.3 移动同步系统 ✅
- 处理 `C2SStartMove`、`C2SUpdateMove`、`C2SEndMove` 请求
- 服务端强校验（速度、坐标连贯性、可行走区域）
- 统一广播 `S2CEntityMove` / `S2CEntityStopMove`，并在异常时自动回滚坐标
- 移动结束时同步坐标到GameServer（`D2GSyncPosition` RPC）

##### 2.4 主动战斗系统 ✅
- 完整处理 `C2SUseSkill`，普通攻击作为技能ID 0 并映射到默认技能（1001）
- 协议层在释放前执行 CD / MP 校验，失败时即时反馈
- 释放结果转换为 `S2CSkillCastResult` 并广播，包含每个目标的命中/暴击/伤害

##### 2.5 副本怪物AI状态机 ✅
- 实现巡逻→侦测→追击→攻击→脱战返回的完整AI流程
- 基于配置的AI参数（巡逻半径、感知范围、思考频率等）
- AI自动移动和技能释放
- AI逻辑完全由 `entity.RunOne()` 驱动，严禁再单独开启协程

##### 2.6 Buff系统 ✅
- Buff配置化（从`buff_config.json`读取）
- Debuff施加（中毒、流血、减速、冰冻等）
- DOT扣血机制

##### 2.7 副本实体主循环调度 ✅
- `DungeonActor` 的 `Loop()` 统一通过 `entitymgr.RunOne()` 顺序驱动每个 `entity.RunOne()`
- `BaseEntity.RunOne()` 负责触发 `BuffSys`、`StateMachine` 等系统
- `MonsterEntity.RunOne()` 额外调度 `AISys.RunOne()`
- 所有AI/Buff/状态推进必须放在 `entity.RunOne()` 内执行，禁止再启额外协程

##### 2.8 实体状态位图 ✅
- `BaseEntity` 改用 `uint64 stateFlags` 表示死亡、无敌、禁攻、禁移等状态位
- 所有状态操作通过位运算完成

##### 2.9 实体移动系统 & 视野广播 ✅
- 新增 `MoveSys`，统一托管玩家与AI的移动状态，所有移动都通过 `RunOne()` 在主线程推进
- 自动处理 AOI 进入/离开，及时下发 `S2CEntityAppear/S2CEntityDisappear`

##### 2.10 副本结算系统 ✅
- 副本奖励计算
- DungeonServer到GameServer的RPC协议（`D2GSettleDungeon`）
- 通过RPC调用GameServer更新副本记录和发放奖励

##### 2.11 常驻副本循环 ✅
- `FuBenMgr.RunOne()` 及 `FuBenSt.RunOne()` 驱动常驻/限时副本的世界状态
- `DungeonActor` 主循环追加调用 `fbmgr.RunOne()`，即便无人在线副本世界也会推进

##### 2.12 场景切换系统 ✅
- 场景切换协议
- 同副本内场景切换校验
- 场景切换时从场景配置的出生点范围随机选择位置

##### 2.13 掉落物系统 ✅
- 怪物死亡掉落奖励到场景中
- 掉落物实体（存在时间管理、超时自动移除）
- 拾取掉落物协议
- 掉落物归属者校验
- 异步RPC实现（不阻塞Actor模型）

##### 2.14 角色死亡复活系统 ✅
- 角色死亡后自动复活到新手村（延迟3秒）
- 客户端主动复活协议
- 复活逻辑：满血满蓝、传送到新手村、清除死亡状态

##### 2.15 获取最近怪物系统 ✅
- 获取最近怪物协议
- 距离计算（使用欧几里得距离公式）
- 怪物筛选（只返回活着的怪物）

##### 2.16 DungeonServer属性接收和初始化逻辑 ✅
- 修改`NewRoleEntity`函数，接收`SyncAttrData`和`SkillMap`参数
- 实现属性初始化逻辑（`applyAllAttrs()`方法）
- 实现属性更新逻辑（`UpdateAttrs()`方法）
- 实现技能列表初始化

#### 3. 配置系统扩展 ✅

##### 3.1 职业配置 ✅
- 职业ID、名称、描述、基础属性、初始技能列表、武器类型

##### 3.2 场景配置 ✅
- 场景ID、名称、尺寸、出生点范围（`BornArea`）

##### 3.3 怪物场景配置 ✅
- 怪物ID、场景ID、出生点范围、生成数量

##### 3.4 NPC场景配置 ✅
- NPC ID、场景ID、位置、功能类型、对话/商店/传送点ID

##### 3.5 传送点配置 ✅
- 传送点ID、源场景/位置、目标场景/位置、等级要求、消耗配置

##### 3.6 ItemConfig重构与配置分离 ✅
- 移除了`ItemConfig`中的业务相关字段
- 装备槽位改为使用`SubType`字段
- 创建了独立的装备强化/精炼/附魔/套装配置表
- ItemUseEffect独立为配置表
- 物品回收配置独立
- 商城购买配置独立

##### 3.7 全局等级属性表系统 ✅
- 定义了通用的属性结构`Attr`和`AttrVec`
- 实现了全局等级属性表，每级提供属性，高等级覆盖低等级属性
- 怪物、玩家共用一份等级属性表，统一从配置表获取属性
- 移除了硬编码的属性计算逻辑，改为从配置表读取

#### 4. 系统架构优化 ✅

##### 4.1 系统数据统一存储架构 ✅
- 各个系统的数据统一存储在`PlayerRoleBinaryData`中
- 系统通过`GetBinaryData()`获取数据，如果不存在则自动初始化
- 移除了所有系统的锁（sync.RWMutex），遵循单Actor模型
- 移除了额外的索引结构，直接使用原始数据，避免数据不一致

##### 4.2 数据库存储架构优化 ✅
- 数据库存储玩家信息时，只需要存储二进制的`PlayerRoleBinaryData`即可
- 移除了`PlayerBag`、`PlayerEquip`、`PlayerMoney`、`PlayerDungeon`等多余的表结构
- 所有系统数据统一存储在`Player.BinaryData`字段中，通过protobuf序列化/反序列化

##### 4.3 消耗和奖励事务支持 ✅
- `ApplyConsume` 支持事务，要么全消耗成功，要么全消耗失败
- `GrantRewards` 支持事务，要么全添加成功，要么全添加失败
- 数据操作支持事务，失败时自动回滚内存状态

##### 4.4 副本Actor单协程循环保障 ✅
- `actor_context.loop()` 同步执行 `handler.Loop()` 与 `HandleMessage()`
- `DungeonActor` 通过 `entitymgr.RunOne()` 顺序驱动 `entity.RunOne()`
- `BaseActorHandler` 同步分发协议处理函数，保持副本业务遵循单Actor模型

##### 4.5 异步RPC架构 ✅
- 所有DungeonServer ↔ GameServer之间的RPC调用必须使用异步方式，严禁使用同步RPC
- DungeonServer → GameServer: 使用`CallGameServer()`异步发送RPC请求
- GameServer处理: RPC请求在PlayerRole的Actor中异步处理
- DungeonServer响应处理: 收到响应后，通过SessionId路由到Actor系统

##### 4.6 枚举迁移到Proto协议 ✅
- 将战斗状态类型（BattleState）、AIState、BuffEffectType等公共枚举迁移到proto协议中生成
- 客户端和服务端共享同一份枚举定义，通过工具一键生成

##### 4.7 Proto生成脚本优化 ✅
- `proto/genproto.sh` 改为使用 `--go_out=paths=source_relative:..` 与 `--go_opt=module=postapocgame/server`
- 生成文件直接覆盖 `server/internal/protocol`，不再产生 `server/server/internal/protocol` 目录
- 生成结束后自动 `gofmt` 项目中的 Go 源码

---

## 🚧 待实现功能

### Phase 2: 核心玩法补充

#### 1. 动画同步协议 ⚠️
**当前状态**: 未实现

**需要实现**:
- 技能释放动画同步
- 受击动画同步
- 移动动画同步
- 状态切换动画同步

#### 2. 战斗录像功能 ⚠️
**当前状态**: 未实现

**需要实现**:
- 战斗过程录制
- 录像回放
- 录像存储

#### 3. 副本匹配/排队系统 ⚠️
**当前状态**: 未实现

**需要实现**:
- 多人副本匹配
- 排队系统
- 匹配算法

#### 4. Boss战特殊机制 ⚠️
**当前状态**: 未实现

**需要实现**:
- Boss阶段切换
- Boss特殊技能
- Boss掉落机制

#### 5. 防作弊机制完善 ⚠️
**当前状态**: 基础框架已完成，部分功能待完善

**待完善功能**:
- 在协议处理中集成操作频率检测
- 加强移动速度校验
- 实现伤害数值校验
- 加强技能CD校验
- 实现数据一致性校验

#### 6. 数据统计与分析 ⚠️
**当前状态**: 未实现

**需要实现**:
- 关键事件记录（登录、战斗、任务完成等）
- 数据统计接口
- 玩家行为分析
- 性能监控
- 数据上报

### Phase 3: 社交经济（待实现）

#### 1. 聊天系统 ⚠️
**当前状态**: 未实现

**需要实现**:
- 全服/世界/私聊
- 位置: 建议在GameServer中实现（玩家Actor模型）

#### 2. 好友/公会框架 ⚠️
**当前状态**: 未实现

**需要实现**:
- 好友系统（添加、删除、列表）
- 公会基础功能（创建、加入、退出）
- 位置: 建议在GameServer中实现

#### 3. 拍卖行 ⚠️
**当前状态**: 个人商城已实现，但缺少拍卖行

**需要实现**:
- 拍卖行（上架、购买、下架）
- 位置: 建议在GameServer中实现

#### 4. 排行榜系统 ⚠️
**当前状态**: 未实现

**需要实现**:
- 等级榜、战力榜等
- 位置: 建议在GameServer中实现

### Phase 4: PvP内容（待实现）

#### 1. 竞技场系统 ⚠️
**当前状态**: 未实现

**需要实现**:
- 匹配、战斗、评分
- 位置: 建议在DungeonServer中实现（战斗逻辑）

#### 2. 实时配对系统 ⚠️
**当前状态**: 未实现

**需要实现**:
- PvP匹配算法（ELO、MMR等）
- 位置: 建议在GameServer中实现（匹配逻辑）

#### 3. 评分系统 ⚠️
**当前状态**: 未实现

**需要实现**:
- 积分计算、排名更新
- 位置: 建议在GameServer中实现

---

## 📁 关键代码位置

### 数据库层
- `server/internal/database/` - 所有数据库操作
  - `database.go` - 数据库初始化
  - `migrate.go` - 表迁移
  - `account.go` - 账号相关
  - `player.go` - 角色相关（包含`BinaryData`字段存储`PlayerRoleBinaryData`）
  - **注意**: 所有系统数据统一存储在`Player.BinaryData`字段中（protobuf序列化的`PlayerRoleBinaryData`），不再使用独立的数据库表

### 游戏服务器系统
- `server/service/gameserver/internel/playeractor/entitysystem/` - 玩家系统
  - `bag_sys.go` - 背包系统 ✅（使用`PlayerRoleBinaryData.bag_data`，无锁）
  - `equip_sys.go` - 装备系统 ✅（使用`PlayerRoleBinaryData.equip_data`，无锁，实现`CalculateAttrs()`方法）
  - `money_sys.go` - 货币系统 ✅（使用`PlayerRoleBinaryData.money_data`，无锁）
  - `fuben_sys.go` - 副本系统 ✅（使用`PlayerRoleBinaryData.dungeon_data`，无锁）
  - `shop_sys.go` - 商城系统 ✅（无锁）
  - `level_sys.go` - 等级系统 ✅
  - `sys_mgr.go` - 系统管理器
  - `quest_sys.go` - 任务系统 ✅
  - `mail_sys.go` - 邮件系统 ✅
  - `vip_sys.go` - VIP系统 ✅
  - `gm_sys.go` - GM系统 ✅
  - `gm_manager.go` - GM命令管理器 ✅
  - `attr_sys.go` - 属性系统汇总 ✅
  - `item_use_sys.go` - 物品使用系统 ✅
  - `recycle_sys.go` - 物品回收系统 ✅
  - `skill_sys.go` - 技能系统 ✅
  - `offline_reward_sys.go` - 离线收益系统 ✅
  - `anti_cheat_sys.go` - 防作弊系统 ✅（基础框架已完成）
  - `daily_quest_sys.go` - 每日任务系统 ✅
  - `achievement_sys.go` - 成就系统 ✅
  - `newbie_sys.go` - 新手保护系统 ✅

### 协议定义
- `proto/csproto/` - Protocol Buffer定义
  - `cs.proto` - 客户端到服务器协议
  - `sc.proto` - 服务器到客户端协议
  - `system.proto` - 系统数据定义
  - `player.proto` - 玩家数据定义（包含`PlayerRoleBinaryData`）
- 生成代码位置: `server/internal/protocol/`
- 生成脚本: `proto/genproto.sh`

### 配置系统
- `server/internal/jsonconf/` - 配置管理
  - `config_manager.go` - 配置管理器
  - 所有配置结构都有对应的JSON文件（共26个配置文件）
- 配置文件位置: `server/output/config/`

### 副本服务器
- `server/service/dungeonserver/` - 副本服务器
  - `internel/entitysystem/` - 实体系统
    - `state_machine.go` - 战斗状态机 ✅
    - `fight_sys.go` - 战斗系统 ✅
    - `attr_sys.go` - 属性系统 ✅
    - `buff_sys.go` - Buff系统 ✅
    - `ai_sys.go` - AI系统 ✅
    - `move_sys.go` - 移动系统 ✅
  - `internel/skill/` - 技能系统
    - `skill.go` - 技能释放逻辑 ✅
    - `skill_damage_calculator.go` - 伤害计算器 ✅（使用万分比）
  - `internel/fuben/` - 副本实现
    - `fubenst.go` - 副本结构 ✅
    - `settlement.go` - 副本结算系统 ✅

---

## 🔧 开发注意事项

### 架构原则

1. **GameServer**: 使用一个玩家一个Actor模型，处理非副本业务
   - 背包、装备、任务、商店等
   - 所有操作在玩家自己的Actor中执行，无锁化
   - 系统数据统一存储在`PlayerRoleBinaryData`中

2. **DungeonServer**: 使用单Actor模型，处理副本业务
   - 战斗、移动、技能释放等
   - 所有操作在单Actor中顺序执行，无锁化
   - 所有AI/Buff/状态推进必须放在 `entity.RunOne()` 内执行，禁止再启额外协程

3. **数据持久化**: 
   - 所有玩家系统数据统一存储在`Player.BinaryData`字段中（protobuf序列化的`PlayerRoleBinaryData`）
   - 系统初始化时从`Player.BinaryData`加载数据，登出时统一保存
   - 可通过`SaveToDB()`方法立即保存数据

4. **配置驱动**: 游戏数据通过JSON配置表管理
   - 物品、技能、怪物等配置
   - 支持热加载（ConfigManager.Reload()）

5. **数据一致性**: 
   - 系统必须直接使用`PlayerRoleBinaryData`中的数据，不要维护额外的索引结构（如map）
   - 如需快速查找，使用辅助函数从原始数据中查找
   - 避免索引与数据不一致导致业务错误

6. **异步RPC架构**:
   - 所有DungeonServer ↔ GameServer之间的RPC调用必须使用异步方式，严禁使用同步RPC
   - 避免阻塞Actor模型

7. **百分比计算**: 
   - 所有百分比计算统一使用万分比（除以10000），先扩大再缩小
   - 项目中尽可能不使用float

8. **RunOne()使用**: 
   - 能放在RunOne()里执行的都放里面
   - 涉及到百分比计算的，统一使用万分比

9. **加锁原则**: 
   - 开发前掌握服务器架构，避免开发时使用错误的技术
   - 尤其要注意是否要加锁！！！
   - GameServer和DungeonServer都遵循单Actor模型，不需要加锁

### 开发规范

1. **错误处理**: 使用 `customerr` 包处理错误
2. **日志记录**: 使用 `log` 包记录日志
3. **事件发布**: 通过 `PlayerRole.Publish()` 发布玩家事件
4. **协议定义**: 修改proto文件后需要运行脚本重新生成代码
5. **枚举定义**: 所有客户端和服务端共享的枚举都应该定义在proto协议中
6. **事务处理**: 涉及多个数据操作的业务（如消耗、奖励）必须使用事务，确保数据一致性
7. **系统无锁化**: 所有GameServer系统都不需要加锁，因为每个系统只被当前角色的Actor使用
8. **系统串行执行**: 系统回调（如`OnRoleLogin`）必须在Actor中串行执行，不要创建新协程

---

## 🎯 建议的开发优先级

### 优先级1: Phase 2 核心功能补充（紧急）

1. **防作弊机制完善** ⚠️ **高优先级**
   - 在协议处理中集成操作频率检测
   - 加强移动速度校验
   - 实现伤害数值校验
   - 加强技能CD校验
   - 实现数据一致性校验

2. **数据统计与分析** ⚠️ **中优先级**
   - 关键事件记录
   - 数据统计接口
   - 玩家行为分析
   - 性能监控
   - 数据上报

### 优先级2: Phase 2 高级功能

1. **动画同步协议** ⚠️
   - 技能释放、受击、移动、状态切换动画同步

2. **战斗录像功能** ⚠️
   - 战斗过程录制、录像回放、录像存储

3. **副本匹配/排队系统** ⚠️
   - 多人副本匹配、排队系统、匹配算法

4. **Boss战特殊机制** ⚠️
   - Boss阶段切换、Boss特殊技能、Boss掉落机制

### 优先级3: Phase 3 社交经济

1. **聊天系统**（相对简单，可以先实现）
   - 全服/世界/私聊
   - 位置: GameServer

2. **好友系统**
   - 添加、删除、列表
   - 位置: GameServer

3. **拍卖行**
   - 上架、购买、下架
   - 位置: GameServer

4. **排行榜系统**
   - 等级榜、战力榜等
   - 位置: GameServer

### 优先级4: Phase 4 PvP内容

1. **竞技场系统**
   - 匹配、战斗、评分
   - 位置: DungeonServer（战斗）+ GameServer（匹配）

2. **实时配对系统**
   - PvP匹配算法（ELO、MMR等）
   - 位置: GameServer

3. **评分系统**
   - 积分计算、排名更新
   - 位置: GameServer

---

## 🔗 相关文档

- `docs/服务端开发进度文档.md` - 详细的开发进度文档（推荐查看）
- `server/README.md` - 服务器架构说明

---

## 💡 提示

这份文档提供了：
- 项目当前状态概览
- 已完成功能列表
- 待实现功能列表
- 开发优先级建议
- 关键代码位置
- 开发注意事项

**建议**: 查看 `docs/服务端开发进度文档.md` 获取更详细的开发进度和实现细节。
