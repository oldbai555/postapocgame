## 0. 开发必读
- 权威设计文档：`docs/go-zero实现方案.md`。按文档分层（API → Handler → Logic → Repository → Model），禁止保留旧兼容层。
- 完成功能记入「已完成功能」，分阶段需求放「待实现 / 待完善功能」，技术约束写入「技术决策记录」。
- 统一响应/错误码、JWT 双令牌、bcrypt 密码、logx 日志、go-zero sqlx + cache 数据访问、go-zero 限流。
- **开发流程规范（强制遵守）**：
  1. **确定要开发的功能**：明确功能需求，确定模块名称和功能描述
  2. **生成初始化 SQL**：使用 `scripts/generate-sql.sh -group <group> -name <name>` 生成初始化表 SQL 语句，以及对应的权限菜单接口等 SQL 语句、前端页面 xxx.vue、xxx.api 文件
  3. **补齐初始化表 SQL**：检查生成的 SQL，补齐初始化表 SQL 语句所需要的字段（如 created_at、updated_at、deleted_at 等）
  4. **补齐 CRUD 接口参数**：检查生成的 .api 文件，补齐 CRUD 接口的参数定义
  5. **生成 Model 代码**：使用 `scripts/generate-model.sh <sql_file>` 生成对应的 Model 代码
  6. **生成 API 代码**：使用 `scripts/generate-api.sh <api_file>` 生成对应的 Handler/Logic 代码骨架
  7. **开发功能**：实现 Repository、Logic、Handler 的业务逻辑，完成后执行对应的 SQL 语句，创表和写入对应的权限菜单等
  8. **启动后端服务**：确保后端服务能正常启动，接口可独立测试通过
  9. **完成前端页面**：将生成的前端 xxx.vue 进行页面完善，然后能正常启动前端项目，进行前后端联调
  10. **测试通过后再开发下一个功能**：每个功能必须完整实现并测试通过后，才能开始下一个功能的开发
- **权限 SQL 生成规范（必须遵守）**：
  - 每新增一个功能模块，必须同时生成对应的权限列表 SQL 文件
  - SQL 文件命名：`admin-server/db/permissions_{module_name}.sql`
  - 权限编码规范：`{module}:{action}`（如 `user:list`、`user:create`、`user:update`、`user:delete`）
  - 权限 SQL 必须包含：列表、新增、编辑、删除四个基础权限
  - 执行权限 SQL 后，需要在菜单管理中添加对应的菜单项，并关联权限编码
  - 参考示例：`admin-server/db/permissions_menu_user.sql`
- **数据字典使用规范（必须遵守）**：
  - **字典的使用场景**：
    - **状态枚举**：用户状态、订单状态、审核状态等需要在多个地方使用的状态值
    - **类型分类**：文件类型、存储类型、支付方式、物流方式等业务类型
    - **选项列表**：性别、是否、地区、行业等需要在表单中下拉选择的选项
    - **业务常量**：需要在多个模块中复用的常量值，如用户等级、会员类型等
    - **配置选项**：需要动态调整且可能频繁变更的配置项，如通知类型、消息模板类型等
  - **优先考虑使用字典的情况**：
    - 前端需要在下拉选择框、单选框、多选框等组件中展示的选项
    - 需要在多个页面或模块中复用的枚举值
    - 需要由业务人员或管理员动态维护的选项（不需要改代码）
    - 需要支持多语言或国际化显示的选项
    - 需要按业务规则动态调整的选项（如根据权限、地区等过滤）
    - 需要在报表、统计、导出等功能中使用的分类字段
  - **不建议使用字典的情况**：
    - 系统级别的固定枚举（如 HTTP 方法、数据库类型等），应使用代码常量
    - 只在单一模块内部使用的简单枚举，可直接在代码中定义
    - 需要复杂业务逻辑判断的选项，应使用专门的业务表
  - **字典使用流程**：
    1. 在开发新功能时，先评估字段是否需要使用字典
    2. 如果需要，**编写增量字典插入 SQL 语句**（见下方「字典 SQL 插入规范」）
    3. 将字典 SQL 语句添加到 `admin-server/db/data.sql` 文件中，或创建独立的字典初始化 SQL 文件
    4. 执行 SQL 语句，创建字典类型和字典项
    5. 前端通过 `/api/v1/dict?code={dict_code}` 接口获取字典项列表
    6. 后端在 Logic 层可以通过 Repository 查询字典项进行验证或转换
  - **字典 SQL 插入规范（必须遵守）**：
    - **字典数据通过 SQL 语句新增**：所有字典类型和字典项的数据都通过 SQL 语句插入，不在管理界面中手动创建
    - **增量 SQL 格式**：在 `admin-server/db/data.sql` 文件中，字典相关的 SQL 应放在统一位置，使用注释标识
    - **字典类型 SQL 模板**：
      ```sql
      -- {功能模块}相关字典类型
      INSERT INTO `admin_dict_type` (`id`, `name`, `code`, `description`, `status`, `created_at`, `updated_at`, `deleted_at`)
      VALUES 
        ({id}, '{字典类型名称}', '{字典类型编码}', '{字典类型描述}', 1, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), 0)
      ON DUPLICATE KEY UPDATE 
        `name`=VALUES(`name`), 
        `description`=VALUES(`description`), 
        `updated_at`=UNIX_TIMESTAMP(), 
        `deleted_at`=0;
      ```
    - **字典项 SQL 模板**：
      ```sql
      -- {字典类型名称}字典项
      INSERT INTO `admin_dict_item` (`id`, `type_id`, `label`, `value`, `sort`, `status`, `remark`, `created_at`, `updated_at`, `deleted_at`)
      VALUES 
        ({id1}, {type_id}, '{字典项标签1}', '{字典项值1}', 1, 1, '{备注1}', UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), 0),
        ({id2}, {type_id}, '{字典项标签2}', '{字典项值2}', 2, 1, '{备注2}', UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), 0)
      ON DUPLICATE KEY UPDATE 
        `label`=VALUES(`label`), 
        `value`=VALUES(`value`), 
        `sort`=VALUES(`sort`), 
        `status`=VALUES(`status`), 
        `remark`=VALUES(`remark`), 
        `updated_at`=UNIX_TIMESTAMP(), 
        `deleted_at`=0;
      ```
    - **ID 分配规范**：
      - 字典类型 ID：从 1 开始连续递增，参考 `admin-server/db/data.sql` 中已有的最大 ID
      - 字典项 ID：从 1 开始连续递增，参考 `admin-server/db/data.sql` 中已有的最大 ID
      - 确保 ID 不冲突，建议在现有最大 ID 基础上递增
    - **SQL 执行时机**：
      - 在开发新功能时，确定需要使用的字典后，立即编写并执行字典 SQL 语句
      - 字典 SQL 应在创建业务表之前或同时执行，确保字典数据可用
      - 执行后验证字典数据是否正确插入，可通过字典管理界面或直接查询数据库验证

---

## 1. 已完成功能
- 初始化 admin-server 工程骨架：go-zero Rest 服务、/api/v1/ping 健康接口、分层结构（Handler → Logic → Repository → Model）搭建。
- 配置与数据源：扩展配置（Rest + DB + Redis + JWT + bcrypt），ServiceContext 接入 go-zero sqlx + cache 与 go-redis 初始化并统一注入 Repository，迁移目录预留。
- 统一响应与错误码：新增 `pkg/errs`（业务错误码与 Error 封装）与 `pkg/response`（统一响应 Envelope 与日志记录），并在 Ping Handler 中落地使用。
- 认证模块骨架：定义 `auth.api`（/api/v1/auth/login），使用 goctl 生成 Handler/Logic/Types，实现 Handler → Logic → UserRepository → UserModel 分层。
- 登录流程实现：`LoginLogic.Login` 基于 `admin_user` 表实现登录（用户名/密码必填校验、状态检查、bcrypt 密码比对），使用 `pkg/jwt` 生成 Access/Refresh JWT，并通过统一响应返回 `TokenPair`。
- 刷新与登出：新增 `/auth/refresh` 与 `/auth/logout` 接口，`RefreshLogic.Refresh` 基于 Refresh Token 生成新双令牌，`LogoutLogic.Logout` 使用 Redis 黑名单（`jwt:blacklist:*`）封禁 Access/Refresh Token。
- 鉴权中间件：实现 JWT 鉴权中间件 `internal/middleware/auth_middleware.go`，校验 Access Token + Redis 黑名单，并将用户信息写入 Context；新增受保护接口 `/auth/profile` 以验证中间件链路。
- RBAC 骨架：新增 RBAC 表迁移 `002_init_rbac.sql`（role/permission/department/user_role/role_permission），对应 Model（`internal/model/*`）与 Repository（`internal/repository/*`），实现基础 `RBACService.ListPermissionCodesByUser`。
- 管理员初始化脚本：新增 `cmd/adminseed`，基于配置连接数据库并创建默认管理员账号（用户名/密码可通过参数覆盖，密码使用 bcrypt 按配置 cost 加密）。
- 阶段三 RBAC 完整实现：
  - 角色管理：CRUD API（列表分页、新增、编辑、删除），前端页面（RoleList.vue）支持分配权限功能。
  - 权限管理：CRUD API（列表分页、新增、编辑、删除），前端页面（PermissionList.vue）支持分配菜单和分配接口功能。
  - 部门管理：树形结构 API（树形查询、新增、编辑、删除），前端页面（DepartmentList.vue）树形展示。
  - 菜单管理：树形结构 API（完整菜单树、用户菜单树、新增、编辑、删除），前端页面（MenuList.vue）树形展示，支持按钮级权限（type=3）。
  - 用户管理：CRUD API（列表分页、新增、编辑、删除），前端页面（UserList.vue）支持分配角色功能。
  - 接口管理：CRUD API（列表分页、新增、编辑、删除），前端页面（ApiList.vue）。
  - 关联关系管理：
    - 用户-角色关联：查询/更新用户角色（`/api/v1/users/roles`）。
    - 角色-权限关联：查询/更新角色权限（`/api/v1/roles/permissions`）。
    - 权限-菜单关联：查询/更新权限菜单（`/api/v1/permissions/menus`）。
    - 权限-接口关联：查询/更新权限接口（`/api/v1/permissions/apis`）。
  - 权限中间件：实现 `PermissionMiddleware`，基于用户权限验证 API 访问权限。
  - 按钮级权限：菜单类型3（按钮）与权限关联，前端 `v-permission` 指令支持按钮级权限控制。
- 阶段四 系统支撑（系统配置、数据字典、文件存储）：
  - 系统配置管理：CRUD API（列表分页、查询、新增、编辑、删除），支持按 key 查询单个配置，前端页面（ConfigList.vue）支持刷新缓存功能。
  - 数据字典类型管理：CRUD API（列表分页、新增、编辑、删除），前端页面（DictTypeList.vue）支持刷新缓存功能。
  - 数据字典项管理：CRUD API（列表分页、新增、编辑、删除），前端页面（DictItemList.vue）。
  - 公共字典查询：`/api/v1/dict` 接口，支持按字典编码查询字典项列表，供前端下拉选择等场景使用。
  - 文件管理：CRUD API（列表分页、新增、编辑、删除），文件上传（支持本地存储），文件下载，前端页面（FileList.vue）支持上传和下载功能。
  - 缓存刷新：`/api/v1/cache/refresh` 接口，支持一键刷新配置和字典缓存，确保数据一致性。

---

## 2. 待实现 / 待完善功能
- [⏳] 阶段一：基础工程搭建
  - [✅] 初始化 go-zero 工程骨架（go.mod、目录、goctl 生成基础 API，Handler/Logic/Repository/Model 分层）
  - [✅] 配置管理与 svc 载入（RestConf inline，DB/Redis/JWT/bcrypt 配置，ServiceContext 构建数据源）
  - [✅] 数据库与 go-zero sqlx + cache 初始化封装，预留迁移目录
  - [✅] 统一响应与错误码封装（pkg/errs, pkg/response，并接入 Handler）
- [⏳] 阶段二：认证与授权（登录/注册、JWT、黑名单、权限中间件）
  - [✅] 定义 auth.api 并生成路由/类型，构建 LoginLogic + UserRepository + UserModel 骨架
  - [✅] 实现登录业务：账号状态校验、bcrypt 比对、JWT 双令牌生成与返回（黑名单/刷新接口待补）
  - [✅] 令牌黑名单与登出、刷新接口（暂未接入全局鉴权中间件）
- [✅] 阶段三：RBAC 权限/组织/菜单管理（用户/角色/权限/部门/菜单/按钮）
  - [✅] RBAC 表结构与 Model/Repository/RBACService 骨架
  - [✅] 角色/权限/部门管理 API 与前端所需列表接口（分页/树形）
  - [✅] 菜单管理后端 API（树形查询、新增、编辑、删除）
  - [✅] 用户管理后端 API（列表查询、新增、编辑、删除）
  - [✅] 菜单管理前端页面（MenuList.vue）
  - [✅] 用户管理前端页面（UserList.vue）
- [✅] 阶段四：系统支撑（系统配置、数据字典、文件存储）
  - [✅] 系统配置管理 API 与前端页面
  - [✅] 数据字典类型管理 API 与前端页面
  - [✅] 数据字典项管理 API 与前端页面
  - [✅] 公共字典查询接口
  - [✅] 文件管理 API 与前端页面（上传、下载）
  - [✅] 缓存刷新接口
- [ ] 阶段五：日志与监控（操作/登录日志、审计、限流与健康检查）
- [ ] 阶段六：性能与缓存优化（Redis 缓存策略、索引/分页、测试完善）

---

## 3. 技术决策记录
- 2025-12-23：后台按 go-zero + sqlx + cache 重建，不保留旧兼容路径；目录遵循 Handler → Logic → Repository → Model（使用 go-zero 生成的 logic 层，不再使用 Service 层）。
- 2025-12-26：数据访问层统一使用 goctl 生成的 sqlx + cache Model，不再使用 GORM。

---

## 4. API 清单
- GET `/api/v1/ping`：健康检查。
- 角色管理：
  - GET `/api/v1/roles`：角色列表（分页）。
  - POST `/api/v1/roles`：新增角色。
  - PUT `/api/v1/roles/:id`：更新角色。
  - DELETE `/api/v1/roles/:id`：删除角色（软删）。
- 权限管理：
  - GET `/api/v1/permissions`：权限列表（分页）。
  - POST `/api/v1/permissions`：新增权限。
  - PUT `/api/v1/permissions/:id`：更新权限。
  - DELETE `/api/v1/permissions/:id`：删除权限（软删）。
- 部门管理：
  - GET `/api/v1/departments/tree`：部门树。
  - POST `/api/v1/departments`：新增部门。
  - PUT `/api/v1/departments/:id`：更新部门。
  - DELETE `/api/v1/departments/:id`：删除部门（软删）。
- 菜单管理：
  - GET `/api/v1/menus/tree`：菜单树（所有菜单，用于菜单管理页面）。
  - GET `/api/v1/menus/my-tree`：当前用户有权限的菜单树（用于侧边栏）。
  - POST `/api/v1/menus`：新增菜单。
  - PUT `/api/v1/menus/:id`：更新菜单。
  - DELETE `/api/v1/menus/:id`：删除菜单（软删）。
- 用户管理：
  - GET `/api/v1/users`：用户列表（分页）。
  - POST `/api/v1/users`：新增用户。
  - PUT `/api/v1/users/:id`：更新用户。
  - DELETE `/api/v1/users/:id`：删除用户（软删）。
- 角色-权限关联：
  - GET `/api/v1/roles/permissions`：查询角色拥有的权限ID列表（query: roleId）。
  - PUT `/api/v1/roles/permissions`：更新角色的权限关联（body: roleId, permissionIds）。
- 用户-角色关联：
  - GET `/api/v1/users/roles`：查询用户拥有的角色ID列表（query: userId）。
  - PUT `/api/v1/users/roles`：更新用户的角色关联（body: userId, roleIds）。
- 接口管理：
  - GET `/api/v1/apis`：接口列表（分页）。
  - POST `/api/v1/apis`：新增接口。
  - PUT `/api/v1/apis`：更新接口（body: id）。
  - DELETE `/api/v1/apis`：删除接口（body: id）。
- 权限-菜单关联：
  - GET `/api/v1/permissions/menus`：查询权限关联的菜单ID列表（query: permissionId）。
  - PUT `/api/v1/permissions/menus`：更新权限的菜单关联（body: permissionId, menuIds）。
- 权限-接口关联：
  - GET `/api/v1/permissions/apis`：查询权限关联的接口ID列表（query: permissionId）。
  - PUT `/api/v1/permissions/apis`：更新权限的接口关联（body: permissionId, apiIds）。
- 系统配置管理：
  - GET `/api/v1/configs`：系统配置列表（分页）。
  - GET `/api/v1/configs/:key`：查询单个配置（path: key）。
  - POST `/api/v1/configs`：新增配置。
  - PUT `/api/v1/configs`：更新配置（body: id）。
  - DELETE `/api/v1/configs`：删除配置（body: id）。
- 数据字典类型管理：
  - GET `/api/v1/dict-types`：字典类型列表（分页）。
  - POST `/api/v1/dict-types`：新增字典类型。
  - PUT `/api/v1/dict-types`：更新字典类型（body: id）。
  - DELETE `/api/v1/dict-types`：删除字典类型（body: id）。
- 数据字典项管理：
  - GET `/api/v1/dict-items`：字典项列表（分页，query: typeId）。
  - POST `/api/v1/dict-items`：新增字典项。
  - PUT `/api/v1/dict-items`：更新字典项（body: id）。
  - DELETE `/api/v1/dict-items`：删除字典项（body: id）。
- 公共字典查询：
  - GET `/api/v1/dict`：按字典编码查询字典项列表（query: code）。
- 文件管理：
  - GET `/api/v1/files`：文件列表（分页）。
  - POST `/api/v1/files`：新增文件记录。
  - PUT `/api/v1/files`：更新文件记录（body: id）。
  - DELETE `/api/v1/files`：删除文件记录（body: id）。
  - POST `/api/v1/files/upload`：文件上传。
  - GET `/api/v1/files/:id/download`：文件下载（path: id）。
- 缓存管理：
  - POST `/api/v1/cache/refresh`：刷新配置和字典缓存。

---

## 5. 关键代码位置
- 入口与路由：`admin-server/admin.go`、`internal/handler/routes.go`
- Handler：`internal/handler/ping/pinghandler.go`
- Logic：`internal/logic/ping/pinglogic.go`
- Repository：`internal/repository/repository.go`
- 配置：`internal/config/config.go`、`etc/admin-api.yaml`
- 阶段三 RBAC 核心代码：
  - API 定义：`admin-server/api/admin.api`
  - Handler：`internal/handler/role/`、`internal/handler/permission/`、`internal/handler/department/`、`internal/handler/menu/`、`internal/handler/user/`、`internal/handler/api/`、`internal/handler/user_role/`、`internal/handler/role_permission/`、`internal/handler/permission_menu/`、`internal/handler/permission_api/`
  - Logic：`internal/logic/role/`、`internal/logic/permission/`、`internal/logic/department/`、`internal/logic/menu/`、`internal/logic/user/`、`internal/logic/api/`、`internal/logic/user_role/`、`internal/logic/role_permission/`、`internal/logic/permission_menu/`、`internal/logic/permission_api/`
  - Repository：`internal/repository/role_repository.go`、`internal/repository/permission_repository.go`、`internal/repository/department_repository.go`、`internal/repository/menu_repository.go`、`internal/repository/user_repository.go`、`internal/repository/api_repository.go`、`internal/repository/user_role_repository.go`、`internal/repository/role_permission_repository.go`、`internal/repository/permission_menu_repository.go`、`internal/repository/permission_api_repository.go`
  - Model：`internal/model/adminrolemodel.go`、`internal/model/adminpermissionmodel.go`、`internal/model/admindepartmentmodel.go`、`internal/model/adminmenumodel.go`、`internal/model/adminusermodel.go`、`internal/model/adminapimodel.go`、`internal/model/adminuserrolemodel.go`、`internal/model/adminrolepermissionmodel.go`、`internal/model/adminpermissionmenumodel.go`、`internal/model/adminpermissionapimodel.go`
  - 权限中间件：`internal/middleware/permissionmiddleware.go`
- 阶段四系统支撑核心代码：
  - Handler：`internal/handler/config/`、`internal/handler/dict_type/`、`internal/handler/dict_item/`、`internal/handler/dict/`、`internal/handler/file/`、`internal/handler/cache/`
  - Logic：`internal/logic/config/`、`internal/logic/dict_type/`、`internal/logic/dict_item/`、`internal/logic/dict/`、`internal/logic/file/`、`internal/logic/cache/`
  - Repository：`internal/repository/config_repository.go`、`internal/repository/dict_type_repository.go`、`internal/repository/dict_item_repository.go`、`internal/repository/file_repository.go`
  - Model：`internal/model/adminconfigmodel.go`、`internal/model/admindicttypemodel.go`、`internal/model/admindictitemmodel.go`、`internal/model/adminfilemodel.go`

---

## 6. 数据库变更记录
- 2025-12-24：统一初始化 SQL `db/tables.sql`，包含 admin_user/admin_role/admin_permission/admin_department/admin_user_role/admin_role_permission/admin_menu/admin_api/admin_permission_menu/admin_permission_api，所有表采用 `created_at/updated_at/deleted_at` BIGINT(秒级，默认0)，软删除通过 `deleted_at` 标识（关联关系表不包含 `deleted_at`）。
- 2025-12-24：添加菜单管理和用户管理菜单项到 `db/data.sql`（id=14, 15）。
- 2025-12-24：创建权限 SQL 脚本 `db/permissions_menu_user.sql`，包含菜单管理和用户管理的权限列表。
- 2025-12-26：完善 `db/data.sql`，添加按钮级菜单（type=3）和对应的权限-菜单关联，包含角色/权限/部门/菜单/用户/接口管理的新增/编辑/删除按钮（共18个按钮菜单）。
- 2025-12-26：阶段四新增表：`admin_config`（系统配置表）、`admin_dict_type`（数据字典类型表）、`admin_dict_item`（数据字典项表）、`admin_file`（文件表），并在 `db/tables.sql` 中添加初始化数据。
- 2025-12-26：阶段四补充权限菜单接口初始化 SQL：在 `db/data.sql` 中补充系统配置、数据字典类型、数据字典项、文件管理模块的权限（id=26-41）、菜单（id=28-43）、接口（id=36-55）、权限-菜单关联（id=25-40）、权限-接口关联（id=34-52）的初始化数据。
- 2025-12-26：阶段四补充通用权限：新增 `common:profile`（ID=42）、`common:logout`（ID=43）、`common:dict`（ID=44）、`common:cache_refresh`（ID=45）、`menu:my_tree`（ID=46）权限，并关联对应接口。
- 2025-12-26：阶段四完善菜单过滤逻辑：修复 `MenuMyTreeLogic` 菜单过滤逻辑，使用完整的菜单-权限映射进行过滤，确保只显示用户有权限的菜单和按钮。

