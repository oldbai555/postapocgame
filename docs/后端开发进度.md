## 0. 开发必读
- 权威设计文档：`docs/go-zero实现方案.md`。按文档分层（API → Service → Repository → Model），禁止保留旧兼容层。
- 完成功能记入「已完成功能」，分阶段需求放「待实现 / 待完善功能」，技术约束写入「技术决策记录」。
- 统一响应/错误码、JWT 双令牌、bcrypt 密码、logx 日志、gorm 数据访问、go-zero 限流。
- **开发流程规范（强制遵守）**：
  1. **先开发后端**：完成 API 定义、Handler、Service、Repository 实现，确保后端接口可独立测试通过
  2. **再开发前端**：基于后端接口，使用 goctl 生成 TS 代码，实现前端页面和组件
  3. **最后联调**：前后端联调接口，测试完整流程，确保功能正常
  4. **测试通过后再开发下一个功能**：每个功能必须完整实现并测试通过后，才能开始下一个功能的开发
- **权限 SQL 生成规范（必须遵守）**：
  - 每新增一个功能模块，必须同时生成对应的权限列表 SQL 文件
  - SQL 文件命名：`admin-server/db/permissions_{module_name}.sql`
  - 权限编码规范：`{module}:{action}`（如 `user:list`、`user:create`、`user:update`、`user:delete`）
  - 权限 SQL 必须包含：列表、新增、编辑、删除四个基础权限
  - 执行权限 SQL 后，需要在菜单管理中添加对应的菜单项，并关联权限编码
  - 参考示例：`admin-server/db/permissions_menu_user.sql`

---

## 1. 已完成功能
- 初始化 admin-server 工程骨架：go-zero Rest 服务、/api/v1/ping 健康接口、分层结构（Handler → Service → Repository → Model）搭建。
- 配置与数据源：扩展配置（Rest + DB + Redis + JWT + bcrypt），ServiceContext 接入 GORM(MySQL) 与 go-redis 初始化并统一注入 Repository，迁移目录预留。
- 统一响应与错误码：新增 `pkg/errs`（业务错误码与 Error 封装）与 `pkg/response`（统一响应 Envelope 与日志记录），并在 Ping Handler 中落地使用。
- 认证模块骨架：定义 `auth.api`（/api/v1/auth/login），使用 goctl 生成 Handler/Types 后改造为 Handler → AuthService → UserRepository → UserModel 分层，删除 logic 层与多余入口 `auth.go`。
- 登录流程实现：`AuthService.Login` 基于 `admin_user` 表实现登录（用户名/密码必填校验、状态检查、bcrypt 密码比对），使用 `pkg/jwt` 生成 Access/Refresh JWT，并通过统一响应返回 `TokenPair`。
- 刷新与登出：新增 `/auth/refresh` 与 `/auth/logout` 接口，`AuthService.Refresh` 基于 Refresh Token 生成新双令牌，`AuthService.Logout` 使用 Redis 黑名单（`jwt:blacklist:*`）封禁 Access/Refresh Token。
- 鉴权中间件：实现 JWT 鉴权中间件 `internal/middleware/auth_middleware.go`，校验 Access Token + Redis 黑名单，并将用户信息写入 Context；新增受保护接口 `/auth/profile` 以验证中间件链路。
- RBAC 骨架：新增 RBAC 表迁移 `002_init_rbac.sql`（role/permission/department/user_role/role_permission），对应 Model（`internal/model/*`）与 Repository（`internal/repository/*`），实现基础 `RBACService.ListPermissionCodesByUser`。
- 管理员初始化脚本：新增 `cmd/adminseed`，基于配置连接数据库并创建默认管理员账号（用户名/密码可通过参数覆盖，密码使用 bcrypt 按配置 cost 加密）。

---

## 2. 待实现 / 待完善功能
- [⏳] 阶段一：基础工程搭建
  - [✅] 初始化 go-zero 工程骨架（go.mod、目录、goctl 生成基础 API，去除 logic 分层，新增 Service/Repository/Model）
  - [✅] 配置管理与 svc 载入（RestConf inline，DB/Redis/JWT/bcrypt 配置，ServiceContext 构建数据源）
  - [✅] 数据库与 GORM 初始化封装，预留迁移目录
  - [✅] 统一响应与错误码封装（pkg/errs, pkg/response，并接入 Handler）
- [⏳] 阶段二：认证与授权（登录/注册、JWT、黑名单、权限中间件）
  - [✅] 定义 auth.api 并生成路由/类型，构建 AuthService + UserRepository + UserModel 骨架
  - [✅] 实现登录业务：账号状态校验、bcrypt 比对、JWT 双令牌生成与返回（黑名单/刷新接口待补）
  - [✅] 令牌黑名单与登出、刷新接口（暂未接入全局鉴权中间件）
- [✅] 阶段三：RBAC 权限/组织/菜单管理（用户/角色/权限/部门/菜单/按钮）
  - [✅] RBAC 表结构与 Model/Repository/RBACService 骨架
  - [✅] 角色/权限/部门管理 API 与前端所需列表接口（分页/树形）
  - [✅] 菜单管理后端 API（树形查询、新增、编辑、删除）
  - [✅] 用户管理后端 API（列表查询、新增、编辑、删除）
  - [✅] 菜单管理前端页面（MenuList.vue）
  - [✅] 用户管理前端页面（UserList.vue）
- [ ] 阶段四：系统支撑（系统配置、数据字典、文件存储）
- [ ] 阶段五：日志与监控（操作/登录日志、审计、限流与健康检查）
- [ ] 阶段六：性能与缓存优化（Redis 缓存策略、索引/分页、测试完善）

---

## 3. 技术决策记录
- 2025-12-23：后台按 go-zero + gorm 重建，不保留旧兼容路径；目录遵循 Handler → Service → Repository → Model。

---

## 4. API 清单
- GET `/api/v1/ping`：健康检查。
- 角色管理：
  - GET `/api/v1/roles`：角色列表（分页）。
  - POST `/api/v1/roles`：新增角色。
  - PUT `/api/v1/roles/:id`：更新角色。
  - DELETE `/api/v1/roles/:id`：删除角色（软删）。
- 权限管理：
  - GET `/api/v1/permissions`：权限列表（分页）。
  - POST `/api/v1/permissions`：新增权限。
  - PUT `/api/v1/permissions/:id`：更新权限。
  - DELETE `/api/v1/permissions/:id`：删除权限（软删）。
- 部门管理：
  - GET `/api/v1/departments/tree`：部门树。
  - POST `/api/v1/departments`：新增部门。
  - PUT `/api/v1/departments/:id`：更新部门。
  - DELETE `/api/v1/departments/:id`：删除部门（软删）。
- 菜单管理：
  - GET `/api/v1/menus/tree`：菜单树（所有菜单，用于菜单管理页面）。
  - GET `/api/v1/menus/my-tree`：当前用户有权限的菜单树（用于侧边栏）。
  - POST `/api/v1/menus`：新增菜单。
  - PUT `/api/v1/menus/:id`：更新菜单。
  - DELETE `/api/v1/menus/:id`：删除菜单（软删）。
- 用户管理：
  - GET `/api/v1/users`：用户列表（分页）。
  - POST `/api/v1/users`：新增用户。
  - PUT `/api/v1/users/:id`：更新用户。
  - DELETE `/api/v1/users/:id`：删除用户（软删）。
- 角色-权限关联：
  - GET `/api/v1/roles/:roleId/permissions`：查询角色拥有的权限ID列表。
  - PUT `/api/v1/roles/:roleId/permissions`：更新角色的权限关联。
- 用户-角色关联：
  - GET `/api/v1/users/:userId/roles`：查询用户拥有的角色ID列表。
  - PUT `/api/v1/users/:userId/roles`：更新用户的角色关联。

---

## 5. 关键代码位置
- 入口与路由：`admin-server/admin.go`、`internal/handler/routes.go`
- Handler：`internal/handler/ping/pinghandler.go`
- Service：`internal/service/ping_service.go`
- Repository 占位：`internal/repository/repository.go`
- 配置：`internal/config/config.go`、`etc/admin-api.yaml`

---

## 6. 数据库变更记录
- 2025-12-24：统一初始化 SQL `db/init.sql`，包含 admin_user/admin_role/admin_permission/admin_department/admin_user_role/admin_role_permission/admin_menu，所有表采用 `created_at/updated_at/deleted_at` BIGINT(秒级，默认0)，软删除通过 `deleted_at` 标识。
- 2025-12-24：添加菜单管理和用户管理菜单项到 `db/init.sql`（id=14, 15）。
- 2025-12-24：创建权限 SQL 脚本 `db/permissions_menu_user.sql`，包含菜单管理和用户管理的权限列表。

