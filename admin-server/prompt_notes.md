# Go-Zero 后端开发 Cursor Prompt

## 系统级长期提示（放入 Cursor 项目设置）

```text
你是 admin-system 的"Go-Zero 后端开发与文档协作助手"，需要：
1）按现有代码/文档开发或重构；2）完成功能后同步文档。

权威文档：
- docs/go-zero实现方案.md      —— 后端实现方案：架构设计、功能模块、实现步骤、项目结构。
- docs/后端开发进度.md          —— 开发进度追踪：已完成功能、待实现功能、技术决策记录。

架构原则（必须遵守）：
- 分层架构：API Layer → Service Layer → Repository Layer → Model Layer
- 依赖方向：上层依赖下层，下层不依赖上层，使用接口解耦
- Handler 职责：路由处理、参数验证、调用 Service、构造响应（不包含业务逻辑）
- Service 职责：核心业务逻辑、事务控制、权限校验（业务层面）
- Repository 职责：数据访问、CRUD 封装、查询优化
- Model 职责：数据结构定义、数据库映射

开发规范：
- 代码风格：遵循 Go 官方规范，通过 golangci-lint 检查
- 错误处理：统一错误码体系，使用 errors.Wrap 追踪调用栈
- 日志规范：使用 logx，区分 Info/Warn/Error 级别，包含关键上下文
- 数据库：使用 GORM，避免 N+1 查询，合理使用 Preload/Join
- 缓存策略：热数据缓存（用户、权限、菜单），设置合理过期时间
- 事务管理：Service 层控制事务边界，避免过大事务
- API 设计：遵循 RESTful 规范，统一响应格式，版本化管理

安全要求：
- 密码：bcrypt 加密存储，禁止明文
- Token：JWT 双令牌（Access + Refresh），黑名单机制
- 参数验证：所有输入必须验证，防止 SQL 注入/XSS
- 权限控制：中间件验证 Token，Service 验证业务权限
- API 限流：使用 go-zero 内置限流中间件
- 敏感信息：加密存储，日志脱敏

关键目录结构：
- api/              - API 定义文件（.api 文件）
- internal/handler/ - HTTP 处理器（路由处理）
- internal/service/ - 业务逻辑层（核心业务）
- internal/model/   - 数据模型（数据库映射）
- internal/repository/ - 数据访问层（CRUD 封装）
- internal/middleware/ - 中间件（认证、日志、限流）
- internal/config/  - 配置管理
- pkg/              - 公共工具包（可被其他项目复用）
- db/migrations/    - 数据库迁移脚本

goctl 使用规范：
- 使用 goctl api go 生成 API 代码骨架
- 使用 goctl model 生成 Model 代码（从数据库或 SQL）
- 手动实现 Service 和 Repository 层（不使用生成）
- 保持生成代码和手写代码分离

文档维护规则：
- 实现方案文档（go-zero实现方案.md）：仅在架构调整或新增模块时更新
- 进度文档（后端开发进度.md）：
  * 新功能完成后补充到"已完成功能"
  * 待实现功能用 [ ] 标记，进行中用 [⏳]，已完成用 [✅]
  * 技术决策/架构调整记录到"技术决策记录"
  * API 接口补充到"API 清单"
  * 关键文件路径补充到"关键代码位置"
  * 数据库变更记录到"数据库变更记录"
- 修改文档必须真实读写文件，回复时简述改动（≤5行），不整篇粘贴

开发工作流：
1. 接到任务先读 go-zero实现方案.md 对应章节，了解设计原则
2. 查看 后端开发进度.md 确认当前进度和依赖关系
3. 编写 .api 文件定义接口，使用 goctl 生成代码骨架
4. 设计数据库表结构，编写 migration 脚本
5. 实现 Repository → Service → Handler 层
6. 编写单元测试，确保代码质量
7. 更新进度文档（API 清单、已完成功能、数据库变更等）
8. 代码可编译、可运行，通过 golangci-lint 检查
```

---

## 单次任务模板

### 1. 完整功能开发 + 同步文档

```text
阅读以下文档和代码后，完成功能并同步文档：
- 文档：docs/go-zero实现方案.md、docs/后端开发进度.md
- 代码范围：{示例：internal/handler/user/、internal/service/user/}

目标：
- {用 2～3 句话描述要实现的功能，例如：实现用户管理模块，包含 CRUD、批量操作、权限验证}

技术要求：
- 遵守分层架构：Handler → Service → Repository → Model
- 完整的错误处理和日志记录
- 数据库查询优化（索引、分页、避免 N+1）
- 缓存策略（热数据缓存、合理过期）
- 权限验证（中间件 + Service 层）
- 单元测试覆盖核心逻辑

数据库变更：
- 编写 migration 脚本（db/migrations/）
- 更新 Model 定义
- 添加必要索引

文档更新：
- 后端开发进度.md：
  * "已完成功能"补充本次实现的功能说明
  * "API 清单"补充新增的接口
  * "数据库变更记录"记录表结构变更
  * "待实现功能"更新状态（✅/⏳/ [ ]）
  * 如有技术决策记录到"技术决策记录"
  * 关键文件补充到"关键代码位置"
- go-zero实现方案.md：仅在架构调整时更新

完成后用 ≤5 行总结：
1. 实现了哪些功能
2. 新增/修改了哪些文件
3. 数据库变更内容
4. 更新了哪些文档
```

### 2. API 接口开发

```text
开发新的 API 接口：
- 文档：docs/go-zero实现方案.md、docs/后端开发进度.md
- 接口定义：{示例：GET /api/v1/users、POST /api/v1/users}

开发步骤：
1. 编写 .api 文件定义接口（api/user.api）
2. 使用 goctl 生成 Handler 和 Types 代码
3. 实现 Service 层业务逻辑
4. 实现 Repository 层数据访问（如需要）
5. 添加中间件（认证、权限、限流等）
6. 编写单元测试

技术要求：
- 遵循 RESTful 规范
- 统一响应格式（成功/失败/错误码）
- 完整的参数验证
- 详细的错误信息
- API 文档注释

文档更新：
- "API 清单"补充接口说明（路径、方法、功能、权限）
- "已完成功能"补充 API 开发说明
```

### 3. 数据库设计 + Migration

```text
设计数据库表结构并创建 migration：
- 文档：docs/go-zero实现方案.md、docs/后端开发进度.md
- 目标表：{示例：users、roles、permissions}

设计要求：
- 合理的字段类型和长度
- 必要的索引（主键、外键、唯一索引、普通索引）
- 软删除支持（deleted_at）
- 时间戳（created_at、updated_at）
- 考虑查询性能和扩展性

开发步骤：
1. 编写 migration 脚本（db/migrations/001_create_users_table.sql）
2. 使用 goctl model 生成 Model 代码
3. 在 Repository 层封装常用查询
4. 编写测试用例

文档更新：
- "数据库变更记录"记录表结构
- "已完成功能"补充数据库设计说明
- "关键代码位置"补充 Model 和 Repository 路径
```

### 4. 中间件开发

```text
开发中间件：{中间件名}
- 文档：docs/go-zero实现方案.md、docs/后端开发进度.md
- 功能：{示例：JWT 认证中间件、权限验证中间件、日志中间件}
- 位置：internal/middleware/{middleware_name}.go

技术要求：
- 遵循 go-zero 中间件接口
- 统一的错误处理
- 详细的日志记录
- 性能优化（缓存、避免重复查询）

文档更新：
- "已完成功能"补充中间件说明
- "关键代码位置"补充中间件路径
- 如有通用规范记录到"技术决策记录"
```

### 5. 业务逻辑重构

```text
重构业务逻辑：
- 文档：docs/go-zero实现方案.md、docs/后端开发进度.md
- 目标文件：{示例：internal/service/user/user_service.go}

重构目标：
- {描述重构原因和目标，例如：优化查询性能，拆分复杂方法，改进错误处理}

要求：
- 保持功能不变
- 优化代码结构和性能
- 改进错误处理和日志
- 增强可测试性
- 添加/完善单元测试

文档更新：
- "技术决策记录"补充重构说明
- 包含：重构原因、方案、效果、性能对比
```

### 6. 缓存策略实现

```text
实现缓存策略：{模块名}
- 文档：docs/go-zero实现方案.md、docs/后端开发进度.md
- 缓存目标：{示例：用户信息、权限数据、菜单树}

要求：
- 使用 Redis 缓存热数据
- 合理的缓存 Key 设计
- 设置过期时间
- 缓存更新策略（主动更新/被动失效）
- 缓存预热机制
- 防止缓存穿透/击穿/雪崩

实现步骤：
1. 在 Repository 层添加缓存逻辑
2. 实现缓存更新/删除方法
3. 添加缓存预热脚本
4. 编写测试用例

文档更新：
- "已完成功能"补充缓存策略说明
- "技术决策记录"记录缓存设计（Key 规则、过期策略等）
```

### 7. 权限系统实现

```text
实现权限验证系统：
- 文档：docs/go-zero实现方案.md、docs/后端开发进度.md
- 范围：{示例：用户-角色-权限关联、权限验证中间件、动态权限查询}

要求：
- RBAC 模型实现
- 中间件验证 Token 和基础权限
- Service 层验证业务权限
- 权限数据缓存
- 支持动态权限分配

实现步骤：
1. 设计权限表结构（users、roles、permissions、关联表）
2. 实现权限查询和缓存
3. 实现权限验证中间件
4. 在 Service 层添加权限校验
5. 编写测试用例

文档更新：
- "已完成功能"补充权限系统说明
- "技术决策记录"记录权限模型和验证流程
- "API 清单"补充权限相关接口
```

### 8. 架构讨论（不改代码）

```text
阅读 docs/go-zero实现方案.md、docs/后端开发进度.md，分析以下架构问题并给方案：

背景：
- {描述问题，例如：Service 层职责过重，Repository 查询性能差，事务控制混乱}

期望输出：
- 明确各层职责边界
- 给出可落地的重构方案
- 评估改动范围和影响
- 提供迁移建议
- 性能优化方案

输出格式：
- 问题分析（当前架构问题）
- 解决方案（具体改进措施）
- 实施步骤（分阶段实施计划）
- 性能评估（预期性能提升）
- 风险评估（可能的影响和应对）
```

### 9. 只更新进度文档

```text
根据以下变化更新 docs/后端开发进度.md，其他文档不动：
- 完成功能：{列出已完成的功能}
- 新增 API：{列出新增的接口}
- 数据库变更：{列出表结构变更}
- 新增任务：{列出新增的待实现功能}
- 技术决策：{列出需要记录的技术决策}

要求：
- 使用 [ ] / [⏳] / [✅] 管理 TODO
- 已完成移到"已完成功能"，TODO 中标记 ✅ 或删除
- API 清单补充接口说明（路径、方法、功能、权限）
- 数据库变更记录补充表结构变更
- 完成后简述改动（≤3行）
```

---

## 常见场景快速提示

### 新增 CRUD 模块
```text
实现 {模块名} 的完整 CRUD 功能：
- API：列表查询、详情、新增、编辑、删除、批量操作
- 数据库：设计表结构，编写 migration
- 实现：Handler → Service → Repository → Model
- 权限：接口级权限控制
- 测试：单元测试覆盖核心逻辑

遵守标准架构，完成后更新进度文档。
```

### 开发认证授权模块
```text
实现认证授权系统：
- 用户注册/登录/登出
- JWT 双令牌方案（Access + Refresh）
- Token 验证中间件
- 黑名单机制
- 密码加密存储（bcrypt）

完成后更新进度文档的认证部分和 API 清单。
```

### 优化数据库查询
```text
优化 {模块名} 的数据库查询性能：
- 分析慢查询（N+1 问题、缺失索引）
- 添加必要索引
- 优化查询语句（Preload/Join）
- 实施分页限制
- 性能测试对比

完成后在"技术决策记录"补充优化说明和效果对比。
```

### 实现缓存优化
```text
为 {模块名} 实现缓存策略：
- 缓存热数据（用户信息、权限、菜单等）
- 设计 Key 规则和过期策略
- 实现缓存更新机制
- 防止缓存穿透/击穿/雪崩

完成后在"技术决策记录"补充缓存设计说明。
```

### 编写单元测试
```text
为 {模块名} 编写单元测试：
- 测试 Service 层核心逻辑
- 测试 Repository 层数据访问
- Mock 外部依赖（数据库、Redis、HTTP）
- 覆盖正常流程和异常流程
- 测试覆盖率 ≥ 70%

完成后在"已完成功能"补充测试说明。
```

---

## 特殊场景提示

### goctl 代码生成
```text
使用 goctl 生成代码：
- API 定义：编写 .api 文件
- 生成命令：goctl api go -api {file}.api -dir .
- Model 生成：goctl model mysql datasource -url="{dsn}" -table="{tables}" -dir=./internal/model
- 检查生成代码，手动实现 Service 和 Repository

生成后更新"关键代码位置"。
```

### 数据库迁移
```text
创建数据库迁移：
- 编写 SQL：db/migrations/{version}_{description}.sql
- 包含：CREATE TABLE、ALTER TABLE、CREATE INDEX 等
- 提供回滚脚本（down.sql）
- 使用 migrate 工具执行：migrate -path db/migrations -database "{dsn}" up

完成后更新"数据库变更记录"。
```

### 性能测试
```text
进行性能测试：
- 使用 pprof 分析性能瓶颈
- 测试 QPS/TPS、响应时间、内存占用
- 压测工具：wrk/ab/jmeter
- 优化目标：{示例：QPS > 1000，P99 < 100ms}

完成后在"技术决策记录"补充性能测试报告。
```

---

## 维护说明

- 本 prompt 应与 docs/go-zero实现方案.md、docs/后端开发进度.md 配合使用
- 文档结构调整时同步更新本 prompt
- 可根据项目实际情况新增场景模板
- 团队成员可基于此 prompt 自定义个人工作流
- 定期 review 和优化 prompt 内容